<PlatformWrapper platform="unity">
### Implement the user interface

For a basic <Vpl k="NAME" /> <Vpl k="CLIENT" />, you need:

* One view for local video

* One view for remote video

* Buttons so the user can join or leave a channel

<ProductWrapper product="interactive-live-streaming">
* One selector to choose to join as the host or the audience
</ProductWrapper>

To implement this user interface, in your Unity project:

1. **Add the join and leave buttons**

    To create buttons that you access programmatically to implement the <Vpd k="NAME" /> workflow:

    1. Right-click **Sample Scene**, then click **Game Object** > **UI** > **Button**. A button appears in the **Scene** Canvas.

    If you can’t see the button clearly, in Unity, zoom out and rotate the scene.

    2. In **Inspector**, rename **Button** to **Leave**, then change the following coordinates:

        * **Pos X** - 350
        * **Pos Y** - -172

    3. Select the **Text** sub-item of **Leave**, and in **Inspector**, change **Text** to *Leave*.

    4. Use the same procedure to create a button called **Join** with a **Text** sub-item where its **Text** says *Join*.

    5. To shift **Join** to the left of the Canvas, in **Inspector** change the following coordinates:

        * **Pos X** - -350
        * **Pos Y** - -172

2. **Add the local and remove video views**

    To create raw images using <Vpl k="NAME" /> that you access programmatically to display video streams on:

    1. For local video, right-click **Canvas**, then click **UI** > **Raw Image**.

    2. In **Inspector**, rename **RawImage** to **LocalView**, and change the following coordinates:

        * **Pos X** - -250
        * **Pos Y** - 0
        * **Width** - 250
        * **Height** - 250

    3. For remote video, use the same procedure to create a **RawImage** called **RemoteView** with the following coordinates:

        * **Pos X** - 250
        * **Pos Y** - 0
        * **Width** - 250
        * **Height** - 250

<ProductWrapper product="interactive-live-streaming">
3. **Enable the user to join a channel as the host or the audience**

    1. In your <Vpl k="NAME" /> project, right-click **Canvas**, then click **UI** > **Toggle**.

    2. In **Inspector**, rename **Toggle** to "Broadcaster", then change **Pos Y** to "-30".

    3. Select the **Label** sub-item of **Broadcaster**, in **Inspector**, change the **Label** to "Host".

    4. Use the same procedure to create a **Toggle** called **Audience** with a **Label** sub-item which says **Audience**. Don’t change **Pos Y** for **Audience**, this **Toggle** is best in the center of the **Canvas**.
</ProductWrapper>

### Handle the system logic

Import the necessary .NET libraries, set up your <Vpl k="CLIENT" /> to run on Android, and request permissions for the camera and microphone.

1. **Create a new script to hold the system logic**

    To create a new script, in your <Vpl k="CLIENT" />:

    1. In **Projects**, open **Assets** > **Agora-Unity-Plugin** > **Agora-Unity-RTC-SDK** > **Code**.

    2. Right-click **Code**, then click **Create** > **C# Script**.

    3. In **Assets**, rename `NewBehaviourScript` to `JoinChannelVideo`.

        The template code is visible in Inspector.

2. **Import the <Vg k="VSDK" /> libraries**

    1. In  **Inspector**, click `Open`.

        The script opens in your default text editor.

    2. Add the following code after `using UnityEngine;`:
    ``` csharp
    using UnityEngine.UI;
    using UnityEngine.Android;
    ```
3. **Manage Android permissions**

    1. Add the following lines before `Start`:
    ``` csharp
    private ArrayList permissionList = new ArrayList() { Permission.Camera, Permission.Microphone };
    ```

    2. To check if permissions are granted, add the following code after `Update`:
    ``` csharp
    private void CheckPermissions() {
        foreach (string permission in permissionList)
        {
            if (!Permission.HasUserAuthorizedPermission(permission))
            {
                Permission.RequestUserPermission(permission);
            }
        }
    }
    ```

4. **Bind your script to the canvas**

    1. In `Assets/Agora-RTC-Plugin/Agora-Unity-RTC-SDK/Code`, drag and drop `JoinChannelVideo.cs` on **Canvas** to the **Hierarchy**.

    1. Click **Inspector**, you see that `JoinChannelVideo.cs` is added to **Canvas**.

### Implement the <Vpd k="PRODUCT" /> logic

The following figure shows the API call sequence of implementing  <Vpd k="PRODUCT" />.

<ProductWrapper product="video-calling">
    ![image](/images/video-sdk/video-call-logic-unity.svg)
</ProductWrapper>

<ProductWrapper product="interactive-live-streaming">
    ![image](/images/video-sdk/ils-call-logic-unity.svg)
</ProductWrapper>

To implement this logic, take the following steps:

1. **Import the <Vg k="COMPANY"/> library**

    In `Assets/Agora-RTC-Plugin/Agora-Unity-RTC-SDK/Code/JoinChannelVideo.cs`, add the following library after `using UnityEngine.UI;`:
    ``` csharp
    using Agora.Rtc;
    ```

1. **Declare the variables that you use to create and join a channel**

    Add the following lines in `JoinChannelVideo : MonoBehaviour{}`:
    <ProductWrapper product="video-calling">
    ``` csharp
    // Fill in your app ID.
    private string _appID= "";
    // Fill in your channel name.
    private string _channelName = "";
    // Fill in the temporary token you obtained from Agora Console.
    private string _token = "";
    internal VideoSurface LocalView;
    internal VideoSurface RemoteView;
    internal IRtcEngine RtcEngine;
    ```
    </ProductWrapper>

    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    // Fill in your app ID.
    private string _appID= "";
    // Fill in your channel name.
    private string _channelName = "";
    // Fill in the temporary token you obtained from Agora Console.
    private string _token = "";
    private Toggle toggle1;
    private Toggle toggle2;
    internal VideoSurface LocalView;
    internal VideoSurface RemoteView;
    internal IRtcEngine RtcEngine;
    ```
    </ProductWrapper>

1. **Setup <Vg k="ENGINE"/>**

    To call a method to initialize <Vg k="ENGINE"/> when the <Vpl k="CLIENT" /> is launched, add the following after `CheckPermissions`:
    <ProductWrapper product="video-calling">
    ``` csharp
    private void SetupVideoSDKEngine()
    {
        // Create an RtcEngine instance.
        RtcEngine = Agora.Rtc.RtcEngine.CreateAgoraRtcEngine();
        // Set the context.
        RtcEngineContext context = new RtcEngineContext(_appID, 0, true,
        CHANNEL_PROFILE_TYPE.CHANNEL_PROFILE_LIVE_BROADCASTING,
        AUDIO_SCENARIO_TYPE.AUDIO_SCENARIO_DEFAULT);
        // Initialize RtcEngine.
        RtcEngine.Initialize(context);
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    private void SetupVideoSDKEngine()
    {
        // Create an RtcEngine instance.
        RtcEngine = Agora.Rtc.RtcEngine.CreateAgoraRtcEngine();
        RtcEngine.SetChannelProfile(CHANNEL_PROFILE_TYPE.CHANNEL_PROFILE_LIVE_BROADCASTING);
        // Set the context.
        RtcEngineContext context = new RtcEngineContext(_appID, 0, true,
        CHANNEL_PROFILE_TYPE.CHANNEL_PROFILE_LIVE_BROADCASTING,
        AUDIO_SCENARIO_TYPE.AUDIO_SCENARIO_DEFAULT);
        // Initialize RtcEngine.
        RtcEngine.Initialize(context);
    }
    ```
    </ProductWrapper>

1. **Handle and respond to <Vg k="ENGINE"/> events**

    To register the callbacks, add the following lines after `setupVideoSDKEngine`:
    ``` csharp
    private void InitEventHandler()
    {
        // Creates a UserEventHandler instance.
        UserEventHandler handler = new UserEventHandler(this);
        RtcEngine.InitEventHandler(handler);
    }

    internal class UserEventHandler : IRtcEngineEventHandler
    {
        private readonly JoinChannelVideo _videoSample;

        internal UserEventHandler(JoinChannelVideo videoSample)
        {
            _videoSample = videoSample;
        }

        // This callback is triggered when the local user joins the channel.
        public override void OnJoinChannelSuccess(RtcConnection connection, int elapsed)
        {
        }
    }
    ```

1. **Reference the UI elements from SampleScene**

    Add the reference code before `SetupVideoSDKEngine`:
    <ProductWrapper product="video-calling">
    ``` csharp
    private void SetupUI()
    {
        GameObject go = GameObject.Find("LocalView");
        LocalView = go.AddComponent<VideoSurface>();
        go.transform.Rotate(0.0f, 0.0f, -180.0f);
        go = GameObject.Find("RemoteView");
        RemoteView = go.AddComponent<VideoSurface>();
        go.transform.Rotate(0.0f, 0.0f, -180.0f);
        go = GameObject.Find(*Leave*);
        go.GetComponent<Button>().onClick.AddListener(Leave);
        go = GameObject.Find("Join");
        go.GetComponent<Button>().onClick.AddListener(Join);
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    private void SetupUI()
    {
        GameObject go = GameObject.Find("LocalView");
        LocalView = go.AddComponent<VideoSurface>();
        go.transform.Rotate(0.0f, 0.0f, -180.0f);
        go = GameObject.Find("RemoteView");
        RemoteView = go.AddComponent<VideoSurface>();
        go.transform.Rotate(0.0f, 0.0f, -180.0f);
        go = GameObject.Find(*Leave*);
        go.GetComponent<Button>().onClick.AddListener(Leave);
        go = GameObject.Find("Join");
        go.GetComponent<Button>().onClick.AddListener(Join);
        GameObject Obj1 = GameObject.Find("Broadcaster");
        toggle1 = Obj1.GetComponent<Toggle>();
        toggle1.isOn = false;
        toggle1.onValueChanged.AddListener((value) =>
        {
            Func1(value);
        });
        GameObject Obj2 = GameObject.Find("Audience");
        toggle2 = Obj2.GetComponent<Toggle>();
        toggle2.isOn = false;
        toggle2.onValueChanged.AddListener((value) =>
        {
            Func2(value);
        });
    }
    ```
    </ProductWrapper>

1. **Join a channel to start <Vpl k="NAME" />**

    When the local user clicks the `Join` button, you call `Join()`. This method securely connects the local user to a channel using the authentication token. Add the following lines after `InitEventHandler`:
    <ProductWrapper product="video-calling">
    ``` csharp
    public void Join()
    {
        // Enables the video module.
        RtcEngine.EnableVideo();
        // Sets the user role as broadcaster.
        RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER);
        // Sets the local video view.
        LocalView.SetForUser(0, "", VIDEO_SOURCE_TYPE.VIDEO_SOURCE_CAMERA);
        // Starts rendering local video.
        LocalView.SetEnable(true);
        // Joins a channel.
        RtcEngine.JoinChannel(_token, _channelName);
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    public void Join()
    {
        if (toggle1.isOn == false && toggle2.isOn == false)
        {
            Debug.Log("Select a role first");
        }
        else
        {
            // Enables the video module.
            RtcEngine.EnableVideo();
            // Sets the user role as broadcaster.
            RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER);
            // Sets the local video view.
            LocalView.SetForUser(0, "", VIDEO_SOURCE_TYPE.VIDEO_SOURCE_CAMERA);
            // Joins a channel.
            RtcEngine.JoinChannel(_token, _channelName);
        }
    }
    ```
    </ProductWrapper>

1. **View the remote user when they join a channel**

    When a remote user joins the channel, <Vg k="COMPANY"/> fires the `OnUserJoined` callback. To catch this callback and start remote video, add the following code after `OnJoinChannelSuccess`:
    ``` csharp
    // This callback is triggered when a remote user joins the channel.
    public override void OnUserJoined(RtcConnection connection, uint uid, int elapsed)
    {
        // Sets the remote video view.
        _videoSample.RemoteView.SetForUser(uid, connection.channelId, VIDEO_SOURCE_TYPE.VIDEO_SOURCE_REMOTE);
        // Starts rendering remote video.
        _videoSample.RemoteView.SetEnable(true);
    }
    ```
<ProductWrapper product="interactive-live-streaming">
8. **Manage the user role**

    1. Change the `LocalView` and `RemoteView` visibility.
    When the user role switches, <Vg k="COMPANY"/> fires the `OnClientRoleChanged` callback. To catch this callback and enable or disable `LocalView`, `RemoteView` accordingly, add the following code after `OnUserJoined`:
        ``` csharp
        public override void OnClientRoleChanged(RtcConnection connection, CLIENT_ROLE_TYPE oldRole, CLIENT_ROLE_TYPE newRole)
        {
            if (newRole == CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER)
            {
                _videoSample.LocalView.SetEnable(true);
                _videoSample.RemoteView.SetEnable(false);
                Debug.Log("Role changed to Broadcaster");
            }
            else
            {
                _videoSample.LocalView.SetEnable(false);
                _videoSample.RemoteView.SetEnable(true);
                Debug.Log("Role changed to Audience");
            }
        }
        ```

    1. Switch the user role between broadcaster and audience.
    When toggles are switched on, to switch client role and turn off the toggles, add the following code before `internal class UserEventHandler : IRtcEngineEventHandler{}`:

        ``` csharp
        void Func1(bool value)
        {
            if(value==true)
            {
                toggle2.isOn = false;
                RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER);
            }
        }

        void Func2(bool value)
        {
            if (value==true)
            {
                toggle1.isOn = false;
                RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_AUDIENCE);
            }
        }
        ```
</ProductWrapper>
8. **Stop remote video when a remote user leaves the channel**

    When a remote user leaves the channel or drops offline, <Vg k="COMPANY"/>  fires the `OnUserOffline` callback. To catch this callback and stop remote video, add the following lines after `OnUserJoined`:
    ``` csharp
    // This callback is triggered when a remote user leaves the channel or drops offline.
    public override void OnUserOffline(RtcConnection connection, uint uid, USER_OFFLINE_REASON_TYPE reason)
    {
        _videoSample.RemoteView.SetEnable(false);
    }
    ```

1. **Leave the channel when a user ends the call**

    When a user clicks **Leave**, you call `Leave()` to exit the channel. Add the following lines after `Join`:
    ``` csharp
    public void Leave()
    {
        // Leaves the channel.
        RtcEngine.LeaveChannel();
        // Disable the video modules.
        RtcEngine.DisableVideo();
        // Stops rendering the remote video.
        RemoteView.SetEnable(false);
        // Stops rendering the local video.
        LocalView.SetEnable(false);
    }
    ```

### Start and stop your <Vpl k="CLIENT" />

In this implementation, you initiate and remove  <Vg k="ENGINE" /> when the app opens and closes. The local user joins and leaves a channel using the same  <Vg k="ENGINE" /> instance. In order to send video and audio streams to  <Vg k="COMPANY" />, you need to ensure that the local user gives permission to access the camera and microphone on the local device. To implement this functionality:

1. **Check that the application has the correct permissions to start**

    For Android, call `CheckPermissions` and check that the permissions are granted. Replace `Update` with the following code:
    ``` csharp
    void Update()
    {
        CheckPermissions();
    }
    ```

2. **Start <Vpd k="PRODUCT" />**

    Replace `Start` with the following code:
    ``` csharp
    void Start()
    {
        SetupVideoSDKEngine();
        InitEventHandler();
        SetupUI();
    }
    ```

3. **Clean up the resources used by your <Vpl k="CLIENT" />**

    When a user closes the <Vpl k="CLIENT" />, use `OnApplicationQuit` to clean up the resources you created in `SetupVideoSDKEngine`. Add the following code after `Update`:
    ``` csharp
    void OnApplicationQuit()
    {
        if (RtcEngine != null)
        {
            Leave();
            RtcEngine.Dispose();
            RtcEngine = null;
        }
    }
    ```

</PlatformWrapper>