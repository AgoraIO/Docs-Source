

<PlatformWrapper notAllowed="web">
This extension is for Web only.
</PlatformWrapper>

<PlatformWrapper platform="web">

Vitual background enables users to blur their background or replace it with a solid color or an image. This extension is applicable to scenarios such as online conferences, online classes, and live streaming. It helps to protect personal privacy and reduce the audience getting distracted.

The following figure shows how the extension works:

![](https://web-cdn.agora.io/docs-files/1647325748630)

Click the <a href="https://webdemo.agora.io/virtualBackground/index.html" target="_blank">online demo</a> to try this feature out.


## Understand the tech

A typical transmission pipeline in the Agora Web SDK consists of a chain of procedures, including capture, preprocessing, encoding, transmitting, decoding, post-processing, and playback. In the preprocessing stage, extensions can modify the audio and video data in the pipeline to implement features such as virtual background and noise cancellation.

![](https://web-cdn.agora.io/docs-files/1647326674232)

## Implementation

Integrate the virtual background extension, and implement the virtual background feature, as follows:

1. Refer to the appropriate Quickstart Guide to integrate the Web SDK (v4.10.0 or later) and implement the basic real-time communication functions in your project.

2. Integrate the [virtual background extension](https://www.npmjs.com/package/agora-extension-virtual-background) into your project via npm:

   1. To install the virtual background extension, run the following command :

      ```bash
      npm install agora-extension-virtual-background
      ```

   2. To import the virtual background extension, use any of the following methods:

      Method one: Add the following code to the JavaScript file:

      ```typescript
      import VirtualBackgroundExtension from "agora-extension-virtual-background";
      ```

      Method two: Use the Script tag in the HTML file. Once imported, the `VirtualBackgroundExtension` object can be used directly in JavaScript files.

      ```html
      <script src="./agora-extension-virtual-background.js"></script>
      ```

3. Dynamically load the Wasm dependency: The virtual background extension depends on a Wasm file. Find the Wasm file in `node_modules/agora-extension-virtual-background/wasms`. You need to publish the Wasm file to a CDN or static resource server. You need to pass in the URL of the Wasm file when calling `processor.init` in subsequent steps. The extension dynamically loads the Wasm file.

If the host URL of the Wasm file is not the same as that of the web application, enable the CORS policy. Do not put the Wasm file in an HTTP service, because loading HTTP resources in the HTTPS domain is blocked by browsers' security policy.

4. Register the virtual background extension: After calling `AgoraRTC.createClient`to create a client object, new a `VirtualBackgroundExtension` object and pass in the `VirtualBackgroundExtension` object when calling `AgoraRTC.registerExtensions`.

   ```typescript
   // Create a client object
   var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
   // Create a VirtualBackgroundExtension instance
   const extension = new VirtualBackgroundExtension();
   // Register the extension
   AgoraRTC.registerExtensions([extension]);
   ```

5. Initialize the virtual background extension:

   1. Call `extension.createProcessor` to create a `VirtualBackgroundProcessor` instance.

      ```typescript
      processor = extension.createProcessor();
      ```

   2. Call `processor.init` to initialize the extension. In this method, you need to pass in the URL of the Wasm module. If resource loading or extension initialization fails, this method throws an exception. Catch this exception, and handle it accordingly.

      ```typescript
      await processor.init("./assets/wasms");
      ```

   3. After creating a local camera track, call `videoTrack.pipe` and `videoTrack.processorDestination` to inject the extension into the SDK's media processing pipeline.

      ```typescript
      localTracks.videoTrack.pipe(processor).pipe(localTracks.videoTrack.processorDestination);
      ```

6. Call `processor.setOptions` to choose the virtual background type and make settings. Agora supports the following settings:

   - Set a solid color as the background: Set the `type` parameter as `"color"`, and set the `color` parameter.

      ```typescript
      processor.setOptions({type: 'color', color: '#00ff00'});
      ```

   - Set an image as the background: Set the `type` parameter as `"img"`, and set the `source` parameter to specify the image object.

      ```typescript
      processor.setOptions({type: 'img', source: HTMLImageElement});
      ```

   - Blur the user's original background: Set the `type` parameter as `"blur"` and set the `blurDegree` parameter to choose the blurring degree, low (`1`), medium (`2`), or high (`3`).

      ```typescript
      processor.setOptions({type: 'blur', blurDegree: 2});
      ```

7. Call `processor.enable` to enable the virtual background feature.

   ```typescript
   await processor.enable();
   ```

   If you do not call `setOptions` before calling this method, the default behavior of the SDK is to blur users' actual background with the blurring degree set as 1. After enabling the virtual background feature, to switch the virtual background type, just call `setOptions`.

## Sample code

```typescript
import AgoraRTC from "agora-rtc-sdk-ng";
import VirtualBackgroundExtension from "agora-extension-virtual-background";

// Create a client object
var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
// Create a VirtualBackgroundExtension instance
const extension = new VirtualBackgroundExtension();
// Register the extension
AgoraRTC.registerExtensions([extension]);

let processor = null;
var localTracks = {
  videoTrack: null,
  audioTrack: null
};

// Initialization
async function getProcessorInstance() {
  if (!processor && localTracks.videoTrack) {
    // Create a VirtualBackgroundProcessor instance
    processor = extension.createProcessor();

      try {
        // Initialize the extension and pass in the URL of the Wasm file
        await processor.init("./assets/wasms");
        } catch(e) {
          console.log("Fail to load WASM resource!");return null;
          }
    // Inject the extension into the video processing pipeline in the SDK
    localTracks.videoTrack.pipe(processor).pipe(localTracks.videoTrack.processorDestination);
  }
  return processor;
}

// Join a channel
async function join() {
  // Add event listeners
  client.on("user-published", handleUserPublished);
  client.on("user-unpublished", handleUserUnpublished);

  [options.uid, localTracks.audioTrack, localTracks.videoTrack] = await Promise.all([
    // Join a channel
    client.join(options.appid, options.channel, options.token || null),
    // Create a local microphone track and camera track
    localTracks.audioTrack || AgoraRTC.createMicrophoneAudioTrack(),
    localTracks.videoTrack || AgoraRTC.createCameraVideoTrack({encoderConfig: '720p_4'})
  ]);

  // Play local tracks
  localTracks.videoTrack.play("local-player");
}

// Set a solid color as the background
async function setBackgroundColor() {
  if (localTracks.videoTrack) {
    document.getElementById("loading").style.display = "block";

    let processor = await getProcessorInstance();

    try {
      processor.setOptions({type: 'color', color: '#00ff00'});
      await processor.enable();
    } finally {
      document.getElementById("loading").style.display = "none";
    }

    virtualBackgroundEnabled = true;
  }
}

// Blur the user's actual background
async function setBackgroundBlurring() {
  if (localTracks.videoTrack) {
    document.getElementById("loading").style.display = "block";

    let processor = await getProcessorInstance();

    try {
      processor.setOptions({type: 'blur', blurDegree: 2});
      await processor.enable();
    } finally {
      document.getElementById("loading").style.display = "none";
    }

    virtualBackgroundEnabled = true;
  }
}

// Set an image as the background
async function setBackgroundImage() {
    const imgElement = document.createElement('img');

    imgElement.onload = async() => {
      document.getElementById("loading").style.display = "block";

      let processor = await getProcessorInstance();

      try {
        processor.setOptions({type: 'img', source: imgElement});
        await processor.enable();
      } finally {
        document.getElementById("loading").style.display = "none";
      }

      virtualBackgroundEnabled = true;
    }
    imgElement.src = '/images/background.png';
}
```

## Considerations

- This extension works best when there is only one user in the video captured by the camera.
- The browser support for the virtual background extension is as follows:
   - To get a better virtual background experience, Agora recommends using this feature on the latest version of Desktop Chrome.
   - Agora does not recommend enabling the virtual background feature on Firefox and Safari browsers. Backgrounding the web app on Firefox may cause the video to freeze, while the performance on Safari could be poor due to the browser's own performance issues.
   - Agora does not recommend enabling the virtual background feature on mobile browsers.
- The virtual background feature has high performance requirements. Make sure your computer meets the following requirements:
   - CPU: Intel Core i5 4 cores or higher
   - 8G RAM or more
   - 64-bit operating system


## API reference

### IVirtualBackgroundExtension

#### createProcessor

```typescript
createProcessor(): IVirtualBackgroundProcessor;
```

Creates an `VirtualBackgroundProcessor` object.

### IVirtualBackgroundProcessor

#### init

```typescript
init(wasmDir: string): Promise<void>;
```

Initializes the extension.

If the initialization of the extension fails due to the failure to access the Wasm file, this method throws an exception. Agora recommends that you disable the virtual background feature catching the exception.

If the Wasm file is deployed on third-party services such as CDN and OSS across domains, you need to enable cross-domain access. For example, when deploying Nginx servers across domains, to enable cross-domain access, add the following configurations:

```
add_header 'Access-Control-Allow-Origin' "$http_origin";
add_header 'Access-Control-Allow-Credentials' "true";
```

Parameters:

- `wasmDir`: The URL where the virtual background WASM module is located (without the `WASM` filename).

<a name="setoptions"></a>

#### setOptions

```typescript
setOptions(options: VirtualBackgroundEffectOptions): void;
```

Chooses the virtual background type, and sets parameters.

Parameters:

- `options`: The virtual background options. See [VirtualBackgroundEffectOptions](#virtualbackgroundeffectoptions).

#### enable

```typescript
enable(): void | Promise<void>;
```

Enables the virtual background feature.

If you do not call `setOptions` before calling this method, the default behavior of the SDK is to blur users' actual background with the blurring degree set as 1.

#### disable

```typescript
disable(): void | Promise<void>;
```

Disables the virtual background feature.

#### onoverload

```typescript
onoverload?: () => void;
```

When the system performance cannot meet the processing requirements, the SDK triggers `onoverload`.

Agora recommends calling `disable` in this event to disable virtual background and adding a UI prompt.

### Type definition

<a name="virtualbackgroundeffectoptions"></a>

#### VirtualBackgroundEffectOptions

Virtual background types and settings. Used in the [setOptions](#setoptions) method.

```typescript
export type VirtualBackgroundEffectOptions = {
  type: string,
  color?: string;
  source?: HTMLImageElement;
  blurDegree?: Number;
};
```

Properties:

- `type`: String. Choose the virtual background type:
   - `"color"`: Sets a solid color as the background.
   - `"img"`: Sets an image as the background.
   - `"blur"`: Blurs the user's original background.

- `color`: String. When you set `type` as `"color"`, set this parameter to specify the color. The value must be a valid CSS color such as `"white"`, `"#00ff00"`, or ` "RGB(255, 0, 0)"`.

- `source`: The HTMLImageElement object. When you set `type` as `"img"`, you can set a custom background image through this parameter.

<div class="alert note"><li>If the error "texture bound to texture unit 2 is not renderable. It might be non-power-of-2 or have incompatible texture filtering (maybe)?" occurs, check whether the product of the picture's width and height is a multiple of 2.</li><li>Due to the restriction of browsers' security policy, if your background image resources are deployed across domains, you need to enable your servers' cross-domain permission and set the <code>crossOrigin</code> property of the <code> HTMLImageElement</code> object as <code>"anonymous"</code>.</li><li>Since it takes time to load the image in the<code> HTMLImageElement</code> object, Agora recommends calling <code>setOptions</code> in the <code>onload</code> callback of the <code> HTMLImageElement</code> object, otherwise, the background momentarily turns black.</li></div>

- `blurDegree`: Number. When you set `type` as `"blur"`, set this parameter to choose the blurring degree:
   - `1`: Low
   - `2`: Medium
   - `3`: High

</PlatformWrapper>