import CodeBlock from '@theme/CodeBlock';

This section introduces the core Go code for building the conversational AI engine.

    <details>

    If you want to run the sample quickly without diving into the implementation details:

    1. Copy the complete example code below into your `main.go` file.
    2. Configure the required parameters as described in the second step.
    3. Skip to the [Test the Agent](#test-the-agent) section to continue.

    <summary>Complete `main.go` example</summary>
    <CodeBlock language="go" showLineNumbers>
    {`package main
import (
    "context"
    "log"
    "time"

    "github.com/AgoraIO-Community/agora-rest-client-go/agora/auth"
    "github.com/AgoraIO-Community/agora-rest-client-go/agora/domain"
    agoraLogger "github.com/AgoraIO-Community/agora-rest-client-go/agora/log"
    agoraUtils "github.com/AgoraIO-Community/agora-rest-client-go/agora/utils"
    "github.com/AgoraIO-Community/agora-rest-client-go/services/convoai"
    "github.com/AgoraIO-Community/agora-rest-client-go/services/convoai/req"
)

const (
    appId                 = "<your appId>"
    cname                 = "<your cname>"
    agentRtcUid           = "<your agent rtc uid>"
    username              = "<the username of basic auth credential>"
    password              = "<the password of basic auth credential>"
    agentRtcToken         = "<your agent rtc token>"
    llmURL                = "<your LLM URL>"
    llmAPIKey             = "<your LLM API Key>"
    llmModel              = "<your LLM model>"
    ttsBytedanceToken     = "<your bytedance tts token>"
    ttsBytedanceAppId     = "<your bytedance tts app id>"
    ttsBytedanceCluster   = "<your bytedance tts cluster>"
    ttsBytedanceVoiceType = "<your bytedance tts voice type>"
)

func main() {
    log.SetFlags(log.LstdFlags | log.Lshortfile)

    // Initialize the ConvoAI REST client configuration
    config := &convoai.Config{
        AppID:      appId,
        Credential: auth.NewBasicAuthCredential(username, password),
        // Specify the server region. Options: CN, EU, AP, US
        // The REST client automatically uses the optimal domain for the selected region
        DomainArea: domain.CN,
        // Set the log output level. Options: DebugLevel, InfoLevel, WarningLevel, ErrLevel
        // To disable logging, set the logger to DiscardLogger
        Logger: agoraLogger.NewDefaultLogger(agoraLogger.DebugLevel),
        // Specify the service region. Options: ChineseMainlandServiceRegion, GlobalServiceRegion
        // These two represent different service scopes
        ServiceRegion: convoai.ChineseMainlandServiceRegion,
    }

    // Initialize the ConvoAI REST client
    convoaiClient, err := convoai.NewClient(config)
    if err != nil {
        log.Fatalln(err)
    }
    ctx := context.Background()

    name := appId + ":" + cname

    // Create a conversational agent
    joinResp, err := convoaiClient.Join(ctx, name, &req.JoinPropertiesReqBody{
        Token:           agentRtcToken,
        Channel:         cname,
        AgentRtcUId:     agentRtcUid,
        RemoteRtcUIds:   []string{"*"},
        EnableStringUId: agoraUtils.Ptr(false),
        IdleTimeout:     agoraUtils.Ptr(120),
        LLM: &req.JoinPropertiesCustomLLMBody{
            Url:    llmURL,
            APIKey: llmAPIKey,
            SystemMessages: []map[string]any{
                {
                    "role":    "system",
                    "content": "You are a helpful chatbot.",
                },
            },
            Params: map[string]any{
                "model":      llmModel,
                "max_tokens": 1024,
            },
            MaxHistory:      agoraUtils.Ptr(30),
            GreetingMessage: "Hello, how can I help you?",
        },
        TTS: &req.JoinPropertiesTTSBody{
            Vendor: req.BytedanceTTSVendor,
            Params: &req.TTSBytedanceVendorParams{
                Token:       ttsBytedanceToken,
                AppId:       ttsBytedanceAppId,
                Cluster:     ttsBytedanceCluster,
                VoiceType:   ttsBytedanceVoiceType,
                SpeedRatio:  1.0,
                VolumeRatio: 1.0,
                PitchRatio:  1.0,
                Emotion:     "happy",
            },
        },
    })
    if err != nil {
        log.Fatalln(err)
    }

    if joinResp.IsSuccess() {
        log.Printf("Join success:%+v", joinResp)
    } else {
        log.Printf("Join failed:%+v", joinResp)
        return
    }

    agentId := joinResp.SuccessResp.AgentId

    log.Printf("agentId:%s", agentId)

    defer func() {
        // Stop the conversational agent
        leaveResp, err := convoaiClient.Leave(ctx, agentId)
        if err != nil {
            log.Fatalln(err)
        }

        if leaveResp.IsSuccess() {
            log.Printf("Leave success:%+v", leaveResp)
        } else {
            log.Printf("Leave failed:%+v", leaveResp)
            return
        }
    }()

    // List conversational agents
    listResp, err := convoaiClient.List(ctx,
        req.WithState(2),
        req.WithLimit(10),
    )
    if err != nil {
        log.Fatalln(err)
    }

    if listResp.IsSuccess() {
        log.Printf("List success:%+v", listResp)
    } else {
        log.Printf("List failed:%+v", listResp)
        return
    }

    if listResp.SuccessRes.Data.Count > 0 {
        for _, agent := range listResp.SuccessRes.Data.List {
            log.Printf("Agent:%+v\n", agent)
        }
    } else {
        log.Printf("No agent found\n")
    }

    // Keep the agent running for 60 seconds
    time.Sleep(time.Second * 60)
}`}
    </CodeBlock>
    </details>


Follow these steps to integrate a conversational AI agent into your existing project:

1. **Import the required modules**

    In the `main.go` file, add the following code to import the required dependencies:

    <CodeBlock language="go" showLineNumbers>
    {`package main

    import (
        "context"
        "log"
        "time"

        "github.com/AgoraIO-Community/agora-rest-client-go/agora/auth"
        "github.com/AgoraIO-Community/agora-rest-client-go/agora/domain"
        agoraLogger "github.com/AgoraIO-Community/agora-rest-client-go/agora/log"
        agoraUtils "github.com/AgoraIO-Community/agora-rest-client-go/agora/utils"
        "github.com/AgoraIO-Community/agora-rest-client-go/services/convoai"
        "github.com/AgoraIO-Community/agora-rest-client-go/services/convoai/req"
    )`}
    </CodeBlock>

2. **Add the required variables**

    The required configuration parameters fall into three categories:

    1. **Agora parameters**

        - `appId`: Your Agora App ID.
        - `cname`: The RTC channel name that the conversational agent joins. Use the same name used when generating the temporary token.
        - `agentRtcUid`: The RTC user ID of the conversational agent. Defaults to an `int` (e.g., `123`). To use a string UID (e.g., `"123"`), set `EnableStringUid` to `true` in the code.
        - `username` and `password`: Your Agora Customer ID and Customer Secret.
        - `agentRtcToken`: The temporary token the agent uses to join the RTC channel.

    2. **LLM parameters**

        - `llmURL`: Callback URL for the LLM API.
        - `llmAPIKey`: API key for the LLM.
        - `llmModel`: Name of the large language model.

    3. **TTS parameters**

        The sample uses **Bytedance (Volcano) TTS**. You can use another provider as needed. For details on configuration, see the `JoinPropertiesTTSBody` structure.

            - `ttsBytedanceToken`: API token for Bytedance TTS.
            - `ttsBytedanceAppId`: App ID for Bytedance TTS.
            - `ttsBytedanceCluster`: Cluster region for Bytedance TTS.
            - `ttsBytedanceVoiceType`: Voice type to be used by Bytedance TTS.


    In the `main.go` file, add the following variables:

    <CodeBlock language="go" showLineNumbers>
    {`const (
        // Agora configuration
        appId                 = "<your appId>"
        cname                 = "<your cname>"
        agentRtcUid           = "<your agent rtc uid>"
        username              = "<the username of basic auth credential>"
        password              = "<the password of basic auth credential>"
        agentRtcToken         = "<your agent rtc token>"

        // LLM configuration
        llmURL                = "<your LLM URL>"
        llmAPIKey             = "<your LLM API Key>"
        llmModel              = "<your LLM model>"

        // TTS configuration (using Bytedance TTS as an example)
        ttsBytedanceToken     = "<your bytedance tts token>"
        ttsBytedanceAppId     = "<your bytedance tts app id>"
        ttsBytedanceCluster   = "<your bytedance tts cluster>"
        ttsBytedanceVoiceType = "<your bytedance tts voice type>"
    )`}
    </CodeBlock>

3. **Initialize the conversational AI engine**

    The `main` function sets the logging format, initializes the Agora configuration, and creates a new Conversational AI Engine using `NewClient`. To implement this logic, in `main.go`, add the following function:

    <CodeBlock language="go" showLineNumbers>
    {`func main() {
        log.SetFlags(log.LstdFlags | log.Lshortfile)

        // Set up the Conversational AI Engine REST client configuration.
        config := &convoai.Config{
            AppID:      appId,
            Credential: auth.NewBasicAuthCredential(username, password),
            
            // Set the server region. Options: CN, EU, AP, US.
            // The client selects the optimal domain based on the region.
            DomainArea: domain.CN,

            // Set the log output level.
            // To disable logging, set the level accordingly.
            Logger: agoraLogger.NewDefaultLogger(agoraLogger.DebugLevel),

            // Set the service region. Options:
            // - ChineseMainlandServiceRegion
            // - GlobalServiceRegion
            // These are separate services.
            ServiceRegion: convoai.ChineseMainlandServiceRegion,
        }

        // Create the REST client instance.
        convoaiClient, err := convoai.NewClient(config)
        if err != nil {
            log.Fatalln(err)
        }

        // Create a background context for subsequent API calls.
        ctx := context.Background()

        // ... Additional code follows.
    }`}
    </CodeBlock>

4. **Start the conversational agent**

    To create a conversational agent, use the `Join` method . Pass the configuration parameters for LLM and TTS using `JoinPropertiesCustomLLMBody` and `JoinPropertiesTTSBody`. In `main.go`, add the following code:

    <CodeBlock language="go" showLineNumbers>
    {`// ... Previous configuration code

    // Set the agent name. A common format is appId:channelName.
    name := appId + ":" + cname

    // Create the conversational agent.
    joinResp, err := convoaiClient.Join(ctx, name, &req.JoinPropertiesReqBody{
        Token:           agentRtcToken,
        Channel:         cname,
        AgentRtcUId:     agentRtcUid,
        RemoteRtcUIds:   []string{"*"},
        EnableStringUId: agoraUtils.Ptr(false),
        IdleTimeout:     agoraUtils.Ptr(120),

        // LLM configuration
        LLM: &req.JoinPropertiesCustomLLMBody{
            Url:    llmURL,
            APIKey: llmAPIKey,
            SystemMessages: []map[string]any{
                {
                    "role":    "system",
                    "content": "You are a helpful chatbot.",
                },
            },
            Params: map[string]any{
                "model":      llmModel,
                "max_tokens": 1024,
            },
            MaxHistory:      agoraUtils.Ptr(30),
            GreetingMessage: "Hello, how can I help you?",
        },

        // TTS configuration
        TTS: &req.JoinPropertiesTTSBody{
            Vendor: req.BytedanceTTSVendor,
            Params: &req.TTSBytedanceVendorParams{
                Token:       ttsBytedanceToken,
                AppId:       ttsBytedanceAppId,
                Cluster:     ttsBytedanceCluster,
                VoiceType:   ttsBytedanceVoiceType,
                SpeedRatio:  1.0,
                VolumeRatio: 1.0,
                PitchRatio:  1.0,
                Emotion:     "happy",
            },
        },
    })

    if err != nil {
        log.Fatalln(err)
    }

    if joinResp.IsSuccess() {
        log.Printf("Join succeeded: %+v", joinResp)
    } else {
        log.Printf("Join failed: %+v", joinResp)
        return
    }

    // Retrieve the agent ID for future operations.
    agentId := joinResp.SuccessResp.AgentId
    log.Printf("agentId: %s", agentId)`}
    </CodeBlock>

5. **List active agents**

    Use the `List` method to retrieve a list of currently running conversational agents. To implement this logic, in `main.go`, add the following:

    <CodeBlock language="go" showLineNumbers>
    {`// ... Previous code

    // List active conversational agents.
    listResp, err := convoaiClient.List(
        ctx,
        req.WithState(2),  // Filter by running state.
        req.WithLimit(10), // Limit the number of results.
    )
    if err != nil {
        log.Fatalln(err)
    }

    if listResp.IsSuccess() {
        log.Printf("List succeeded: %+v", listResp)
    } else {
        log.Printf("List failed: %+v", listResp)
        return
    }

    if listResp.SuccessRes.Data.Count > 0 {
        for _, agent := range listResp.SuccessRes.Data.List {
            log.Printf("Agent: %+v\n", agent)
        }
    } else {
        log.Printf("No agents found\n")
    }

    // Keep the agent running for 60 seconds.
    time.Sleep(60 * time.Second)`}
    </CodeBlock>

6. **Stop the agent**

    To ensure the conversational agent shuts down correctly when the program exits, use a deferred `Leave` call. In `main.go`, add the following function:

    <CodeBlock language="go" showLineNumbers>
    {`// ... Previous code

    // Defer cleanup to ensure the agent is stopped when the program ends.
    defer func() {
        // Stop the conversational agent.
        leaveResp, err := convoaiClient.Leave(ctx, agentId)
        if err != nil {
            log.Fatalln(err)
        }

        if leaveResp.IsSuccess() {
            log.Printf("Leave succeeded: %+v", leaveResp)
        } else {
            log.Printf("Leave failed: %+v", leaveResp)
            return
        }
    }()

    // ... Remaining code`}
    </CodeBlock>

