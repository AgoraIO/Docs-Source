import Prerequisites from '@docs/shared/extensions-marketplace/common/_prerequities.mdx';
import ProjectSetup from '@docs/shared/extensions-marketplace/faceunity/project-setup/index.mdx';
import ProjectImplementation from '@docs/shared/extensions-marketplace/faceunity/project-implementation/index.mdx';
import ProjectTest from '@docs/shared/extensions-marketplace/faceunity/project-test/index.mdx'
import Reference from '@docs/shared/extensions-marketplace/faceunity/reference/index.mdx';

The FaceUnity AR Filter extension uses 3D vision, 3D graphics, deep learning, and other technologies to provide the industry’s leading AR portrait video effects for <Vg k="VSDK"/>. It provides diverse special effects that cover full coverage of the human face.

* Basic beauty: skin beautification, whitening, rosy.
* Advanced beauty: Add video beauty effects for shape, face and skin.
* Number detection: Detects the number of faces, humans, or gestures.

This page shows you how to integrate and use the FaceUnity AR Filter extension in your <Vpl k="CLIENT" />.

<PlatformWrapper notAllowed="android">
<PlatformWrapper notAllowed="ios">
<PlatformWrapper notAllowed="flutter">
This extension is not provided for this platform.
</PlatformWrapper>
</PlatformWrapper>
</PlatformWrapper>

<PlatformWrapper notAllowed="web">
<PlatformWrapper notAllowed="macos">
<PlatformWrapper notAllowed="windows">
<PlatformWrapper notAllowed="react-native">

## Understand the tech

To quickly integrate FaceUnity's AR filter capabilities, call the  <Vg k="VSDK" />  method and pass the corresponding `key` and `value`.

Taking `setExtensionProperty` for example, the `key` is named after the FaceUnity API, and the `value` wraps certain or all the parameters of that API in JSON. When you call `setExtensionProperty` and pass in the pair of `key` and `value`, it is equivalent to calling the corresponding FaceUnity API. The case is the same for `setExtensionPropertyWithVendor`.

Currently, the extension encapsulates part of the APIs of the FaceUnity Nama SDK. For details, see the <a href="#faceunity-key-value-overview">key overview</a>.

## Prerequisites

The development environment requirements are as follows:

<Prerequisites />
- Implemented <Link to="../../../video-calling/get-started/get-started-sdk"><Vg k="GET_STARTED"/> for <Vg k="VIDEO"/></Link>.
- A physical device (not an emulator)

## Project Setup

<ProjectSetup />

### Activate the extension

You need to <Link to="{{Global.AGORA_CONSOLE_URL}}/marketplace/list/all">activate the extension</Link> in Agora Console. Save the certificate file you obtain from activation. The certificate is used in subsequent integration.

### Add the extension to your project

<ProjectSetup />

## Integrate the FaceUnity extension

This section describes the call sequence of using the extension. For a detailed parameter description, see the [API Reference](#api-reference).

<ProjectImplementation />

## Test your implementation

<ProjectTest />

## Reference

This section contains information that completes the information in this page, or points you to documentation that explains other aspects to this product.

### FaceUnity key-value overview<a name="key-value"></a>

This section lists the APIs related to using extensions with the Agora SDK.

The key corresponds to the name of the FaceUnity API, and the value corresponds to the parameters of the FaceUnity API. In this section, if the value is the same as the parameters of the FaceUnity API, the link leads to the FaceUnity documentation. If the value is different from the parameters of the FaceUnity API, the link leads to subsequent sections on this page.

#### Method keys

Method keys refer to the keys you pass in when calling the `setExtensionProperty`/`setExtensionPropertyWithVendor` method of the Agora SDK.

##### Initialization
| Method keys | Description |
| ------------------------------------ | -------- |
| [fuSetup](#fusetup) | Initialize the extension and authenticate the user. Must be executed before other keys. Otherwise, a crash can happen. |
| [fuLoadAIModelFromPackage](#fuloadaimodelfrompackage) | Preload AI capabilities. |
| [fuReleaseAIModel](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fureleaseaimodel-%e5%87%bd%e6%95%b0) | Free up resources occupied by AI capabilities. |

##### Prop package loading
| Method keys | Description |
| ------------------------------------ | -------- |
| [fuCreateItemFromPackage](#fucreateitemfrompackage) | Loads the prop package. |
| [fuLoadTongueModel](#fuloadtonguemodel) | Loads tongue detection data. |
| [fuItemSetParam](#fuitemsetparam) | Modifies or sets the value of a variable in the prop package. |

##### Destruction
| Method keys | Description |
| ------------------------------------ | -------- |
| [fuDestroyItem](#fudestroyitem) | Destroys a specified item. |
| [fuDestroyAllItems](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fudestroyallitems-%e5%87%bd%e6%95%b0) | Destroys all loaded items and releases all occupied resources. |
| [fuOnDeviceLost](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fuondevicelost-%e5%87%bd%e6%95%b0) | Resets the system's GL state. Use this key when the OpenGL context is released/destroyed by external resources. |
| [fuDestroyLibData](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fudestroylibdata-%e5%87%bd%e6%95%b0) | Frees up the memory allocated to the face tracking module after calling ` fuSetup`. |

##### System functions
| Method keys | Description |
| ------------------------------------ | -------- |
| [fuBindItems](#fubinditems) | Binds resource items to a target item. |
| [fuUnbindItems](#fuunbinditems) | Unbinds the resource items from a target item. |
| [fuIsTracking](#fuistracking) | Sets whether to get the number of faces being tracked. |
| [fuSetMaxFaces](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fusetmaxfaces-%e5%87%bd%e6%95%b0) | Sets the maximum number of tarcked faces. |
| [fuSetDefaultRotationMode](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fusetdefaultrotationmode-%e5%87%bd%e6%95%b0) | Sets the default human face orientation. |

##### Algorithm functions
| Method keys | Description |
| ------------------------------------ | -------- |
| [fuFaceProcessorSetMinFaceRatio](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fufaceprocessorsetminfaceratio-%e5%87%bd%e6%95%b0) | Sets the distance of face detection. |
| [fuSetTrackFaceAIType](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fusettrackfaceaitype-%e5%87%bd%e6%95%b0) | Sets the fuTrackFace algorithm type. |
| [fuSetFaceProcessorFov](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fusetfaceprocessorfov-%e5%87%bd%e6%95%b0) | Sets the fov (equivalent to focal length) of the FaceProcessor algorithm module. |
| [fuHumanProcessorReset](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fuhumanprocessorreset-%e5%87%bd%e6%95%b0) | Resets the state of the HumanProcessor algorithm module. |
| [fuHumanProcessorSetMaxHumans](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fuhumanprocessorsetmaxhumans-%e5%87%bd%e6%95%b0) | Sets the number of bodies tracked by the HumanProcessor algorithm module. |
| [fuHumanProcessorGetNumResults](#fuhumanprocessorgetnumresults) | Sets whether to get the number of bodies tracked by the HumanProcessor algorithm module. |
| [fuHumanProcessorSetFov](https://www.faceunity.com/DOCS/API/NamaC/#/?id=fuhumanprocessorsetfov-%e5%87%bd%e6%95%b0) | Sets the fov (equivalent to focal length) used by the HumanProcessor algorithm module to track 3D key points on human bodies. |
| [fuHandDetectorGetResultNumHands](#fuhanddetectorgetresultnumhands) | Sets whether to get the number of gestures tracked by the HandGesture algorithm module. Note that `ai_gesture.bundle` needs to be loaded. |

####  Method key description
##### fuSetup
The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `authdata` | The path to the certificate file. |

##### fuLoadAIModelFromPackage

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `data` | String. The path of the AI capability model file `ai_xxx.bundle`. Such model files are located in the `assets/AI_Model` directory of the resource package. |
| `type` | Int. The AI capability type corresponding to the bundle file. Possible values are listed in [enum FUAITYPE](https://github.com/Faceunity/FULivePC/blob/5061509684360285b2d0b2be76e3eedb93a041ba/ThirdParty/Windows/FaceUnity-SDK-PC/include/CNamaSDK.h#L41). |

##### fuCreateItemFromPackage

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `data` | String. The path to the prop package you want to load. A prop package usually has a suffix `*.bundle` . |

##### fuLoadTongueModel

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `data` | String. The path of tongue model data `tongue.bundle`. |

##### fuItemSetParam

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `obj_handle` | String. The path of the prop package passed in when calling [fuCreateItemFromPackage](#fucreateitemfrompackage). |
| name`` | String. The name of the variable to set in the prop package. |
| `value` | Object. The variable value to be set. |

For details on the variable names and values in the prop package, refer to the [FaceUnity documentation](https://github.com/Faceunity/FULiveDemoDroid/blob/master/doc/nama/%E7%BE%8E%E9%A2%9C%E9%81%93%E5%85%B7%E5%8A%9F%E8%83%BD%E6%96%87%E6%A1%A3.md).

##### fuDestroyItem

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `item` | String. The path of the prop package passed in when calling [fuCreateItemFromPackage](#fucreateitemfrompackage). |


##### fuBindItems

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `obj_handle` | String. The path of the target item. |
| `p_items` | String Array. The paths to the resource items you want to bind. |

##### fuUnbindItems

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `obj_handle` | String. The path of the target item. |
| `p_items` | String Array, the paths to the resource items you want to unbind. |

##### fuIsTracking

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `enable` | Bool. Whether to get the number of faces being tracked. If set to `true`, you can receive the [fuIsTracking](#fuIsTracking1) callback. |

##### fuHumanProcessorGetNumResults

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `enable` | Bool. Whether to get the number of human bodies tracked by the HumanProcessor algorithm module. If set to `true`, you can receive the [fuHumanProcessorGetNumResults](#fuHumanProcessorGetNumResults1) callback. |

##### fuHandDetectorGetResultNumHands

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `enable` | Bool. Whether to get the number of gestures tracked by the HandGesture algorithm module. If set to `true`, you can receive the [fuHandDetectorGetResultNumHands](#fuHandDetectorGetResultNumHands1) callback. |


#### Callback keys <a name="onevent"></a>

Callback keys refer to the keys returned in the `onEvent` callback of the Agora SDK.

| Callback keys | Description |
| ------------------------------------ | -------- |
| [fuIsTracking](#fuIsTracking1) | Returns the number of faces being tracked. |
| [fuHumanProcessorGetNumResults](#fuHumanProcessorGetNumResults1) | Returns the number of human bodies tracked by the HumanProcessor algorithm module. |
| [fuHandDetectorGetResultNumHands](#fuHandDetectorGetResultNumHands1) | Returns the number of gestures tracked by the HandGesture algorithm module. |
| [fuDestroyLibData](#fuDestroyLibData1)                       | Reports that the memory allocated to the face tracking module after calling ` fuSetup` is released. |

####  Callback key description

##### fuIsTracking<a name="fuIsTracking1"></a>

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `faces` | Int. The number of faces being tracked. |

##### fuHumanProcessorGetNumResults<a name="fuHumanProcessorGetNumResults1"></a>

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `people` | Int. The number of bodies being tracked. |

##### fuHandDetectorGetResultNumHands<a name="fuHandDetectorGetResultNumHands1"></a>

The value contains the following parameters:

| Value parameters | Description |
| ----------- | ---------------------- |
| `hands` | Int. The number of gestures being tracked. |

##### fuDestroyLibData <a name="fuDestroyLibData1"></a>

Its value contains no parameters.

### Resource package structure

For a full description of the FaceUnity resource package, refer to:
- [Android resource package](https://github.com/Faceunity/FULiveDemoDroid/blob/master/doc/Android_Nama_Demo_Guide.md)
- [iOS resource package](https://github.com/FaceUnity/FULiveDemo/blob/master/docs/iOS_Nama_Demo_Guide.md#2-file-structure)

<Reference />

### FAQ

1. **Why there is no beauty effect when I run the [sample project](#demo)？**

    Common reasons include:
    - The extension package is saved in a wrong directory or is not imported;
    - Model or prop files from the resource package are saved in wrong directories or are missing;
    - Authentication fails because the certificate file does not match with the package name (Android) or bundle identifier (iOS).

1. **Why does it take nearly 1 second to render the video after the camera is enabled?**

    Loading FaceUnity resources can cause openGL rendering to freeze and costs around 800ms. Agora recommends that you use a workaround in your app (for example, add a loading screen).

1. **Why does enableExtension/enableExtensionWithVendor return -3？**

    -3 is returned when the extensions package cannot be found. Ensure that you save the package according to [Integrate the extension](#integration).

1. **Why enableExtension/enableExtensionWithVendor returns 0, but then setExtensionProperty/setExtensionPropertyWithVendor returns -2 and there is no beauty effect？**

    This is because `enableExtension/enableExtensionWithVendor` is called improperly. Ensure that you follow the call sequence in [Enable the extension](#enable).


</PlatformWrapper>
</PlatformWrapper>
</PlatformWrapper>
</PlatformWrapper>