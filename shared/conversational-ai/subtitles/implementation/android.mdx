import CodeBlock from '@theme/CodeBlock';

1. **Integrate the toolkit**

    Copy the [`convoaiApi`](https://github.com/AgoraIO-Community/Conversational-AI-Demo/tree/main/Android/scenes/convoai/src/main/java/io/agora/scene/convoai/convoaiApi) folder to your project and import the toolkit before calling the toolkit API. Refer to [Folder structure](#folder-structure) to understand the role of each file.

1. **Create a subtitle processing toolkit instance**

    Create configuration objects for the RTC and RTM instances, set the transcription subtitle rendering mode, and create component instances.

    <CodeBlock language="kotlin" showLineNumbers>
    {`// Create configuration objects for the RTC and RTM instances
    val config = ConversationalAIAPIConfig(
        rtcEngine = rtcEngineInstance,
        rtmClient = rtmClientInstance,

        // Set the transcription subtitle rendering mode. Options:
        // - TranscriptionRenderMode.Word: Renders subtitles word by word.
        // - TranscriptionRenderMode.Text: Renders the full sentence at once.
        
        renderMode = TranscriptionRenderMode.Word,
        enableLog = true
    )
    // Create component instance
    val api = ConversationalAIAPIImpl(config)`}
    </CodeBlock>

1. **Receive subtitles**

    Call the `addHandler` method to register your implementation of the subtitle transcription callback.

    <CodeBlock language="kotlin" showLineNumbers>
    {`// Register the callback
    api.addHandler(object : IConversationalAIAPIEventHandler {
        // Listen for transcription updates to display subtitles in real time
        override fun onTranscriptionUpdated(agentUserId: String, transcription: Transcription) {
            when (transcription.type) {
                TranscriptionType.AGENT -> {
                    // Transcription from the AI agent
                    when (transcription.status) {
                        TranscriptionStatus.IN_PROGRESS -> {
                            // Transcription is in progress; update UI in real time
                            updateAgentTranscription(transcription.text, false)
                        }
                        TranscriptionStatus.END -> {
                            // Final transcription result; render final output
                            updateAgentTranscription(transcription.text, true)
                        }
                        TranscriptionStatus.INTERRUPTED -> {
                            // Transcription was interrupted
                            updateAgentTranscription(transcription.text, true)
                            Log.d("Transcription", "Agent transcription interrupted")
                        }
                    }
                }
                TranscriptionType.USER -> {
                    // Transcription from the user
                    when (transcription.status) {
                        TranscriptionStatus.IN_PROGRESS -> {
                            // User is speaking; update UI in real time
                            updateUserTranscription(transcription.text, false)
                        }
                        TranscriptionStatus.END -> {
                            // User finished speaking; render final result
                            updateUserTranscription(transcription.text, true)
                        }
                        TranscriptionStatus.INTERRUPTED -> {
                            // User's speech was interrupted
                            updateUserTranscription(transcription.text, true)
                            Log.d("Transcription", "User transcription interrupted")
                        }
                    }
                }
            }
        }
    })`}
    </CodeBlock>

1. **Implement subtitle UI rendering logic**

    Inherit your subtitle UI module from the `IConversationSubtitleCallback` interface. Implement the `onTranscriptionUpdated` method to handle the logic for rendering subtitles to the UI.

    <CodeBlock language="kotlin" showLineNumbers>
    {`class CovMessageListView @JvmOverloads constructor(
        context: Context,
        attrs: AttributeSet? = null,
        defStyleAttr: Int = 0
    ) : LinearLayout(context, attrs, defStyleAttr), IConversationSubtitleCallback {
        override fun onTranscriptionUpdated(subtitle: SubtitleMessage) {
            // Implement the UI rendering logic here
        }
    }`}
    </CodeBlock>


1. **Subscribe to the channel**

    Subtitles are delivered through <Vg k="SIG" /> channel messages. To receive subtitle data, call `subscribeMessage` before starting the agent session.
    
    <CodeBlock language="kotlin" showLineNumbers>
    {`api.subscribeMessage("channelName") { error ->
        if (error != null) {
            // Handle error
        }
    }`}
    </CodeBlock>


1. **Add a Conversational AI agent to the channel**

    To [start a <Vpd k="AGENT" />](/conversational-ai/rest-api/join), configure the following parameters in your `POST` request:

    | Parameter                               | Description                                  | Required |
    | --------------------------------------- | -------------------------------------------- | -------- |
    | `advanced_features.enable_rtm: true`    | Starts the <Vg k="SIG" /> service                       | Yes      |
    | `parameters.data_channel: "rtm"`        | Enables <Vg k="SIG" /> as the data transmission channel | Yes      |
    | `parameters.enable_metrics: true`       | Enables agent performance data collection    | Optional |
    | `parameters.enable_error_message: true` | Enables reporting of agent error events      | Optional |

    After a successful response, the agent joins the specified <Vg k="VSDK"/> channel and is ready to interact with the user.


1. **Unsubscribe from the channel**

    After an agent session ends, unsubscribe from channel messages to release subtitle-related resources:

    <CodeBlock language="kotlin" showLineNumbers>
    {`api.unsubscribeMessage("channelName") { error ->
        if (error != null) {
            // Handle the error
        }
    }`}
    </CodeBlock>

1. **Release resources**

    At the end of each call, use the `destroy` method to clean up the cache.

    <CodeBlock language="kotlin" showLineNumbers>
    {`api.destroy()`}
    </CodeBlock>

