<PlatformWrapper platform="web">

This section explains how to use the media stream encryption feature of the Web <Vpl k="CLIENT" />


Before joining a channel, call the `AgoraRTCClient.setEncryptionConfig` method to select the encryption mode.
<Vg k="COMPANY" /> supports the following encryption modes:

- `"aes-128-xts"`: 128-bit AES encryption, XTS mode.
- `"aes-256-xts"`: 256-bit AES encryption, XTS mode.
- `"aes-128-gcm"`: 128-bit AES encryption, GCM mode.
- `"aes-256-gcm"`: 256-bit AES encryption, GCM mode.
- `"aes-128-ecb"`: 128-bit AES encryption, ECB mode.
- `"sm4-128-ecb"`: 128-bit SM4 encryption, ECB mode.
- `"aes-128-gcm2"`: 128-bit AES encryption, GCM mode, salted. Available only for Web SDK v4.5.0 and later.
- `"aes-256-gcm2"`: 256-bit AES encryption, GCM mode, salted. Available only for Web SDK v4.5.0 and later.

If an encryption mode is choosen other than `"aes-128-gcm2"` and `"aes-256-gcm2"`,  only key is required to set. To strengthen security, <Vg k="COMPANY" /> recommends to set the encryption mode to `"aes-128-gcm2"` or `"aes-256-gcm2"` and set both the key and salt.

Follow these steps to generate and set the key and salt separately.

<Admonition type="info" title="note" style="background-color:pink">
- All users within the same channel must use the same encryption mode, key, and salt. Otherwise, undefined behaviors such as black screens or audio loss may occur.
</Admonition>

1. Generate and set the key on your server.

    1. Execute the following command on your server to randomly generate a String-type, 32-byte key via OpenSSL:
    ```shell
    # Randomly generate a String type, 32-byte key
    openssl rand -hex 32
    dba643c8ba6b6dc738df43d9fd624293b4b12d87a60f518253bd10ba98c48453
    ```
    2. The web client obtains the Hex-encoded key from the server.

    1. By calling `setEncryptionConfig`, the web client converts the key from Hex to ASCII, which is then passed to the <Vpd k="SDK"/>.

1. Generate and set the salt on your server.

    1. Execute the following command on your server to randomly generate a Base64 encoded, 32-byte salt using OpenSSL:
    ```shell
    # Randomly generate a Base64 encoded, 32-byte salt
    openssl rand -base64 32
    X5w9T+50kzxVOnkJKiY/lUk82/bES2kATOt3vBuGEDw=
    ```
    2. The Web client obtains the Hex encoded key from the server.

    1.  By calling `setEncryptionConfig`, the web client converts the salt from Base64 to Uint8Array, which is then passed in to the <Vpd k="SDK"/>.

1. Sample Code

    - The following sample code refers to the local client object created by `AgoraRTC.createClient`

    ```javascript
    // Declare a utility function to convert Base64 to Uint8Array
    function base64ToUint8Array(base64Str: string): Uint8Array {
    const raw = window.atob(base64Str);
    const result = new Uint8Array(new ArrayBuffer(raw.length));

    for (let i = 0; i < raw.length; i += 1) {
        result[i] = raw.charCodeAt(i);
    }

    return result;
    }

    // Declare a utility function to convert Hex to ASCII
    function hex2ascii(hexx) {
        const hex = hexx.toString();//force conversion
        let str = '';
        for (let i = 0; i < hex.length; i += 2)
            str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
        return str;
    }

    async function getSecretAndSalt() {
    // Suppose getSecretAndSaltFromServer returns the key and salt value from the server ["dba643c8ba6b6dc738df43d9fd624293b4b12d87a60f518253bd10ba98c48453", "X5w9T+50kzxVOnkJKiY/lUk82/bES2kATOt3vBuGEDw="]
    let [secret, salt] = await getSecretAndSaltFromServer();
    salt = base64ToUint8Array(salt);
    secret = hex2ascii(secret);
    return [secret, salt];
    }

    let [secret, salt] = await getSecretAndSalt();

    // Set the encryption scheme to AES-256-GCM2 and pass in secret and salt
    client.setEncryptionConfig("aes-256-gcm2", secret, salt);
    ```

1. Development Considerations
    - Please ensure encryption is set before calling `AgoraRTCClient.join` to join the channel.
    - The media stream encryption feature is supported in both communication and live broadcasting scenarios. However, in the live broadcasting scenario, <Vg k="COMPANY" /> does not support pushing the encrypted media stream to CDN.
    - To use the media stream encryption feature, please ensure that the same encryption mode is used on both the receiver and sender sides. otherwise undefined behaviors such as silent audio or black video screen may occur.


</PlatformWrapper>
