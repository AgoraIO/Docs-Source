<PlatformWrapper platform="windows">

### Implement the user interface

This section guides you through the necessary UI changes in the _Get Started_ project interface to implement call quality features. 

1. **Add a network status indicator to the user interface**

    To enable <Vpl k="CLIENT" /> users to see the network status, add `Static Text` to the user interface. To do this, take the following steps`:

        1. Go to menu **View** > **Other Windows** > **Resource View**.
        
            If the **Resource View** window isn't the top-most window, select the **Resource View** tab to bring it to the top.

        1. In **Resource View**, go to **AgoraImplementation.rc** > **Dialog** and double-click `IDD_AGORAIMPLEMENTATION_DIALOG`.

            The resource opens inside the **Dialog Editor**. 
    
        1. Click **View** > **ToolBox**. The **Toolbox** opens.

        1. From **ToolBox**, drag **Static Text** to the surface of the **Dialog Editor**.

1. **Add a button to start and stop the echo test**

    1. From **ToolBox**, drag **Button** to the surface of the **Dialog Editor**

    1. In **Properties**, update the **Caption** field to `Echo Test`.

1. **Add an Edit Control to display statistics**

    To display call and quality statistics, you use **Edit Control**. From **ToolBox**, drag **Edit Control** to the surface of the **Dialog Editor**.

1. **Add a button to switch the remote video quality**

    1. From **ToolBox**, drag **Button** to the surface of the **Dialog Editor**

    1. In **Properties**, update the **Caption** field to `Video Quality`.

1. **Adjust the position of UI elements as needed**

### Handle the system logic

1.  **Declare the variables you need**

    To store source and destination channel settings and manage channel relay, in `AgoraImplementationDlg.cpp`, add the following declarations after the list of headers:

    ``` cpp
    BOOL highQuality = true; // Quality of the remote video stream being played
    BOOL isEchoTestRunning = false; // Keeps track of the echo test
    CButton echoTestButton;
    CStatic* networkStatus;
    CEdit* textBox;
    int EID_USER_NETWOEK_QUALITY = 2;
    int EID_LAST_MILE_RESULT = 3;
    ```

1.  **Access the echo test button**

    To access the echo test button, in `AgoraImplementationDlg.cpp`, add the following to `OnInitDialog` before `return true;`:  

    ``` cpp
    echoTestButton = (CButton*)GetDlgItem(IDC_BUTTON3);
    ```


1. **Update the network status indication**

    To show the network quality result visually to the user, add the following to the `MainActivity` class:

    ```cpp
    private void updateNetworkStatus(int quality){  
        if (quality > 0 && quality < 3) networkStatus.setBackgroundColor(Color.GREEN);
        else if (quality <= 4) networkStatus.setBackgroundColor(Color.YELLOW);
        else if (quality <= 6) networkStatus.setBackgroundColor(Color.RED);
        else networkStatus.setBackgroundColor(Color.WHITE);
    }
    ```

### Implement features to ensure quality

To implement the call quality features, take the following steps:

1. **Enable the user to test the network**

    When the <Vpl k = "CLIENT"/> launches, you call `startLastmileProbeTest` with a `LastmileProbeConfig` object to check the last-mile uplink and downlink quality. To implement this workflow, take the following steps:

    1.  In `AgoraImplementationDlg.h`, add the following after `virtual BOOL OnInitDialog();`:

        ```cpp
        afx_msg void startProbeTest();
        ```


    1.  Add the following to `AgoraImplementationDlg.cpp`:

        ```cpp
        void CLiveBroadcastingDlg::startProbeTest()
        {
            // Configure a LastmileProbeConfig instance.
            LastmileProbeConfig config;
            // Probe the uplink network quality.
            config.probeUplink = true;
            // Probe the downlink network quality.
            config.probeDownlink = true;
            // The expected uplink bitrate (bps). The value range is [100000,5000000].
            config.expectedUplinkBitrate = 100000;
            // The expected downlink bitrate (bps). The value range is [100000,5000000].
            config.expectedDownlinkBitrate = 100000;
            int res = agoraEngine->startLastmileProbeTest(config);
        }
        ```

1. **Implement best practice for app initiation**

    When a user starts your <Vpl k="CLIENT" />, the <Vg k="ENGINE" /> is initialized in `InitAgora`. After initialization, do the following:

    * _Enable dual stream mode_: Required for multi-user scenarios.
    * _Set an audio profile and audio scenario_: Setting an audio profile is optional and only required if you have special requirements such as streaming  music.
    * _Set the video profile_: Setting a video profile is also optional. It is useful when you want to change one or more of `mirrorMode`, `frameRate`, `bitrate`, `dimensions`, `orientationMode` or `degradationPrefer` from default setting to custom values.
    * _Start the network probe test_: A quick test at startup to gauge network quality.

    To implement these features, add the following code to `InitAgora` after `agoraEngine->initialize(context)`;

    ```cpp
    // Enable the dual stream mode
    agoraEngine->enableDualStreamMode(true);
    // Set audio profile and audio scenario.
    agoraEngine->setAudioProfile(AUDIO_PROFILE_DEFAULT, AUDIO_SCENARIO_GAME_STREAMING);
    // Set the video profile
    VideoEncoderConfiguration videoConfig;
    // Set mirror mode
    videoConfig.mirrorMode = VIDEO_MIRROR_MODE_AUTO;
    // Set framerate
    videoConfig.frameRate = FRAME_RATE_FPS_10;
    // Set bitrate
    videoConfig.bitrate = STANDARD_BITRATE;
    // Set dimensions
    videoConfig.dimensions = VideoDimensions(360,360);
    // Set orientation mode
    videoConfig.orientationMode = ORIENTATION_MODE_ADAPTIVE;
    // Set degradation preference
    videoConfig.degradationPreference = MAINTAIN_BALANCED;
    // Set compression preference: low latency or quality.
    videoConfig.compressionPreference = PREFER_LOW_LATENCY;    // Apply the configuration
    agoraEngine->setVideoEncoderConfiguration(videoConfig);
    // Start the probe test
    startProbeTest();
    ```

3. **Test the user's hardware**

    The echo test checks that the user's hardware is working properly. To implement the echo test logic, in **Dialog Editor**, double-click **Echo Test**. **Dialog Editor** automatically creates and opens an event listener for you. To start and stop the echo test on the button click event, add the following code to the event listener you just created:

    ```cpp
    if (!isEchoTestRunning) {
        EchoTestConfiguration echoConfig;
        echoConfig.enableAudio = true;
        echoConfig.enableVideo = true;
        echoConfig.token = Token;
        echoConfig.channelId = ChannelName;

        RenderLocalVideo();
        echoConfig.view = localView;
        agoraEngine->startEchoTest(echoConfig);
        isEchoTestRunning = true;
    }
    else {
        agoraEngine->stopEchoTest();
        isEchoTestRunning = false;
        StopLocalVideo();
    }
    ```

4. **Listen to <Vg k="ENGINE" /> events to receive state change notifications and quality statistics**

    Add the following event handlers to receive state change notifications and quality statistics:

    * `onLastmileQuality`: Receives the network quality result.
    * `onLastmileProbeResult`: Receives detailed probe test results.
    * `onNetworkQuality`: Receives statistics on network quality.
    * `onRtcStats`: Receives the <Vg k="ENGINE" /> stats.
    * `onRemoteVideoStateChanged`: Receives notification regarding any change in the state of the remote video.
    * `onRemoteVideoStats`: Receives stats about the remote videos.

    To implement these callbacks, take the following steps:

    1. In `AgoraImplementationDlg.h`, add the following callbacks to `AgoraEventHandler` after `onLeaveChannel`:

        ```cpp
           virtual void onLastmileQuality(int quality) override;
           virtual void onLastmileProbeResult(const LastmileProbeResult& result) override;
           afx_msg LRESULT OnEIDLastMileProbleResult(WPARAM wParam, LPARAM lParam);
           virtual void onNetworkQuality(uid_t uid, int txQuality, int rxQuality) override;
           virtual void onRtcStats(const RtcStats& stats) override;
           virtual void onRemoteVideoStateChanged(uid_t uid, REMOTE_VIDEO_STATE state, REMOTE_VIDEO_STATE_REASON reason, int elapsed);
           virtual void onRemoteVideoStats(const RemoteVideoStats& stats);
        ```
    1. Add the following to `CAgoraImplementationDlg.cpp`:

        ```cpp
        LRESULT CAgoraImplementationDlg::OnEIDLastMileProbleResult(WPARAM wParam, LPARAM lParam)
        {
            agoraEngine->stopLastmileProbeTest();
            return true;
        }
        void AgoraEventHandler::onLastmileQuality(int quality)
        {
            if ((quality > 0) && (quality < 3))
            {
                networkStatus->SetWindowText(_T("Network Quality: Excellent"));
            }
            else if (quality <= 4)
            {
                networkStatus->SetWindowText(_T("Network Quality: Good"));
            }
            else if (quality <= 6)
            {
                networkStatus->SetWindowText(_T("Network Quality: Poor"));
            }
        }
        void AgoraEventHandler::onLastmileProbeResult(LastmileProbeResult& result)
        {
            if (m_hMsgHanlder) {
                ::PostMessage(m_hMsgHanlder, WM_MSGID(EID_LAST_MILE_RESULT), (WPARAM)NULL, (LPARAM)NULL);
            }
            // The result object contains the detailed test results that help you
            // manage call quality, for example, the downlink jitter.
            AfxMessageBox(L"Downlink jitter: " + result.downlinkReport.jitter);
        }
        void AgoraEventHandler::onNetworkQuality(uid_t uid, int txQuality, int rxQuality)
        {
            if ((rxQuality > 0) && (rxQuality < 3))
            {
                networkStatus->SetWindowText(_T("Network Quality: Excellent"));
            }
            else if (rxQuality <= 4)
            {
                networkStatus->SetWindowText(_T("Network Quality: Good"));
            }
            else if (rxQuality <= 6)
            {
                networkStatus->SetWindowText(_T("Network Quality: Poor"));
            }
        }
        void AgoraEventHandler::onRtcStats(const RtcStats& stats)
        {
            CString s = L"";
            char a[50];
            sprintf(a, "User(s): %d ", stats.userCount);
            s += a;
            sprintf(a, "Packet loss rate: % d ", stats.rxPacketLossRate);
            s += a;
            textBox->SetWindowText(s);
        }
        void AgoraEventHandler::onRemoteVideoStateChanged(uid_t uid, REMOTE_VIDEO_STATE state, REMOTE_VIDEO_STATE_REASON reason, int elapsed)
        {
            CString s = L"";
            char a[50];
            sprintf(a, "Remote video state changed: \n Uid %d ", uid);
            s += a;
            sprintf(a, "NewState: % d ", state);
            s += a;
            sprintf(a, "reason: % d ", reason);
            s += a;
            textBox->SetWindowText(s);
        }
        void AgoraEventHandler::onRemoteVideoStats(const RemoteVideoStats& stats)
        {
            CString s = L"";
            char a[50];
            sprintf(a, "Remote Video Stats: \n User id = ", stats.uid);
            s += a;
            sprintf(a, "\n Received bitrate: % d ", stats.receivedBitrate);
            s += a;
            sprintf(a, "\n Total frozen time  ", stats.totalFrozenTime);
            s += a;
            textBox->SetWindowText(s);
        }
        ```
    Each event reports the statistics of the audio video streams from each remote user and host. 


5. **Switch stream quality when the user taps the remote video**

    To take advantage of dual-stream mode and switch remote video quality to high or low, in **Dialog Editor**, double-click **Video Quality**. **Dialog Editor** automatically creates and opens an event listener for you. To switch the video quality on the button click event, add the following code to the event listener you just created:

    ```cpp
    highQuality = !highQuality;
    if (highQuality) 
    {
        agoraEngine.setRemoteVideoStreamType(remoteUId, VIDEO_STREAM_HIGH);
        AfxMessageBox("Switching to high-quality video");
    } 
    else 
    {
        agoraEngine.setRemoteVideoStreamType(remoteUId, VIDEO_STREAM_LOW);
        AfxMessageBox("Switching to low-quality video");
    }
    ```
6. **Configure the <Vpd k="SDK" /> log file**

    To customize the location, content and size of log files, in `AgoraImplementationDlg.cpp`, add the following code to `InitAgora` before `context.eventHandler = &agoraEventHandler`:

    ```cpp
    context.logConfig.filePath = R"(C:\\Users\\<user_name>\\AppData\\Local\Agora\<process_name>\agorasdk.log)";
    context.logConfig.fileSizeInKB = 256;
    context.logConfig.level = agora::commons::LOG_LEVEL::LOG_LEVEL_WARN;
    ```

    Make sure you replace the `<process_name>` in `filePath` with the name of your package.

    If you want to upload the log file automatically to a CDN, call `setLocalAccessPoint(LocalAccessPointConfiguration& config)` to specify the local access point and assign the native access module to the SDK.

<ProductWrapper product="interactive-live-streaming">
7. **Set the latency level**

    In `CAgoraImplementationDlg.cpp`, add the following code to the `OnBnClickedButton1` method, after `agoraEngine->startPreview();`, to specify the audience latency level. For special use cases that require ultra-low latency choose `AUDIENCE_LATENCY_LEVEL_ULTRA_LOW_LATENCY`. Ultra-low latency is a feature of <Vg k="ILSP" /> and its use is subject to special [pricing](../reference/pricing#unit-pricing).

    ```cpp
    // Set the latency level
    options.audienceLatencyLevel= AUDIENCE_LATENCY_LEVEL_LOW_LATENCY;
    // for ultra low-latency use AUDIENCE_LATENCY_LEVEL_ULTRA_LOW_LATENCY;
    ```
</ProductWrapper>

</PlatformWrapper>
