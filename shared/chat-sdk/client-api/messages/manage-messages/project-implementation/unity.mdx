<PlatformWrapper platform="unity">

This section shows how to implement managing messages.

### Retrieve conversations

Call `LoadAllConversations` to retrieve all the conversations on the local device:

```csharp
List<Conversation>list = SDKClient.Instance.ChatManager.LoadAllConversations();
```

### Retrieve messages in the specified conversation

Refer to the following code sample to retrieve the messages in the specified conversation:

```csharp
// Get the specified conversation on the local device.
Conversation conv = SDKClient.Instance.ChatManager.GetConversation(conversationId, convType);
// Call LoadMessages to retrieve messages by specifying the `startMsgId` and `pageSize`.
conv.LoadMessages(startMsgId, pagesize, callback:new ValueCallBack<List<Message>>(
  onSuccess: (list) => {
     Debug.Log($"{list.Count} Messages retrieved.");
  },
  onError:(code, desc) => {
     Debug.Log($"Fails to retrieve the message, errCode={code}, errDesc={desc}");
  }
));
```

### Retrieve the count of unread messages in the specified conversation

Refer to the following code example to retrieve the count of unread messages:

```csharp
Conversation conv = SDKClient.Instance.ChatManager.GetConversation(conversationId, convType);
int unread = conv.UnReadCount;
```

### Retrieve the count of unread messages in all conversations

Refer to the following code example to retrieve the count of all unread messages:

```csharp
SDKClient.Instance.ChatManager.GetUnreadMessageCount();
```

### Pin a conversation

To keep track of an important conversation, you can pin it to the top of your conversation list. You can pin up to 50 conversations.  The pinned state is stored on the server. In a multi-device login scenario, if you pin or unpin a conversation, other login devices will receive the `CONVERSATION_PINNED` or `CONVERSATION_UNPINNED` events.

Refer to the following code example to pin a conversation:

```csharp
SDKClient.Instance.ChatManager.PinConversation(convId, isPinned, new CallBack(
    onSuccess: () =>
    {

    },
    onError: (code, desc) =>
    {

    }
));
```


### Retrieve the pinned conversations from the server with pagination

End users can pin up to 50 conversations. This API sorts all the conversations based on the following order:

1. Pinned conversations with recently received messages. The more recent the messages are, the higher the conversation is sorted/ranked so that it appears on the top of the UI.
1. Pinned conversation without any messages, that is, empty conversations.
1. Unpinned conversations.

The Agora Chat servers store the pinned/unpinned status of active conversations for 7 days, regardless of the package subscription.

The Limit parameter specifies the number of conversations each API call can return, from a range of 1-50. Refer to the following code example to get a list of pinned conversations from the server with pagination:

```csharp
int limit = 10;
string cursor = "";
bool pinOnly = true; // `false`: Get the list of all conversations; `true`: Get the list of only pinned conversations.
SDKClient.Instance.ChatManager.GetConversationsFromServerWithCursor(pinOnly, cursor, limit, new ValueCallBack<CursorResult<Conversation>>(
   onSuccess: (result) =>
   {
       // Traverse the obtained conversation list
       foreach (var conv in result.Data)
       {

       }
       // The cursor for the next query
       string nextCursor = result.Cursor;
   },
   onError: (code, desc) =>
   {

   }
));
```

### Mark unread messages as read

Refer to the following code example to mark the specified messages as read:

```csharp
Conversation conv = SDKClient.Instance.ChatManager.GetConversation(conversationId, convType);
// Mark all the messages in the current conversation as read.
conv.MarkAllMessageAsRead();
// Mark the specified message as read.
conv.MarkMessageAsRead(msgId);
// Mark all unread messages as read.
SDKClient.Instance.ChatManager.MarkAllConversationsAsRead();
```

### Delete conversations and historical messages

You can delete conversations on both the local device and the server.

To delete them on the local device, call `DeleteConversation` and `DeleteMessage`:

```csharp
// Call DeleteConversation to delete the specified conversation. 
// `true` indicates to keep the historical messages while deleting the conversation. To remove the historical messages as well, set it as `false`.
SDKClient.Instance.ChatManager.DeleteConversation(conversationId, true);
// Delete the specified message in the current conversation.
Conversation conv = SDKClient.Instance.ChatManager.GetConversation(conversationId, convType);
conv.DeleteMessage(msgId);
```

To delete conversations on the server, call `DeleteConversationFromServer`:

```csharp
// Delete a conversation on the server. If you want to keep the historical messages, pass “false” to the third parameter.
SDKClient.Instance.ChatManager.DeleteConversationFromServer(conversationId, type, true, new CallBack(
    onSuccess: () => {
    },
    onError: (code, desc) => {
    }
));
```

### Search for messages using keywords

Call `SearchMsgFromDB` to search for messages by keywords, timestamp, and message sender:

```csharp
List<Message> list = SDKClient.Instance.ChatManager.SearchMsgFromDB(keywords, timeStamp, maxCount, from, MessageSearchDirection.UP);
```

### Import messages

Call `ImportMessages` to import multiple messages to the specified conversation. This applies to scenarios where chat users want to formard messages from another conversation.

```csharp
SDKClient.Instance.ChatManager.ImportMessages(messages, new CallBack(
  onSuccess: () => {
  },
  onError: (code, desc) =>
  {
  }
));
```

### Insert messages

If you want to insert a message to the current conversation without actually sending the message, construct the message body and call `InsertMessage`. This can be used to send notification messages such as "XXX recalls a message", "XXX joins the chat group", and "Typing ...".

```csharp
// Insert the message to the current conversation.
Conversation conv = SDKClient.Instance.ChatManager.GetConversation(conversationId, convType);
conv.InsertMessage(message);
```

</PlatformWrapper>