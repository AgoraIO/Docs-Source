<PlatformWrapper platform="flutter">

### Handle the system logic

Import the necessary <Vpl k="NAME" /> libraries and set up the <Vpl k="CLIENT" /> framework.

1. **Import the required <Vg k="COMPANY" /> and <Vpl k="NAME" /> classes**

    In `/lib/main.dart`, replace the contents of the file with the following:

    ```dart
    import 'dart:async';

    import 'package:agora_rtc_ng/agora_rtc_ng.dart';
    import 'package:flutter/material.dart';
    import 'package:permission_handler/permission_handler.dart';
    ```

1. **Set up the <Vpl k="CLIENT" /> framework**

    To set up the <Vpl k="NAME" /> <Vpl k="CLIENT" /> framework, you do the following:
    
    * Create a stateful widget
    * Declare the connection variables including the `appId`, `channelName`, and `token`.
    * Define a method to display useful messages to the user
        
    To create this framework, paste the following code in `/lib/main.dart` after the import statements:

    ```dart
    const appId = "<Insert app ID here>";

    void main() => runApp(const MaterialApp(home: MyApp()));

    class MyApp extends StatefulWidget {
    const MyApp({Key? key}) : super(key: key);

    @override
    _MyAppState createState() => _MyAppState();
    }

    class _MyAppState extends State<MyApp> {
        String channel = "<Insert channel name here>";
        String token = "<Insert authentication token here>";
        
        int uid = 0;

        int? _remoteUid;
        bool _isJoined = false;
        late RtcEngine agoraEngine;

        final GlobalKey<ScaffoldMessengerState> scaffoldMessengerKey
        = GlobalKey<ScaffoldMessengerState>(); // Global key to access the scaffold

        showMessage(String message) {
            scaffoldMessengerKey.currentState?.showSnackBar(SnackBar(
            content: Text(message),
            ));
        }
    }
    ```

### Implement the user interface

To implement the user interface, you create the following UI elements:

* An `AgoraVideoView` widget to display the local video preview.
* An `AgoraVideoView` widget to render the remote video.
* A button widget to **Join** a channel.
* A button widget to **Leave** the channel.

To implement this user interface, copy the following code into `/lib/main.dart`, after the `import` statements.

<ProductWrapper product="video-calling">
    ``` dart
    // Build UI
    @override
    Widget build(BuildContext context) {
        return MaterialApp(
        scaffoldMessengerKey: scaffoldMessengerKey,
        home: Scaffold(
            appBar: AppBar(
                title: const Text('Get started with Video Calling'),
            ),
            body: ListView(
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                children: [
                // Container for the local video
                Container(
                    height: 240,
                    decoration: BoxDecoration(border: Border.all()),
                    child: _localPreview(),
                ),
                const SizedBox(height: 10),
                //Container for the Remote video
                Container(
                    height: 240,
                    decoration: BoxDecoration(border: Border.all()),
                    child: _remoteVideo(),
                ),
                // Button Row
                Row(
                    children: <Widget>[
                    Expanded(
                        child: ElevatedButton(
                        child: const Text("Join"),
                        onPressed: () => {join()},
                        ),
                    ),
                    const SizedBox(width: 10),
                    Expanded(
                        child: ElevatedButton(
                        child: const Text("Leave"),
                        onPressed: () => {leave()},
                        ),
                    ),
                    ],
                ),
                // Button Row ends
                ],
            )),
        );
    }

    // Display local preview
    Widget _localPreview() {
        if (_isJoined) {
        return AgoraVideoView(
            controller: VideoViewController(
            rtcEngine: agoraEngine,
            canvas: VideoCanvas(uid: uid),
            ),
        );
        } else {
        return const Text(
            'Join a channel',
            textAlign: TextAlign.center,
        );
        }
    }

    // Display remote user's video
    Widget _remoteVideo() {
        if (_remoteUid != null) {
        return AgoraVideoView(
            controller: VideoViewController.remote(
            rtcEngine: agoraEngine,
            canvas: VideoCanvas(uid: _remoteUid),
            connection: RtcConnection(channelId: channelName),
            ),
        );
        } else {
        return const Text(
            'Waiting for a remote user to join',
            textAlign: TextAlign.center,
        );
        }
    }
    ```
</ProductWrapper>

<ProductWrapper product="interactive-live-streaming">
``` dart
insert ILS Build UI code here
```
</ProductWrapper>

You see errors in your IDE. This is because this layout refers to methods that you create later.

### Implement the <Vpd k="PRODUCT" /> logic

The following figure shows the API call sequence of implementing  <Vpd k="PRODUCT" />.

<ProductWrapper product="video-calling">
![image](/images/video-sdk/video-call-logic-flutter.svg)
</ProductWrapper>
<ProductWrapper product="interactive-live-streaming">
![image](/images/video-sdk/ils-call-logic-flutter.svg)
</ProductWrapper>

To implement this logic, take the following steps:

1. **Call a method to initialize <Vg k="ENGINE" /> when the <Vpl k="CLIENT" /> is launched**

    In the `_MyAppState` class, add the following code before `showMessage(String message) {`:

    ``` dart
    @override
    void initState() async {
        super.initState();
        // Set up an instance of Agora engine
        setupVideoSDKEngine();
    }
    ```

1.  **Check user permissions and instantiate <Vg k="ENGINE" />**

    To set up <Vg k="ENGINE" />, you do the following: 
    
    * Check camera and microphone permissions
    * Create an `RtcEngine` instance with a call to `createAgoraRtcEngine()`
    * Initialize <Vg k="ENGINE" /> with the `appID`
    * Enable the video module
    * Register an event handler to receive <Vg k="ENGINE" /> callbacks

    In `_MyAppState` class, add the following code after the `initState()` method:

    ``` java
    Future<void> setupVideoSDKEngine() async {
        // retrieve or request camera and microphone permissions
        await [Permission.microphone, Permission.camera].request();

        //create an instance of the Agora engine
        agoraEngine = createAgoraRtcEngine();
        await agoraEngine.initialize(const RtcEngineContext(
        appId: appId
        ));

        await agoraEngine.enableVideo();
        
        // Register the event handler
        agoraEngine.registerEventHandler(
        RtcEngineEventHandler(
            onJoinChannelSuccess: (RtcConnection connection, int elapsed) {
            showMessage("local user ${connection.localUid} joined");
            setState(() {
                _isJoined = true;
            });
            },
            onUserJoined: (RtcConnection connection, int remoteUid, int elapsed) {
            showMessage("remote user $remoteUid joined");
            setState(() {
                _remoteUid = remoteUid;
            });
            },
            onUserOffline: (RtcConnection connection, int remoteUid,
                UserOfflineReasonType reason) {
            showMessage("remote user $remoteUid left channel");
            setState(() {
                _remoteUid = null;
            });
            },
        ),
        );
    }
    ```

7.  **Join a channel to start  <Vpd k="PRODUCT" />**

    When a local user clicks the **Join** button, you call `join()`. This method securely connects the local user to a channel using the authentication token. It sets the client role and channel profile, and starts the local preview. In the `_MyAppState` class, add the following code after the `initState()` method:
    <ProductWrapper product="video-calling">
    ``` dart
    void  join() async {
        // Set the client role
        await agoraEngine.setClientRole(role: ClientRoleType.clientRoleBroadcaster);
        
        // Set the channel profile
        await agoraEngine.setChannelProfile(ChannelProfileType.channelProfileCommunication);

        await agoraEngine.startPreview();

        await agoraEngine.joinChannel(
        token: token,
        channelId: channelName,
        info: '',
        uid: uid,
        );
    }
    ```
    </ProductWrapper>

    <ProductWrapper product="interactive-live-streaming">
    ``` dart
    ils code
    ```
    </ProductWrapper>

1.  **Leave the channel when a user ends the call**

    When a user clicks **Leave**, use `leave()` to exit the channel. In the `_MyAppState` class, add the following `leave()` method after `join()`:
    <ProductWrapper product="video-calling">

    ``` dart
    void leave() {
        setState(() {
        _isJoined = false;
        _remoteUid = null;
        });
        agoraEngine.leaveChannel();
    }
    ```
    </ProductWrapper>

    <ProductWrapper product="interactive-live-streaming">
    ``` dart
    ils code
    ```
    </ProductWrapper>

1.  **Clean up the resources used by your <Vpl k="CLIENT" />**

    When the user closes the <vpl k="CLIENT" />, use the `dispose` callback to clean up the resources you created. In the `_MyAppState` class, add `dispose()` after `initState()`:

    ``` java
    // Clean up the resources when you leave
    @override
    void dispose() async {
    await agoraEngine.leaveChannel();
    super.dispose();
    }
    ```

</PlatformWrapper>