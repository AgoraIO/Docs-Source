<PlatformWrapper platform="unreal">
### Implement the user interface

For a basic <Vpl k="NAME" /> <Vpl k="CLIENT" />, you need:

* One view for local video

* One view for remote video

* Buttons so the user can join or leave a channel

<ProductWrapper product="interactive-live-streaming">
* One selector to choose to join as the host or the audience
</ProductWrapper>

To implement this user interface, take the following steps:

1. **Add a user widget class**

    In Unreal Editor, go to **Tools** > **New C++ Class**. The **Add C++ Class** window opens. Click **All Classes** and input `UserWidget` in the **Search** field. From the search results, select `UserWidget` and click **Next**. A new C++ class is added to your project and the class source code opens in Visual Studio IDE.

2. **Create a blueprint for the user widget class**

    In **Content Browser**, go to **Add** > **Blueprint Class**. The **Pick Parent Class** window opens. Input `MyUserWidget` in the search field. From the search results, click `MyUserWidget` and press **Select**. You see a new blueprint in the content folder called `NewBlueprint`.

3. **Add the join and leave buttons**

    In **Content Browser**, navigate to the content folder and double-click `NewBlueprint`. The blueprint opens in the editor. To add buttons in your <Vpl k = "CLIENT"/>:

    1. Add a canvas to add new widgets. Drag **Canvas Panel** from the **Panel** section of the **Palette Panel** to the **Graph**.

    1. Drag **Button** from the **Common** section of the **Palette Panel** to the canvas panel. You see a button appears on the canvas panel.
    
    1. In **Details**, rename **Button_0** to `JoinBtn`, then change the following coordinates:

        * **Position X** - 1000
        * **Position Y** - 960
        * **Size X** - 130
        * **Size Y** - 60

    1. Use the same procedure to create a button called `LeaveBtn` and change the following properties in **Details**.

        * **Position X** - 1150
        * **Position Y** - 960
        * **Size X** - 130
        * **Size Y** - 60

    1. To add a label, drag **Text** from the **Common** section of the **Palette Panel** to the canvas panel, then change the following properties in **Details**.

        * **Position X** - 1030
        * **Position Y** - 972
        * **Size X** - 96
        * **Size Y** - 40

    4. To change the label text, in **Details**, input `Join` in the **Text** field.

    5. Use the same procedure and add one more label, then change the following coordinates in **Details**.

        * **Position X** - 1168
        * **Position Y** - 972

    6. To change the text of the second label, in **Details**, input `Leave` in the **Text** field.

2. **Add the local and remote video views**

    You use the image widget to display the local and remote streams. To add image widgets in your <Vpl k = "CLIENT"/>, take the following steps:

    1. For local video, drag **Image** from the **Common** section of the **Palette Panel** to the canvas panel.

    2. In **Details**, rename **Image_0** to **localView**, and change the following coordinates:

        * **Position X** - 442
        * **Position Y** - 336
        * **Size X** - 400
        * **Size Y** - 400

    3. For remote video, use the same procedure to create an **Image** called **remoteView** with the following coordinates:

        * **Pos X** - 924
        * **Pos Y** - 336
        * **Size X** - 400
        * **Size Y** - 400

<ProductWrapper product="interactive-live-streaming">
3. **Enable the user to join a channel as the host or the audience**

    1. Drag **Check Box** from the **Common** section of the **Palette Panel** to the canvas panel, and change the following properties in **Details**.

        * **Pos X** - 1040
        * **Pos Y** - 772
        * **Size X** - 100
        * **Size Y** - 40

    1. In **Details**, rename **CheckBox_0** to `Host`.

    1. Add a text widget for the check box. Drag **Text** from **Palette Panel** to the canvas panel and change the following properties in **Details**.

        * **Pos X** - 1072
        * **Pos Y** - 772

    1. To change the text of the text widget, in **Details**, input `Host` in the **Text** field.

    1. Use the same procedure to create a **Check Box** called **Audience** with a **Text**, then change the following coordinates:
        
        * **Pos X** - 1040 
        * **Pos Y** - 820     
</ProductWrapper>

3. **Add the widget blueprint to viewport**

    Once you have created and laid out your widget blueprint, in order for it to be displayed in your game, you need to call it by using the **Create Widget** and **Add to Viewport** nodes inside **Level Blueprint**. To implement this workflow, take the following steps:

    1. In the list of world blueprints, click **Open Level Blueprint**. The **Event Graph** window opens.

    2. Right-click in the **Event Graph** window and input `event beginplay` in the **Search** field. From the search results, choose **Event BeginPlay**. You see a node appears in **Level Blueprint**.

    3. Use the same procedure and add the **Create Widget** node in **Level Blueprint**.

    5. Repeat step three add node called **Add to Viewport**.

    6. Connect **Event BeginPlay** to the left connectors of the **Construct None** node.

    7. Connect the right connector on **Construct None** node to the **Add to Viewport** left connector.

    8. Set the **Class** field on the **Construct None** node to `NewBlueprint`.

    9. Click **Compile** button in the **Event Graph** window. The yellow question mark turns green.

    Your **Event Graph** looks like:
      
      ![image](/images/video-sdk/unreal-blueprint.png)

To check that you successfully added `NewBlueprint` to the view port. In Unreal Editor, click **Play**. You see the following UI:

![image](/images/video-sdk/unreal-video-calling-ui.png)




### Handle the system logic

Import the necessary C++ libraries, set up your <Vpl k="CLIENT" /> to run on Android, and request permissions for the camera and microphone.

1. **Reference the user widgets**

    In Visual Studio, add the following property specifiers to `MyUserWidget.h` after `GENERATED_BODY()`:

    ```cpp
      UPROPERTY(BlueprintReadWrite, meta = (BindWidget))
		UImage* remoteView = nullptr;
      UPROPERTY(BlueprintReadWrite, meta = (BindWidget))
		UImage* localView = nullptr;
      UPROPERTY(VisibleAnywhere, BlueprintReadWrite, meta = (BindWidget))
		UButton* JoinBtn = nullptr;
      UPROPERTY(VisibleAnywhere, BlueprintReadWrite, meta = (BindWidget))
		UButton* LeaveBtn = nullptr;
    ```

1. **Setup event listeners for the buttons**

    In `MyUserWidget.h`, add the following to `UMyUserWidget` after `UButton* LeaveBtn = nullptr;`:

    ```cpp
    UFUNCTION(BlueprintCallable)
	void OnLeaveButtonClick();
    LeaveBtn->OnClicked.AddDynamic(this, &UMyUserWidget::OnLeaveButtonClick);
    UFUNCTION(BlueprintCallable)
	void OnJoinButtonClick();
    JoinBtn->OnClicked.AddDynamic(this, &UMyUserWidget::OnJoinButtonClick);
    ```

3. **Manage Android permissions**

    1. Add the Unreal Android libraries. In `MyUserWidget.h`, add the following to the list of header files:

        ```cpp
        #if PLATFORM_ANDROID
        #include "AndroidPermission/Classes/AndroidPermissionFunctionLibrary.h"
        #endif
        ```

    2. Setup a function to check permissions are granted. In `MyUserWidget.h`, add the following method declaration to `UMyUserWidget`:

        ``` cpp
        void CheckAndroidPermission();
        ```

    3. Add the logic to request permissions to `CheckAndroidPermission`. Add the following method to `MyUserWidget.cpp`:

        ```cpp
        void UMyUserWidget::CheckAndroidPermission() 
        {
            #if PLATFORM_ANDROID
            FString pathfromName = UGameplayStatics::GetPlatformName();
            if (pathfromName == "Android")
            {
                TArray<FString> AndroidPermission;
                AndroidPermission.Add(FString("android.permission.CAMERA"));
                AndroidPermission.Add(FString("android.permission.RECORD_AUDIO"));
                AndroidPermission.Add(FString("android.permission.READ_PHONE_STATE"));
                AndroidPermission.Add(FString("android.permission.WRITE_EXTERNAL_STORAGE"));
                UAndroidPermissionFunctionLibrary::AcquirePermissions(AndroidPermission);
            }
        #endif
        }
        ```

### Implement the channel logic

The following figure shows the API call sequence of implementing  <Vpd k="PRODUCT" />.

<ProductWrapper product="video-calling">
    ![image](/images/video-sdk/video-call-logic-unity.svg)
</ProductWrapper>

<ProductWrapper product="interactive-live-streaming">
    ![image](/images/video-sdk/ils-call-logic-unity.svg)
</ProductWrapper>

To implement this logic, take the following steps:

1. **Import the <Vg k="COMPANY"/> libraries**

    In `MyUserWidget.h`, add the following header includes to the list of headers:
    
    ```cpp
    #include "IAgoraRtcEngine.h"
    #include "AgoraBase.h"
    #include "AgoraMediaBase.h"
    ```

    To import the <Vg k="COMPANY"/> namespaces, add the following before `UCLASS()`:

    ```cpp
    using namespace agora::rtc;
    using namespace agora;
    ```

1. **Declare the variables that you use to create and join a channel**

    In `MyUserWidget.h`, add the following declarations to `UMyUserWidget`:

    <ProductWrapper product="video-calling">
    ```cpp
    IRtcEngine* agoraEngine;
	std::string appId = "";
	std::string channelName = "";
	std::string token = "";
	BOOL isJoin = false;
	int remoteUId;
    ```
    </ProductWrapper>

    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    // Fill in your app ID.
    private string _appID = "";
    // Fill in your channel name.
    private string _channelName = "";
    // Fill in the temporary token you obtained from Agora Console.
    private string _token = "";
    // A variable to hold the user role.
    private string clientRole = "";
    // A variable to save the remote user uid.
    private uint remoteUid;
    private Toggle toggle1;
    private Toggle toggle2;
    internal VideoSurface LocalView;
    internal VideoSurface RemoteView;
    internal IRtcEngine RtcEngine;
    ```
    </ProductWrapper>

1. **Setup <Vg k="ENGINE"/>**

    To setup an instance of <Vg k="ENGINE"/>, take the following steps:

    1. Setup a function to add the logic of creating an engine instance. In `MyUserWidget.h`, add the following method declaration to `UMyUserWidget`:

        ```cpp
       	void setupVideoSDKEngine();
        ```

    2. Create an instance of the <Vg k = "VSDK"/>. Add the following method to `MyUserWidget.cpp`:

    <ProductWrapper product="video-calling">
    ``` cpp
    void UMyUserWidget::setupVideoSDKEngine() 
    {
        RtcEngineContext context;
        context.appId = appId.c_str();
        context.eventHandler = NULL;
        context.channelProfile = CHANNEL_PROFILE_TYPE::CHANNEL_PROFILE_COMMUNICATION;
        agoraEngine = createAgoraRtcEngine();
        agoraEngine->initialize(context);
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">
    ``` cpp
    void UMyUserWidget::setupVideoSDKEngine() 
    {
        RtcEngineContext context;
        context.appId = appId.c_str();
        context.eventHandler = NULL;
        context.channelProfile = CHANNEL_PROFILE_TYPE::CHANNEL_PROFILE_LIVE_BROADCASTING;
        agoraEngine = createAgoraRtcEngine();
        agoraEngine->initialize(context);
    }
    ```
    </ProductWrapper>

1. **Handle and respond to <Vg k="ENGINE"/> events**

    To register the callbacks, inherit the `UMyUserWidget` with `IRtcEngineEventHandler`. In `MyUserWidget.h`, add the following after `class AGORAIMPLEMENTATION_API UMyUserWidget : public UUserWidget`:
    
    ```cpp
    , public IRtcEngineEventHandler
    ```

    To implement the required callbacks in your <Vpl k = "CLIENT"/>, take the following steps:

        1. To override the necessary callbacks, in `MyUserWidget.h`, add the following callbacks to `UUserWidget` after `void setupVideoSDKEngine();`:

            ```cpp
            // Occurs when a remote user joins the channel.
            void onUserJoined(uid_t uid, int elapsed) override;
            // Occurs when a local user joins the channel.
	        void onJoinChannelSuccess(const char* channel, uid_t uid, int elapsed) override;
            // Occurs when you leave the channel.
	        void onLeaveChannel(const RtcStats& stats) override;
            // Occurs when the remote user drops offline.
	        void onUserOffline(uid_t uid, USER_OFFLINE_REASON_TYPE reason) override;
            ```
        2. Add your logic to the callbacks you declared in `UMyUserWidget`:

           ```cpp
           void UMyUserWidget::onLeaveChannel(const agora::rtc::RtcStats& stats) 
           {
                AsyncTask(ENamedThreads::GameThread, [=]()
                {
                    UE_LOG(LogTemp, Warning, TEXT("UMyUserWidget::onLeaveChannel"));
                    VideoCanvas videoCanvas;
                    videoCanvas.view = nullptr;
                    videoCanvas.uid = 0;
                    videoCanvas.sourceType = VIDEO_SOURCE_TYPE::VIDEO_SOURCE_CAMERA;
                    if (agoraEngine != nullptr)
                    {
                        agoraEngine->setupLocalVideo(videoCanvas);
                    }
                });
           }
           void UMyUserWidget::onJoinChannelSuccess(const char* channel, uid_t uid, int elapsed)
           {
                AsyncTask(ENamedThreads::GameThread, [=]()
                {
                    UE_LOG(LogTemp, Warning, TEXT("JoinChannelSuccess uid: %u"), uid);
                    isJoin = TRUE;
                });
           }
           ```

1. **Join a channel to start <Vpd k="PRODUCT" />**

    When the user clicks **Join**, you call the `OnJoinButtonClick()` method to connect to a channel. This method securely connects the local user to a channel using the authentication token. In `MyUserWidget.h`, add the following before `setupVideoSDKEngine`:
    <ProductWrapper product="video-calling">
    ``` csharp
    void UMyUserWidget::OnJoinButtonClick() 
    {
        UE_LOG(LogTemp, Warning, TEXT("UVideoWidget OnJoinButtonClick ======"));
	    agoraEngine->enableAudio();
	    agoraEngine->enableVideo();
	    VideoCanvas videoCanvas;
	    videoCanvas.view = localView;
	    videoCanvas.uid = 0;
	    videoCanvas.sourceType = agora::rtc::VIDEO_SOURCE_TYPE::VIDEO_SOURCE_CAMERA;
	    agoraEngine->setupLocalVideo(videoCanvas);
	    agoraEngine->joinChannel(token.c_str(), channelName.c_str(), "", 0);
	    agoraEngine->setClientRole(agora::rtc::CLIENT_ROLE_TYPE::CLIENT_ROLE_BROADCASTER);
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">
    ``` csharp
    public void Join()
    {
        if (toggle1.isOn == false && toggle2.isOn == false)
        {
            Debug.Log("Select a role first");
        }
        else
        {
            // Enable the video module.
            RtcEngine.EnableVideo();
            // Set the local video view.
            LocalView.SetForUser(0, "", VIDEO_SOURCE_TYPE.VIDEO_SOURCE_CAMERA);
            // Join a channel.
            RtcEngine.JoinChannel(_token, _channelName);
        }
    }
    ```
    </ProductWrapper>

1. **View the remote user when they join a channel**

    When a remote user joins the channel, <Vg k="COMPANY"/> fires `OnUserJoined`. To catch this callback and start remote video, in `MyUserWidget.h`, add the following code after `OnJoinChannelSuccess`:
    <ProductWrapper product="video-calling">
    ``` csharp
    void UMyUserWidget::onUserJoined(uid_t uid, int elapsed) 
    {
        AsyncTask(ENamedThreads::GameThread, [=]()
        {
            UE_LOG(LogTemp, Warning, TEXT("UMyUserWidget::onUserJoined  uid: %u"), uid);
            VideoCanvas videoCanvas;
            videoCanvas.view = remoteView;
            videoCanvas.uid = uid;
            remoteUId = uid;
            videoCanvas.sourceType = VIDEO_SOURCE_TYPE::VIDEO_SOURCE_REMOTE;
            RtcConnection connection;
            connection.channelId = channelName.c_str();
            ((IRtcEngineEx*)agoraEngine)->setupRemoteVideoEx(videoCanvas, connection);
            });
        }
    }
    ```
    </ProductWrapper>
    <ProductWrapper product="interactive-live-streaming">

    ``` csharp
    public override void OnUserJoined(RtcConnection connection, uint uid, int elapsed)
    {
        // Setup remote view.
        _videoSample.RemoteView.SetForUser(uid, connection.channelId, VIDEO_SOURCE_TYPE.VIDEO_SOURCE_REMOTE);
        if(_videoSample.clientRole == "Audience")
        {
            // Start rendering remote video.
            _videoSample.RemoteView.SetEnable(true);
        }
        _videoSample.remoteUid = uid;
    }
    ```
    </ProductWrapper>

<ProductWrapper product="interactive-live-streaming">
8. **Manage the user role**

    1. Change the `LocalView` and `RemoteView` visibility.
    When the user role switches, <Vg k="COMPANY"/> fires `OnClientRoleChanged`. To catch this callback and enable or disable `LocalView`, `RemoteView` accordingly, in your script file, add the following code after `OnUserJoined`:
        ``` csharp
        public override void OnClientRoleChanged(RtcConnection connection, CLIENT_ROLE_TYPE oldRole, CLIENT_ROLE_TYPE newRole)
        {
            if (newRole == CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER)
            {
                _videoSample.LocalView.SetEnable(true);
                _videoSample.RemoteView.SetEnable(false);
                Debug.Log("Role changed to Broadcaster");
            }
            else
            {
                _videoSample.LocalView.SetEnable(false);
                _videoSample.RemoteView.SetEnable(true);
                Debug.Log("Role changed to Audience");
            }
        }
        ```

    1. Switch the user role between broadcaster and audience.
    When toggles are switched on, to switch client role and turn off the toggles, in your script file, add the following methods to `NewBehaviourScript`:

        ``` csharp
        void Func1(bool value)
        {
            if(value==true)
            {
                toggle2.isOn = false;
                RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_BROADCASTER);
                clientRole = "Host";
            }
        }
        void Func2(bool value)
        {
            if (value==true)
            {
                toggle1.isOn = false;
                RtcEngine.SetClientRole(CLIENT_ROLE_TYPE.CLIENT_ROLE_AUDIENCE);
                clientRole = "Audience";
            }
        }
        ```
</ProductWrapper>
8. **Stop remote video when a remote user leaves the channel**

    When a remote user leaves the channel or drops offline, <Vg k="COMPANY"/>  fires `OnUserOffline`. To catch this callback and stop remote video, in your script file, add the following callback method to `UserEventHandler`:
    ``` csharp
    // This callback is triggered when a remote user leaves the channel or drops offline.
    void UMyUserWidget::onUserOffline(agora::rtc::uid_t uid, agora::rtc::USER_OFFLINE_REASON_TYPE reason) 
    {
        AsyncTask(ENamedThreads::GameThread, [=]()
        {
            UE_LOG(LogTemp, Warning, TEXT("UMyUserWidget::onUserOffline  uid: %u"), uid);
            VideoCanvas videoCanvas;
            videoCanvas.view = nullptr;
            videoCanvas.uid = uid;
            videoCanvas.sourceType = VIDEO_SOURCE_TYPE::VIDEO_SOURCE_REMOTE;
            RtcConnection connection;
            connection.channelId = channelName.c_str();
            if (agoraEngine != nullptr)
            {
                ((IRtcEngineEx*)agoraEngine)->setupRemoteVideoEx(videoCanvas, connection);
            }
        });
    }
    ```

1. **Leave the channel when a user ends the call**

    When a user clicks **Leave**, you call `OnLeaveButtonClick()` to exit the channel. In `MyUserWidget.cpp`, add the following before `onUserJoined`:
    ``` csharp
    void UMyUserWidget::OnLeaveButtonClick() 
    {
        UE_LOG(LogTemp, Warning, TEXT("UMyUserWidget:: OnLeaveButtonClick ======"));
        agoraEngine->leaveChannel();
        remoteUId = NULL;
        isJoin = FALSE;
    }
    ```

### Start and stop your <Vpl k="CLIENT" />

In this implementation, you initiate and remove  <Vg k="ENGINE" /> when the app opens and closes. The local user joins and leaves a channel using the same  <Vg k="ENGINE" /> instance. In order to send video and audio streams to  <Vg k="COMPANY" />, you need to ensure that the local user gives permission to access the camera and microphone on the local device. To implement this functionality:

1. **Check that the <Vpl k="CLIENT" /> has the correct permissions to start**

    For Android, call `CheckAndroidPermission` and check that the permissions are granted. To execute `CheckAndroidPermission` at startup, call `CheckAndroidPermission` in the constructor of the `UMyUserWidget` class. To implement this workflow, take the following steps:

    1. Implement a constructor in `UMyUserWidget`. In `MyUserWidget.h`, add the following before `setupVideoSDKEngine`:

        ```cpp
        void NativeDestruct();
        ```

    2. Call `CheckAndroidPermission` in the constructor. In `MyUserWidget.cpp`, add the following code before `setupVideoSDKEngine`:

        ```cpp
        void UMyUserWidget::NativeConstruct()
        {
            CheckAndroidPermission();
        }
        ```
    3. After you check permissions, you call `setupVideoSDKEngine` to create an engine instance. In `MyUserWidget.cpp`, add the following at the end of `NativeConstruct`:

        ```cpp
        setupVideoSDKEngine();
        ```

3. **Clean up the resources used by your <Vpl k="CLIENT" />**

    When a user closes the <Vpl k="CLIENT" />, use `NativeDestruct` to clean up the resources you created in `setupVideoSDKEngine`. To implement this workflow, take the following steps:

    1. Declare `NativeDestruct` in the `UMyUserWidget` class. In `MyUserWidget.h`, add the following before `void NativeConstruct();`:

        ```cpp
        void NativeConstruct();
        ```

    2. Add the resource clean up logic. In `MyUserWidget.cpp`, add the following before `NativeConstruct`:

        ```cpp
        void UMyUserWidget::NativeDestruct() 
        {
            Super::NativeDestruct();
            UE_LOG(LogTemp, Warning, TEXT("UMyUserWidget::NativeDestruct"));
            if (agoraEngine != nullptr)
            {
                agoraEngine->unregisterEventHandler(this);
                agoraEngine->release();
                delete agoraEngine;
                agoraEngine = nullptr;
            }
        }
        ```

</PlatformWrapper>