<PlatformWrapper platform="electron">

### Implement the user interface

To create a simple interface for testing speech to text functionality, you add two buttons to the UI. Open `index.html` and add the following lines after `<button type="button" id="leave">Leave</button>`:

```html
<button type="button" id="speechToText">Start speech to text</button>
<button type="button" id="speechToTextQuery">Query speech to text</button>
```

### Handle the system logic

To integrate HTTP and JSON capabilities into your app for speech to text:

1. **Import the `https` module into your project**

    To call `HTTP` methods that start, stop, and query a speech-to-text task, you add a `https` module to your project. Open `preload.js` and add the following before `let agoraEngine;`:

    ```javascript
    var https = require('https');
    ```

1. **Define variables to manage a speech-to-text task**

    In `preload.js`, add the following to declarations:

    ```javascript
    var baseUrl = "api.agora.io";
    var apiKey = "<your API key from Agora console>";
    var apiSecret = "<your API secret from Agora console>";
    var instanceID = "Test-1";
    var authorizationHeader, builderToken;
    var speechToTextTaskId = ""; // Returned by the start method
    var isSpeechToTextRunning = false;
    ```

### Manage a speech-to-text task

Take the following steps to start, stop and query a text-to-speech task in your <Vpl k="CLIENT" />.

1. **Get a `builderToken`**

    To use the speech to text RESTful API, you generate a Base64-encoded credential with the API key and secret provided by <Vg k="COMPANY" />. You add this credential to the request header as a parameter named `Authorization`. In the request body, you pass a parameter `instanceID` that you choose to identify the instance. To [acquire a `builderToken`](#acquire-a-buildertoken), in `preload.js`, add the following before `document.getElementById("join").onclick = async function ()`:

    ```javascript
    document.getElementById("speechToText").onclick = async function ()
    {
      if(isSpeechToTextRunning)
      {
        stopSpeechToText();
        return;
      }
      var path =  "/v1/projects/" + appID + "/rtsc/speech-to-text/builderTokens";
      var plainCredentials = apiKey + ":" + apiSecret;
      var base64Credentials = Buffer.from(plainCredentials).toString('base64')
      authorizationHeader = "Basic " + base64Credentials;
      var postData = JSON.stringify(
        {
          "instanceId": instanceID
        });
        // Set request parameters
      const options = 
      {
        hostname: baseUrl,
        port: 443,
        path: path,
        method: 'POST',
        headers: 
        {
          'Authorization':authorizationHeader,
          'Content-Type': 'application/json',
          'Content-Length': postData.length
        }
      }
      // Create request object and send request
      const req = https.request(options, res => 
      {
        console.log(`Status code: ${res.statusCode}`)
        res.on('data', function(data) 
        {
          // Retrieve token from the response.
          var data = JSON.parse(data);
          builderToken = data.tokenName;
          startSpeechToText();
          console.log(builderToken);      
        })
      })
      req.on('error', error => 
      {
        // Display the error result when the request is not complete.
        console.error(error)
      })
      // Send the post request data to the upstream server port.
      req.write(postData);
      // End the request.
      req.end()  
    }
    ```

    A `builderToken` is usable for 5 minutes. After the time has expired, you must generate a new token.

1. **Start a speech-to-text task**

    To [start a speech-to-text task](#start-a-speech-to-text-task), you create a JSON configuration and pass it in the body of a `POST` request. You add the `builderToken` as a query parameter to the URL. Upon success, the method returns a `taskId` that you use to query or stop the task later on. To start a task, in `preload.js`, add the following method before `window.onload = () =>`:

    ```javascript
    function startSpeechToText()
    {
        var url = "/v1/projects/" + appID + "/rtsc/speech-to-text/tasks?" + "builderToken=" + builderToken;
        var body = JSON.stringify(
            {
                "audio": 
                {
                    "subscribeSource": "AGORARTC",
                    "agoraRtcConfig": 
                    {
                        "channelName": channel,
                        "uid": "1",
                        "token": token,
                        "channelType": "LIVE_TYPE",
                        "subscribeConfig": 
                        {
                            "subscribeMode": "CHANNEL_MODE"
                        },
                        "maxIdleTime": 60
                    }
                },
                "config": 
                {
                    "features": 
                    [
                        "RECOGNIZE"
                    ],
                    "recognizeConfig": 
                    {
                        "language": "ENG",
                        "model": "Model",
                        "output": 
                        {
                            "destinations": 
                            [
                                "AgoraRTCDataStream",
                                "Storage"
                            ],
                            "agoraRTCDataStream": 
                            {
                                "channelName": channel,
                                "uid": "1",
                                "token": token
                            },
                            "cloudStorage": 
                            [
                                {
                                    "format": "HLS",
                                    "storageConfig": 
                                    {
                                        "vendor": 0,
                                        "region": 0,
                                        "bucket":"<YourBucket>",
                                        "accessKey":"<YourOssAccessKey>",
                                        "secretKey":"<YourOssSecretKey>"
                                    },
                                    "fileNamePrefix":
                                    [
                                        "directory1",
                                        "directory2"
                                    ]
                                }
                            ]
                        }
                    }
                }
            });
        const options = 
        {
            hostname: baseUrl,
            path: url,
            method: 'POST',
            headers: 
            {
                'Authorization':authorizationHeader,
                'Content-Type': 'application/json',
                'Content-Length': body.length
            }
        }
        // Create request object and send request
        const req = https.request(options, res => 
        {
            console.log(`Status code: ${res.statusCode}`)
            res.on('data', (d) =>
            {
                // Retrieve token from the response.
                var data = JSON.parse(d);
                var status = data.status;
                speechToTextTaskId = data.taskId;
                if (status == "STARTED" || status == "IN_PROGRESS") 
                {
                    isSpeechToTextRunning = true;
                    taskId = data.taskId;
                    document.getElementById("speechToText").innerHTML = "Stop speech to text";
                    console.log("Speech to text task started");
                } 
                else 
                {
                    isSpeechToTextRunning = false;
                    console.log("Speech to text status: " + status);
                }
                process.stdout.write(d);
            })
        })
        req.on('error', error => 
        {
            // Display the error result when the request is not complete.
            console.error("Error parsing query call response: " + error)
        })
        // Send the post request data to the upstream server port.
        req.write(body);
        // End the request.
        req.end()  
    }
    ```

1. **Query task status**

    You [query the status](#query-the-status-of-speech-to-text) of a speech-to-text task using a `GET` request containing the `taskId` and `builderToken` to notify the user of any change. To do this, in `preload.js`, add the following method before `document.getElementById("join").onclick = async function ()`:

    ```javascript
    document.getElementById("speechToTextQuery").onclick = async function ()
    {
      var path = "/v1/projects/" + appID + "/rtsc/speech-to-text/tasks/" + speechToTextTaskId + "?builderToken=" + builderToken;
      // Set request parameters
      const options = 
      {
        hostname: baseUrl,
        port: 443,
        path: path,
        method: 'GET',
        headers: 
        {
            'Authorization':authorizationHeader,
            'Content-Type': 'application/json',
        }
      }
      // Create request object and send request
      const req = https.request(options, res => 
        {
          console.log(`Status code: ${res.statusCode}`)
          res.on('data', function(data) 
          {
            // Retrieve token from the response.
            var data = JSON.parse(data);
            var status = data.status;
            speechToTextTaskId = data.taskId;
            if (status == "IN_PROGRESS") 
            {
              isSpeechToTextRunning = true;
              document.getElementById("speechToText").innerHTML = "Stop speech to text";
              console.log("Speech to text is running");
            } 
            else 
            {
              isSpeechToTextRunning = false;
              speechToTextTaskId = "";
              console.log("Speech to text status: " + status + "");
              document.getElementById("speechToText").innerHTML = "Start speech to text";
            }
          })
        })
      req.on('error', error => 
      {
        // Display the error result when the request is not complete.
        console.error(error)
      })
      // End the request.
      req.end()         
    }
    ```

1. **Stop the task**

    To [stop speech to text](#stop-speech-to-text), you send a `DELETE` request with the, `appId`, `taskId` and `builderToken` in the URL. In the `preload.js`, add the following method before `window.onload = () =>`:

    ```javascript
    function stopSpeechToText()
    {
      var path =  "/v1/projects/" + appID
      + "/rtsc/speech-to-text/tasks/" + speechToTextTaskId
      + "?builderToken=" + builderToken;
      const options = 
      {
        hostname: baseUrl,
        port: 443,
        path: path,
        method: 'DELETE',
        headers: 
        {
          'Authorization': authorizationHeader,
          'Content-Type': 'application/json',
        }
      }
      // Create request object and send request
      const req = https.request(options, res => 
      {
        console.log(`Status code: ${res.statusCode}`)
        if(res.statusCode == "200")
        {
          console.log("Speech-to-text task stopped");
          speechToTextTaskId = "";
          document.getElementById("speechToText").innerHTML = "Start speech to text"
          isSpeechToTextRunning = false;
        }
        res.on('data', (d) =>
        {
          process.stdout.write(d);
        })
      })
      req.on('error', error => 
      {
        // Display the error result when the request is not complete.
        console.error("Error while stopping the speech-to-text task: " + error)
      })
      // End the request.
      req.end()  
    }
    ```

1. **Receive and display the text stream**

    When you set one of the `destinations` in the starting configuration as `AgoraRTCDataStream`, the speech-to-text conversion output stream is pushed to your RTC channel. To receive this stream and display the text in your <Vpl k="CLIENT" />, in `preload.js`, add the following code after `const EventHandles = {`:

    ```javascript
    onStreamMessage: (connection, remoteUid, streamId, data, length, sentTs) =>
    {
      var text =  new TextDecoder().decode(data);
      console.log(text);
    },
    ```
</PlatformWrapper>
