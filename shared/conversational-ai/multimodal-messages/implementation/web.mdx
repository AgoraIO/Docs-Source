import CodeBlock from '@theme/CodeBlock';

1. **Integrate the toolkit**

    Copy the [`conversational-ai-api`](https://github.com/AgoraIO-Community/Conversational-AI-Demo/tree/main/Web/Scenes/VoiceAgent/src/conversational-ai-api) file to your project and import the toolkit before calling its API. Refer to [Folder structure](#folder-structure) to understand the role of each file.

1. **Create a toolkit instance**

    Before joining a <Vg k="VSDK"/> channel, create video and <Vg k="SIG" /> engine instances and pass in to the toolkit instance.

    <CodeBlock language="js" showLineNumbers>
    {`// Initialize the component
    ConversationalAIAPI.init({
        rtcEngine,
        rtmEngine,
    })

    // Get the API instance (singleton)
    const conversationalAIAPI = ConversationalAIAPI.getInstance()`}
    </CodeBlock>

1. **Subscribe to the channel**
    Agent-related events are delivered through <Vg k="SIG" /> messages. Before starting an agent session, call `subscribeMessage` to receive these events:

    <CodeBlock language="ts" >
    {`conversationalAIAPI.subscribeMessage(channel_name)`}
    </CodeBlock>


1. **Register callbacks**

    <CodeBlock language="js" >
    {`// Listen for message receipt updates
    conversationalAIAPI.on(EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED, handleMessageReceiptUpdated)
    // Listen for agent error events
    conversationalAIAPI.on(EConversationalAIAPIEvents.AGENT_ERROR, onAgentError)`}
    </CodeBlock>

1. **Add a Conversational AI agent to the channel**

    To [start a <Vpd k="AGENT" />](/conversational-ai/rest-api/agent/join), configure the following parameters in your `POST` request:

    | Parameter       | Description   | Required |
    | ----------------| ------------- | -------- |
    | `advanced_features.enable_rtm: true`    | Starts the <Vg k="SIG" /> service | Yes  |
    | `parameters.data_channel: "rtm"`  | Enables <Vg k="SIG" /> as the data transmission channel | Yes |
    | `parameters.enable_metrics: true`  | Enables agent performance data collection    | Optional |
    | `parameters.enable_error_message: true` | Enables reporting of agent error events  | Optional |

    After a successful response, the agent joins the specified <Vg k="VSDK"/> channel and is ready to interact with the user.

1. **Send an image**

    Call the `chat` method to send a picture message. The following example sends a picture using a URL:

    <CodeBlock language="js" showLineNumbers>
    {`import { EChatMessageType } from '@/conversational-ai-api/type'

    // Send picture message
    await conversationalAIAPI.chat(\`\${agent_rtc_uid}\`, {
            messageType: EChatMessageType.IMAGE,
            url: "https://example.com/image.jpg",
            uuid: genUUID()
            })`}
    </CodeBlock>

    <Admonition type="info">
    The callback of the `chat` completion interface only indicates whether the sending request is successful, and does not reflect the actual processing status of the message.
    </Admonition>

1. **Receive image sending response**

    The success of sending a picture message is confirmed by the picture message receipt callback `onMessageReceiptUpdated`. If sending fails, the agent error callback `onAgentError` is fired. The `uuid` value in the callback identifies the  uploaded picture.

    - Image sent successfully

        When you receive the `handleMessageReceiptUpdated` callback, follow the steps below to parse the JSON message in the callback and obtain the image's `uuid` and status information to confirm that the image was sent successfully:

        <CodeBlock language="js" showLineNumbers> 
        {`import { TMessageReceipt, EModuleType, EConversationalAIAPIEvents } from '@/conversational-ai-api/type'

        // Handle the send status of an image message
        conversationalAIAPI.on(EConversationalAIAPIEvents.MESSAGE_RECEIPT_UPDATED, (agentUserId: string,  messageReceipt: TMessageReceipt) => {
            // Check if the message type is Context
            if (messageReceipt.moduleType !== EModuleType.CONTEXT) {
                return
            }
            // Parse receipt.message as a JSON object
            try {
                const receiptMessage = JSON.parse(messageReceipt.message)
                // Check if the uuid field exists
                const uuid = receiptMessage.uuid
                if (!uuid) {
                    return
                }
                // Announce that the message was sent successfully
                console.log(\`Message sent successfully, UUID: \${uuid}\`) // Replace this with actual voice feedback logic
            } catch (error) {
                console.error('Failed to parse message:', error)
            }
        })`}
        </CodeBlock>

    - Image sending failed

        If you receive the `handleAgentError` callback, follow the steps below to parse the JSON message in the callback to obtain the image's `uuid` and status information to confirm that the image sending failed:

        <CodeBlock language="js" showLineNumbers> 
        {`import { EConversationalAIAPIEvents, EChatMessageType } from '@/conversational-ai-api/type';

        conversationalAIAPI.on(EConversationalAIAPIEvents.MESSAGE_ERROR, (agentUserId, error) => {
        console.error(\`Message error for agent \${agentUserId}:\`, error);
        if (error.type === EChatMessageType.IMAGE) {
            try {
                const errorData = JSON.parse(error.message);
                if (errorData?.uuid) {
                    console.warn(\`Image error for agent \${agentUserId} with UUID: \${errorData.uuid}\`);
                }
            } catch (e) {
                console.error(\`Failed to handle image error for agent \${agentUserId}:\`, e);
            }
        }
        })`}
        </CodeBlock>

1. **Unsubscribe from the channel**

    After each agent session ends, unsubscribe from channel messages to release resources associated with callback events:

    <CodeBlock language="ts" >
    {`conversationalAIAPI.unsubscribeMessage(channel_name)`}
    </CodeBlock>

1. **Release resources**

    At the end of each call, use the `destroy` method to clean up the cache.

    <CodeBlock language="ts" >
    {`conversationalAIAPI.destroy()`}
    </CodeBlock>
