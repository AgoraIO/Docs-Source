<PlatformWrapper platform="ios">

## Implement a custom plugin

This section uses the countdown plug-in as an example to introduce the basic steps of implementing a custom plug-in through a Widget and embedding the plug-in in Flexible Classroom.

### Implement the widget

Refer to the following steps to implement a custom Widget:

1. Import the `AgoraWidget` library

   ```swift
   import AgoraWidget
   ```

1. Initialize the Widget's interface and data in the `onWidgetDidLoad` method :

   ```swift
   public override func onWidgetDidLoad() {
    super.onWidgetDidLoad()
    initViews()
    initConstraints()
    updateRoomData()
    updateViewData()
    updateViewFrame()

    log(content: info.roomProperties?.jsonString() ?? "nil",
        extra: nil,
        type: .info)
   }
   ```

1. Monitor `onWidgetRoomPropertiesUpdated` and `onMessageReceived` methods to update data:

   ```swift
   public override func onWidgetRoomPropertiesUpdated(_ properties: [String : Any],
                                                      cause: [String : Any]?,
                                                      keyPaths: [String]) {
      super.onWidgetRoomPropertiesUpdated(properties,
                                          cause: cause,
                                          keyPaths: keyPaths)
      updateRoomData()
      updateViewData()
      shouldStartTime()

      log(content: properties.jsonString() ?? "nil",
         extra: cause?.jsonString(),
         type: .info)
   }

   public override func onMessageReceived(_ message: String) {
      super.onMessageReceived(message)

      if let timestamp = message.toSyncTimestamp() {
         objectCreateTimestamp = timestamp
         initCurrentTimestamp()
         shouldStartTime()
      }

      log(content: message,
         type: .info)
   }
   ```

1. If you need to change the size of the Widget, send a message to the outside using `sendMessage`, and the parent container that listens for the message will update the size of the Widget:

   ```swift
   func updateViewFrame() {
      let size = ["width": countdownView.neededSize.width,
                  "height": countdownView.neededSize.height]

      guard let message = ["size": size].jsonString() else {
         return
      }

      sendMessage(message)
   }   
   ```

### Register Widget in Agora Classroom SDK

`AgoraEduLaunchConfig.widgetsAdd` a countdown to `AgoraWidgetConfig`, and register the implemented plugin to the Agora Classroom SDK `launch` when:

   ```swift
   let launchConfig = AgoraEduLaunchConfig(userName: userName,
                                          userUuid: userUuid,
                                          userRole: userRole,
                                          roomName: roomName,
                                          roomUuid: roomUuid,
                                          roomType: roomStyle,
                                          appId: appId,
                                          token: rtmToken,
                                          startTime: nil,
                                          duration: NSNumber(value: duration),
                                          region: region.eduType,
                                          mediaOptions: mediaOptions,
                                          userProperties: nil)

   let widgetId = "countdownTimer"

   launchConfig.widgets[widgetId] = AgoraWidgetConfig(with: AgoraCountdownTimerWidget.self,
                                                      widgetId: widgetId)

   AgoraClassroomSDK.launch(launchConfig,
                           success: launchSuccessBlock,
                           failure: failureBlock)
   ```

### Using Widgets in the Classroom

Refer to the following steps to integrate the countdown plugin in the classroom:

1. Add as an observer of the widget activity through `AgoraEduContext.widget` the `addWidgetActivityObserver` method of, and listen for the callback of the activity, `AgoraClassToolsViewController`.

   ```swift
   override func viewDidLoad() {
      super.viewDidLoad()
      contextPool.room.registerRoomEventHandler(self)
      contextPool.widget.add(self)
   }
   ```

1. Create and destroy the widget.

   ```swift
   extension AgoraClassToolsViewController: AgoraWidgetActivityObserver {
      // Create Widget when onWidgetActive callback is received
      func onWidgetActive(_ widgetId: String) {
         createWidget(widgetId)
      }

      // When the `onWidgetInactive` callback is received, destroy the Widget
      func onWidgetInactive(_ widgetId: String) {
         releaseWidget(widgetId)
      }
   }
   ```

1. Create the Widget object of `AgoraCountdownTimer` and implement the communication of the Widget on the local client.

   ```swift
   // Call the createWidget method to create the Widget object of AgoraCountdownTimer
   func createWidget(_ widgetId: String) {
      let widgetController = contextPool.widget

      guard widgetIdList.contains(widgetId),
            // Call getWidgetConfig to get AgoraWidgetConfig of AgoraCountdownTimer
            let config = widgetController.getWidgetConfig(widgetId) else {
         return
      }

      if let _ = getWidget(widgetId) {
         return
      }

      // Add AgoraClassToolsViewController as the observer of Widget syncFrame through addObserverForWidgetSyncFrame of AgoraWidgetContext, and monitor the callback of syncFrame
      widgetController.addObserver(forWidgetSyncFrame: self, widgetId: widgetId)

      // Add AgoraClassToolsViewController as an observer of widget message through addWidgetMessageObserver of AgoraWidgetContext, and monitor the callback of message
      widgetController.add(self, widgetId: widgetId)

      let widget = widgetController.create(config)

      view.addSubview(widget.view)

      switch widgetId {
         case PollWidgetId:
            pollWidget = widget
         case CountdownTimerWidgetId:
            countdownTimerWidget = widget
         case PopupQuizWidgetId:
            popupQuizWidget = widget
         default:
            return
      }

      sendWidgetCurrentTimestamp(widgetId)
   }

   func sendWidgetCurrentTimestamp(_ widgetId: String) {
      let syncTimestamp = contextPool.monitor.getSyncTimestamp()
      let tsDic = ["syncTimestamp": syncTimestamp]

      if let string = tsDic.jsonString() {
         // Call the sendMessage method to send the current timestamp to the Widget
         contextPool.widget.sendMessage(toWidget: widgetId,
                                          message: string)
      }
   }
   ```

1. Implement the `syncFrameListener` callback

   ```swift
   extension AgoraClassToolsViewController: AgoraWidgetSyncFrameObserver {
      // When syncFrame is updated, update the position and size of the Widget
      func onWidgetSyncFrameUpdated(_ syncFrame: CGRect,
                                    widgetId: String) {
         let size = getWidgetSize(widgetId)
         updateWidgetFrame(widgetId,
                           size: size)
      }
   }
   ```

1. The callback method for listening to the message.

   ```swift
   extension AgoraClassToolsViewController: AgoraWidgetMessageObserver {
      // When the message callback is received, AgoraClassToolsViewController acts as the parent container to update the size of the Widget
      func onMessageReceived(_ message: String,
                              widgetId: String) {
         if let size = parseSizeMessage(widgetId: widgetId,
                                          message: message) {
               updateWidgetFrame(widgetId,
                                 size: size)
         }
      }
   }
   ```

</PlatformWrapper>