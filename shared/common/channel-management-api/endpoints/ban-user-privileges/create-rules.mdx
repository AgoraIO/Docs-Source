import Authorization from '@docs/shared/common/channel-management-api/authorization.mdx';
import CodeBlock from '@theme/CodeBlock';
import MultiCodeBlock, { CodeGroup, CodeItem } from '@app/mdx-components/MultiCodeBlock';
import RestAPILayout from '@site/src/components/rest-api/RestAPILayout';
import LeftColumn from '@site/src/components/rest-api/LeftColumn';
import RightColumn, { Section } from '@site/src/components/rest-api/RightColumn';
import ParameterList, { Parameter } from '@site/src/components/rest-api/ParameterList';
import PathParameter from '@site/src/components/rest-api/PathParameter';
import { Tabs, TabItem } from '@site/src/components/rest-api/Tabs';

<RestAPILayout>

  <LeftColumn
    title={frontMatter.title}
    method="POST"
    endpoint="https://api.agora.io/dev/v1/kicking-rule"
  >
  This method creates a rule for banning specified user privileges. For details on the privileges that can be banned and the callbacks a banned user receives, see [Banning rules and privileges](#banning-rules-and-privileges).

### Request

**Request header**

<Authorization/>

**Request body**

<div class="api-mime-type">APPLICATION/JSON</div>

<ParameterList title="BODY" required={true}>
  <Parameter name="appid" type="string" required={true}>
    The App ID of the project. You can get it through one of the following methods:
    <ul>
      <li>Copy from the <Link to="{{Global.AGORA_CONSOLE_URL}}"><Vg k="CONSOLE" /></Link></li>
      <li> Call the [Get all projects](../../agora-console-rest-api#get-all-projects) API, and read the value of the `vendor_key` field in the response body.</li>
    </ul>
  </Parameter>
  <Parameter name="cname" type="string" required={false}>
    The channel name. 
  </Parameter>
  <Parameter name="uid" type="number" required={false}>
    The user ID. Do not set it as `0`. 
  </Parameter>
  <Parameter name="ip" type="string" required={false}>
    The IP address of the user. Do not set it as `0`.   
  </Parameter>
  <Parameter name="time" type="number" required={true}>
    The time duration (in minutes) to ban the user. The value range is [1,1440].<p> **Note** </p>
    <ul>
      <li>If the set value is between `0` and `1`, Agora automatically sets the value to `1`.</li>
      <li>If the set value is greater than `1440`, Agora automatically sets the value to `1440`.</li>
      <li>If the set value is `0`, the banning rule does not take effect. The server sets all users that conform to the rule offline, and users can log in again to rejoin the channel.</li><li>Use either `time` or `time_in_seconds`. If you set both parameters, the `time_in_seconds` parameter takes effect; if you set neither of these parameters, the Agora server automatically sets the banning time duration to 60 minutes, that is, 3600 seconds.</li>
    </ul>
  </Parameter>
  <Parameter name="privileges" type="array[string]" required={true}
        possibleValues="join_channel, publish_audio, publish_audio"
    >
    The user privileges you want to block. You can choose the following values: 
    <ul>
      <li> `join_channel`: String. Bans a user from joining a channel or kicks a user out of a channel.</li>
      <li> `publish_audio`: String. Bans a user from publishing audio. </li>
      <li> `publish_video`: Bans a user from publishing video. </li>You can pass in both `publish_audio` and `publish_video` to ban a user from publishing audio and video.
    </ul>
  </Parameter>
</ParameterList>

### Response

If the status code is `200`, the request succeeds, and the response body includes the following parameters:

  <ParameterList title="OK">
    <Parameter 
      name="status" 
      type="string" 
      possibleValues="success, failed"
    >
      The status of this request. `success` means the request succeeds.
    </Parameter>
    <Parameter name="id" type="integer">
      The rule ID. Save the rule ID to update or delete this rule later.
    </Parameter>
  </ParameterList>
If the status code is not `200`, the request fails. See the `message` field in the response body for the reason for this failure. For details about possible response status codes, see [Response status codes](../../response-status-code).

## Reference

This section contains content that completes the information on this page, or points you to documentation that explains other aspects to this product.

### Banning rules and privileges

The user `privileges` that can be banned include:

- `join_channel`: Joining a channel.

- `publish_audio`: Publishing audio.

- `publish_video`: Publishing video.

The banning rule works based on the following three fields: `cname`, `uid`, and `ip`.

When you set `privileges` as `join_channel`, the rule works as follows:

|`ip`|`cname`|`UID`|Rule|
|:----:|:---:|:---:|:-----|
|✔|✘|✘|All users with this `ip` cannot join any channel in the app. Using `ip` as a filter field may incorrectly block users who should not be blocked, for example, in a use-case where multiple users share an IP address.|
|✘|✔|✘|No one can join the channel specified by the `cname` field. Using `cname` as a filter field directly blocks the channel with the `cname`.|
|✘|✘|✔|The user with the `UID` cannot join any channel in the app.|
|✘|✔|✔|The user with the `UID` cannot join the channel specified by the `cname` field.|

When you set `privileges` as `publish_audio` or `publish_video`, the rule works as follows:

|`ip`|`cname`|`UID`|Rule|
|:-----:|:----:|:----:|:-----|
|✔|✘|✘|The users with this `ip` cannot publish audio or video in any channel of the app.|
|✘|✔|✘|No one can publish audio or video in the channel specified by the `cname` field.|
|✘|✘|✔|The user with the `UID` cannot publish audio or video in any channel of the app.|
|✘|✔|✔|The user with the `UID` cannot publish audio or video in the channel specified by the `cname` field.|

A user who is kicked out of a channel when you set `privileges` as `join_channel` receives one of the following callbacks based on their platform:

- Android: The `onConnectionStateChanged` callback reports `CONNECTION_CHANGED_BANNED_BY_SERVER(3)`.
- iOS/macOS: The `connectionChangedToState` callback reports `AgoraConnectionChangedBannedByServer(3)`.
- Web (3.x): The `Client.on("client-banned")` callback.
- Web (4.x): The `Client.on("connection-state-change")` callback.
- Windows:The  `onConnectionStateChanged` callback reports `CONNECTION_CHANGED_BANNED_BY_SERVER(3)`.
- Electron: The `AgoraRtcEngine.on("connectionStateChanged")` callback reports `3`.
- Unity: The `OnConnectionStateChangedHandler` callback reports `CONNECTION_CHANGED_BANNED_BY_SERVER(3)`.
- React Native: The `ConnectionStateChanged` callback reports `BannedByServer(3)`.
- Flutter: The `ConnectionStateChanged` callback reports `BannedByServer(3)`.
- Cocos Creator: The `onConnectionStateChanged` callback reports `CONNECTION_CHANGED_BANNED_BY_SERVER(3)`.
- Applets: `on(event: "client-banned")`.

<Admonition type="info" title="Note">

To maximize the success rate of core functions, create (POST), update (PUT), and delete (DELETE), the success rate and accuracy of the query (GET) method is degraded to a certain extent when the quality of the public network is abnormally low. Some request records may be missing in the returned results of the query (GET). When calling POST to create a rule (`time` is not set to 0), which you need to update or delete later, best practice is to:

* Save the rule ID returned in the POST request on your server, and rely on this ID for subsequent update and delete operations.
* To ensure that you can still obtain the rule ID returned in the POST request under poor network connections, set the timeout for the POST request to 20 seconds or higher. Make sure that the timeout is set to no less than 5 seconds.
* In case the POST request times out or returns a `504` error, use the response of the GET method to obtain the rule ID. If the rule exists, it indicates that the POST request is successful, and you can save the rule ID on your server.

</Admonition>

  </LeftColumn>
<RightColumn>

<Section title="Authorization">
The endpoint requires [RESTful authentication](/video-calling/channel-management-api/restful-authentication).
</Section>
<Section title="Request example">
  <Tabs groupId="code-examples">
    <TabItem value="curl" label="curl" default>
    ```bash
    curl --request POST \\
      --url http://api.sd-rtn.com/dev/v1/kicking-rule \\
      --header 'Accept: application/json' \\
      --header 'Authorization: ' \\
      --header 'Content-Type: application/json' \\
      --data '{
      "appid": "4855xxxxxxxxxxxxxxxxxxxxxxxxeae2",
      "cname": "channel1",
      "uid": 589517928,
      "ip": "",
      "time": 60,
      "privileges": [
        "join_channel"
      ]
    }'
    ```
  </TabItem>
  <TabItem value="python" label="Python" default>
  ```python
  import http.client
  import json
  conn = http.client.HTTPConnection("api.sd-rtn.com")\n
  payload = {
      "appid": "4855xxxxxxxxxxxxxxxxxxxxxxxxeae2",
      "cname": "channel1",
      "uid": 589517928,
      "ip": "",
      "time": 60,
      "privileges": [
          "join_channel"
      ]
  }\n
  headers = {
      'Authorization': "",
      'Content-Type': "application/json",
      'Accept': "application/json"
  }\n
  conn.request("POST", "/dev/v1/kicking-rule", json.dumps(payload), headers)\n
  res = conn.getresponse()
  data = res.read()\n
  print(data.decode("utf-8"))
  ```
  </TabItem>
  <TabItem value="node" label="Node.js" default>

  ```js
  const http = require('http');
  const options = {
    method: 'POST',
    hostname: 'api.sd-rtn.com',
    port: null,
    path: '/dev/v1/kicking-rule',
    headers: {
      Authorization: '',
      'Content-Type': 'application/json',
      Accept: 'application/json'
    }
  };\n
  const req = http.request(options, function (res) {
    const chunks = [];
    res.on('data', function (chunk) {
      chunks.push(chunk);
    });\n
    res.on('end', function () {
      const body = Buffer.concat(chunks);
      console.log(body.toString());
    });
  });\n
  req.write(JSON.stringify({
    appid: '4855xxxxxxxxxxxxxxxxxxxxxxxxeae2',
    cname: 'channel1',
    uid: 589517928,
    ip: '',
    time: 60,
    privileges: ['join_channel']
  }));
  req.end();
  ```
  </TabItem>
</Tabs>

</Section>
<Section title="Response example">

```json
{
  "status": "success",
  "id": 1953
}
```
</Section>
</RightColumn>
</RestAPILayout>
