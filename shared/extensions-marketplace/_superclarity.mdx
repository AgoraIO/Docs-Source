import CodeBlock from '@theme/CodeBlock';

The <Vg k="RTEE_CLARITY" /> extension encapsulates Agora's proprietary AI image enhancement algorithm. This algorithm intelligently enhances video quality without altering the resolution, optimizing the viewing experience for recipients. Covering over 95% of mobile phone models, the AI image enhancement algorithm ensures high-quality rendering even on low-end phones, maintaining performance with larger resolution videos.

<PlatformWrapper platform="web" >

## Understand the tech
The media transmission pipeline of Agora Web SDK consists of collection, pre-processing, encoding, transmission, decoding, post-processing, and playback stages. In the post-processing stage, the <Vg k="RTEE_CLARITY" /> extension processes the video data in the pipeline using AI to achieve the desired image enhancement.

![](/images/extensions-marketplace/super-clarity.svg)

To use the <Vg k="RTEE_CLARITY" /> extension in your project, you create an extension instance and register it. After you create a video track, you create a processor and pipe it to the track.

## Prerequisites

Before you begin, make sure that you have:

- Implemented <Link to="../../../video-calling/get-started/get-started-sdk"><Vg k="GET_STARTED"/> for <Vg k="VIDEO"/></Link> with Web SDK v4.19.0 or above.

- A supported browser: 

    | Browser | Version requirements |
    |:--------|:---------------------|
    | Desktop, mobile Chrome	| 96 or above |
    | Desktop Safari | 15.4 or above |
    | Mobile Safari	iOS | 16.0 or above |

## Project setup

To implement <Vg k="RTEE_CLARITY" /> features in your app, open the SDK quickstart for Video Calling project you created previously.

1. Download and install the `agora-extension-super-clarity` package using `npm`:

    ```shell
    npm install agora-extension-super-clarity
    ```
 
1. To import the <Vg k="RTEE_CLARITY" /> functionality into your code, use either of the following methods:

    * Add the following code at the top of your JavaScript file:
    
        ```typescript
        import {
          SuperClarityExtension,
          SuperClarityEvents,
          SuperClarityProcessor,
        } from 'agora-extension-super-clarity';
        ```

    * Add the extension through the `Script` tag in your HTML file:
    
        ```typescript
        <script src="./agora-extension-super-clarity.js"></script>
        ```

## Integrate the extension

This section describes the call sequence you implement to use <Vg k="RTEE_CLARITY" /> features in your app. Follow the step-by-step guide or copy the complete sample code to add <Vg k="RTEE_CLARITY" /> to your project.

<details>
<summary>Complete sample code</summary>
<CodeBlock language="js" showLineNumbers>
{`const extension = new SuperClarityExtension();
AgoraRTC.registerExtensions([extension]);

const context = {
  uid: undefined,
  client: undefined,
  track: undefined,
  processor: undefined,
};

async function join(appid, channel) {
  context.client = AgoraRTC.createClient({ mode: "live", codec: "vp8", role: "host" });
  client.on("user-published", onUserPublished);
  client.on("user-unpublished", onUserUnpublished);

  await client.join(appid, channel, null);
}

async function onUserPublished(user, mediaType) {
  if (!context.client || mediaType !== "video" || !!context.uid) {
    return;
  }
  context.uid = user.uid;
  context.track = await context.client.subscribe(user, mediaType);
  context.processor = extension.createProcessor();

  context.processor.on("first-video-frame", (stats) => {
    console.log("Extension has received the first video frame, stats:", stats);
  });
  context.processor.on("error", (msg) => {
    console.log("Extension error:", msg);
  });
  context.processor.on("stats", (stats) => {
    console.log("Extension stats:", Date.now(), stats);
  });
  context.track.pipe(context.processor).pipe(context.track.processorDestination);
  await context.processor.enable();
  context.track.play('any element id')
}

async function onUserUnpublished(user, mediaType) {
  if (!context.client || mediaType !== "video" || context.uid !== user.uid) {
    return;
  }
  context.processor.unpipe();
  context.track.unpipe();
  await context.processor.release();
  context.processor = undefined;
  context.track.stop();
  context.track = undefined;
}

join('your-appid', 'your-channel');`}
</CodeBlock>
</details>

1. Create an extension instance and register it.

    ```typescript
    // Create a SuperClarityExtension object
    const extension = new SuperClarityExtension();
    
    // Register the extension
    AgoraRTC.registerExtensions([extension]);

    const context = {
      uid: undefined,
      client: undefined,
      track: undefined,
      processor: undefined,
    };

    async function join(appid, channel) {
      context.client = AgoraRTC.createClient({ mode: "live", codec: "vp8", role: "host" });
      client.on("user-published", onUserPublished);
      client.on("user-unpublished", onUserUnpublished);

      await client.join(appid, channel, null);
    }

    // Join a channel
    join('your-appid', 'your-channel');
    ```

1. When subscribing to a remote video track, follow these steps to enable the <Vg k="RTEE_CLARITY" /> extension:

    1. Call the extension's `createProcessor` method to create a `processor` and listen to the related events.
    1. Call the SDK's `IRemoteVideoTrack.pipe` method to connect the pipeline between the <Vg k="RTEE_CLARITY" /> extension and the video track.
    1. Call the extension's `enable` method to start the extension. Play the video track to see the effect of the <Vg k="RTEE_CLARITY" /> extension.

    ```typescript
    async function onUserPublished(user, mediaType) {
      if (!context.client || mediaType !== "video" || !!context.uid) {
        return;
      }
      context.uid = user.uid;
      context.track = await context.client.subscribe(user, mediaType);
      // Create processor
      context.processor = extension.createProcessor();

      // Listen to processor related events
      context.processor.on("first-video-frame", (stats) => {
        console.log("Extension has received first video frame, stats:", stats);
      });
      context.processor.on("error", (msg) => {
        console.log("Extension error:", msg);
      });
      context.processor.on("stats", (stats) => {
        console.log("Extension stats:", Date.now(), stats);
      });

      // Connect processor with the pipeline between video track
      context.track.pipe(context.processor).pipe(context.track.processorDestination);

      // Enable the extension
      await context.processor.enable();
      context.track.play('any element id')
    }
    ```

    <Admonition type="caution" title="Note">
    In order to avoid `processor` performance problems caused by multiple simultaneous jobs, the extension supports creating up to two processors. This means that the AI â€‹extension can process up to two video tracks at the same time.
    </Admonition>

1. Switch video tracks

    Although the extension limits the number of processors you can create, you can use the same `processor` to perform <Vg k="RTEE_CLARITY" /> processing on multiple video tracks by switching the video track.

    To switch video tracks, call the SDK's `IRemoteVideotrack.unpipe` method to disconnect the `processor` from the current video track. Call the SDK `IRemoteVideotrack.pipe` method to connect to the new video track.

    ```typescript
    {
        // Disconnect the pipeline between the processor and the current video track
        await processor.disable();
        processor.unpipe();
        track?.unpipe();
        track?.pipe(
        track.processorDestination
        );
    }
    {
        // Connect to the new video track
        track2.pipe(processor).pipe(track2.processorDestination);
        await processor.enable()
        track2.play(ele)
    }
    ```

1. To stop using the <Vg k="RTEE_CLARITY" /> extension, call the SDK's `IRemoteVideotrack.unpipe` method to disconnect the `processor` pipeline from the current video track. Call the processor's `release` method to destroy it. Call the track's stop method to stop the video track and then destroy it.

    ```typescript
    async function onUserUnpublished(user, mediaType) {
      if (!context.client || mediaType !== "video" || context.uid !== user.uid) {
        return;
      }
      // Disconnect the pipeline between the processor and the current video track first
      context.processor.unpipe();
      context.track.unpipe();
      // Then release the processor and video track
      await context.processor.release();
      context.processor = undefined;
      context.track.stop();
      context.track = undefined;
    }
    ```

## Reference

This section contains content that completes the information on this page, or points you to documentation that explains other aspects to this product.

### Development note for iOS devices

The <Vg k="RTEE_CLARITY" /> extension may not be able to adaptively switch resolutions on iOS devices. To address this issue, when the remote video resolution changes, destroy the `processor` and then recreate it. Refer to the following sample code:

<details>
<summary>Sample code to switch resolution on iOS</summary>
<CodeBlock language="js" showLineNumbers>
{`const isIOS =
  // @ts-ignore
  /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
const versions = navigator.userAgent.match(/Version\/([\d.]+).*Safari/);
let version = 0;
if (versions && versions.length > 1) {
  version = parseInt(versions[1]);
}
var shouldCleanResource: boolean =
  isIOS && isSafari && version < 16 ? true : false;


var extension: SuperClarityExtension | undefined = undefined;

var initSCProcessor = async () => {
  if (!extension) {
    extension = new SuperClarityExtension();
    AgoraRTC.registerExtensions([extension]);
  }

  var processor = extension.createProcessor();

  processor.on(SuperClarityEvents.FIRST_VIDEO_FRAME, (stats: any) => {
    console.log('Extension has received the first video frame, stats:', stats);
  });
  processor.on(SuperClarityEvents.ERROR, (msg: any) => {
    console.log('Extension error:', msg);
  });
  processor.on(SuperClarityEvents.STATS, (stats: any) => {
    console.log('Extension stats:', Date.now(), stats);
  });
  return processor;
};
var destroySCProcessor = async (processor) => {
  if (!processor ) {
    return;
  }
  processor.removeAllListeners(SuperClarityEvents.FIRST_VIDEO_FRAME);
  processor.removeAllListeners(SuperClarityEvents.ERROR);
  processor.removeAllListeners(SuperClarityEvents.STATS);
  await processor .release();
  processor= undefined;
};
// Refresh the processor
{
    var info:{ w?:number, h?:number}={}
    if (shouldCleanResource) {
      setInterval(async ()=>{
        !info.w && info.w = track?.getStats().receiveResolutionWidth;
        !info.h && info.h = track?.getStats().receiveResolutionHeight;
        if (
        (track?.getStats().receiveResolutionWidth &&
          info.w &&
          track?.getStats().receiveResolutionWidth !== info.w) ||
        (track?.getStats().receiveResolutionHeight &&
          info.h &&
          track?.getStats().receiveResolutionHeight !== info.h)
      ) {
        info.w = track?.getStats().receiveResolutionWidth;
        info.h = track?.getStats().receiveResolutionHeight;
        if (processor) {
          processor.unpipe();
          track?.unpipe();
          track?.pipe(track.processorDestination);
          await destroySCProcessor(processor);
          processor= undefined;
        }
          processor = await initSCProcessor();
            track!.pipe(processor !).pipe(track!.processorDestination);
            await processor !.enable();
        }
      }, 1000);
    }
}`}
</CodeBlock>
</details>

### API reference
This section provides the API reference for the <Vg k="RTEE_CLARITY" /> extension.

#### `createProcessor`
Create an `ISuperClarityProcessor` instance.
```ts
createProcessor(): ISuperClarityProcessor;
```

#### `enable`
Turn on the <Vg k="RTEE_CLARITY" /> function.

```ts
enable(): void | Promise<void>;
```

#### `disable`

Stop the <Vg k="RTEE_CLARITY" />  function.

```ts
disable(): void | Promise<void>;
```

#### `release`
Release all resources used by the extension.

```ts
release(): Promise<void>;
```

#### SDK APIs

- <Link to="{{global.API_REF_WEB_ROOT}}/interfaces/iagorartc.html#registerextensions">registerExtensions</Link>
- <Link to="{{global.API_REF_WEB_ROOT}}/interfaces/iremotevideotrack.html#pipe">pipe</Link>
- <Link to="{{global.API_REF_WEB_ROOT}}/interfaces/iremotevideotrack.html#unpipe">unpipe</Link>

</PlatformWrapper>

<PlatformWrapper notAllowed="web" >
**This extension is currently not available for <Vpl k="NAME" />**.
</PlatformWrapper>