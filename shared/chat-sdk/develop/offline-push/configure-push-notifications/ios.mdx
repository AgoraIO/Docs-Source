<PlatformWrapper platform="ios">

You can use extension fields to implement customized push settings, customized ringtones, notification bar collapse, forced push, silent message sending, and rich text push.

## Custom push fields

When creating a push message, you can add custom fields to the message:

```objective-c
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
    NSString* currentUsername = AgoraChatClient.sharedClient.currentUsername;
    NSString* conversationId = @"remoteId";
    AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId from:currentUsername to:conversationId body:body ext:nil];
    message.ext = @{@"em_apns_ext":@{@"extern":@{@"test":123}}};
    message.chatType = AgoraChatTypeChat;
    [AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```
The data structure of the custom field is as follows:

```json
{
    "em_apns_ext": {
      "extern": {"test": 123}
    }
}
```

| Parameters              | Description                 |
| :--------------- | :------------------ |
|  `em_apns_ext`   |     The built-in message extension fields.       |
|  `extern`        | The user-added custom key; multiple keys can be added. |

## Set certain group members to receive push notifications

In offline push is in the do not disturb mode, if you want only certain group members to receive offline push notifications when sending messages in a group, you can achieve this by setting the message extension field.

```Objective-C
AgoraChatTextMessageBody* body = [[AgoraChatTextMessageBody alloc] initWithText:@"hello"];
    AgoraChatMessage* msg = [[AgoraChatMessage alloc] initWithConversationID:@"groupId" body:body ext:nil];
    // When pushing to all members in the group, set to ` All` .
    msg.ext = @{@"em_apns_ext":@{@"em_at_list":@"All"}};
    //Push to the specified group members and set it as member list.
    msg.ext = @{@"em_apns_ext":@{@"em_at_list":@[@"userId1",@"userId2"]}};
    message.chatType = AgoraChatTypeGroupChat;
    [AgoraChatClient.sharedClient.chatManager sendMessage:msg progress:nil completion:nil];
```
The data structure of this extension field is as follows:
```json
{
    "em_apns_ext": {
        "em_at_list": "All"
    }
}
```

| Parameters              | Description                |
| :--------------- | :----------------- |
|  ` em_apns_ext` |     Built -in push extension fields. |
|  ` em_at_list` |           Built-in extension field key, the corresponding value is an array type, indicating the user ID of the group member who receives the push notification. Setting it to ` All` means pushing the notification to all group members   . |

## Set the notification bar to collapse

You can collapse multiple messages in the notification bar. The sample code is as follows:

```Objective-C
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId body:body ext:nil];
message.ext = @{@"em_apns_ext":@{@"em_push_collapse_key":@"collapseKey"}};
message.chatType = AgoraChatTypeChat;
[AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```
The data structure of the notification bar collapse field is as follows:
```json
{
    "em_apns_ext": {
        "em_push_collapse_key": "collapseKey"
    }
}
```

| Parameters              | Description                |
| :--------------- | :----------------- |
|  ` em_apns_ext` |     Built -in message extension fields.   |
|  ` em_push_collapse_key `    | Specifies a set of messages that can be collapsed (e.g. with collapse_key: "Updates Available") so that only the last message is sent when delivery is resumed, thus avoiding sending too many identical messages when the device comes back online or becomes active.    |

## Custom Ringtones

When creating a push message, you can customize the notification tone when the recipient receives the message. You need to add the audio file to the app and configure the audio file name used in the push. For details, see [ Apple official documentation ] ( https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/generating_a_remote_notification?language=objc ) .

```Objective-C
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
    AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId from:AgoraChatClient.sharedClient.currentUsername to:conversationId body:body ext:nil];
    message.ext = @{@"em_apns_ext":@{@"em_push_sound":@"custom.caf"}};
    message.chatType = AgoraChatTypeChat;
    [AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```
The data structure of the custom ringtone field is as follows:
```json
{
  "ext": {
    "em_apns_ext": {
      "em_push_sound":"custom.caf"
    }
  }
}
```

| Parameters              | Description                  |
| :--------------- | :------------------- |
|  ` em_apns_ext` |     Built -in message extension fields.        |
|  ` em_push_sound` | Key of   the custom reminder ringtone field. This field is a built-in field and the field name cannot be modified.     |
|  ` custom.caf `      | The name of the audio file for the ringtone. |

## Force push

After setting up forced push, the user will ignore the recipient's do not disturb setting when sending messages, and the message will be pushed to the recipient normally regardless of whether it is in the do not disturb time period.

```Objective-C
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId from:AgoraChatClient.sharedClient.currentUsername to:conversationId body:body ext:nil];
// Set whether to force push. This extension field is a built-in field with the following values: ` YES ` : forced push; (default) ` NO ` : non-forced push.
message.ext = @{@"em_force_notification":@YES};
message.chatType = AgoraChatTypeChat;
[AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```
## Send a silent message
Sending silent messages means that the sender sets the message not to be pushed when sending a message. That is, when the user is offline, the IM service will not push message notifications to the user's device through the third-party vendor's message push service. Therefore, the user will not receive message push notifications. When the user goes online again, he will receive all the messages during the offline period.
Both silent message sending and do not disturb mode do not push messages. The difference is that silent message sending is set by the sender when sending the message, while do not disturb mode is set by the receiver not to receive push notifications within a specified time period.
```Objective-C
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId from:AgoraChatClient.sharedClient.currentUsername to:conversationId body:body ext:nil];
// Set whether to send silent messages. This field is a built-in extension field with the following values: `YES`: send silent messages; (default) `NO`: push the message.
message.ext = @{@"em_ignore_notification":@YES};
message.chatType = AgoraChatTypeChat;
[AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```

## Realize rich text push

If your target platform is iOS 10.0 or above, you can refer to the following code to implement the rich text push function of [ ` UNNotificationServiceExtension ` ] ( https://developer.apple.com/documentation/usernotifications/unnotificationserviceextension?language=objc ) .

```Objective-C
AgoraChatTextMessageBody *body = [[AgoraChatTextMessageBody alloc] initWithText:@"test"];
AgoraChatMessage *message = [[AgoraChatMessage alloc] initWithConversationID:conversationId from:AgoraChatClient.sharedClient.currentUsername to:conversationId body:body ext:nil];
// em_apns_ext: message extension field
message.ext = @{@"em_apns_ext":@{@"em_push_mutable_content":@YES}};
message.chatType = AgoraChatTypeChat;
[AgoraChatClient.sharedClient.chatManager sendMessage:message progress:nil completion:nil];
```
| Parameters | Description |
| :------------------------ | :----------------------------- |
| `body` | Push message content. |
| `conversationId` | The conversation ID to which the message belongs. |
| `from` | The user ID of the sender of the message. |
| `to` | The user ID of the message recipient. |
| `em_apns_ext` | Built-in message extension fields. |
| `em_push_mutable_content` | Whether to use rich text push notification (`em_apns_ext`): <ul><li>`YES`: rich text push notification; </li><li>(Default)`NO`: normal push notification. </li></ul><br/>This field is a built-in field and the field name cannot be modified. |
When the receiver receives a rich text push, it will enter the callback `didReceiveNotificationRequest:withContentHandler:`. The sample code is as follows:
```Objective-C
- (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent * _Nonnull))contentHandler {
    // Push extension fields
    NSDictionary *userInfo = request.content.userInfo;
    // Notification content
    UNNotificationContent *content = [request.content mutableCopy];
    contentHandler(content);
}
```

| Parameters               | Description                                                |
| :---------------- | :------------------------------------------------- |
|  ` body` |             Push message content                                      . |
|  ` badge `            | Square badge number.                                            |
|  ` sound `            | The recipient will hear a ring tone when receiving the message.                                          |
|  ` mutable-content `  | Set to ` 1 ` to activate ` UNNotificationServiceExtension ` . |
|  ` f `                | The user ID of the message sender.                                  |
|  ` t `                | The user ID of the message recipient.                                  |
|  ` m` |                The message ID.                                           |

</PlatformWrapper>