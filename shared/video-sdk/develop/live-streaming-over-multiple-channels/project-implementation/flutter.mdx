<PlatformWrapper platform="flutter">

This section shows you how to implement the following methods of multi-channel streaming:

-   [Channel media relay](#channel-media-relay)

-   [Join multiple channels](#implement-joining-multiple-channels)

Choose the method that best suits your scenario and follow the step by step procedure.

### Channel media relay

In this example, you use a single `Button` to start and stop channel media relay.

#### Implement the user interface

To enable your users to start and stop relaying to another channel, add a `Button` to the user interface. Open `/lib/main.dart` and add the following lines after `ListView(...children: [` in the `build` method:
``` dart
ElevatedButton(
    child: relayState == ChannelMediaRelayState.relayStateRunning
        ? const Text("Stop Channel media relay")
        : relayState == ChannelMediaRelayState.relayStateConnecting
            ? const Text("Channel media relay connecting ...")
            : const Text("Start media relay"),
    onPressed: () => {channelRelay()},
),
```

#### Implement channel media relay

To enable <Vpl k="CLIENT" /> users to relay channel media to a destination channel, take the following steps:

1.  **Declare the variables you need**

    To store source and destination channel settings and manage channel relay, in `/lib/main.dart`, add the following variable declarations to the `_MyAppState` class:

    ``` dart
    String destChannelName = "<name of the destination channel>";
    String destChannelToken = "<access token for the destination channel>";    
    int destUid = 0; // Uid to identify the relay stream in the destination channel
    String sourceChannelToken =  "<access token for the source channel>"; // Generate with the channelName and uid = 0.
    bool mediaRelaying = false;
    ChannelMediaRelayState relayState = ChannelMediaRelayState.relayStateIdle;
    ```

1.  **Start or stop channel media relay**

    When a user presses the button, the <Vpl k="CLIENT" /> starts relaying media from the source channel to the destination channel. If channel media relay is already running, the <Vpl k="CLIENT" /> stops it. To integrate this workflow, add the following method to the `_MyAppState` class.

    ``` dart
    void channelRelay() async {
        if (mediaRelaying) {
            agoraEngine.stopChannelMediaRelay();
        } else {
            // Define the channel media relay configuration
            ChannelMediaRelayConfiguration mediaRelayConfiguration =
                ChannelMediaRelayConfiguration(
                    srcInfo: ChannelMediaInfo(
                        channelName: channelName, // Default value is NULL, which means the SDK applies the name of the current channel
                        uid: 0, // You must set it as 0 which means the SDK generates a random uid
                        token: sourceChannelToken // token generated with the channelName and uid in srcInfo
                    ), //
                    destInfos: [
                        ChannelMediaInfo(
                            channelName: destChannelName, // The name of the destination channel
                            uid: destUid, // The Uid to identify the relay stream in the destination channel
                            token: destChannelToken // Token generated with the channelName and uid in destInfos
                        )
                    ],
                    destCount: 1);

            // Start relaying media streams across channels
            agoraEngine.startChannelMediaRelay(mediaRelayConfiguration);
        }
    }
    ```

1.  **Monitor the channel media relay state**

    To receive notification of connection state changes during channel media relay, you add an event handler. Your <Vpl k="CLIENT" /> responds to connection and failure events in the `onChannelMediaRelayStateChanged` event. In `setupVideoSDKEngine()`, add the following code after `RtcEngineEventHandler(`:

    ``` dart
    onChannelMediaRelayStateChanged: (ChannelMediaRelayState state, ChannelMediaRelayError error) {
        setState(() {
            relayState = state;
        });

        if (state == ChannelMediaRelayState.relayStateRunning) {
            mediaRelaying = true;
            showMessage("Channel media relay running.");
        } else {
            mediaRelaying = false;
            showMessage("Relay state:\n" + state.toString()) + "\n" + error.toString() ;
        }
    },
    ```

1.  **Monitor channel media relay events**

    To receive notifications of important channel relay events such as network disconnection, reconnection, and users joining channels, you add the `onChannelMediaRelayEvent` method to the event handler. In `setupVideoSDKEngine()`, add the following code after `RtcEngineEventHandler(`:

    ``` dart
    onChannelMediaRelayEvent: (ChannelMediaRelayEvent mediaRelayEvent) {
        // This example shows messages when relay events occur.
        // A production level app needs to handle these events properly.
        showMessage(mediaRelayEvent.toString());
    },
    ```

### Join multiple channels

The alternate approach to multi-channel live streaming is joining multiple channels. In this section, you learn how to implement joining a second channel in your <Vpl k="CLIENT" />.

#### Implement the user interface

In this example, you use a single `Button` to join and leave a second channel. To add the `Button`, in `/app/res/layout/activity_main.xml`, add the following code before `</RelativeLayout>`:

``` xml
<Button
    android:id="@+id/secondChannelButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_below="@+id/LeaveButton"
    android:layout_alignEnd="@id/LeaveButton"
    android:layout_alignStart="@id/JoinButton"
    android:onClick="joinSecondChannel"
    android:text="Join second channel" />
```

#### Handle the system logic

In your project, import the relevant libraries and declare the required variables.

1.  **Add the required libraries**

    To connect to multiple channels and access the UI elements, import the corresponding <Vg k="COMPANY" /> and Android libraries. In `/app/java/com.example.<projectname>/MainActivity`, add the
    following to the list of `import` statements:

    ``` dart
    import io.agora.rtc2.RtcConnection;
    import io.agora.rtc2.RtcEngineEx;

    import android.widget.Button;
    ```

2.  **Declare the variables you need**

    To join and manage a second channel, in `/app/java/com.example.<projectname>/MainActivity`, add the
    following declarations to the `_MyAppState` class:

    ``` dart
    private Button secondChannelButton;
    private RtcConnection rtcSecondConnection;
    private String secondChannelName = "<name of the second channel>";
    private int secondChannelUid = 100; // Uid for the second channel
    private String secondChannelToken = "<access token for the second channel>";
    private boolean isSecondChannelJoined = false; // Track connection state of the second channel
    ```

3.  **Enable the user to join another channel**

    1.  In the `onCreate` method of the `_MyAppState` class, add the following lines after `setupVideoSDKEngine();`:

        ``` dart
        secondChannelButton = findViewById(R.id.secondChannelButton);
        secondChannelButton.setEnabled(false);
        ```

    2.  Enable this button when a user joins the initial channel. Add the following line to the `joinChannel` method after `isJoined = true;`:

        ``` dart
        secondChannelButton.setEnabled(true);
        ```

#### Implement joining multiple channels

To add multi-channel functionality to your <Vpl k="CLIENT" />, take the following steps:

1.  **Use the multi-channel enabled `RtcEngineEx` interface**

    In the Get Started code, the <Vg k="ENGINE" /> instance was declared as `RtcEngine`. To implement multi-channel functionality, you use the multi-channel interface of the <Vg k="ENGINE" /> `RtcEngineEx`. In order to
    switch to the multi-user interface, do the following:

    1.  In the `_MyAppState` class, replace the declaration `private RtcEngine agoraEngine;` with:

        ``` dart
        private RtcEngineEx agoraEngine;
        ```

    2.  In the `setupVideoSDKEngine` method, replace the line `agoraEngine = RtcEngine.create(config);` with the following:

        ``` dart
        agoraEngine = (RtcEngineEx) RtcEngine.create(config);
        ```

2.  **Join a second channel**

    When a user presses the button, the <Vpl k="CLIENT" /> joins a second channel. If the <Vpl k="CLIENT" /> is already connected to a second channel, it leaves the channel. To do this, add the following method to the
    `_MyAppState` class.

    ``` dart
    public void joinSecondChannel(View view) {

        if (isSecondChannelJoined) {
            agoraEngine.leaveChannelEx(rtcSecondConnection);

        } else {
            ChannelMediaOptions mediaOptions = new ChannelMediaOptions();

            if (audienceRole.isChecked()) { // Audience Role
                mediaOptions.autoSubscribeAudio = true;
                mediaOptions.autoSubscribeVideo = true;
                mediaOptions.clientRoleType = Constants.CLIENT_ROLE_AUDIENCE;
            } else { // Host Role
                mediaOptions.publishCameraTrack = true;
                mediaOptions.publishAudioTrack = true;
                mediaOptions.channelProfile = Constants.CHANNEL_PROFILE_LIVE_BROADCASTING;
                mediaOptions.clientRoleType = Constants.CLIENT_ROLE_BROADCASTER;
            }

            rtcSecondConnection = new RtcConnection();
            rtcSecondConnection.channelId = secondChannelName;
            rtcSecondConnection.localUid = secondChannelUid;

            agoraEngine.joinChannelEx(secondChannelToken, rtcSecondConnection, mediaOptions, secondChannelEventHandler);
            isSecondChannelJoined = true;
        }
    }
    ```

3.  **Receive callbacks from the second channel**

    The `IRtcEngineEventHandler` implements channel callbacks. For the second channel, you create another instance of `IRtcEngineEventHandler` and register it with the <Vg k="ENGINE" /> when you
    join the channel using `joinChannelEx`. To create an instance named `secondChannelEventHandler`, add the following code to the `_MyAppState` class:

    ``` dart
    // Callbacks for the second channel
    private final IRtcEngineEventHandler secondChannelEventHandler = new IRtcEngineEventHandler() {
        @Override
        public void onJoinChannelSuccess(String channel, int uid, int elapsed) {
            showMessage(String.format("onJoinChannelSuccess channel %s uid %d", secondChannelName, uid));
            runOnUiThread(() -> {
                secondChannelButton.setText("Leave Second Channel");
            });
        }

        public void onLeaveChannel(RtcStats stats) {
            isSecondChannelJoined = false;
            showMessage("Left the channel " + secondChannelName);
            runOnUiThread(() -> {
                secondChannelButton.setText("Join Second Channel");
            });
        }

        @Override
        public void onUserJoined(int uid, int elapsed) {
            showMessage(String.format("user %d joined!", uid));

            // Create surfaceView for remote video
            remoteSurfaceView = new SurfaceView(getBaseContext());
            remoteSurfaceView.setZOrderMediaOverlay(true);

            FrameLayout container = findViewById(R.id.remote_video_view_container);

            // Add surfaceView to the container
            runOnUiThread(() -> {
                if (container.getChildCount() > 0) container.removeAllViews();
                container.addView(remoteSurfaceView);
            });

            // Setup remote video to render
            agoraEngine.setupRemoteVideoEx(new VideoCanvas(remoteSurfaceView,
                    VideoCanvas.RENDER_MODE_HIDDEN, uid), rtcSecondConnection);
            remoteSurfaceView.setVisibility(View.VISIBLE);
        }
    };
    ```

4.  **Update the `setupRemoteVideo` method**

    In this example, you display two remote videos from two different channels. To display a remote video in either frame, update the `setupRemoteVideo` method by doing the following:

    1.  Replace the `setupRemoteVideo(int uid)` method with the following:

        ``` dart
        private void setupRemoteVideo(int uid, FrameLayout container) {
            remoteSurfaceView = new SurfaceView(getBaseContext());
            remoteSurfaceView.setZOrderMediaOverlay(true);
            container.addView(remoteSurfaceView);
            agoraEngine.setupRemoteVideo(new VideoCanvas(remoteSurfaceView, VideoCanvas.RENDER_MODE_FIT, uid));
            remoteSurfaceView.setVisibility(View.VISIBLE);
        }
        ```

    2.  To update the `setupRemoteVideo` method call, in `onUserJoined` under `mRtcEventHandler`, replace `runOnUiThread(() -> setupRemoteVideo(uid));` with the following:

        ``` dart
        runOnUiThread(() -> setupRemoteVideo(uid,findViewById(R.id.local_video_view_container)));
        ```

    3.  For null safety, in `onUserOffline` under `mRtcEventHandler`, replace `runOnUiThread(() -> remoteSurfaceView.setVisibility(View.GONE));` with the following:

        ``` dart
        runOnUiThread(() -> {
            if (remoteSurfaceView != null) remoteSurfaceView.setVisibility(View.GONE);
        });
        ```
</PlatformWrapper>