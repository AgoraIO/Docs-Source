

<PlatformWrapper notAllowed="web">
This extension is for Web only.
</PlatformWrapper>

<PlatformWrapper platform="web">

The `agora-extension-virtual-background` extension is used together with the Agora Web SDK (v4.15.0 or later) to implement the virtual background feature. This feature allows users to blur their actual background, or replace it with a solid color, an image, or a video. This extension is applicable to scenarios such as online conferences, online classes, and live streaming. It helps to protect personal privacy and reduce the audience getting distracted.

### Features
|  Feature  |  Example |
| ---- | ---- |
|  Blurred background and image background   |   ![](https://web-cdn.agora.io/docs-files/1647325748630)   |
|   Video/Animated background   |   <video src="https://web-cdn.agora.io/docs-files/1654508267206" poster="https://web-cdn.agora.io/docs-files/1654571689670"  controls width="100%" height="auto">Your browser does not support the <code>video</code>  element.</video>   |

Click the <a href="https://webdemo.agora.io/virtualBackground/index.html" target="_blank">online demo</a> to try this feature out.

### Considerations

- This extension works best when there is only one user in the video captured by the camera.
- The browser support for the virtual background extension is as follows:
   - The extension is supported on desktop Chrome 91 and later versions. To get a better virtual background experience, Agora recommends using it on the latest version of desktop Chrome.
   - Agora does not recommend enabling the virtual background feature on Firefox and Safari browsers. Backgrounding the web app on Firefox may cause the video to freeze, while the performance on Safari could be poor due to the browser's own performance issues.
   - Agora does not recommend enabling the virtual background feature on mobile browsers.
- The virtual background feature has high performance requirements. Make sure your computer meets the following requirements (you can use [navigator.hardwareConcurrency ](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/hardwareConcurrency) and [navigator.deviceMemory ](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/deviceMemory) to check):
   - Intel i5 dual core CPU or better
   - 8 GB RAM or more
   - 64-bit operating system
- When using the extension on a laptop, Agora recommends choosing the high performance mode or the balanced mode. The battery saver mode might not suffice.
- As of v1.0.0-beta-3, the extension supports setting a video as the virtual background. The video must be in a format supported by the HTML `<video>` element. Additionally, Agora recommends the following tips:
	-  The video should have a similar resolution to the subject in the image and a reasonable bitrate.
	-  The video content should fit with a loop playback in order to create a more convincing animated background.
  - The video frame rate can be reduced to 15 fps or lower. Agora does not recommend using a video that has a frame rate higher than 30 fps.

## Understand the tech

A typical transmission pipeline in the Agora Web SDK consists of a chain of procedures, including capture, preprocessing, encoding, transmitting, decoding, post-processing, and playback. In the preprocessing stage, extensions can modify the audio and video data in the pipeline to implement features such as virtual background and noise cancellation.

![](https://web-cdn.agora.io/docs-files/1647326674232)

## Implementation

This section introduces how to use the <b>latest version</b> of the virtual background extension. Implementation for previous versions might be different. For details, see <a href="./release_extension_web_ng">Extension release notes</a>.

Integrate the virtual background extension, and implement the virtual background feature, as follows:

1. Refer to the appropriate Quickstart Guide to integrate the Web SDK (v4.15.0 or later) and implement the basic real-time communication functions in your project.

2. Integrate the [virtual background extension](https://www.npmjs.com/package/agora-extension-virtual-background) into your project via npm:

   1. To install the virtual background extension, run the following command :

      ```bash
      npm install agora-extension-virtual-background
      ```

   2. To import the virtual background extension, use any of the following methods:

      Method one: Add the following code to the JavaScript file:

      ```typescript
      import VirtualBackgroundExtension from "agora-extension-virtual-background";
      ```

      Method two: Use the Script tag in the HTML file. Once imported, the `VirtualBackgroundExtension` object can be used directly in JavaScript files.

      ```html
      <script src="./agora-extension-virtual-background.js"></script>
      ```

3. Dynamically load the Wasm dependency: The virtual background extension depends on a Wasm file. Find the Wasm file in `node_modules/agora-extension-virtual-background/wasms`. You need to publish the Wasm file to a CDN or static resource server. You need to pass in the URL of the Wasm file when calling `processor.init` in subsequent steps. The extension dynamically loads the Wasm file.

 <div class="alert note"><ul><li>If the host URL of the Wasm file is not the same as that of the web application, enable the CORS policy.</li><li>Do not put the Wasm file in an HTTP service, because loading HTTP resources in the HTTPS domain is blocked by browsers' security policy.</li></ul></div>

4. Register the virtual background extension: After calling `AgoraRTC.createClient`to create a client object, new a `VirtualBackgroundExtension` object and pass in the `VirtualBackgroundExtension` object when calling `AgoraRTC.registerExtensions`.

   ```typescript
   // Create a client object
   var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
   // Create a VirtualBackgroundExtension instance
   const extension = new VirtualBackgroundExtension();
   // Register the extension
   AgoraRTC.registerExtensions([extension]);
   ```

5. Initialize the virtual background extension:

   1. Call `extension.createProcessor` to create a `VirtualBackgroundProcessor` instance.

      ```typescript
      processor = extension.createProcessor();
      ```

   2. Call `processor.init` to initialize the extension. In this method, you need to pass in the URL of the Wasm module. If resource loading or extension initialization fails, this method throws an exception. Catch this exception, and handle it accordingly.

      ```typescript
      await processor.init("./assets/wasms");
      ```

   3. After creating a local camera track, call <Link to="{{GLOBAL.API_REF_WEB_ROOT}}/interfaces/ilocalvideotrack.html#pipe">`videoTrack.pipe`</Link> and specify  <Link to="{{GLOBAL.API_REF_WEB_ROOT}}/interfaces/ilocalvideotrack.html#processordestination">`videoTrack.processorDestination`</Link> to inject the extension into the SDK's media processing pipeline.
<div class="alert note"><ul><li>For better performance, Agora recommends that you use the extension on a single video track.</li><li>If you need two video tracks for preview purposes, create two <code>VirtualBackgroundProcessor</code> instances. </li></ul></div>

      ```typescript
      localTracks.videoTrack.pipe(processor).pipe(localTracks.videoTrack.processorDestination);
      ```

6. Call `processor.setOptions` to choose the virtual background type and make settings. Agora supports the following settings:

   - Set a solid color as the background: Set the `type` parameter as `"color"`, and set the `color` parameter.

      ```typescript
      processor.setOptions({type: 'color', color: '#00ff00'});
      ```

   - Set an image as the background: Set the `type` parameter as `"img"`, and set the `source` parameter to specify the image object.

      ```typescript
      processor.setOptions({type: 'img', source: HTMLImageElement});
      ```

   - Blur the user's original background: Set the `type` parameter as `"blur"` and set the `blurDegree` parameter to choose the blurring degree, low (`1`), medium (`2`), or high (`3`).

      ```typescript
      processor.setOptions({type: 'blur', blurDegree: 2});
      ```

   - Set a video as the background: Set the `type` parameter as `"video"`, and set the `source` parameter to specify the video object.

      ```typescript
      processor.setOptions({type: 'video', source: HTMLVideoElement});
      ```

7. Call `processor.enable` to enable the virtual background feature.

   ```typescript
   await processor.enable();
   ```

   If you do not call `setOptions` before calling this method, the default behavior of the SDK is to blur users' actual background with the blurring degree set as 1. After enabling the virtual background feature, to switch the virtual background type, just call `setOptions`.

8. When virtual background is not in use for a short period of time, call `processor.disable`.

9. When virtual background is not needed, call <Link to="{{GLOBAL.API_REF_WEB_ROOT}}/interfaces/ilocalvideotrack.html#unpipe">`videoTrack.unpipe`</Link> to remove the extension's processor from the current video track.

   ```typescript
   localTracks.videoTrack.unpipe()
   ```

10. To use virtual background again, use the `VirtualBackgroundProcessor` instance you created previously instead of creating a new one.

## Sample code

```typescript
import AgoraRTC from "agora-rtc-sdk-ng";
import VirtualBackgroundExtension from "agora-extension-virtual-background";

// Create a client object
var client = AgoraRTC.createClient({mode: "rtc", codec: "vp8"});
// Create a VirtualBackgroundExtension instance
const extension = new VirtualBackgroundExtension();
// Register the extension
AgoraRTC.registerExtensions([extension]);

let processor = null;
var localTracks = {
  videoTrack: null,
  audioTrack: null
};

// Initialization
async function getProcessorInstance() {
  if (!processor && localTracks.videoTrack) {
    // Create a VirtualBackgroundProcessor instance
    processor = extension.createProcessor();

      try {
        // Initialize the extension and pass in the URL of the Wasm file
        await processor.init("./assets/wasms");
        } catch(e) {
          console.log("Fail to load WASM resource!");return null;
          }
    // Inject the extension into the video processing pipeline in the SDK
    localTracks.videoTrack.pipe(processor).pipe(localTracks.videoTrack.processorDestination);
  }
  return processor;
}

// Join a channel
async function join() {
  // Add event listeners
  client.on("user-published", handleUserPublished);
  client.on("user-unpublished", handleUserUnpublished);

  [options.uid, localTracks.audioTrack, localTracks.videoTrack] = await Promise.all([
    // Join a channel
    client.join(options.appid, options.channel, options.token || null),
    // Create a local microphone track and camera track
    localTracks.audioTrack || AgoraRTC.createMicrophoneAudioTrack(),
    localTracks.videoTrack || AgoraRTC.createCameraVideoTrack({encoderConfig: '720p_4'})
  ]);

  // Play local tracks
  localTracks.videoTrack.play("local-player");
}

// Set a solid color as the background
async function setBackgroundColor() {
  if (localTracks.videoTrack) {
    document.getElementById("loading").style.display = "block";

    let processor = await getProcessorInstance();

    try {
      processor.setOptions({type: 'color', color: '#00ff00'});
      await processor.enable();
    } finally {
      document.getElementById("loading").style.display = "none";
    }

    virtualBackgroundEnabled = true;
  }
}

// Blur the user's actual background
async function setBackgroundBlurring() {
  if (localTracks.videoTrack) {
    document.getElementById("loading").style.display = "block";

    let processor = await getProcessorInstance();

    try {
      processor.setOptions({type: 'blur', blurDegree: 2});
      await processor.enable();
    } finally {
      document.getElementById("loading").style.display = "none";
    }

    virtualBackgroundEnabled = true;
  }
}

// Set an image as the background
async function setBackgroundImage() {
    const imgElement = document.createElement('img');

    imgElement.onload = async() => {
      document.getElementById("loading").style.display = "block";

      let processor = await getProcessorInstance();

      try {
        processor.setOptions({type: 'img', source: imgElement});
        await processor.enable();
      } finally {
        document.getElementById("loading").style.display = "none";
      }

      virtualBackgroundEnabled = true;
    }
    imgElement.src = '/images/background.png';
}
```

## API reference

### IVirtualBackgroundExtension

#### createProcessor

```typescript
createProcessor(): IVirtualBackgroundProcessor;
```

Creates an `VirtualBackgroundProcessor` instance.

#### checkCompatibility

```typescript
checkCompatibility(): boolean;
```

**Since v1.1.1**.

Checks whether the virtual background extension is supported on the current browser.


### IVirtualBackgroundProcessor

#### init

```typescript
init(wasmDir: string): Promise<void>;
```

Initializes the extension.

If the initialization of the extension fails due to the failure to access the Wasm file, this method throws an exception. Agora recommends that you disable the virtual background feature catching the exception.

If the Wasm file is deployed on third-party services such as CDN and OSS across domains, you need to enable cross-domain access. For example, when deploying Nginx servers across domains, to enable cross-domain access, add the following configurations:

```
add_header 'Access-Control-Allow-Origin' "$http_origin";
add_header 'Access-Control-Allow-Credentials' "true";
```

Parameters:

- `wasmDir`: The URL where the virtual background WASM module is located (without the `WASM` filename).

<a name="setoptions"></a>

#### setOptions

```typescript
setOptions(options: VirtualBackgroundEffectOptions): void;
```

Chooses the virtual background type, and sets parameters.

Parameters:

- `options`: The virtual background options. See [VirtualBackgroundEffectOptions](#virtualbackgroundeffectoptions).

#### enable

```typescript
enable(): void | Promise<void>;
```

Enables the virtual background feature.

If you do not call `setOptions` before calling this method, the default behavior of the SDK is to blur users' actual background with the blurring degree set as 1.

#### disable

```typescript
disable(): void | Promise<void>;
```

Disables the virtual background feature.

#### onoverload

```typescript
onoverload?: () => void;
```

When system performance cannot meet the processing requirements (processing the first 100 video frames takes over 100 milliseconds), the SDK triggers `onoverload`.

Agora recommends calculating the frequency at which `onoverload` is triggered. If the frequency is not high, ignore this event; if the frequency is high (for example, more than five times per minute), call `disable` in this event, or add a UI prompt to disable virtual background.

<div class="alert info">Ignore this event if you are using two or more <code>IVirtualBackgroundProcessor</code> instances.</div>

### Type definition

<a name="virtualbackgroundeffectoptions"></a>

#### VirtualBackgroundEffectOptions

Virtual background types and settings. Used in the [setOptions](#setoptions) method.

```typescript
export type VirtualBackgroundEffectOptions = {
  type: string,
  color?: string;
  source?: HTMLImageElement | HTMLVideoElement;
  blurDegree?: Number;
  fit?: 'contain' | 'cover' | 'fill';
};
```

Properties:

- `type`: String. Choose the virtual background type:
   - `"color"`: Sets a solid color as the background.
   - `"img"`: Sets an image as the background.
   - `"blur"`: Blurs the user's original background.
   - `"video"`: Sets a video as the animated background.

- `color`: String. When you set `type` as `"color"`, set this parameter to specify the color. The value must be a valid CSS color such as `"white"`, `"#00ff00"`, or ` "RGB(255, 0, 0)"`.

- `source`: The HTMLImageElement or HTMLVideoElement object. When you set `type` as `"img"` or `"video"`, you can set a custom background image or video through this parameter.

<div class="alert note"><li>If the error "texture bound to texture unit 2 is not renderable. It might be non-power-of-2 or have incompatible texture filtering (maybe)?" occurs, check whether the product of the picture's width and height is a multiple of 2.</li><li>Due to the restriction of browsers' security policy, if your background image resources are deployed across domains, you need to enable your servers' cross-domain permission and set the <code>crossOrigin</code> property of the <code> HTMLImageElement</code> object as <code>"anonymous"</code>.</li><li>Since it takes time to load the image in the<code> HTMLImageElement</code> object, Agora recommends calling <code>setOptions</code> in the <code>onload</code> callback of the <code> HTMLImageElement</code> object, otherwise, the background momentarily turns black.</li><li>If you set a video as the background, you need to set the video element to mute or loop through the <code>mute</code> and <code>loop</code> HTML attributes.</li></div>

- `blurDegree`: Number. When you set `type` as `"blur"`, set this parameter to choose the blurring degree:
   - `1`: Low
   - `2`: Medium
   - `3`: High
- `fit`: String. This property sets how the virtual background is resized to fit the container:
  - `"contain"`: The background is scaled to fit within the container while preserving its aspect ratio. If the aspect ratio of the background does not match the aspect ratio of the container, black bars appear on the top and bottom or to the left and right of the background.
  - `"cover"`: The background is scaled to fill the entire container while preserving its aspect ratio. If the aspect ratio of the background does not match the aspect ratio of the container, the background is clipped to fit.
  - `"fill"`: The background is stretched to fill the entire container.

</PlatformWrapper>