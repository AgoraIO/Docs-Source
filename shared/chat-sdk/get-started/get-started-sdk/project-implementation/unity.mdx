<PlatformWrapper platform="unity">
This section shows how to use the <Vpd k="SDK"/> to implement peer-to-peer messaging in your app, step by step.

### Create the UI

In the quick start <Vpl k="CLIENT"/>, you create a simple UI that consists of the following elements:

* A `Button - TextMeshPro` to log in or out of the <Vg k="CHAT_SERVER" />.
* An `Input Field - TextMeshPro` to specify the recipient user ID.
* An `Input Field - TextMeshPro` to enter a text message.
* A `Button - TextMeshPro` to send the text message.
* A scrollable layout to scroll all sent and received messages.
* A `Text - TextMeshPro` to display messages.

To implement this user interface, in your Unity project:

1. **Add a scroll view**

    1. In Unity Editor, right-click **Sample Scene**, then click **Game Object** > **UI** > **Scroll View**. A scroll view appears in the **Scene** Canvas.

        If you canâ€™t see the view clearly, in Unity, zoom out and rotate the scene.

    2. To adjust the scroll view size, in **Inspector**, change the following coordinates:

        * **Pos X** - 0
        * **Pos Y** - 0
        * **Width** - 250
        * **Height** - 300

1. **Add a login button**

    1. Right-click **Sample Scene**, then click **UI** > **Button - TextMeshPro**. A **TMP Importer** windows opens. Click **Import TMP Essentials**. You see your project imports the required TMP essentials in your project.

    1. In **Inspector**, rename **Button** to *joinBtn*, then change the following properties:

        * **Pos X** - 89
        * **Pos Y** - 160
        * **Width** - 70
        * **Height** - 30

    3. Select the **Text(TMP)** sub-item of **joinBtn**, and in **Inspector**, change **Text** to `Join`.

1. **Add a send button**

    1. Right-click **Sample Scene**, then click **UI** > **Button - TextMeshPro**. A button appears in the **Scene** Canvas.

    1. In **Inspector**, rename **Button** to *sendBtn*, then change the following properties:

        * **Pos X** - 97
        * **Pos Y** - -162
        * **Width** - 57
        * **Height** - 30

    1. Select the **Text(TMP)** sub-item of **sendBtn**, and in **Inspector**, change **Text** to `>>`.

1. **Add input fields to enter a message and a recipient user ID**

    1. Right-click **Sample Scene**, then click **UI** > **Input Field - TextMeshPro**. An input field appears in the **Scene** Canvas.

    2. In **Inspector**, rename **InputField (TMP)** to **Message**, and change the following coordinates:

        * **Pos X** - -27
        * **Pos Y** - -162
        * **Width** - 195
        * **Height** - 30

    1. Repeat the same procedure and add another input field called `userName`, then in **Inspector** change the following coordinates:

        * **Pos X** - -35
        * **Pos Y** - 160
        * **Width** - 180
        * **Height** - 30

1. **Add a label to display sent and received messages**

    1. Right-click **Sample Scene**, then click **UI** > **Text - TextMeshPro**. A label appears in the **Scene** Canvas.

    2. In **Inspector**, rename **Text(TMP)** to **myLabel**, and change the following coordinates:

        * **Pos X** - -9
        * **Pos Y** - 126
        * **Width** - 200
        * **Height** - 50

### Handle the system logic

Create a script file, add the necessary namespaces, and bind your script to the canvas*.

1. **Create a new script and import the Unity library**

    1. In **Project**, open **Assets** > **AgoraChat** > **Editor**. Right-click **Editor**, then click **Create** > **C# Script**. In **Assets**, you see the `NewBehaviourScript` file that you use to implement <Vpd k = "PRODUCT"/> in your <Vpl k = "CLIENT"/>.

    1. In **Inspector**, click **Open**. `NewBehaviourScript.cs` opens in your default text editor.


1.  **Import the relevant Agora and Unity classes**

    In `NewBehaviourScript.cs`, add the following lines after `using UnityEngine;`:

    ```csharp
    using UnityEngine.UI;
    using TMPro;
    using AgoraChat;
    using AgoraChat.MessageBody;
    ```

1. **Bind your script to the canvas**

    1. In `Assets/AgoraChat/Editor`, drag and drop `NewBehaviourScript.cs` to **Canvas** on the **Hierarchy**.

    1. Click **Inspector**, you see that your script is added to **Canvas**.
   
### Send and receive messages

When a user opens the app, you instantiate and initialize a `ChatClient`. When the user taps the **Join** button, the app logs in to the <Vg k="CHAT_SERVER" />. When a user types a message in the text box and then presses **Send**, the typed message is sent to the <Vg k="CHAT_SERVER" />. When the <Vpl k="CLIENT"/> receives a message from the server, the message is displayed in the message list. This simple workflow enables you to rapidly build a <Vpd k="NAME" /> client with basic functionality. 

The following figure shows the API call sequence for implementing this workflow.

![image](/images/chat/chat-call-logic-android.svg)

To implement this workflow in your <Vpl k="CLIENT" />, take the following steps:

1. **Declare variables**

    In the `NewBehaviourScript` class, add the following declarations:

   ```csharp
    private TMP_Text label;
    private string userId = "";
    private string token = ""; 
    private string appKey = "";
    private bool isJoined = false;
    ```

1. **Set up <Vpd k="NAME" /> when the app starts**

    When the app starts, you set up a `SDKClient` and callbacks to handle <Vpd k="NAME" /> events. To do this, replace the `Start` method in the `NewBehaviourScript` class with the following:

    ```csharp
    void Start()
    {
        label = GameObject.Find("myLabel").GetComponent<TextMeshProUGUI>();
        label.fontSize = 16;
        label.text = "";
        GameObject go = GameObject.Find("joinBtn");
        go.GetComponent<Button>().onClick.AddListener(joinLeave);
        go = GameObject.Find("sendBtn");
        go.GetComponent<Button>().onClick.AddListener(sendFirstMessage);
        setupChatSDK();
    }
    ```
   
1. **Instantiate the `SDKClient`**   

    To implement peer-to-peer messaging, you use <Vpd k="SDK" /> to initialize a `SDKClient` instance. In the `NewBehaviourScript` class, add the following method before `Start`.

    ```csharp
    void setupChatSDK()
    {
        // Gets your App Key from Agora Console.
        if(appKey == "") 
        {
            Debug.Log("You should set your AppKey first!");
            return;
        }
        Options options = new Options(appKey);
        // Initializes the Agora Chat SDK.
        options.UsingHttpsOnly = true;
        options.DebugMode = true;
        SDKClient.Instance.InitWithOptions(options);
    }
    ```

1.  **Handle and respond to <Vpd k="NAME" /> events**

     To receive notification of <Vpd k="NAME" /> events such as connection, disconnection, and token expiration, you use `IChatManagerDelegate` and `IConnectionDelegate`. When you receive the `onMessageReceived` notification, you display the message to the user. To implement these notifications in your <Vpl k = "CLIENT"/>, do the following:

    1. In the `NewBehaviourScript` class, add the following at the end of `setupChatSDK`:

        ```csharp
        SDKClient.Instance.ChatManager.AddChatManagerDelegate(this);
        ```

    1. Inherit `NewBehaviourScript` with the `IChatManagerDelegate` and `IConnectionDelegate` classes. In `NewBehaviourScript.cs`, add the following after `public class NewBehaviourScript : MonoBehaviour`:

        ```csharp
        ,IChatManagerDelegate,IConnectionDelegate 
        ```

    1. In the `NewBehaviourScript` class, add the following callbacks before `setupChatSDK`:

        ```csharp
        public void OnMessagesReceived(List<Message> messages)
        {
            foreach (Message msg in messages) 
            {
                if (msg.Body.Type == MessageBodyType.TXT)
                {
                    TextBody txtBody = msg.Body as TextBody;
                    string Msg = msg.From + ":" + txtBody.Text;
                    displayMessage(Msg, false);
                }
            }
        }
        public void OnCmdMessagesReceived(List<Message> messages)
        {
            // This callback is triggered only by the reception of a command message that is usually invisible to users.
        }
        public void OnMessagesRead(List<Message> messages)
        {
            // Occurs when a read receipt is received for a message.
        }
        public void OnMessagesDelivered(List<Message> messages)
        {
            // Occurs when a delivery receipt is received.
        }
        public void OnMessagesRecalled(List<Message> messages)
        {
            // Occurs when a received message is recalled.
        }
        public void OnReadAckForGroupMessageUpdated()
        {
            // Occurs when the read status updates of a group message is received.
        }
        public void OnGroupMessageRead(List<GroupReadAck> list)
        {
            // Occurs when a read receipt is received for a group message.
        }
        public void OnConversationsUpdate()
        {
            // Occurs when the number of conversations changes.
        }
        public void OnConversationRead(string from, string to)
        {
            // Occurs when the read receipt is received for a conversation.
        }
        public void MessageReactionDidChange(List<MessageReactionChange> list)
        {
            // Occurs when the reactions changed.
        }
        public void OnConnected()
        {
            Debug.Log("Connected");
        }	
        public void OnTokenExpired()
        {
            // Occurs when the token has expired.
        }	
        public void OnTokenWillExpire()
        {
            // Occurs when the token is about to expire.
        }
        public void OnAuthFailed()
        {
            // Occurs when the user is forced to log out of the current account due to an authentication failure.
        }
        public void OnKickedByOtherDevice()
        {
            // Occurs when the user is forced to log out of the current account from the current device due to login to another device.
        }
        public void OnLoginTooManyDevice()
        {
            // Occurs when the user is forced to log out of the current account because he or she reaches the maximum number of devices that the user can log in to with the current account.
        }
        public void OnChangedIMPwd()
        {
            // Occurs when the user is forced to log out of the current account because the login password is changed.
        }
        public void OnForbidByServer()
        {
            // Occurs when the current user account is banned.
        }
        public void OnRemovedFromServer()
        {
            // Occurs when the current user account is removed from the server.
        }
        public void OnLoggedOtherDevice()
        {
            // Occurs when the user logs in to another device with the current account.
        }
        public void OnDisconnected()
        {
            Debug.Log("Disconnected");
        }
        ```

1. **Log in to the <Vg k="CHAT_SERVER" />**  

    When a user presses **Join**, your <Vpl k="CLIENT"/> logs in to the <Vg k="CHAT_SERVER" />. When a user presses **Leave**, the <Vpl k="CLIENT"/> log out of the <Vg k="CHAT_SERVER" />. To implement this logic, in the `NewBehaviourScript` class, add the following method before `Start`:

    ```csharp
    public void joinLeave() 
    {
        if (isJoined) 
        {
             SDKClient.Instance.Logout(true, callback: new CallBack(
            onSuccess: () => 
            {
                Debug.Log("sign out sdk succeed");
            },
            onError: (code, desc) => 
            {
                Debug.Log($"sign out sdk failed, code: {code}, desc: {desc}");
            }));
            isJoined = false;
            GameObject.Find("joinBtn").GetComponentInChildren<TextMeshProUGUI>().text = "Join";
        }
        else
        {
            SDKClient.Instance.LoginWithAgoraToken(userId, token, callback: new CallBack(
            onSuccess: () => 
            {
                Debug.Log("sign in sdk succeed");
            },
            onError: (code, desc) => 
            {
                Debug.Log($"sign in sdk failed, code: {code}, desc: {desc}");
            }));
            isJoined = true;
            GameObject.Find("joinBtn").GetComponentInChildren<TextMeshProUGUI>().text = "Leave";
        }
    }
    ```

1. **Send a message**
    
    To send a message to the <Vg k="CHAT_SERVER" /> when a user presses the **Send** button, add the following method to the `NewBehaviourScript` class, before `Start`:

    ```csharp
    public void sendFirstMessage() 
    {
        string recipient = GameObject.Find("userName").GetComponent<TMP_InputField>().text;
        string Msg = GameObject.Find("Message").GetComponent<TMP_InputField>().text;
        if (Msg == "" || recipient == "") 
        {
            Debug.Log("You did not type your message");
            return;
        }
        Message msg = Message.CreateTextSendMessage(recipient, Msg);
        displayMessage(Msg, true);
        SDKClient.Instance.ChatManager.SendMessage(ref msg, new CallBack(
            onSuccess: () => 
            {
               Debug.Log($"send message succeed");
               GameObject.Find("Message").GetComponent<TMP_InputField>().text = "";
            },
            onError:(code, desc) => 
            {
                Debug.Log($"send message failed, code: {code}, desc: {desc}");
            }));
    }
    ```

7. **Display chat messages**
    
    To display the messages the current user has sent and received in your <Vpl k="CLIENT"/>, add the following method to the `NewBehaviourScript` class:

    ```csharp
    public void displayMessage(string messageText, bool isSentMessage) 
    {
        if (isSentMessage) 
        {
            label.text  += "<align=\"right\"><color=green>You: " + messageText + "</color>\n";
        } 
        else 
        {
            label.text  += "<align=\"left\"><color=blue>" + messageText + "</color>\n";
        }
    }
    ```

1. **Clean up the resources**

    When you quit the <Vpl k= "CLIENT"/>, it calls `OnApplicationQuit`. You use this method for clean up. To Implement the clean up logic, in the `NewBehaviourScript` class, add the following after `Start`:

    ```csharp
    void OnApplicationQuit()
    {
        SDKClient.Instance.ChatManager.RemoveChatManagerDelegate(this);
        SDKClient.Instance.Logout(true, callback: new CallBack(
            onSuccess: () => 
            {
                Debug.Log("sign out sdk succeed");
            },
            onError: (code, desc) => 
            {
                Debug.Log($"sign out sdk failed, code: {code}, desc: {desc}");
            }));
    }
    ```
</PlatformWrapper>
