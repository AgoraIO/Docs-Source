import Authorization from '@docs/shared/media-gateway/reference/rest-api/authorization.mdx';
import CodeBlock from '@theme/CodeBlock';
import PostmanLink from '@docs/shared/media-gateway/reference/rest-api/postman-link.mdx';
import RestAPILayout from '@site/src/components/rest-api/RestAPILayout'; 
import LeftColumn from '@site/src/components/rest-api/LeftColumn'; 
import RightColumn, { Section } from '@site/src/components/rest-api/RightColumn'; 
import ParameterList, { Parameter } from '@site/src/components/rest-api/ParameterList'; 
import PathParameter from '@site/src/components/rest-api/PathParameter'; 
import { Tabs, TabItem } from '@site/src/components/rest-api/Tabs';

<RestAPILayout>

  <LeftColumn
    title={frontMatter.title}
    method="PUT"
    endpoint="https://api.agora.io/:region/v1/projects/:appId/rtls/ingress/stream-templates/:templateId"
  >

This method creates or resets a flow configuration template.

In the template, you can configure transcoding parameters for video or audio streams, as well as parameters for mitigating network latency.

Up to 10 flow configuration templates can be created under an app ID, each with a unique `templatedId`. Specify the `templateId` when creating a template; if a template corresponding to this ID already exists, the existing template will be reset with the incoming body data.

There are two ways to use flow configuration templates, which can be used in combination:

- Specify a global template for the app ID: All streaming keys under the app ID will use this template by default.
- Specify a configuration template for a specific streaming key: When using this key to push streams, the specific template will be used.

<Admonition type="info" title="Note">By default, a template is not set for the app ID. That is, video transcoding is not enabled.</Admonition>

### Request

**Path parameters**

   <PathParameter name="appId" type="string" required={true}>
    The app ID provided by <Vg k="COMPANY"/> to each developer. After creating a project in <Vg k="CONSOLE"/>, you can get an app ID. The app ID is a unique identifier for a project.
   </PathParameter>
   <PathParameter name="region" type="string" required={true}>
    Create an area for pushing the streaming key. <Vg k="COMPANY"/> supports creation of stream keys by region. Currently, the following regions are supported: 
    <ul>
      <li>`na`: North America</li>
      <li>`eu`: Europe</li>
      <li>`ap`: Asia, except mainland China</li>
      <li>`cn`: Mainland China</li>
    </ul>
    <Admonition type="caution" title="Important">
    Make sure that: 
    <ul>
      <li>The `region` value is the same as for the input source stream.</li>
      <li>The domain names for setting the `region` parameter and streaming are the same. </li>
      <li>The `region` value is in lowercase.</li>
    </ul>
    </Admonition>   
   </PathParameter>
   <PathParameter name="templateId" type="string" required={true}>
   The flow configuration template ID. The value can only include the following characters: a-z, A-Z, 0-9, and the length cannot exceed 12 bytes. The value of the flow configuration template ID can be set according to your business use-case. For example, `"720p"` and `"1080p"` for different target resolutions, or `"gameA"` and `"gameB"`for different game use-cases.
   </PathParameter>

**Headers**

<ParameterList title="HEADER" required={true}>
  <Parameter name="X-Request-ID" type="UUID" required={true}>
    The UUID (Universally Unique Identifier) of the request. After passing in this field, the <Vg k="COMPANY"/> server will return this field in the response header. It is recommended to assign `X-Request-ID` a value. If no value is assigned, the <Vg k="COMPANY"/> server will automatically generate a UUID and pass it in.
  </Parameter>
  <Parameter name="Authorization" type="string" required={true}>
  <Authorization/>
  </Parameter>
</ParameterList>

**Request body**

The request body consists of a JSON Object type `settings` and includes the following fields:

<ParameterList title="BODY" required={false}>
  <Parameter name="transcoding" type="object" required={false}>
    Audio and video transcoding parameter configuration.
    <Parameter name="video" type="object" required={false}>
      Video transcoding parameters.
      <Parameter name="enabled" type="boolean" required={false}>
        Whether to enable video transcoding. Disabled by default.
      </Parameter>
      <Parameter name="mode" type="string" required={false}>
        The transcoding mode.
        <ul>
          <li><code>force</code> (default): Force transcoding.</li>
          <li><code>adaptive</code>: Adaptive transcoding.</li>
        </ul>
      </Parameter>
      <Parameter name="codec" type="string" required={false}>
        The codec format for transcoding. Supported values: <code>H.264</code> (default) and <code>VP8</code>.
      </Parameter>
      <Parameter name="width" type="number" required={false}>
        The width in the encoding resolution (0 to 1920). If <code>0</code>, follows source stream width.
      </Parameter>
      <Parameter name="height" type="number" required={false}>
        The height in the encoding resolution (0 to 1920). If <code>0</code>, follows source stream height.
      </Parameter>
      <Parameter name="fps" type="number" required={false}>
        The video encoding frame rate (0 to 60). If <code>0</code>, follows source stream frame rate.
      </Parameter>
      <Parameter name="simulcastStream" type="object" required={false}>
        Video stream configuration for low-quality stream.
        <Parameter name="width" type="number" required={false}>
          The width of the video stream (0 to 1920). Must be less than <code>video.width</code>. Defaults to <code>video.width / 2</code>.
        </Parameter>
        <Parameter name="height" type="number" required={false}>
          The height of the video stream (0 to 1920). Must be less than <code>video.height</code>. Defaults to <code>video.height / 2</code>.
        </Parameter>
        <Parameter name="fps" type="number" required={false}>
          The frame rate of the video stream (0 to 60). Must be â‰¤ <code>video.fps</code>. Defaults to 15.
        </Parameter>
        <Parameter name="bitrate" type="number" required={false}>
          The bitrate of the low-quality video stream (in Kbps). Must be less than <code>video.bitrate</code>. Defaults automatically.
        </Parameter>
      </Parameter>
      <Parameter name="bitrate" type="number" required={false}>
        Video encoding bitrate in Kbps. If <code>simulcastStream</code> is enabled, must be greater than <code>simulcastStream.bitrate</code>. Defaults automatically.
      </Parameter>
    </Parameter>
    <Parameter name="audio" type="object" required={false}>
      Audio transcoding parameters.
      <Parameter name="enabled" type="boolean" required={false}>
        Whether to enable audio transcoding. Enabled by default.
      </Parameter>
      <Parameter name="profile" type="number" required={false}>
        Encoded audio profile. Default is <code>0</code> (48 KHz, music encoding, mono, max 64 Kbps). Contact support for other profiles.
      </Parameter>
      <Parameter name="bitrate" type="number" required={false}>
        Encoding bitrate in Kbps (64-320). Defaults based on <code>profile</code>.
      </Parameter>
    </Parameter>
  </Parameter>
  <Parameter name="jitterBuffer" type="object" required={false}>
    Network jitter buffer (effective only when video transcoding is enabled).
    <Parameter name="size" type="number" required={false}>
      Maximum length in ms. Default: 500 ms (adds delay to reduce lag caused by network jitter).
    </Parameter>
    <Parameter name="maxSize" type="number" required={false}>
      Maximum length in ms. Default: 1000 ms. Must be greater than <code>jitterBuffer.size</code>. If exceeded, acceleration is enabled.
    </Parameter>
  </Parameter>
</ParameterList>

### Response

**Headers**

<ParameterList title="HEADER" required={true}>
  <Parameter name="X-Request-ID" type="string" required={true}>
  The UUID (Universally Unique Identifier) of the request. The value is in its `X-Request-ID` header. If a request error occurs, print the value in the log to troubleshoot the problem. A `401 (Unauthorized)` response status code means that there is no such field in the response header.
  </Parameter>
</ParameterList>

**Response body**

If the status code is `200`, the request succeeds, and the response body includes the following parameters:

<ParameterList title="BODY" required={true}>
  <Parameter name="status" type="string" required={true}>
    The status of this request. <code>success</code> means the request succeeds.
  </Parameter>
</ParameterList>

If the status code is not `200`, the request fails. See the `message` field in the response body for the reason for this failure. For details about possible response status codes, see [Response status codes](../../response-status-codes).

<PostmanLink />

</LeftColumn>
<RightColumn>
<Section title="Authorization">
The endpoint requires [RESTful Authentication](/media-gateway/reference/restful-authentication#implement-basic-http-authentication).
</Section>
<Section title="Request example">
  <Tabs groupId="code-examples">
    <TabItem value="cURL" label="cURL" default>
    ```shell
    curl --location -g --request PUT 'https://api.agora.io/{{region}}/v1/projects/{{appId}}/rtls/ingress/stream-templates/{{templateId}}' \
    --data '{
        "settings": {
            "transcoding": {
                "video": {
                    "enabled": true,
                    "codec": "H.264",
                    "width": 1280,
                    "height": 720,
                    "fps": 24,
                    "bitrate": 2200,
                    "simulcastStream": {
                        "width": 960,
                        "height": 540,
                        "fps": 24,
                        "bitrate": 1670
            }
                },
                "audio": {
                    "enabled": false,
                    "profile": 3
                }
            },
            "jitterBuffer": {
                "size": 500,
                "maxSize": 800
            }
        }
    }'
    ```
    </TabItem>
    <TabItem value="node" label="Node" default>
    ```js
    const url = `https://api.agora.io/${region}/v1/projects/${appId}/rtls/ingress/stream-templates/${templateId}`;

    const data = {
        settings: {
            transcoding: {
                video: {
                    enabled: true,
                    codec: "H.264",
                    width: 1280,
                    height: 720,
                    fps: 24,
                    bitrate: 2200,
                    simulcastStream: {
                        width: 960,
                        height: 540,
                        fps: 24,
                        bitrate: 1670
                    }
                },
                audio: {
                    enabled: false,
                    profile: 3
                }
            },
            jitterBuffer: {
                size: 500,
                maxSize: 800
            }
        }
    };

    fetch(url, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "Authorization": "Basic <Base64EncodedCredentials>"
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error("Error:", error));
    ```
    </TabItem>
    <TabItem value="python" label="Python" default>
    ```python
    url = f"https://api.agora.io/{region}/v1/projects/{appId}/rtls/ingress/stream-templates/{templateId}"

    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": "Basic <Base64EncodedCredentials>"
    }

    data = {
        "settings": {
            "transcoding": {
                "video": {
                    "enabled": True,
                    "codec": "H.264",
                    "width": 1280,
                    "height": 720,
                    "fps": 24,
                    "bitrate": 2200,
                    "simulcastStream": {
                        "width": 960,
                        "height": 540,
                        "fps": 24,
                        "bitrate": 1670
                    }
                },
                "audio": {
                    "enabled": False,
                    "profile": 3
                }
            },
            "jitterBuffer": {
                "size": 500,
                "maxSize": 800
            }
        }
    }

    response = requests.put(url, headers=headers, data=json.dumps(data))
    ```
    </TabItem>
  </Tabs>

</Section>
<Section title="Response example">
```json
{
  "status": "success"
}
```
</Section>
</RightColumn>
</RestAPILayout>
