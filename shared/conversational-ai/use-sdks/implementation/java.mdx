import CodeBlock from '@theme/CodeBlock';

This section introduces the core Java code for building the <Vpd k="AGENT" />.

    <details>

    If you want to run the sample quickly without diving into the implementation details:

    1. Copy the complete example code below into your `Main.java` file.
    2. Configure the required parameters as described in the second step.
    3. Skip to the [Test the Agent](#test-the-agent) section to continue.

    <summary>Complete `Main.java` example</summary>
    <CodeBlock language="java" showLineNumbers>
    {`package io.agora;

    import io.agora.rest.AgoraException;
    import io.agora.rest.core.BasicAuthCredential;
    import io.agora.rest.core.Credential;
    import io.agora.rest.core.DomainArea;
    import io.agora.rest.services.convoai.ConvoAIClient;
    import io.agora.rest.services.convoai.ConvoAIConfig;
    import io.agora.rest.services.convoai.ConvoAIServiceRegionEnum;
    import io.agora.rest.services.convoai.req.JoinConvoAIReq;
    import io.agora.rest.services.convoai.req.ListConvoAIReq;
    import io.agora.rest.services.convoai.res.JoinConvoAIRes;
    import io.agora.rest.services.convoai.res.ListConvoAIRes;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;

    import java.util.ArrayList;
    import java.util.HashMap;
    import java.util.Map;

    public class Main {
        private static final Logger logger = LoggerFactory.getLogger(Main.class);

        // Agora configuration parameters
        public static final String APP_ID = "<your appId>";
        public static final String CNAME = "<your cname>";
        public static final String AGENT_RTC_UID = "<your agent rtc uid>";
        public static final String USERNAME = "<the username of basic auth credential>";
        public static final String PASSWORD = "<the password of basic auth credential>";
        public static final String AGENT_RTC_TOKEN = "<your agent rtc token>";

        // LLM configuration parameters
        public static final String LLM_URL = "<your LLM URL>";
        public static final String LLM_API_KEY = "<your LLM API Key>";
        public static final String LLM_MODEL = "<your LLM model>";

        // TTS configuration parameters (example uses Bytedance TTS)
        public static final String TTS_BYTEDANCE_TOKEN = "<your bytedance tts token>";
        public static final String TTS_BYTEDANCE_APP_ID = "<your bytedance tts app id>";
        public static final String TTS_BYTEDANCE_CLUSTER = "<your bytedance tts cluster>";
        public static final String TTS_BYTEDANCE_VOICE_TYPE = "<your bytedance tts voice type>";

        public static void main(String[] args) throws Exception {
            Credential credential = new BasicAuthCredential(USERNAME, PASSWORD);
            ConvoAIConfig config = ConvoAIConfig.builder()
                    .appId(APP_ID)
                    .credential(credential)
                    .domainArea(DomainArea.CN)
                    .serverRegion(ConvoAIServiceRegionEnum.CHINESE_MAINLAND)
                    .build();

            ConvoAIClient convoAIClient = ConvoAIClient.create(config);

            String name = APP_ID + ":" + CNAME;

            JoinConvoAIRes joinConvoAIRes;
            try {
                joinConvoAIRes = convoAIClient.join(JoinConvoAIReq.builder()
                        .name(name)
                        .properties(JoinConvoAIReq.Properties.builder()
                                .token(AGENT_RTC_TOKEN)
                                .channel(CNAME)
                                .agentRtcUId(AGENT_RTC_UID)
                                .remoteRtcUIds(new ArrayList<String>() {{
                                    add("*");
                                }})
                                .enableStringUId(false)
                                .idleTimeout(120)
                                .advancedFeatures(JoinConvoAIReq.AdvancedFeatures.builder()
                                        .enableAIVad(true)
                                        .build())
                                .llmPayload(JoinConvoAIReq.LLMPayload.builder()
                                        .url(LLM_URL)
                                        .apiKey(LLM_API_KEY)
                                        .params(new HashMap<String, Object>() {{
                                            put("model", LLM_MODEL);
                                            put("max_tokens", 1024);
                                            put("username", "Jack");
                                        }})
                                        .systemMessages(new ArrayList<Map<String, Object>>() {{
                                            add(new HashMap<String, Object>() {{
                                                put("content", "You are a helpful chatbot.");
                                                put("role", "system");
                                            }});
                                        }})
                                        .maxHistory(30)
                                        .greetingMessage("Hello, how can I help you?")
                                        .build())
                                .ttsPayload(JoinConvoAIReq.TTSPayload.builder()
                                        .vendor(JoinConvoAIReq.TTSVendorEnum.BYTEDANCE)
                                        .params(JoinConvoAIReq.BytedanceTTSVendorParams.builder()
                                                .token(TTS_BYTEDANCE_TOKEN)
                                                .cluster(TTS_BYTEDANCE_CLUSTER)
                                                .voiceType(TTS_BYTEDANCE_VOICE_TYPE)
                                                .appId(TTS_BYTEDANCE_APP_ID)
                                                .speedRatio(1.0F)
                                                .volumeRatio(1.0F)
                                                .pitchRatio(1.0F)
                                                .emotion("happy")
                                                .build())
                                        .build())
                                .vadPayload(JoinConvoAIReq.VADPayload.builder()
                                        .interruptDurationMs(160)
                                        .prefixPaddingMs(300)
                                        .silenceDurationMs(480)
                                        .threshold(0.5F)
                                        .build())
                                .asrPayload(JoinConvoAIReq.ASRPayload.builder()
                                        .language("zh-CN")
                                        .build())
                                .build())
                        .build()).block();
            } catch (AgoraException e) {
                logger.error("Failed to start the agent, err: {}", e.getMessage());
                return;
            } catch (Exception e) {
                logger.error("Unknown exception, err: {}", e.getMessage());
                return;
            }

            if (joinConvoAIRes == null) {
                logger.error("Failed to start the agent");
                return;
            }

            logger.info("Started the agent successfully, joinConvoAIRes: {}", joinConvoAIRes);

            String agentId = joinConvoAIRes.getAgentId();

            Thread.sleep(3000);

            // List active agents
            ListConvoAIRes listConvoAIRes;
            try {
                listConvoAIRes = convoAIClient.list(ListConvoAIReq.builder()
                        .channel(CNAME)
                        .state(2) // 2 = running
                        .build()).block();
            } catch (AgoraException e) {
                logger.error("Failed to list the agent, err: {}", e.getMessage());
                return;
            } catch (Exception e) {
                logger.error("Unknown exception, err: {}", e.getMessage());
                return;
            }

            if (listConvoAIRes == null) {
                logger.error("Failed to list the agent");
                return;
            }

            logger.info("Listed agents successfully, listConvoAIRes: {}", listConvoAIRes);

            Thread.sleep(120000);

            // Stop the agent
            try {
                convoAIClient.leave(agentId).block();
                logger.info("Stopped the agent successfully, agentId: {}", agentId);
            } catch (AgoraException e) {
                logger.error("Failed to stop the agent, err: {}", e.getMessage());
            } catch (Exception e) {
                logger.error("Unknown exception, err: {}", e.getMessage());
            }
        }
    }`}
    </CodeBlock>
    </details>


Follow these steps to integrate a <Vpd k="AGENT" /> into your existing project:

1. **Import the required dependencies**

    In `Main.java`, add the following code to import the required dependencies:

    <CodeBlock language="java" showLineNumbers>
    {`package io.agora;

    import io.agora.rest.AgoraException;
    import io.agora.rest.core.BasicAuthCredential;
    import io.agora.rest.core.Credential;
    import io.agora.rest.core.DomainArea;
    import io.agora.rest.services.convoai.ConvoAIClient;
    import io.agora.rest.services.convoai.ConvoAIConfig;
    import io.agora.rest.services.convoai.ConvoAIServiceRegionEnum;
    import io.agora.rest.services.convoai.req.JoinConvoAIReq;
    import io.agora.rest.services.convoai.req.ListConvoAIReq;
    import io.agora.rest.services.convoai.res.JoinConvoAIRes;
    import io.agora.rest.services.convoai.res.ListConvoAIRes;
    import org.slf4j.Logger;
    import org.slf4j.LoggerFactory;

    import java.util.ArrayList;
    import java.util.HashMap;
    import java.util.Map;`}
    </CodeBlock>

2. **Add the required variables**

    The required configuration parameters fall into three categories:

    1. **Agora parameters**
        - `APP_ID`: Your <Vg k="COMPANY" /> App ID.
        - `CNAME`: The RTC channel name that the conversational agent will join. This should match the channel name used when generating the temporary token.
        - `AGENT_RTC_UID`: The user ID of the conversational agent in the RTC channel. By default, this is an `int` type UID.  
        > *Note:* If you want to use a `String` type UID, set `enableStringUid` to `true` in the later steps and use a string such as `"123"`.
        - `USERNAME` and `PASSWORD`: Your <Vg k="COMPANY" /> **Customer ID** and **Customer Secret**, used for Basic Authentication.
        - `AGENT_RTC_TOKEN`: The token used by the conversational agent to join the RTC channel. You can use a temporary token.

    2. **LLM (Large Language Model) parameters**
        - `LLM_URL`: The LLM API endpoint (callback URL).
        - `LLM_API_KEY`: Your LLM API Key.
        - `LLM_MODEL`: The name of the large language model to be used (e.g., `"gpt-3.5-turbo"`).


    3. **TTS (Text-to-Speech) parameters**
        The sample code uses **Bytedance TTS** (Volcano Engine) as an example. You can choose other TTS providers if preferred.

        - `TTS_BYTEDANCE_TOKEN`: Your Bytedance TTS authentication token.
        - `TTS_BYTEDANCE_APP_ID`: Your Bytedance App ID.
        - `TTS_BYTEDANCE_CLUSTER`: The cluster region for Bytedance TTS.
        - `TTS_BYTEDANCE_VOICE_TYPE`: The voice profile to use (e.g., `"female_voice_1"`).

    In the `Main.java` file, add the following variables:

    <CodeBlock language="java" showLineNumbers>
    {`// Agora parameter configuration
    public static final String APP_ID = "<your appId>";
    public static final String CNAME = "<your cname>";
    public static final String AGENT_RTC_UID = "<your agent rtc uid>";
    public static final String USERNAME = "<the username of basic auth credential>";
    public static final String PASSWORD = "<the password of basic auth credential>";
    public static final String AGENT_RTC_TOKEN = "<your agent rtc token>";

    // LLM parameter configuration
    public static final String LLM_URL = "<your LLM URL>";
    public static final String LLM_API_KEY = "<your LLM API Key>";
    public static final String LLM_MODEL = "<your LLM model>";

    // TTS parameter configuration (using Bytedance TTS as an example)
    public static final String TTS_BYTEDANCE_TOKEN = "<your bytedance tts token>";
    public static final String TTS_BYTEDANCE_APP_ID = "<your bytedance tts app id>";
    public static final String TTS_BYTEDANCE_CLUSTER = "<your bytedance tts cluster>";
    public static final String TTS_BYTEDANCE_VOICE_TYPE = "<your bytedance tts voice type>";`}
    </CodeBlock>

3. **Initialize a <Vpd k="AGENT" />**

    In the `main` method, follow these steps:

    1. Create a `BasicAuthCredential` instance to configure the HTTP Basic Authentication.
    2. Initialize a `ConvoAIConfig` instance with your <Vg k="COMPANY" /> App ID, credential, and regional settings.
    3. Use the configuration to create the <Vpd k="AGENT" /> REST client.

    To implement this logic, in the `Main.java` file, add the following method:

    <CodeBlock language="java" showLineNumbers>
    {`public static void main(String[] args) throws Exception {
        // Create HTTP Basic Auth credentials
        Credential credential = new BasicAuthCredential(USERNAME, PASSWORD);

        // Initialize REST Client configuration
        ConvoAIConfig config = ConvoAIConfig.builder()
                .appId(APP_ID)
                .credential(credential)
                .domainArea(DomainArea.CN)  // Use CN for China domain
                .serverRegion(ConvoAIServiceRegionEnum.CHINESE_MAINLAND) // Server region
                .build();

        // Create the Conversational AI engine REST Client
        ConvoAIClient convoAIClient = ConvoAIClient.create(config);

        // ... further logic follows
    }`}
    </CodeBlock>

4. **Start the conversational agent**

    You can use the `join` method to start a conversational agent by configuring LLM (Large Language Model) and TTS (Text-to-Speech) parameters. To implement this logic, in `Main.java`, add the following:
    <CodeBlock language="java" showLineNumbers>
    {`String name = APP_ID + ":" + CNAME;

    JoinConvoAIRes joinConvoAIRes;
    try {
        joinConvoAIRes = convoAIClient.join(JoinConvoAIReq.builder()
            .name(name)
            .properties(JoinConvoAIReq.Properties.builder()
                .token(AGENT_RTC_TOKEN)
                .channel(CNAME)
                .agentRtcUId(AGENT_RTC_UID)
                .remoteRtcUIds(List.of("*")) // Allow communication with all users in the channel
                .enableStringUId(false)
                .idleTimeout(120) // Auto-leave if idle for 120 seconds
                .advancedFeatures(JoinConvoAIReq.AdvancedFeatures.builder()
                    .enableAIVad(true) // Enable AI-based VAD
                    .build())
                
                // LLM configuration
                .llmPayload(JoinConvoAIReq.LLMPayload.builder()
                    .url(LLM_URL)
                    .apiKey(LLM_API_KEY)
                    .params(Map.of(
                        "model", LLM_MODEL,
                        "max_tokens", 1024,
                        "username", "Jack"
                    ))
                    .systemMessages(List.of(Map.of(
                        "content", "You are a helpful chatbotã€‚",
                        "role", "system"
                    )))
                    .maxHistory(30)
                    .greetingMessage("Hello, how can I help you?")
                    .build())
                
                // TTS configuration (Bytedance)
                .ttsPayload(JoinConvoAIReq.TTSPayload.builder()
                    .vendor(JoinConvoAIReq.TTSVendorEnum.BYTEDANCE)
                    .params(JoinConvoAIReq.BytedanceTTSVendorParams.builder()
                        .token(TTS_BYTEDANCE_TOKEN)
                        .cluster(TTS_BYTEDANCE_CLUSTER)
                        .voiceType(TTS_BYTEDANCE_VOICE_TYPE)
                        .appId(TTS_BYTEDANCE_APP_ID)
                        .speedRatio(1.0F)
                        .volumeRatio(1.0F)
                        .pitchRatio(1.0F)
                        .emotion("happy")
                        .build())
                    .build())

                // Voice Activity Detection (VAD)
                .vadPayload(JoinConvoAIReq.VADPayload.builder()
                    .interruptDurationMs(160)
                    .prefixPaddingMs(300)
                    .silenceDurationMs(480)
                    .threshold(0.5F)
                    .build())

                // ASR configuration
                .asrPayload(JoinConvoAIReq.ASRPayload.builder()
                    .language("zh-CN")
                    .build())

                .build())
            .build()).block();
    } catch (AgoraException e) {
        logger.error("Failed to start the agent, error: {}", e.getMessage());
        return;
    } catch (Exception e) {
        logger.error("Unknown exception, error: {}", e.getMessage());
        return;
    }

    if (joinConvoAIRes == null) {
        logger.error("Failed to start the agent");
        return;
    }

    logger.info("Agent started successfully, joinConvoAIRes: {}", joinConvoAIRes);

    String agentId = joinConvoAIRes.getAgentId(); // Save agent ID for later use`}
    </CodeBlock>

5. **List active agents**

    Use the `list` method to retrieve a list of currently running conversational agents. To implement this logic, in `Main.java`, add the following:

    <CodeBlock language="java" showLineNumbers>
    {`// Wait briefly to ensure the agent has started
    Thread.sleep(3000);

    // Prepare to list agents in the given channel and state
    ListConvoAIRes listConvoAIRes;
    try {
        listConvoAIRes = convoAIClient.list(ListConvoAIReq.builder()
            .channel(CNAME)    // RTC channel name
            .state(2)          // Agent state: 2 = running
            .build()).block();
    } catch (AgoraException e) {
        logger.error("Failed to list the agent, error: {}", e.getMessage());
        return;
    } catch (Exception e) {
        logger.error("Unknown exception, error: {}", e.getMessage());
        return;
    }

    if (listConvoAIRes == null) {
        logger.error("Failed to list the agent");
        return;
    }

    logger.info("Successfully listed agents, listConvoAIRes: {}", listConvoAIRes);`}
    </CodeBlock>


6. **Stop the agent**

    To ensure the conversational agent shuts down correctly when the program exits, use a deferred `leave` call. To implement this logic, add the following to `Main.java`:

    <CodeBlock language="java" showLineNumbers>
    {`Thread.sleep(120000);

    // Stop the agent
    try {
        convoAIClient.leave(agentId).block();
        logger.info("Leave the agent successfully, agentId:{}", agentId);
    } catch (AgoraException e) {
        logger.error("Failed to leave the agent,err:{}", e.getMessage());
    } catch (Exception e) {
        logger.error("Unknown exception,err:{}", e.getMessage());
    }`}
    </CodeBlock>
