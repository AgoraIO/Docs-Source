<PlatformWrapper platform="android">

### Implement the user interface

To create a simple interface for testing speech to text functionality you add two buttons to the UI. Open `/app/res/layout/activity_main.xml` and add the following lines before `</RelativeLayout>`:

```xml
<Button
    android:id="@+id/SpeechToTextButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_below="@id/LeaveButton"
    android:layout_alignStart="@id/remote_video_view_container"
    android:layout_alignEnd="@id/remote_video_view_container"
    android:onClick="SpeechToText"
    android:text="Start speech to text" />


<Button
    android:id="@+id/QuerySpeechToTextButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_below="@id/SpeechToTextButton"
    android:layout_alignStart="@id/remote_video_view_container"
    android:layout_alignEnd="@id/remote_video_view_container"
    android:onClick="query"
    android:text="Query speech to text" />
```

### Handle the system logic

1. **Integrate the `okhttp` library into your project**

    To do this, open `/Gradle Scripts/build.gradle (Module: <project name>.app)` and add the following line under `dependencies {`:

    ```groovy
    implementation 'com.squareup.okhttp3:okhttp:4.10.0'
    ```

1. **Import the required libraries**

    To call `HTTP` methods that start, stop, and query a speech-to-text task, add the following statements after the last `import` statement in `/app/java/com.example.<projectname>/MainActivity`.

    ```java
    import okhttp3.Call;
    import okhttp3.Callback;
    import okhttp3.MediaType;
    import okhttp3.OkHttpClient;
    import okhttp3.Request;
    import okhttp3.RequestBody;
    import okhttp3.Response;

    import java.io.IOException;
    import java.util.Base64;

    import org.json.JSONArray;
    import org.json.JSONException;
    import org.json.JSONObject;
    ```

1. **Define variables to manage a speech-to-text task**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following declarations to the `MainActivity` class:

    ```java
    private String baseUrl = "https://api.agora.io";
    private String apiKey = "<your API key from Agora console>";
    private String apiSecret = "<your API secret from Agora console>";
    private String instanceID = "Test-1";
    private String speechToTextTaskId = "";
    private String builderToken, authorizationHeader;
    private boolean isSpeechToTextRunning = false;
    private Button btnSpeechToText;
    ```

### Manage a speech-to-text task

1. **Get a `builderToken`**

    To use the speech to text RESTful API, you generate a Base64-encoded credential with the API key and secret provided by Agora. You add this credential to the request header as a parameter named `Authorization`. In the request body, you pass a parameter `instanceID` that you choose to identify the instance. To [acquire a `builderToken`](#acquire-a-buildertoken), add the following method to the `MainActivity` class:

    ```java
    public void getBuilderToken() throws IOException {
        String url = baseUrl + "/v1/projects/" + appId + "/rtsc/speech-to-text/builderTokens";
        // Concatenate the key and secret and use base64 encoding
        String plainCredentials = apiKey + ":" + apiSecret;
        String base64Credentials = new String(Base64.getEncoder()
            .encode(plainCredentials.getBytes()));

        // Create authorization header
        authorizationHeader = "Basic " + base64Credentials;
        OkHttpClient httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");

        RequestBody body = RequestBody.create("{\n \"instanceId\" : \""
            + instanceID + "\" \n}", mediaType);
        Request request = new Request.Builder()
            .addHeader("Authorization", authorizationHeader)
            .url(url)
            .method("POST", body)
            .build();

        httpClient.newCall(request)
            .enqueue(new Callback() {
                @Override
                public void onFailure(final Call call, IOException e) {
                    showMessage(e.toString());
                }

                @Override
                public void onResponse(Call call, final Response response) throws IOException {
                    String result = response.body().string();
                    String message = "";
                    try {
                        JSONObject jsonObject = new JSONObject(result);
                        if (response.isSuccessful()) {
                            builderToken = jsonObject.getString("tokenName");
                            showMessage("builderToken received" );
                            startSpeechToText();
                        } else {
                            message = jsonObject.getString("message");
                            showMessage("builderToken not received: " + message);
                        }
                    } catch (Exception e) {
                        showMessage("Exception fetching builderToken: " + e.toString());
                    }
                }
            });
    }
    ```

    A `builderToken` is usable for 5 minutes. After the time has expired, you must generate a new token.

1. **Start a speech-to-text task**

    To [start a speech-to-text task](#start-a-speech-to-text-task), you create a JSON configuration and pass it in the request body. You add the `builderToken` as a query parameter to the URL.
    To start a speech-to-text task, add the following method to the `MainActivity` class:

    ```java
    public void startSpeechToText() throws JSONException {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks?" + "builderToken=" + builderToken;
        // Build Request body JSON
        JSONObject startConfig = new JSONObject()
            .put("audio", new JSONObject()
                .put("subscribeSource", "AGORARTC")
                .put("agoraRtcConfig", new JSONObject()
                        .put("channelName", channelName)
                        .put("uid", String.valueOf(uid))
                        .put("token", token)
                        .put("channelType", "LIVE_TYPE")
                        .put("subscribeConfig", new JSONObject()
                                .put("subscribeMode", "CHANNEL_MODE"))
                        .put("maxIdleTime", 60)))
            .put("config", new JSONObject()
                .put("features", new JSONArray()
                        .put("RECOGNIZE"))
                .put("recognizeConfig", new JSONObject()
                    .put("language", "ENG")
                    .put("model", "Model")
                    .put("output", new JSONObject()
                            .put("destinations", new JSONArray()
                                .put("AgoraRTCDataStream")
                                .put("Storage"))
                            .put("agoraRTCDataStream", new JSONObject()
                                .put("channelName", channelName)
                                .put("uid", String.valueOf(uid))
                                .put("token", token))
                            .put("cloudStorage", new JSONArray()
                                .put(new JSONObject()
                                    .put("format", "HLS")
                                    .put("storageConfig", new JSONObject()
                                        .put("accessKey", "<YourOssAccessKey>")
                                        .put("secretKey", "<YourOssSecretKey>")
                                        .put("bucket", "<YourOssBucketName>")
                                        .put("vendor", 0) // Your Oss Vendor id
                                        .put("region", 0) // Your Oss Region id
                                        .put("fileNamePrefix", new JSONArray()
                                            .put("directory1")
                                            .put("directory2")
                                        )
                                    )
                                )
                            )
                    )
                )
            );

        OkHttpClient httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        RequestBody body = RequestBody.create(startConfig.toString(), mediaType);
        Request request = new Request.Builder()
            .addHeader("Authorization", authorizationHeader)
            .url(url)
            .method("POST", body)
            .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                if (response.isSuccessful()) {
                    try {
                        JSONObject jsonObject = new JSONObject(result);
                        String status = jsonObject.getString("status");
                        speechToTextTaskId = jsonObject.getString("taskId");
                        if (status.equals("IN_PROGRESS") || status.equals("STARTED")) {
                            isSpeechToTextRunning = true;
                            runOnUiThread(() -> btnSpeechToText.setText("Stop speech to text"));
                            showMessage("Speech to text started");
                        } else {
                            isSpeechToTextRunning = false;
                            showMessage("Speech to text status: " + status);
                        }
                    } catch (Exception e) {
                        Log.i("Error parsing start call response", result);
                    }
                } else {
                    showMessage("Exception starting speech-to-text task: " + result);
                }
            }
        }
        );
    }
    ```

1. **Query task status**

    You can [query the status](#query-the-status-of-speech-to-text) of a speech-to-text task to notify the user of a change. To do this, add the following method to the `MainActivity`class:

    ```java
    public void querySpeechToText() {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks/" + speechToTextTaskId
                + "?builderToken=" + builderToken;

        OkHttpClient httpClient = new OkHttpClient().newBuilder().build();
        Request request = new Request.Builder()
                .addHeader("Content-Type", "application/json")
                .addHeader("Authorization", authorizationHeader)
                .url(url)
                .get()
                .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                try {
                    JSONObject jsonObject = new JSONObject(result);
                    if (response.isSuccessful()) {
                        String status = jsonObject.getString("status");
                        speechToTextTaskId = jsonObject.getString("taskId");
                        if (status.equals("IN_PROGRESS")) {
                            isSpeechToTextRunning = true;
                            runOnUiThread(() -> btnSpeechToText.setText("Stop speech to text"));
                            showMessage("Speech to text is running");
                        } else {
                            isSpeechToTextRunning = false;
                            speechToTextTaskId = "";
                            showMessage("Speech to text status: " + status + "");
                            runOnUiThread(() -> btnSpeechToText.setText("Start speech to text"));
                        }
                    } else {
                        String message = jsonObject.getString("message");
                        showMessage("Exception querying speech-to-text task: " + message);
                    }

                } catch (Exception e) {
                    Log.i("Error parsing query call response", result);
                }
            }
        }
        );
    }
    ```

1. **Stop the task**

    To [stop speech to text](#stop-speech-to-text), you send a delete request with the, `appId`, `taskId` and `builderToken` in the URL. In the `MainActivity` class, add the following method:

    ```java
    public void stopSpeechToText() {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks/" + speechToTextTaskId
                + "?builderToken=" + builderToken;
        OkHttpClient httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        Request request = new Request.Builder()
                .addHeader("Content-Type", "application/json")
                .addHeader("Authorization", authorizationHeader)
                .url(url)
                .delete()
                .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                if (response.isSuccessful()) {
                    showMessage("Speech-to-text task stopped");
                    speechToTextTaskId = "";
                    isSpeechToTextRunning = false;
                    runOnUiThread(() -> btnSpeechToText.setText("Start speech to text"));
                } else {
                    showMessage("Exception stopping speech-to-text task: " + result);
                }
            }
        }
        );
    }
    ```

1. **Receive and display the text stream**

    When you set one of the `destinations` in the starting configuration as `AgoraRTCDataStream`, the speech-to-text conversion output stream is pushed to your RTC channel. To receive this stream and display the text in your <Vpl k="CLIENT" />, add the following code after `private final IRtcEngineEventHandler mRtcEventHandler = new IRtcEngineEventHandler() {` in the `MainActivity` class:

    ```java
    @Override
    public void onStreamMessage(int uid, int streamId, byte[] data) {
        showMessage(data.toString());
    }    
    ```

1. **Enable a user to start, query and stop a task**

    In this example, you use two buttons to manage a speech-to-text task.

        1. When a user presses the start button, the <Vpl k="CLIENT" /> requests a `builderToken`. If the request is successful, the <Vpl k="CLIENT" /> starts a speech-to-text task. If a task is already running, you stop the task. To implement this functionality, add the following method tot the `MainActivity` class.

            ```java
            public void SpeechToText(View view) {
                if (!isSpeechToTextRunning) {
                    try {
                        getBuilderToken();
                    } catch (Exception e) {
                        showMessage(e.toString());
                    }
                } else {
                    stopSpeechToText();
                }
            }
            ```

        1. When a user presses the query status button, you call the query method to inform the user of the current task status and update the user interface. To implement this functionality, add the following method tot the `MainActivity` class.

            ```java
            public void query(View view) {
                if (isSpeechToTextRunning) 
                    querySpeechToText();
                else
                    showMessage("Speech-to-text task is not running");
            }
            ```
</PlatformWrapper>
