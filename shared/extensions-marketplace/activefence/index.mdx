import ProjectImplementation from '@docs/shared/extensions-marketplace/activefence/project-implementation/index.mdx';
import Prerequisites from '@docs/shared/extensions-marketplace/common/_prerequities.mdx';

[<Vg k="RTEE_AF" />](https://www.activefence.com/) is the leader in providing Trust & Safety solutions to protect online platforms and their users from
malicious behavior and content. By integrating <Vg k="RTEE_AF" /> capabilities in your <Vpl k="CLIENT" />, design the
exact content moderation processes you want with the ActiveFence AI-driven automated detection for text,
audio, image and video content across multiple abuse areas and languages. Quickly moderate, enforce policies, manage
user flags, send notifications, and more.

IAIN: Need to add a workflow diagram here.

This page shows you how to integrate and use the <Vg k="RTEE_AF" /> content detection & moderation extension in your <Vpl k="CLIENT" />.

## Prerequisites

The development environment requirements are as follows:

<Prerequisites />
- Implemented <Link to="../../../video-calling/get-started/get-started-sdk"><Vg k="GET_STARTED"/> for <Vg k="VIDEO"/></Link>.


## Project Setup

In order to configure <Vg k="RTEE_AF" />:

1. **Setup your <Vg k="RTEE_AF" /> account**

    1. In your browser, navigate to https://www.activefence.com/demo/ and request a demo account.

        <Vg k="RTEE_AF" /> sets up your demo account and supplies the URL to your <Vg k="RTEE_AF_D" />.

    1. In your browser, log into <Vg k="RTEE_AF" /> Dashboard, then click the Settings icon on the top-right.

        **Account Settings** opens.

    1. Click **Data Management** > **<Vg k="RTEE_AF" /> API Keys**, then click **Add Key**.

    1. In **Add API Key**, fill in the form and click **Generate Key**.

    1. Click **Data Management** > **API Management** > **Key Management**, then click **Add Key**.

    1. In **Add API Key**, fill in the \<I DONT KNOW WHAT SHOULD BE FILLED IN HERE, is it the API Key?> and press
   **Save**.


1. **Configure the content that is unacceptable in your  <Vpl k="CLIENT" />**

    Content moderation workflows are the core of <Vg k="RTEE_AF" />. A workflow defines the action that is taken
    when content streamed to a channel is above a percentage risk of being unacceptable. For example, there is an
    80% chance that a user is streaming images of graphic violence, you suspend that user. To setup a workflow:

    1. In <Vg k="RTEE_AF_D" />, click the hamburger menu at the top left, click **Workflows**, then click **Create
   New**.

    1. In your workflow, drag the initiator, condition and action to your workflow. For example:
        - Initiator - `Abuse or Harmful` is `Graphic Violence`.
        - Condition - `Risk Score` equals `90`.
        - Action - `Suspend`.

    When your workflow is defined, you configure the format and data sent to your webhook every time content matches
    the conditions.

1. **Define the information <Vg k="RTEE_AF" /> sends to your webhook**

    <Vg k="RTEE_AF" /> monitors the data sent in a channel. When content matches condtions in a workflow, <Vg
   k="RTEE_AF" /> sends a PUSH request to your webhook with information about the channel the data was sent and the
   user who sent it. To enable this, you configure the data that is sent to your webhook:

    1. In <Vg k="RTEE_AF" />, click **MODERATION CAPABILITIES** > **Custom Fields**.

    1. Add the following editable custom fields:

        | Title      | Key | Type | Tooltip |
        | ----------- | ----------- | ----------- | ----------- |
        |  cname    |   cname    |  Text     |  The name of the channel being monitored.     |
        |  requestId    | requestId      |  Text     |   The Id of the request used to upload an image.    |
        |  sid    |  sid     |  Text     |    The SID uploaded by Video SDK. (I don't understand what this is)   |
        |  source    |  source     |  Text     |   This value is hardcoded as `agora`.   |
        |    timestamp  |  timestamp     |  Number     | The time the image was uploaded in the format; YYYY MM DD HH MM SS SSS |
        |  uid  | uid      |  Number     |   The ID of the user who sent the message to the channel.    |

1. **Define the webhook <Vg k="RTEE_AF" /> sends information to when an action is triggered in your workflow**

    1. In <Vg k="RTEE_AF" />, click **DATA MANAGEMENT** > **Action Webhooks**, then click **Add Webhook**.

    1. In **Add Action Webhook**, update the following fields and click **Save**.

        - **Action** - The name for this webhook.
        - **Related Entity** - Set to `content`.
        - **Endpoint URL** - The FQDM for your webhook. For example: `https://my.super.duper/webhook`.
        - **Request Method** - Set to POST.
        - **API Key** - For authenticated requests to your webhook. Choose the key you configured earlier.   If you
        do not require authentication, set to No auth.


    1. In **Body**, configure the format of the JSON object and data sent to your webhook. Set the following:

        ```json
          {
              "contentUrl":"$contentUrl",
              "status":"$status",
              "userId":"$userId",
              "addedAt":"$addedAt",
              "contentId":"$contentId",
              "reason":"$violationsCategories",
              "metaData":{
                  "callbackData":"$callbackData",
                  "source":"$source",
                  "requestId":"$requestId",
                  "sid":"$sid",
                  "cname":"$cname",
                  "uid":"$uid",
                  "timestamp":"$timestamp"
              }
          }
        ```


1. **Connect your <Vpl k="CLIENT" /> to your <Vg k="RTEE_AF" /> account**

    In order for <Vg k="RTEE_AF" /> to view data streamed to a channel in your <Vpl k="CLIENT" />,   <Vg
    k="RTEE_AF"/>  needs to bind your App ID to your <Vg k="RTEE_AF" /> account. To do this, send the following
    information to support@agora.io.

      ```json
         {
           "companyId":25795,
           "vendorId":130451,
           "vendorAppId":"",
           "vendorAppKey":"",
           "vendorAppSecret":"<API Key>",
           "serviceName":"activeFence",
           "vendor":103,
           "isEnabled":1,
           "vendorApiUrl":"",
           "callbackUrl":"",
           "scenes":[

               ]
         }
          ```






## Integrate the extension

Now that  <Vg k="RTEE_AF" /> can check content sent in the channels in your <Vpl k="CLIENT" />,  you need to:

1. **Enable content moderation in your app**

    To ensure that content moderation is always active in your app, update your `joinChannel` method with the following
    code:

      ```objc
      let connection = AgoraRtcConnection()
       connection.localUid = userId
       connection.channelId = roomName

      agoraEngine.joinChannelEx(byToken: nil, connection: connection, delegate: nil, mediaOptions: mediaOptions, joinSuccess: nil)


      let inspectExtraConfig = AgoraContentInspectConfig()
      var modules = [AgoraContentInspectModule]()
      let module1 = AgoraContentInspectModule()
      module1.type = .imagemoderation  // Be sure to set type as cloudmoderation
      module1.interval = 2       // Set content moderation to run every 2 seconds
      modules.append(module1)
      inspectExtraConfig.modules = modules
      agoraEngine.enableContentInspectEx(true, config: config, connection: connection)


      //IAIN, don't understand why we are doing this again. Is this for another user?
      let connection = AgoraRtcConnection()
       connection.localUid = userId
       connection.channelId = roomName

      agoraEngine.enableContentInspectEx(enabled, config: config, connection: connection)
      ```

1. **Setup your webhook**

    Need to add something like https://docs.agora.io/en/video-calling/develop/receive-notifications?platform=web#create-your-webhook
    to explain how  to create a webhook to monitor activity.


## Reference

