import * as data from '@site/data/variables';

Chat supports HTTP callbacks (webhooks) for synchronization of messages on your own server or moderation of message content. After you set up HTTP callbacks for your Chat app, the Chat server sends notifications in the form of HTTP POST requests to your app server when specified events occur. According to whether the message delivery is intervened, the callbacks are divided in two categories:
- Pre-delivery callbacks: Mainly used for content moderation. When the Chat server receives a message from the client app, it sends a request to your app server and waits for a response that decides if the message delivery is passed or rejected. Pre-delivery callbacks only apply to messages sent from your client apps.
- Post-delivery callbacks: Mainly used for data synchronization. When certain events occur, for example, a user sends out a message or gets offline, the Chat server sends a request to your app server and does not validate the response content. Post-delivery callbacks apply to messages and other events sent from you client and server apps.

## Understand the tech

**Difference between pre-delivery and post-delivery callbacks**

The following table summarizes the differences between the two categories of callbacks.

| Category | Pre-delivery callback | Post-delivery callback |
| ---------------- | ---------------- | ---------------- |
| Supported components      | Client SDKs      | Client SDKs and REST APIs      |
| Supported scopes | Only messages | Messages and other events |
| Response required | Yes | No |
| Typical use case | Content moderation | Chat history synchronization |

**Callback security**

For pre-delivery and post-delivery callbacks, the Chat server sends HTTP/HTTPS POST requests with JSON payloads to your app server. The requests are encoded in UTF-8 and the message in each request is signed with an MD5 signature. In each request header, the `Content-Type` field is `application/json`.

For post-delivery callbacks, the message in requests is signed with an MD5 signature calculated with `org.apache.commons.codec.digest.DigestUtils#md5Hex`.

You can verify the signature to check whether the callbacks are sent from the Chat server.

1. Retrieve the following information:
    - The callback ID, which is the `callId` parameter in the request body of the callback.
    - The secret assigned to the callback rule. You can find it on the callback rule list on the **Callback** page on the [Agora console](https://console.agora.io/).

		![](/images/chat/callback_secret.png)

	- The callback timestamp, which is the timestamp parameter in the request body of the callback.

2. Calculate the [MD5](https://en.wikipedia.org/wiki/MD5) value of the concatenated string of the callback ID, the secret, and the callback timestamp.
3. Check if the calculated value equals to the secret parameter in the request body. If yes, the callback is sent by Agora Chat.

## Prerequisites

To use the HTTP callbacks, you must meet the following requirements:

- You have an Agora project with Chat [enabled](../get-started/enable).
- You understand the API call frequency limit as described in [Limitations](../reference/limitations).
- The HTTP callback feature is not enabled by default. To use this feature, you need to subscribe to the **Pro** or **Enterprise** [pricing plan](../reference/pricing-plan-details) and enable it in <Link to="{{Global.AGORA_CONSOLE_URL}}"><Vg k="CONSOLE" /></Link>.
<div class="alert note">You must contact <a href="mailto:support@agora.io">support@agora.io</a> to disable this feature as this operation will delete all the relevant configurations.</div>

## Configure callback rules

To receive the HTTP callbacks, you need to configure rules for the pre- or post-delivery callbacks in Agora Console.

1. Log in to Agora Console and find your project on the **Project Management** page, then click the edit button.
2. Find **Chat** on the project editing page, and click **Configure**.
3. Choose **Features** > **Callback** and click **Add Callback Address** on the **Callback** page.
   
	  ![](/images/chat/callback_addr_list.png)
		
4. To add a rule for pre-delivery callbacks, fill the following fields under the **Pre Send** tab and then click **Save**:

     ![](/images/chat/pre-delivery-callback.png)

     - **Rule Name**: Enter a name for the rule. Under one project, each rule must have a unique name.
     - **Conversation Type**: Select the types of chat this rule applies to.
     - **Message Type**: Select the types of messages this rule applies to.
     - **Timeout**: Specify the time (in ms) that the Chat server should wait for the HTTP responses. The default value is 200ms. If the response times out, the Chat server continues with the fallback action.
     - **Fallback Action**: Select the action of the Chat server when the HTTP response times out or an error is returned. The default value is **Passed**.
     - **Report Error**: Set whether to notify the message sender when their message is rejected. The default value is **No**, indicating that the sender is not notified of the message delivery failure.
     - **Status**: Set whether to enable this rule. The default value is **Disabled**.
     - **Callback URL**: Enter the URL of your app server for receiving the pre-delivery callbacks. Both HTTP and HTTPS URLs are allowed.

5. To add a rule for post-delivery callbacks, fill the following fields under the **Post Send** tab and then click **Save**:

     ![](/images/chat/post-delivery-callback.png)

     ![](/images/chat/post-delivery-callback-advanced.png)

     - **Rule Name**: Enter a name for the rule. Under one project, each rule must have a unique name.
     - **Callback URL**: Enter the URL of your app server for receiving the post-delivery callbacks. Both HTTP and HTTPS URLs are allowed.
     - **Status**: Set whether to enable this rule. The default value is **Disabled**.
     - **Callback Type**: Select the type of events that you want to received callback for.
     - **Message Type**: To synchronize the chat history on your own server, select chat messages. All messages sent by the users are chat messages, regardless of the online status of the message receiver. To push message notifications, select offline messages. Messages sent to an offline user are counted as offline messages.
     - **REST Message Required**: Set whether the callback should cover messages sent via RESTful API.
     - **From ID** (Optional): The sender UID.
     - **To ID** (Optional): The recipient UID.
     - **Group/Chatroom ID** (Optional): The ID of the relevant chat room or chat group. If you set this parameter, the server will only make callbacks for messages or events in this group or room.
     - **Extension Attribute Key** (Optional): The attribute key in the message extension field. If you set this parameter, the server will only make callbacks for messages containing this attribute key.

        <Admonition type="tip" title="Note">If the sender, receiver, and group/room ID are set at the same time, the sender will not receive a callback when sending a single chat or group chat message to the receiver.</Admonition>

The rules take effect immediately.

Note the following for the rule configurations:

- By default, you can add four rules for the pre- and post-delivery callbacks in total. To extend the limit, contact [support@agora.io](mailto:support@agora.io).
- The rule configuration only supports message events. To receive notifications of other events, contact [support@agora.io](mailto:support@agora.io).

## Pre-delivery callbacks

The following figure shows how the pre-delivery callbacks work.

![](/images/chat/pre_delivery_callback.png)

As shown in the figure, the workflow of pre-delivery callbacks is as follows:

1. The Chat server receives a message from Client A.
2. The Chat server sends an HTTP request that contains the information of the message to your app server.
3. Your app server processes the received data and sends the processing result in the form of HTTP response to the Chat server.
4. The Chat server receives the HTTP response and decides if the message delivery is passed.
5. If the message delivery is passed, the Chat server delivers the message to Client B.

The Chat server determines whether to send the message according to the HTTP response received from your app server. If the HTTP status code is 200 in the response, the Chat server handles the message as specified in the matching pre-delivery callback rule. If a response error occurs, including the required field `valid` being absent or fields being of an incorrect type, the Chat server handles the message as specified by **Fallback Action** in the matching pre-delivery callback rule and `custom internal error` is reported on the client (only when **Report Error** on the **Pre Send tab** page is set to **Yes** on the Agora Console).

<div class="alert note">For pre-delivery callbacks, if your app server does not return the HTTP code 200 and the valid status, the Chat server does not resend the callback and takes the fallback action specified by the applicable rule.</div>

### HTTP request and response

#### Request header

| Field        | Description     |
| :------------- | :---------------------------------- |
| `Content-Type` |  The parameter type. The value is `application/json`. |

#### Request body

| Field   |  Type     | Description     |
| :---------------- | :------------------------ |:------------------------ |
| `callId`    | String  | The callback ID which is the unique identifier assigned to each callback. The callback ID is in the format of `{appKey}_{uuid}`, where the value of `uuid` is randomly generated.     |
| `timestamp`  | Number  | The Unix timestamp when the Chat server receives the message, in milliseconds.         |
| `chat_type` | String  | The chat type:<ul><li>`chat`: One-to-one chats.</li><li>`groupchat`: Chat groups and chat rooms.</li></ul>     |
| `group_id`   | String      | The group or chat room where the message included in the request is to be sent. This parameter is valid only for group and room chats. |
| `from`   | String | The user ID of the message sender.  |
| `to`  | String | The user ID of the message recipient. This parameter is valid only for one-to-one chats. |
| `msg_id`  | String | The ID of the message for which the callback request is sent. This ID is the same as the `msg_id` generated by the Chat server when the message is sent to the recipient. |
| `payload`    | JSON     | The message content which matches the [content of the `payload` parameter in historical messages retrieved with the REST API](https://docs.agora.io/en/agora-chat/restful-api/message-management?platform=android#content-of-historical-messages). |
| `securityVersion`| String | The security check version which is 1.0.0.     |
| `security`     | String  | The signature used to identify whether the HTTP callback request is from the Chat server. The signature is an MD5 hash in the format of `{callId}+{secret}+{timestamp}`, where `secret` is generated by the Chat server to produce the signature and is displayed on the callback rule list on the **Callback** page on the <Link to="{{Global.AGORA_CONSOLE_URL}}"><Vg k="CONSOLE" /></Link>. |

#### Response body

The HTTP responses cannot exceed 1,000 characters; otherwise, the callbacks fail as the Chat server deems the responses as attack packets.

| Field      | Type   | Required | Description      |
| :-------- | :----- | :----------------- | :----------- |
| `valid`   | Boolean   | Yes   | Controls whether the message is appropriate according to the rules specified on your app server：<ul><li>`true`: The message is valid and the Chat server should deliver the message;</li><li>`false`: The message is invalid and the Chat server should reject the message.</li></ul> |
| `code`    | String | No   | Custom pre-delivery callback error description on the client. The value of the `code` field is displayed as the error on the client only when **Report Error** on the **Pre Send** tab page is set to **Yes** on the Agora Console. Callback errors are displayed as follows on the client: <ul><li>If `code` contains the content of the string type, the content is reported as the error; </li><li>If `code` is not included in the response, `custom logic denied` is displayed. </li><li> If `code` is returned as an empty string, `Message blocked by external logic` is displayed on a mobile client; </li><li> If no response is received within the specified period, the default error `custom internal error` is reported. </li><li>If a response error occurs, including the `valid` field being absent or fields being of an incorrect type, `custom internal error` is reported. </li></ul>  |
| `payload` | Object | No   | The modified message content. <br/>Currently, only the text content is allowed. The modified content must be in the same format as the original message and cannot exceed 1 KB. If it is unnecessary to modify the message, ignore this field.  |

#### Request example

```shell
{
    "callId":"easemob-demo#test_XXXX-dp01-6c50-XXXX-cf3b48b20e7e",
    "timestamp":1600060847294,
    "chat_type":"groupchat",
    "group_id":"16934809238921545",
    "from":"user1",
    "to":"user2",
    "msg_id":"8924312242322",
    "payload":{
    // Message content
    },
    "securityVersion":"1.0.0",
    "security":"2ca02c394bef9e7abc83958bcc3156d3"
}
```

#### Response example

```json
{
  "valid": true,
  "code": "HX:10000",
  "payload": {
    // Modified message content.
    // Only text contents are allowed.
  }
}
```

## Post-delivery callbacks

The workflow of post-delivery callbacks is as follows:

![](/images/chat/post_delivery_callback.png)

As shown in the figure, the workflow of post-delivery callbacks is as follows:

1. The Chat server receives a message or other event from a client or server.
2. The Chat server sends an HTTP request that contains the information of the message or event to your app server.
3. Your app server sends an HTTP response to the Chat server to indicate that the callback is received.

<Admonition type="caution" title="Note">If you have set both pre- and post-delivery callbacks, and a message is rejected after the pre-delivery callback returns, the post-delivery callbacks are not triggered.</Admonition>

The Chat server places full trust in callback responses received from your app server without verifying them. As long as the returned HTTP status code is 200, the Chat server regards that the callback succeeds.

Responses to the requests cannot exceed 1,000 characters; otherwise, the callbacks fail as the Chat server deems the responses as attack packets.

### HTTP request and response

#### Request Body

| Parameter      | Description |
| -------------- | ----------- |
| callId         | callId is `{appkey}_{uuid}` where UUID is randomly generated as the unique identifier of each callback. |
| eventType      | • chatChat messages; <br/ > • chat_offlineOffline messages. |
| timestamp      | The Unix timestamp when the IM server received this message, in milliseconds. |
| chat_type      | • chatSingle chat callback; <br/ > • groupchatGroup chat callback includes group and chat room message callbacks, all are selected by default. |
| group_id       | This parameter is only available for group chats and calls back the group where the message is located. |
| from           | The sender of the message. |
| to             | The recipient of the message. |
| msg_id         | The ID of the message. |
| payload        | The message content is consistent with that sent through the REST API. See the message format document. |
| securityVersion| The security verification version is currently 1.0.0. Ignore this parameter, it will be changed to the console for setting in the future. |
| security       | Signature, the format is as follows: MD5 (callId+Secret+timestamp). Secret See Console background callback rules. |

#### Request example

```
{
  "callId": "XXXX-demo#XXXX-dp01-XXXX-8696-cf3b48b20e7e",
  "eventType": "chat_offline",
  "timestamp": 1600060847294,
  "chat_type": "groupchat",
  "group_id": "169XXXX21545",
  "from": "user1",
  "to": "user2",
  "msg_id": "8924312242322",
  "payload": {
    // Specific message content.
  },
  "securityVersion": "1.0.0",
  "security": "2ca02c394bef9e7abc83958bcc3156d3"
}
```

### Response packet field description
<Vg k="COMPANY" /> server will not verify the response content. As long as your server returns us an HTTP status code of 200, the message callback is considered successful.

### Query callback storage details interface description
Query the collection of messages and event types stored when the callback fails due to exceptions (such as link timeout, response timeout, callback rule ban, etc.) under the App Key. It is stored as a date key every ten minutes, and then the user can pull it on demand based on the message collection.

#### Description of functional limitations
The default storage expiration time for abnormal storage is 3 days. If there is storage, it must be reissued in time. It is recommended that the number of reissue retries be controlled within 10 times.

#### Verification method
<Vg k="COMPANY" /> Messaging RESTful API requires Bearer HTTP authentication. Every time you send an HTTP request, you must fill in the following `Authorizationfields` in the request header:

```
Authorization：Bearer YourAppToken
```

In order to improve the security of the project, tokens (dynamic keys) are used to authenticate users who are about to log in to the instant messaging system. The instant messaging RESTful API supports the authentication method using App Token.

#### Basic Information

method:GET

Access Point: `/{org_name}/{app_name}/callbacks/storage/info`

#### Path Parameters

| Parameter       | Type   | Required | Description |
| --------------- | ------ | --------------- | ----------- |
| org_name        | String | yes             | The unique ID assigned by HuanXin Instant Messaging IM to each company (organization). For details, see Obtaining Huanxin IM information. |
| app_name        | String | yes             | The application name you filled in when creating the application in the HuanXin Instant Messaging Cloud Console. For details, see Obtaining Huanxin IM information. |

#### Request header

| Parameter       | Type   | Required | Description |
| --------------- | ------ | --------------- | ----------- |
| Authorization   | String | yes             | Authentication Token, administrator Token (inclusive) and above. |

#### Response body

| Parameter       | Type   | Description |
| --------------- | ------ | ----------- |
| path            | string | Request path. |
| uri             | string | The URI of the request path. |
| timestamp       | long   | The Unix timestamp when the IM server received this message, in milliseconds. |
| organization    | string | The unique identifier of your organization registered in the HuanXin IM management backend. |
| application     | string | The unique identifier of the App you registered in the HuanXin IM management backend. |
| action          | string | Request method. |
| duration        | long   | Request time taken, in milliseconds. |
| applicationName | string | The App name you registered in the HuanXin IM management backend. |
| data            | object | Response data content. Includes the following three parameters: date, size and retry. |
| -date           | String | The current date key, that is, messages and events within every 10 minutes. key is the starting point of 10 minutes. |
| -size           | Int    | The number of messages within this date key. |
| -retry          | Int    | The number of times the data in this date key has been retried. The value is when not retried 0. |

#### Request example

```
curl -X GET 'https://a1.easemob.com/easemob-demo/easeim/callbacks/storage/info' \
-H 'Authorization: Bearer <YourAppToken>'
#Response example
```

#### Response example

```
{
  "path": "/callbacks",
  "uri": "https://XXXX/XXXX/XXXX/callbacks",
  "timestamp": 1631193031254,
  "organization": "XXXX",
  "application": "8dfb1641-XXXX-XXXX-bbe9-d8d45a3be39f",
  "action": "post",
  "data": [
    {
      "date": "202109091440",
      "size": 15,
      "retry": 0
    },
    {
      "date": "202109091450",
      "size": 103,
      "retry": 1
    }
  ],
  "duration": 153,
  "applicationName": "XXXX"
}
```

### Reissue callback storage information interface description
The calling interface performs callback reissue based on the storage collection.

#### Basic Information
method:POST

Access Point: `https://{host}/{org_name}/{app_name}/callbacks/storage/retry`

#### Path Parameters

| Parameter | Type   | Is it necessary | Description |
| --------- | ------ | --------------- | ----------- |
| org_name  | String | yes             | The unique ID assigned by HuanXin Instant Messaging IM to each company (organization). For details, see Obtaining Huanxin IM information. |
| app_name  | String | yes             | The application name you filled in when creating the application in the HuanXin Instant Messaging Cloud Console. For details, see Obtaining Huanxin IM information. |

#### Request Header

| Parameter     | Type   | Is it necessary | Description |
| ------------- | ------ | --------------- | ----------- |
| Content-Type  | String | yes             | Content type, please fill in application/json. |
| Authorization | String | yes             | The value of the authentication App Token. For details, see Using App Token for Authentication. |

#### Request Body

| Parameter | Type   | Is it necessary | Description |
| --------- | ------ | --------------- | ----------- |
| date      | String | yes             | A ten-minute date key that can be reissued. The key is the starting point of ten minutes. |
| retry     | Int    | no              | The number of times development has been retried. Taking into account that reissue may also fail, the server will continue to store. It starts with 0. |
| targetUrl | String | no              | The callback address of the reissue message. If it is empty, the callback address of the original callback rule will be used. |

#### Response Body

| Parameter    | Type   | Description |
| ------------ | ------ | ----------- |
| path         | String | Request path. |
| uri          | String | The URI of the request path. |
| timestamp    | long   | The Unix timestamp when the IM server received this message, in milliseconds. |
| organization | String | The unique ID assigned by HuanXin Instant Messaging IM to each company (organization) is org_name the same as the request parameter. |
| application  | String | The unique identifier of the app you registered in the Huanxin IM management backend. |
| action       | String | Request method. |
| data         | Bool   | success/failure. |
| duration     | long   | Request time taken, in milliseconds. |

#### Request example

```
curl -X POST 'https://XXXX/XXXX/XXXX/callback/storage/retry' \
-H 'Authorization: Bearer <YourAppToken>' \
-H 'Content-Type: application/json' \
--data-raw '{
    "date": "202108272230",
    "retry": 0,
    "targetUrl": "https://localhost:8000/test"
}'
```

#### Response example

```
{
  "path": "/callbacks",
  "uri": "https://XXXX/XXXX/XXXX/callbacks",
  "timestamp": 1631194031721,
  "organization": "XXXX",
  "application": "8dfb1641-XXXX-XXXX-bbe9-d8d45a3be39f",
  "action": "post",
  "data": "success",
  "duration": 225,
  "applicationName": "XXXX"
}
```

#### Response code description

| Status Code | Description |
| ----------- | ----------- |
| 200         | The request was successful. |
| 400         | The request parameters are incorrect, please check according to the returned prompts. |
| 401         | User permission error. |
| 403         | The service is not activated or the permissions are insufficient. |
| 429         | Too many requests per unit time. |
| 500         | Internal server error. |

**Retry logic**

For post-delivery callbacks, the Chat server records a notification failure and tries resending the callback once again. If the second attempt fails, the Chat server stops trying.

If 90 notification failures occur in 30 seconds, the callback rules involving the app server will be temporarily disabled for 5 minutes.

## Status codes

For details, see [HTTP Status Codes](../reference/http-status-codes).

## FAQ

Q: Why is the message delivered to the intended recipient even though the value of the `valid` field is `false` in the pre-delivery callback response?

A: Maybe your server fails to return the pre-delivery callback response within the period specified with the **Timeout** parameter in the pre-delivery callback rule on the **Pre Send** page on the <Link to="{{Global.AGORA_CONSOLE_URL}}"><Vg k="CONSOLE" /></Link>. In this case, the message is delivered if **Fallback Action** on the **Pre Send** page page is set to **Passed**. To avoid this issue, you are advised to increase the value of the **Timeout** parameter (200 milliseconds by default), for example, to 1000 milliseconds.
