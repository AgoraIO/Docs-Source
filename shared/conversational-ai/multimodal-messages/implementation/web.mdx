import CodeBlock from '@theme/CodeBlock';

1. **Integrate the toolkit**

    Copy the [`conversational-ai-api`](https://github.com/AgoraIO-Community/Conversational-AI-Demo/tree/main/Web/Scenes/VoiceAgent/src/conversational-ai-api) file to your project and import the toolkit before calling its API. Refer to [Folder structure](#folder-structure) to understand the role of each file.

1. **Create a toolkit instance**

    Before joining a <Vg k="VSDK"/> channel, create video and <Vg k="SIG" /> engine instances and pass in to the toolkit instance.

    <CodeBlock language="js" showLineNumbers>
    {`// Initialize the component
    ConversationalAIAPI.init({
      rtcEngine,
      rtmEngine,

      /**
      * Set the rendering mode for transcription subtitles. Available options:
      * - ESubtitleHelperMode.WORD: Word-by-word rendering mode. The subtitle content received from the callback 
      *   is rendered to the UI one word at a time.
      * - ESubtitleHelperMode.TEXT: Sentence-by-sentence rendering mode. The full subtitle content from the callback 
      *   is rendered to the UI at once.
      *
      * If not specified, the mode is determined automatically based on the message, or it can be set manually.
      */
      renderMode: ESubtitleHelperMode.WORD, 
    })

    // Get the API instance (singleton)
    const conversationalAIAPI = ConversationalAIAPI.getInstance()`}
    </CodeBlock>

1. **Subscribe to the channel**
    Agent-related events are delivered through <Vg k="SIG" /> messages. Before starting an agent session, call `subscribeMessage` to receive these events:

    <CodeBlock language="ts" >
    {`conversationalAIAPI.subscribeMessage(channel_name)`}
    </CodeBlock>

1. **Receive subtitles**

    Register an event listener to receive subtitle transcription updates:

    <CodeBlock language="ts" showLineNumbers>
    {`import * as React from "react"
    import {
        type IUserTranscription,
        type IAgentTranscription,
        type ISubtitleHelperItem,
        EConversationalAIAPIEvents,
    } from "@/conversational-ai-api/type"
    import { ConversationalAIAPI } from "@/conversational-ai-api"

    // Listen for transcription content updates to display subtitle transcription content in real time
    export const ChatHistory = () => {
    const [chatHistory, setChatHistory] = React.useState
        ISubtitleHelperItem<Partial<IUserTranscription | IAgentTranscription>>[]
    >([])

    const conversationalAIAPI = ConversationalAIAPI.getInstance()
    conversationalAIAPI.on(
        EConversationalAIAPIEvents.TRANSCRIPTION_UPDATED,
        setChatHistory
    )

    return (
        <>
        {chatHistory.map((message) => (
            <div key={\`\${message.uid}-\${message.turn_id}\`}>
            {message.uid}: {message.text}
            </div>
        ))}
        </>
    )
    }`}
    </CodeBlock>

1. **Add a Conversational AI agent to the channel**

    To [start a <Vpd k="AGENT" />](/conversational-ai/rest-api/join), configure the following parameters in your `POST` request:

    | Parameter       | Description   | Required |
    | ----------------| ------------- | -------- |
    | `advanced_features.enable_rtm: true`    | Starts the <Vg k="SIG" /> service | Yes  |
    | `parameters.data_channel: "rtm"`  | Enables <Vg k="SIG" /> as the data transmission channel | Yes |
    | `parameters.enable_metrics: true`  | Enables agent performance data collection    | Optional |
    | `parameters.enable_error_message: true` | Enables reporting of agent error events  | Optional |

    After a successful response, the agent joins the specified <Vg k="VSDK"/> channel and is ready to interact with the user.


1. **Unsubscribe from the channel**

    After each agent session ends, unsubscribe from channel messages to release resources associated with callback events:

    <CodeBlock language="ts" >
    {`conversationalAIAPI.unsubscribeMessage(channel_name)`}
    </CodeBlock>

1. **Release resources**

    At the end of each call, use the `destroy` method to clean up the cache.

    <CodeBlock language="ts" >
    {`conversationalAIAPI.destroy()`}
    </CodeBlock>
