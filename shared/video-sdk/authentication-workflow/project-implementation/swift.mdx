import AddVariables from '@docs/assets/code/video-sdk/authentication-workflow/swift/add-variables.mdx';
import SpecifyChannel from '@docs/assets/code/video-sdk/authentication-workflow/swift/specify-channel.mdx';
import FetchToken from '@docs/assets/code/video-sdk/authentication-workflow/swift/fetch-token.mdx';

1.  **Add the required import statements**

    ``` swift
    import SwiftUI
    import AgoraRtcKit
    ```

2.  **Retrieve a token from the server**

    Use a GET request to retrieve an authentication token for a specific channel from the token server, then decode the return parameters to obtain the token.

    In `AgoraManager` extension, add the following `fetchToken` method:

    <FetchToken />

3.  **Fetch a token and join a channel using that token**

    Retrieve a token from the token server and use it to join the channel.

<PlatformWrapper platform="ios">
    ``` swift
    /** Fetch a token from the token server, and then join the channel using Agora SDK.

     - Returns: A boolean, for whether or not the token fetching was successful.
     - Parameters:
       - tokenUrl: The URL of the token server.
       - channel: The name of the channel for which the token will be used.
    */
    fileprivate func fetchTokenThenJoin(tokenUrl: String, channel: String) async -> Bool {
        if let token = try? await self.fetchToken(
            from: tokenUrl, channel: channel,
            role: role, userId: 0
        ) {
            agoraEngine.joinChannel(byToken: token, channelId: channel, info: nil, uid: 0)
            return true
        } else { return false }
    }
    ```
</PlatformWrapper>
<PlatformWrapper platform="macos">
    ``` swift
    /** Fetch a token from the token server, and then join the channel using Agora SDK
     - Returns: A boolean, for whether or not the token fetching was successful.
    */
    func fetchTokenThenJoin() async -> Bool {
        if !channelId.isEmpty,
           let token = try? await self.agoraManager.fetchToken(
            from: self.tokenUrl, channel: self.channelId,
            role: self.agoraManager.role, userId: 0
        ) {
            self.agoraManager.joinChannel(channelId, token: token)
            return true
        } else { return false }
    }
    ```
</PlatformWrapper>

<PlatformWrapper platform="ios">
4.  **Handle the event triggered by <Vg k="AGORA_BACKEND" /> when the token is about to expire**

    A token expires after the `expireTime` specified in the call to the token server or after 24 hours, if `expireTime` is not specified. The `tokenPrivilegeWillExpire` event handler receives a callback when the current token is about to expire. Your event handler retrieves a fresh token and persists the connection with <Vg k="AGORA_BACKEND" />.

    In `extension AgoraManager {`, add the following event handler function:

    ``` swift
    // Handle the event triggered by {AGORA_BACKEND} when the token is about to expire
    func rtcEngine(
        _ engine: AgoraRtcEngineKit, tokenPrivilegeWillExpire token: String
    ) {
        Task {
            if let token = try? await fetchToken(
                from: DocsAppConfig.shared.tokenUrl,
                channel: DocsAppConfig.shared.channel,
                role: .broadcaster
            ) { self.agoraEngine.renewToken(token) }
        }
    }
    ```
</PlatformWrapper>
