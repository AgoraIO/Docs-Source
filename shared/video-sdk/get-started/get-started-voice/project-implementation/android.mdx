import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import CodeBlock from '@theme/CodeBlock';
import CompleteCodeJava from './complete-code-java.mdx';
import CompleteCodeKotlin from './complete-code-kotlin.mdx';

<PlatformWrapper platform = "android">
The following figure illustrates the essential steps:

<details>
<summary>Quick start sequence</summary>

![](/images/rtc-sdk/quickstart-voice-call-sequence.svg)
</details>


This guide includes [complete sample code](#complete-sample-code) that demonstrates implementing basic real-time interaction. To understand the core API calls in the sample code, review the following implementation steps and use the code in your `MainActivity` file.

### Import Agora classes

Import the relevant Agora classes and interfaces:

<Tabs groupId="language">
<TabItem value="java" label="Java" default>
<CodeBlock language="java" showLineNumbers>
{`import io.agora.rtc2.Constants;
import io.agora.rtc2.IRtcEngineEventHandler;
import io.agora.rtc2.RtcEngine;
import io.agora.rtc2.RtcEngineConfig;
import io.agora.rtc2.ChannelMediaOptions;`}
</CodeBlock>
</TabItem>

<TabItem value="kotlin" label="Kotlin">
<CodeBlock language="kotlin" showLineNumbers>
{`import io.agora.rtc2.ChannelMediaOptions
import io.agora.rtc2.Constants
import io.agora.rtc2.IRtcEngineEventHandler
import io.agora.rtc2.RtcEngine
import io.agora.rtc2.RtcEngineConfig`}
</CodeBlock>

</TabItem>

</Tabs>

### Initialize the engine

For real-time communication, initialize an `RtcEngine` instance and set up event handlers to manage user interactions within the channel. Use `RtcEngineConfig` to specify the application context, [App ID](../get-started/manage-agora-account#get-the-app-id), and custom [event handler](#subscribe-to-sdk-events), then call `RtcEngine.create(config)` to initialize the engine, enabling further channel operations. In your `MainActivity` file, add the following code:

<Tabs groupId="language">
<TabItem value="java" label="Java" default>
<CodeBlock language="java" showLineNumbers>
{`// Fill in the app ID from Agora Console
private String myAppId = "<Your app ID>";
private RtcEngine mRtcEngine;

private void initializeEngine() {
    try {
        RtcEngineConfig config = new RtcEngineConfig();
        config.mContext = getBaseContext();
        config.mAppId = myAppId;
        config.mEventHandler = mRtcEventHandler;
        mRtcEngine = RtcEngine.create(config);
    } catch (Exception e) {
        throw new RuntimeException("Error initializing RTC engine: " + e.getMessage());
    }
}`}
</CodeBlock>

</TabItem>

<TabItem value="kotlin" label="Kotlin">

<CodeBlock language="kotlin" showLineNumbers>
{`// Fill in the App ID obtained from the Agora Console
private val myAppId = "<Your app ID>"
private var mRtcEngine: RtcEngine? = null

private fun initializeEngine() {
    try {
        val config = RtcEngineConfig().apply {
            mContext = baseContext
            mAppId = myAppId
            mEventHandler = mRtcEventHandler
        }
        mRtcEngine = RtcEngine.create(config)
    } catch (e: Exception) {
        throw RuntimeException("Error initializing RTC engine: \${e.message}")
    }
}`}
</CodeBlock>

</TabItem>
</Tabs>

### Join a channel

To join a channel, call `joinChannel` with the following parameters:

- **Channel name**: The name of the channel to join. Clients that pass the same channel name join the same channel. If a channel with the specified name does not exist, it is created when the first user joins.

- **Authentication token**: A dynamic key that authenticates a user when the client joins a channel. In a production environment, you obtain a token from a [token server](../token-authentication/deploy-token-server) in your security infrastructure. For the purpose of this guide [Generate a temporary token](../get-started/manage-agora-account#generate-temporary-tokens).

- **User ID**: A 32-bit signed integer that identifies a user in the channel. You can specify a unique user ID for each user yourself. If you set the user ID to `0` when joining a channel, the SDK generates a random number for the user ID and returns the value in the `onJoinChannelSuccess` callback. 

- **Channel media options**: Configure `ChannelMediaOptions` to define publishing and subscription settings, optimize performance for your specific use-case, and set optional parameters. 

For voice calling, set the `channelProfile` to `CHANNEL_PROFILE_COMMUNICATION` and the user role to `CLIENT_ROLE_BROADCASTER`.

<Tabs groupId="language">
<TabItem value="java" label="Java" default>
<CodeBlock language="java" showLineNumbers>
{`// Fill in the channel name
private String channelName = "<Your channel name>";
// Fill in the temporary token generated from Agora Console
private String token = "<Your token>";

private void joinChannel() {
    ChannelMediaOptions options = new ChannelMediaOptions();
    options.clientRoleType = Constants.CLIENT_ROLE_BROADCASTER;
    options.channelProfile = Constants.CHANNEL_PROFILE_COMMUNICATION;
    options.publishMicrophoneTrack = true;
    mRtcEngine.joinChannel(token, channelName, 0, options);
}`}
</CodeBlock>
</TabItem>

<TabItem value="kotlin" label="Kotlin">
<CodeBlock language="kotlin" showLineNumbers>
{`// Fill in the channel name
private val channelName = "<Your channel name>"
// Fill in the temporary token generated from Agora Console
private val token = "<Your token>"

private fun joinChannel() {
    val options = ChannelMediaOptions().apply {
        clientRoleType = Constants.CLIENT_ROLE_BROADCASTER
        channelProfile = Constants.CHANNEL_PROFILE_COMMUNICATION
        publishMicrophoneTrack = true;
    }
    mRtcEngine?.joinChannel(token, channelName, 0, options)
}`}
</CodeBlock>
</TabItem>

</Tabs>

### Subscribe to SDK events

The <Vpd k="SDK"/> provides an interface for subscribing to channel events. To use it, create an instance of `IRtcEngineEventHandler` and implement the event methods you want to handle.

<Admonition type="info">
To ensure that you receive all <Vpd k="SDK" /> events, set the <Vg k="ENGINE" /> event handler before joining a channel.
</Admonition>

<Tabs groupId="language">
<TabItem value="java" label="Java" default>
<CodeBlock language="java" showLineNumbers>
{`private final IRtcEngineEventHandler mRtcEventHandler = new IRtcEngineEventHandler() {
    // Callback when successfully joining the channel
    @Override
    public void onJoinChannelSuccess(String channel, int uid, int elapsed) {
        super.onJoinChannelSuccess(channel, uid, elapsed);
        showToast("Joined channel " + channel);
    }
    // Callback when a remote user or host joins the current channel
    @Override
    public void onUserJoined(int uid, int elapsed) {
        super.onUserJoined(uid, elapsed);
        showToast("User joined: " + uid); // Show toast for user joining
    }
    // Callback when a remote user or host leaves the current channel
    @Override
    public void onUserOffline(int uid, int reason) {
        super.onUserOffline(uid, reason);
        showToast("User offline: " + uid); // Show toast for user going offline
    }
};`}
</CodeBlock>

</TabItem>
<TabItem value="kotlin" label="Kotlin" default>
<CodeBlock language="kotlin" showLineNumbers>
{`private val mRtcEventHandler = object : IRtcEngineEventHandler() {
    override fun onJoinChannelSuccess(channel: String?, uid: Int, elapsed: Int) {
        super.onJoinChannelSuccess(channel, uid, elapsed)
        showToast("Joined channel $channel")
    }
    override fun onUserJoined(uid: Int, elapsed: Int) {
        showToast("User joined: $uid")
    }
    override fun onUserOffline(uid: Int, reason: Int) {
        super.onUserOffline(uid, reason)
        showToast("User offline: $uid")
    }
}`}
</CodeBlock>
</TabItem>
</Tabs>

### Handle permissions

To access the <Vpd k="MEDIA_DEVICES" /> on Android devices, declare the necessary permissions in the app's manifest and ensure that the user grants these permissions when the <Vpl k="CLIENT" /> starts.

1. Open your project's `AndroidManifest.xml` file and add the following permissions before `<application>`:
    
    ```xml
    <!--Required permissions-->
    <uses-permission android:name="android.permission.INTERNET"/>
    
    <!--Optional permissions-->
    <uses-permission android:name="android.permission.RECORD_AUDIO"/>
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/>
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/>
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.BLUETOOTH"/>
    <!-- For devices running Android 12 (API level 32) or higher and integrating Agora Voice SDK version v4.1.0 or lower, you also need to add the following permissions -->
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT"/>
    <!-- For Android 12 or higher, the following permissions are also required -->
    <uses-permission android:name="android.permission.READ_PHONE_STATE"/>
    <uses-permission android:name="android.permission.BLUETOOTH_SCAN"/>
    ```

1. Use the following code to handle runtime permissions in your Android app. The logic ensures that the necessary permissions are granted before starting <Vpd k="NAME" />. In your `MainActivity` file, add the following code:

    <Tabs groupId="language">
    <TabItem value="java" label="Java" default>

    <CodeBlock language="java" showLineNumbers>
    {`private static final int PERMISSION_REQ_ID = 22;
   // Get the permissions required for real-time audio interaction experience
   private String[] getRequiredPermissions(){
       // Determine the permissions required when targetSDKVersion is 31 and above
       if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
           return new String[]{
                   Manifest.permission.RECORD_AUDIO, // Audio recording permission
                   Manifest.permission.READ_PHONE_STATE, // Read phone state permission
                   Manifest.permission.BLUETOOTH_CONNECT // Bluetooth connection permission
           };
       } else {
           return new String[]{
                   Manifest.permission.RECORD_AUDIO,
           };
       }
   }
   private boolean checkPermissions() {
       for (String permission : getRequiredPermissions()) {
           int permissionCheck = ContextCompat.checkSelfPermission(this, permission);
           if (permissionCheck != PackageManager.PERMISSION_GRANTED) {
               return false;
           }
       }
       return true;
   }`}
    </CodeBlock>
    </TabItem>

    <TabItem value="kotlin" label="Kotlin">
    <CodeBlock language="kotlin" showLineNumbers>
    {`
   private val PERMISSION_REQ_ID = 22
   // Get the permissions required for real-time audio interaction experience
   private fun getRequiredPermissions(): Array<String> {
       // Determine the permissions required when targetSDKVersion is 31 and above
       return if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.S) {
           arrayOf(
               Manifest.permission.RECORD_AUDIO, // Audio recording permission
               Manifest.permission.READ_PHONE_STATE, // Read phone state permission
               Manifest.permission.BLUETOOTH_CONNECT // Bluetooth connection permission
           )
       } else {
           arrayOf(
               Manifest.permission.RECORD_AUDIO
           )
       }
   }

   private fun checkPermissions(): Boolean {
       for (permission in getRequiredPermissions()) {
           val permissionCheck = ContextCompat.checkSelfPermission(this, permission)
           if (permissionCheck != PackageManager.PERMISSION_GRANTED) {
               return false
           }
       }
       return true
   }`}
    </CodeBlock>
    </TabItem>
    </Tabs>

### Start and close the app

When a user launches your <Vpl k="CLIENT"/>, start real-time interaction. When a user closes the app, stop the interaction.

1. In the `onCreate` callback, check whether the <Vpl k="CLIENT"/> has been granted the required permissions. If the permissions have not been granted, request the required permissions from the user. If permissions are granted, initialize `RtcEngine` and join a channel.

    <Tabs groupId="language">
    <TabItem value="java" label="Java" default>

    <CodeBlock language="java" showLineNumbers>
    {`@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        if (checkPermissions()) {
            initializeAndJoinChannel();  
        } else {
            ActivityCompat.requestPermissions(this, getRequiredPermissions(), PERMISSION_REQ_ID);  
        }
    }`}
    </CodeBlock>
    </TabItem>

    <TabItem value="kotlin" label="Kotlin">
    <CodeBlock language="kotlin" showLineNumbers>
    {`override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
        
        if (checkPermissions()) {
            initializeAndJoinChannel()
        } else {
            ActivityCompat.requestPermissions(this, getRequiredPermissions(), PERMISSION_REQ_ID)
        }
    }`}
    </CodeBlock>
    </TabItem>

    </Tabs>    
    
2. When a user closes the <Vpl k="CLIENT"/>, or switches the <Vpl k="CLIENT"/> to the background, call `leaveChannel` to leave the current channel and release all session-related resources.

    <Tabs groupId="language">
    <TabItem value="java" label="Java" default>
    <CodeBlock language="java" showLineNumbers>
    {`private void cleanupAgoraEngine() {
        if (mRtcEngine != null) {
            mRtcEngine.leaveChannel();
            mRtcEngine = null;
            RtcEngine.destroy();
        }
    }`}
    </CodeBlock>
    </TabItem>

    <TabItem value="kotlin" label="Kotlin">
    <CodeBlock language="kotlin" showLineNumbers>
    {`private fun cleanupAgoraEngine() {
        if (mRtcEngine != null) {
            mRtcEngine?.leaveChannel()
            mRtcEngine = null
            RtcEngine.destroy()
        }
    }`}
    </CodeBlock>
    </TabItem>

    </Tabs>

### Complete sample code

A complete code sample demonstrating the basic process of real-time interaction is provided for your reference. To use the sample code, copy the following lines into the `MainActivity` file in your project. Then, replace `<projectname>` in package `com.example.<projectname>` with your project's name.

<details>
<summary>Complete sample code for voice interaction</summary>

<Tabs groupId="language">
<TabItem value="java" label="Java" default>
<CompleteCodeJava />
</TabItem>

<TabItem value="kotlin" label="Kotlin">
<CompleteCodeKotlin />
</TabItem>
</Tabs>

</details>

<Admonition type="info">
For the `myAppId` and `token` variables, replace the placeholders with the values you obtained from <Vg k="CONSOLE"/>. Ensure you enter the same `channelName` you used when generating the temporary token.
</Admonition>

### Create a user interface
Use the following code to generate a basic user interface. Paste the code into the `/app/src/main/res/layout/activity_main.xml` file, replacing the existing content. 

<details>
<summary>Sample code to create the user interface</summary>
<CodeBlock language="xml" showLineNumbers>
{`<?xml version="1.0" encoding="UTF-8"?>
<RelativeLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/activity_main"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:background="@android:color/darker_gray"
    tools:context=".MainActivity">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_centerInParent="true"
        android:text="Welcome to Agora Voice Calling." />
        
</RelativeLayout>`}
</CodeBlock>
</details>

</PlatformWrapper>
