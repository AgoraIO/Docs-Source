import * as data from '@site/data/variables';
import Prerequites from '@docs/shared/common/prerequities.mdx';
import ProjectSetup from '@docs/shared/video-sdk/develop/speech-to-text/project-setup/index.mdx';
import ProjectImplement from '@docs/shared/video-sdk/develop/speech-to-text/project-implementation/index.mdx';
import ProjectTest from '@docs/shared/video-sdk/develop/speech-to-text/project-test/index.mdx';
import Reference from '@docs/shared/video-sdk/develop/speech-to-text/reference/index.mdx';


<Vg k="COMPANY" /> provides a speech-to-text service which takes the audio content of a host's media stream and transcribes it into written words in real time. This doc explains how to start and stop speech recognition in an app, then download and present the transcript.

## Understand the tech

Send an HTTP request to the Agora server through your business server to convert speech to text in real time. The speech-to-text service supports two modes:

* Convert speech to text in real time.
* Convert speech to text in real time, store the text in WebVTT format and upload the file to a third-party cloud storage.

In order to use the RESTful API to convert speech to text, you take the following steps:

1. Call the `acquire` method to request a `builderToken` for speech-to-text. A `buildToken` is valid for 5 minutes.
1. Call the `start` method within five minutes after getting the `builderToken` to start the speech-to-text task.
1. After you start a speech-to-text task, call `query` to check its status.
1. Call the `stop` method to stop the speech-to-text task.

The following figure shows the workflow you need to integrate speech to text functionality into your <Vpl k="CLIENT" />.

`<TODO: Add figure here>`

## Prerequisites

In order to follow this procedure you must have:

* Implemented <Link to="../get-started/get-started-sdk">Get Started with <Vpd k="NAME"/></Link>
* Enabled the speech-to-text service for your project. Contact sales@agora.io
* To record and store speech-to-text videos and texts, make sure you have activated a [supported cloud storage service](#supported-third-party-cloud-storage-services). 

<Prerequites />

## Project setup

To create the environment necessary to implement playing media files into your <Vpl k="CLIENT" />, open the project you created in <Link to="../get-started/get-started-sdk">Get Started with <Vpd k="NAME"/></Link>.

<ProjectSetup />

## Add a speech to text to your <Vpl k="CLIENT" />

This section shows how to use the <Vg k="VSDK" /> to implement a speech to text into your <Vpl k="CLIENT" />, step-by-step.

<ProjectImplement />

## Test your implementation

To ensure that you have implemented speech to text features into your <Vpl k="CLIENT" />:

1. [Generate a temporary token](../reference/manage-agora-account#generate-a-temporary-token) in <Vg k="CONSOLE" /> .

2. In your browser, navigate to the <Link target="_blank" to="{{Global.DEMO_BASIC_VIDEO_CALL_URL}}"><Vg k="COMPANY" /> web demo</Link> and update _App ID_, _Channel_, and _Token_ with the values for your temporary token, then click **Join**.

<ProjectTest />


## Reference

This section contains information that completes the information in this page, or points you to documentation that explains other aspects to this product.

### Acquire: Generate a builderToken

A `builderToken` secures your speech-to-text tasks. Call this method to generate a builderToken before starting a speech-to-text task.

Use this `builderToken` to send a request within 5 minutes. After the time has expired, you need to generate a new builderToken; otherwise, other methods cannot be called.

#### HTTP request

```
POST https://api.agora.io/v1/projects/<appId>/rtsc/speech-to-text/builderTokens
```

**Path parameter**
`appId`: (Required) String. The App ID provided by Agora. 

**Request header**
* `Content-Type`: `application/json`
* `Authorization`: The value of this field needs to refer to the authentication instructions.

**Request body**
The following parameters need to be passed in the request body:

| Field | Type | Description |
|:------|:----|:----------------|
|`instanceId`|String|(Required) The instance ID set by the developer. The maximum length is 64 characters. The following character sets are supported:<ul><li>All lowercase English letters (a-z)</li><li>All uppercase English letters (A-Z)</li><li>All numeric characters: 0-9</li><li>"-", "_"</li></ul>One `instanceId` can generate multiple `builderTokens`, but only one `builderToken` can be used to send a request in a task. |

Request body example:
```json
{
    "instanceId": "XXXX"
}
```

#### HTTP response

If the status code is 2XX, the request is successful. The response body contains the following fields:

| Field | Type | Description |
|:------|:----|:----------------|
| `tokenName` | String | The value of the dynamic key `builderToken`. This value needs to be passed in when calling other methods. |
| `createTs` | Number | The Unix timestamp (seconds) when the builderToken was generated. |
| `instanceId` | Number | The instance ID set in the request body. |

Response body example:
```json
{
    "tokenName": "XXXXXX",
    "createTs": 1550024508,
    "instanceId": "XXXXXX"
}
```

If the status code is not 2XX, the request fails. The response body contains the message field, reporting the reason for the failure of the request.

### Start: Start a speech-to-text task


A builderToken can guarantee the security of your request. You should generate a builderToken before calling the start method.

#### HTTP request
```
POST https://api.agora.io/v1/projects/<appid>/rtsc/speech-to-text/tasks?builderToken=<tokenName>
```
**Path parameter**

`appId`: (Required) String. The App ID provided by Agora.

**Query parameter**

`builderToken`: The dynamic key obtained through the generate a `builderToken` method. Used to ensure the security of speech-to-text tasks.

**Request header**
* `Content-Type`: `application/json`
* `Authorization`: The value of this field needs to refer to the authentication instructions.

**Request body**
The following parameters need to be passed in the request body:

| Field | Type | Description |
|:------|:----|:----------------|
| `audio` | JSON Object | (Required) The configuration for input audio. |
| `audio.subscribeSource` | String | (Required) The source type of the audio input.Supports the audio stream published in the Agora RTC channel only. The type is `AGORARTC`. |
| `audio.agoraRtcConfig` | JSON Object | (Required) Information required to enter the Agora RTC channel. |
| `audio.agoraRtcConfig.channelName` | String | (Required) The RTC channel name. |
| `audio.agoraRtcConfig.uid` | String | (Required) The RTC user ID. Every user ID in the RTC channel must be unique. |
| `audio.agoraRtcConfig.token` | String | (Optional) The token required to enter the RTC channel. Used to ensure channel security. |
| `audio.agoraRtcConfig.channelType` | String | (Required) The channel profile. For a speech-to-text task, you need to set the channel profile to live streaming (LIVE_TYPE). |
| `audio.agoraRtcConfig.subscribeConfig` | JSON Object | (Required) The subscription configuration. |
| `audio.agoraRtcConfig.maxIdleTime` | Number | (Optional) The maximum idle channel time (seconds). The default value is 30. The value range is [5, 2,592,000]. If there is no user in the channel for longer than this time, the task automatically stops. |
| `config` | JSON Object | (Required) The feature configuration. |
| `config.features` | JSON Array | (Required) The service type. Only speech to text (RECOGNIZE) is supported. |
| `config.recognizeConfig` | JSON Object | (Required) The speech-to-text conversion configuration. |

**Subscription configuration**

| Field | Type | Description |
|:------|:----|:----------------|
| `subscribeConfig.subscribeMode` | String | (Required) The subscription mode. To use speech to text, you need to set this field to `CHANNEL_MODE`. |

**Conversion configuration**
| Field | Type | Description |
|:------|:----|:----------------|
| `recognizeConfig.language` | String | (Required) The conversion language. Because the speech-to-text service currently only supports English as conversion language, you need to set this field to `ENG`. |
| `recognizeConfig.model` | String | (Required) The conversion mode. To use speech to text, you need to set this field to `Model`. |
| `recognizeConfig.output` | JSON Object | (Required) The output configuration. |
| `recognizeConfig.output.destinations` | JSON Array | (Required) The target channel type for the output streams. Set this field as `AgoraRTCDataStream` to push speech-to-text conversion output to RTC channel. If you need to store speech-to-text output text in WebVTT format to third-party cloud storage, you also need to add `Storage` to the field. |
| `recognizeConfig.output.agoraRTCDataStream` | JSON Object | (Required) The target channel configuration. | 
| `recognizeConfig.output.cloudStorage` | JSON Array | (Optional) The third-party cloud storage configuration. This field must be set to store speech-to-text output text and subtitle file. |

**Target channel configuration**

| Field | Type | Description |
|:------|:----|:----------------|
| `agoraRTCDataStream.channelName` | String	(Required)| The target channel name. |
| `agoraRTCDataStream.uid` | String | (Required)The RTC user ID in target channel. |
| `agoraRTCDataStream.token` | String | (Required) The token required to enter the RTC channel. Used to ensure channel security. |

**Cloud storage configuration**

| Field | Type | Description |
|:------|:----|:----------------|
| `cloudStorage.format` | String | (Required) Reserved filed. You need to set this field to `HLS`. |
| `cloudStorage.storageConfig` | JSON Object | (Required) The third-party cloud storage information configuration, for storing speech-to-text output text and subtitle file. |

**`cloudStorage.storageConfig`**

When speech-to-text process ends, an output text file (txt format) and a subtitle file (WebVTT format) are generated. This field is used to store the two files.

| Field | Type | Description |
|:------|:----|:----------------|
| `accessKey` | String| (Required) The access key of the third-party cloud storage. In general, Agora recommends providing write-only access keys. For delayed transcoding, the access key must have both read and write permissions.
| `secretKey` | String| (Required) The secret key of the third-party cloud storage.
| `bucket` | String | (Required) The bucket of the third-party cloud storage. The bucket name must conform to the naming rules of the corresponding third-party cloud storage service.
| `vendor` | Number | (Required) The third-party cloud storage platform.
| `region` | Number | (Required) The region information specified for the third-party cloud storage.
| `fileNamePrefix` | JSON Array | (Optional) An array of strings specifying where the recorded files are stored in the third-party cloud storage. For example, if `fileNamePrefix` = `["directory1","directory2"]`, Agora speech-to-text adds the prefix `"directory1/directory2/"` before the name of the recorded file, that is, `directory1/directory2/xxx.m3u8`. The maximum length of the prefix, including the slashes, is 128 characters. The string itself cannot contain symbols such as slash, underscore, or parenthesis. The following character sets are supported:<ul><li>All lowercase English letters (a-z)</li><li>All uppercase English letters (A-Z)</li><li>All numeric characters: 0-9</li><li>"-", "_"</li></ul> |

Request body example:
```json
{
    "audio": {
        "subscribeSource": "AGORARTC",
        "agoraRtcConfig": {
            "channelName": "<YourChannelName>",
            "uid": "<YourUid>",
            "token": "<YourToken>",
            "channelType": "<YourChannelType>",
            "subscribeConfig": {
                "subscribeMode": "CHANNEL_MODE"
            },
            "maxIdleTime": 60
        }
    },
    "config": {
        "features": [
            "RECOGNIZE"
        ],
        "recognizeConfig": {
            "language": "ENG",
            "model": "Model",
            "output": {
                "destinations": [
                    "AgoraRTCDataStream",
                      "Storage"
                ],
                "agoraRTCDataStream": {
                    "channelName": "<YourChannelName>",
                    "uid": "<YourUid>",
                    "token": "<YourToken>"
                },
                "cloudStorage": [
                    {
                        "format": "HLS",
                        "storageConfig": {
                            "accessKey": "<YourOssAccessKey>",
                            "secretKey": "<YourOssSecretKey>",
                            "bucket": "<YourOssBucketName>",
                            "vendor": "<YourOssVendor>",
                            "region": "<YourOssRegion>",
                            "fileNamePrefix": "<YourOssPrefix>"
                        }
                    }
                ]
            }
        }
    }
}
```
#### HTTP response

**Response body**

If the status code is 2XX, the request is successful. The response body contains the following fields:

| Field | Type | Description |
|:------|:----|:----------------|
| `taskId` | String | The task ID, a UUID (Universal Unique Identifier) generated by the Agora server to identify a speech-to-text task that has been created. |
| `createTs` | Number | The Unix timestamp (seconds) when the task was created. |
| `status` | Number | The running status of tasks:<ul><li>`IDLE`: The task has not started or has ended.</li><li>`PREPARING`: The task has received a start request.</li><li>`IN_PROGRESS`: The task is in progress.</li><li>`STOPPING`: The task is stopping.</li><li>`STOPPED`: The task has been stopped.</li><li>`RECONNECTING`: The task is being reestablished.</li></ul> |

If the status code is not 2XX, the request fails. The response body contains the message field, reporting the reason for the failure of the request.

Response body example:
```json
{
   "taskId": "XXXX",
   "createTs": 1550024508,
   "status": "IN_PROGRESS"
}
```
### Query: Query the status of speech to text
#### HTTP request

```
GET https://api.agora.io/v1/projects/<appId>/rtsc/speech-to-text/tasks/<taskId>?builderToken=<tokenName>
```

**Path parameter**

`appId`: (Required) String. The App ID provided by Agora. 

**Query parameter**

`builderToken`: (Required) String. Get the parameter value `tokenName` of `builderToken` by generating `builderToken` method.

**Request header**

`Content-Type`: `application/json`
`Authorization`: The value of this field needs to refer to the authentication instructions.

#### HTTP response

**Response body**

If the status code is 2XX, the request is successful. The response body contains the following fields:

| Field | Type | Description |
|:------|:----|:----------------|
| `taskId` | String | The task ID, a UUID (Universal Unique Identifier) generated by the Agora server to identify a speech-to-text task that has been created. |
| `createTs` | Number | The Unix timestamp (seconds) when the task was created. |
| `status` | Number | The running status of tasks:<ul><li>`IDLE`: The task has not started or has ended.</li><li>`PREPARING`: The task has received a start request.</li><li>`IN_PROGRESS`: The task is in progress.</li><li>`STOPPING`: The task is stopping.</li><li>`STOPPED`: The task has been stopped.</li><li>`RECONNECTING`: The task is being reestablished.</li></ul> |

Response body example:

```json
{
   "taskId": "XXXX",
   "createTs": 1550024508,
   "status": "IN_PROGRESS"
}
```

### Stop: Stop speech-to-text

####  HTTP request

```
DELETE https://api.agora.io/v1/projects/<appId>/rtsc/speech-to-text/tasks/<taskId>?builderToken=<tokenName>
```

**Path parameter**

* `appId`: (Required) String. The App ID provided by Agora. An App ID is the unique identification of a project. You can get an App ID after creating a project in Agora console.
* `taskId`: (Required) String. The task ID generated by calling the start method. A task ID is a UUID (Universal Unique Identifier) generated by the Agora server to identify a speech-to-text task that has been created.
* `tokenName`: The value of the dynamic key builderToken.

**Query parameter**

`builderToken`: The dynamic key obtained through the generate a `builderToken` method. Used to ensure the security of speech-to-text tasks.

#### HTTP response

### Supported third-party cloud storage services

The following third-party cloud storage service providers are currently supported:

* [Alibaba Cloud](https://www.alibabacloud.com/product/oss)
* [Amazon S3](https://aws.amazon.com/s3/?nc1=h_ls)
* [Baidu AI Cloud](https://intl.cloud.baidu.com/product/bos.html)
* [Google Cloud](https://cloud.google.com/storage)
* [Huawei Cloud](https://www.huaweicloud.com/intl/en-us/product/obs.html)
* [Kingsoft Cloud](https://en.ksyun.com/nv/product/KS3.html)
* [Microsoft Azure](https://azure.microsoft.com/en-us/services/storage/blobs/)
* [Qiniu Cloud](https://www.qiniu.com/en/products/kodo)
* [Tencent Cloud](https://intl.cloud.tencent.com/product/cos)


<Reference />
