<PlatformWrapper platform="android">
This section shows how to use the <Vpd k="SDK" /> to implement <Vpd k="PRODUCT" /> features into your <Vpl k="CLIENT" />, step-by-step.

At startup, you initialize the RTC service. When a user taps a button, the <Vpl k="CLIENT" /> joins or leaves a channel. When another user joins the same channel, their video and audio is rendered in the <Vpl k="CLIENT" />. 

### Implement the user interface

In the interface, create buttons to join and leave a channel. In `/app/res/layout/activity_main.xml`, replace the contents of the file with the following:

    ``` xml
    <?xml version="1.0" encoding="UTF-8"?>
    <ScrollView xmlns:android="http://schemas.android.com/apk/res/android"
                xmlns:tools="http://schemas.android.com/tools"
                android:id="@+id/activity_main"
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                tools:context=".MainActivity">

        <RelativeLayout
            android:layout_width="match_parent"
            android:layout_height="wrap_content">

            <Button
                android:id="@+id/JoinButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_margin="10dp"
                android:onClick="joinChannel"
                android:text="Join" />

            <Button
                android:id="@+id/LeaveButton"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_margin="10dp"
                android:layout_toRightOf="@id/JoinButton"
                android:onClick="leaveChannel"
                android:text="Leave" />
        </RelativeLayout>
    </ScrollView>
    ```

You see errors in your IDE. This is because this layout refers to methods that you create later.

### Handle the system logic

Import the necessary Android classes and handle Android permissions.

1.  **Import the Android classes**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines after `package com.example.<project name>`:

        ``` java
        import androidx.core.app.ActivityCompat;
        import androidx.core.content.ContextCompat;
        import android.Manifest;
        import android.content.pm.PackageManager;
        import android.view.View;
        import android.widget.Toast;
        ```

2.  **Handle Android permissions**

    When your app launches, ensure that the permissions necessary to use <Vpd k="PRODUCT" /> features are granted. If the permissions are not granted, use the built-in Android feature to request them; if they are granted, return `true`.

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines before the `onCreate` method:

    ``` java
    private static final int PERMISSION_REQ_ID = 22;
    private static final String[] REQUESTED_PERMISSIONS =
        {
            Manifest.permission.RECORD_AUDIO,
            Manifest.permission.CAMERA
        };

    private boolean checkSelfPermission()
    {
        if (ContextCompat.checkSelfPermission(this, REQUESTED_PERMISSIONS[0]) !=  PackageManager.PERMISSION_GRANTED ||
                ContextCompat.checkSelfPermission(this, REQUESTED_PERMISSIONS[1]) !=  PackageManager.PERMISSION_GRANTED)
        {
            return false;
        }
        return true;
    }
    ```

3.  **Show status updates to your users**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines before the `onCreate` method:

    ``` javascript
    void showMessage(String message) {
        runOnUiThread(() ->
            Toast.makeText(getApplicationContext(), message, Toast.LENGTH_SHORT).show());
    }
    ```

### Implement the channel logic

To implement <Vpd k="PRODUCT" />, take the following steps:

1.  **Import the <Vpd k="SDK" /> classes**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines after the last `import` statement:

    ``` java
    import io.agora.rtc.AgoraRtcService;
    import io.agora.rtc.AgoraRtcEvents;
    ```

1.  **Declare the variables that you use to create and join a channel**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines to `MainActivity` class:
        ``` java
        // Fill the App ID of your project generated on Agora Console.
        private final String appId = "<Your app Id>";
        // Fill the channel name.
        private String channelName = "<Your channel name>";
        // Fill the temp token generated on Agora Console.
        private String token = "<your access token>";
        // An integer that identifies the local user.
        private int uid = 0;
        private boolean isJoined = false;
        private String rtcLicense = "<Your device license string>";
        private int connectionId;

        private AgoraRtcService agoraRtcService;
        ```

1.  **Setup <Vg k="COMPANY" /> RTC Service**

    To use <Vpd k="PRODUCT" /> features, you use the <Vpd k="SDK" /> to create a RTC service instance. In `/app/java/com.example.<projectname>/MainActivity`, add the following code before the `onCreate` method:

    ``` java
    private void setupAgoraRtcService(){
        agoraRtcService= new AgoraRtcService();

        // This method is used for License verification 
        // If the license is not used, this method can be ignored
        String credential = agoraRtcService.licenseGenCredential();
        int licenseRet = agoraRtcService.licenseVerify(rtcLicense, credential);
        if (licenseRet < 0) {
            showMessage("Failed to verify device license");
            return;
        } else {
            showMessage("License verified");
        }
        // Specify service options
        AgoraRtcService.RtcServiceOptions rtcServiceOptions = new AgoraRtcService.RtcServiceOptions();
        rtcServiceOptions.areaCode = AgoraRtcService.AreaCode.AREA_CODE_GLOB;
        // Initialize the service
        agoraRtcService.init(appId, agoraRtcEvents, rtcServiceOptions);
    }
    ```

1.  **Handle and respond to service events**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following lines before `setupAgoraRtcService`:

        ``` java
        private final AgoraRtcEvents agoraRtcEvents = new AgoraRtcEvents() {
            @Override
            public void onJoinChannelSuccess(int connId, int uid, int elapsed_ms) {
                isJoined = true;
                showMessage("Successfully joined the channel");
            }

            @Override
            public void onConnectionLost(int connId) {
                // Connection was lost.
            }

            @Override
            public void onRejoinChannelSuccess(int connId, int uid, int elapsed_ms) {
                // The channel was successfully rejoined
            }

            @Override
            public void onError(int connId, int code, String msg) {
                // A warning callback that reports a network or media related error.
                // Normally, the app can ignore the warning message and the SDK will automatically recover.
            }

            @Override
            public void onUserJoined(int connId, int uid, int elapsed_ms) {
                // A remote user joined the channel.
            }

            @Override
            public void onUserOffline(int connId, int uid, int reason) {
                // A remote user went offline
            }

            @Override
            public void onUserMuteAudio(int connId, int uid, boolean muted) {
                // A remote user paused or resumed sending the audio stream
            }

            @Override
            public void onUserMuteVideo(int connId, int uid, boolean muted) {
                // A remote user paused or resumed sending the video stream
            }

            @Override
            public void onKeyFrameGenReq(int connId, int requestedUid, int streamType) {
                // Callback for key frame requests from remote users in the channel
            }

            @Override
            public void onAudioData(int connId, int uid, int sent_ts, byte[] data, AgoraRtcService.AudioFrameInfo info) {
                // Receive the audio frame callback of the remote user in the channel.
                // Add code here to render audio.
            }

            @Override
            public void onMixedAudioData(int connId, byte[] data, AgoraRtcService.AudioFrameInfo info) {
                // Callback for receiving audio mixing data from local and remote users in the channel.
                // This callback fires every 20 ms.
            }

            @Override
            public void onVideoData(int connId, int uid, int sent_ts, byte[] data, AgoraRtcService.VideoFrameInfo info) {
                // Receive video frame data from a remote user in the channel.
                // Add code here to render video.
            }

            @Override
            public void onTargetBitrateChanged(int connId, int targetBps) {
                // Encoder code rate update notification callback.
                // Use this callback to update the encoder bit rate.
            }

            @Override
            public void onTokenPrivilegeWillExpire(int connId, String token) {
                // The current authentication token will expire in 30 seconds
                // Get a new token and call the renewToken method
            }

            @Override
            public void onMediaCtrlReceive(int connId, int uid, byte[] payload) {

            }

        };
        ```

1.  **Join a channel**

    When a local user initiates a connection, call `joinChannel`. This method securely connects the local user to a channel using the authentication token. In `/app/java/com.example.<projectname>/MainActivity`, add the following code after `setupAgoraRtcService`:

        ``` java
        public void joinChannel(View view) {
            // Create a Connection
            connectionId = agoraRtcService.createConnection();
            if (connectionId == AgoraRtcService.ConnectionIdSpecial.CONNECTION_ID_INVALID) {
                showMessage("Failed to create a connection");
                return;
            }
            // Set channel options
            AgoraRtcService.ChannelOptions channelOptions = new AgoraRtcService.ChannelOptions();
            channelOptions.autoSubscribeAudio = true;
            channelOptions.autoSubscribeVideo = true;
            channelOptions.audioCodecOpt.audioCodecType 
                = AgoraRtcService.AudioCodecType.AUDIO_CODEC_TYPE_OPUS; // Choose an audio codec option
            channelOptions.audioCodecOpt.pcmSampleRate = 16000;
            channelOptions.audioCodecOpt.pcmChannelNum = 1;

            int ret = agoraRtcService.joinChannel(connectionId, channelName, uid, token, channelOptions);
            if (ret != AgoraRtcService.ErrorCode.ERR_OKAY) {
                showMessage("Failed to join a channel");
            }
        }
        ```

1. **Send and receive audio and video data**

    After joining an RTC channel, you can:

        * Listen to the `onAudioData` callback to receive audio from users in the channel.
        * Listen to the `onVideoData` callback to receive video from users in the channel. 
        * Call the `sendAudioData` method to send audio data.
        * Call the `sendVideoData` method to send video data.

    Write your own methods to load audio and video data from your device into byte arrays for sending to the channel. When sending audio and video data, you set the sending interval such that it is consistent with the video frame rate and audio frame length.
    
    Use the following code to create and push a video frame from the byte array:

        ```java
            byte[] videoBuffer = new byte[frameSize];
            // Add code here to load video frame data

            // Create and send a video frame
            AgoraRtcService.VideoFrameInfo videoFrameInfo = new AgoraRtcService.VideoFrameInfo();
            videoFrameInfo.dataType = AgoraRtcService.VideoDataType.VIDEO_DATA_TYPE_H264;
            videoFrameInfo.streamType = AgoraRtcService.VideoStreamType.VIDEO_STREAM_HIGH;
            videoFrameInfo.frameType = AgoraRtcService.VideoFrameType.VIDEO_FRAME_KEY;
            videoFrameInfo.frameRate = AgoraRtcService.VideoFrameRate.VIDEO_FRAME_RATE_FPS_15;
            int returnValue = agoraRtcService.sendVideoData(connectionId, videoBuffer, videoFrameInfo);
        ```
        
    Use the following code to create and push an audio frame from the byte array:

        ```java
            byte[] audioBuffer = new byte[frameSize];
            // Add code here to load audio frame data

            // Create and send an audio frame
            AgoraRtcService.AudioFrameInfo audioFrameInfo = new AgoraRtcService.AudioFrameInfo();
            audioFrameInfo.dataType = AgoraRtcService.AudioDataType.AUDIO_DATA_TYPE_PCM;
            int returnValue = agoraRtcService.sendAudioData(connectionId, audioBuffer, audioFrameInfo);
        ```

1.  **Leave the channel when a user ends the call**

    When a user presses the **Leave** button, use `leaveChannel` to exit the channel. In `/app/java/com.example.<projectname>/MainActivity`, add `leaveChannel` after `joinChannel`:

        ``` java
        public void leaveChannel(View view) {
            if (!isJoined) {
                showMessage("Join a channel first");
            } else {
                // Leave the channel
                int ret = agoraRtcService.leaveChannel(connectionId);
                if (ret != AgoraRtcService.ErrorCode.ERR_OKAY) {
                    showMessage("Failed to leave the channel");
                } else {
                    isJoined = false;
                }
            }
        }
        ```


### Start and stop your <Vpl k="CLIENT" />

In this implementation, you initiate and destroy the RTC service when the app opens and closes. The local user joins and leaves a channel using the same service instance. In order to send video and audio streams to <Vg k="COMPANY" />, you need to ensure that the local user gives permission to access the camera and microphone on the local device.

To elegantly start and stop your app:

1.  **Check that the app has the necessary permissions and initiate the service**

    In `/app/java/com.example.<projectname>/MainActivity`, replace `onCreate` with the following code:

        ``` java
        @Override
        protected void onCreate(Bundle savedInstanceState) {
            super.onCreate(savedInstanceState);
            setContentView(R.layout.activity_main);
            // If permissions are granted, set up the Rtc service.
            if (!checkSelfPermission()) {
                ActivityCompat.requestPermissions(this, REQUESTED_PERMISSIONS, PERMISSION_REQ_ID);
            }
            setupAgoraRtcService();
        }
        ```

2.  **Clean up the resources used by your app**

    When a user closes the app, use `onDestroy` to clean up all the resources you created. In `/app/java/com.example.<projectname>/MainActivity`, add `onDestroy` after `onCreate`:

    ``` java
    protected void onDestroy() {
        super.onDestroy();

        // Release all resources allocated to the SDK by the init method
        agoraRtcService.fini();

        // Destroy the connection
        agoraRtcService.destroyConnection(connectionId);
        connectionId = AgoraRtcService.ConnectionIdSpecial.CONNECTION_ID_INVALID;
    }
    ```
</PlatformWrapper>
