
This document describes how to use the interface and implementation for enabling low-bitrate high-definition features (PVC) for video transcoding on an RTMP gateway.

## Understand the tech

RTMPG currently supports enabling <Vg k="COMPANY" /> SDK's PVC function or Super Quality function while enabling video transcoding to achieve the **low code and high definition** function.

## Placement method

When creating a **Stream Configuration Template**, you can enable PVC or Super Quality.

The following is an example of a stream configuration template that enables PVC and ultra-high quality:

  ```json
  {
     "settings": {
        "transcoding": {
           "video": {
              "enabled": true,
              "width": 1920,
              "height": 1080,
              "fps": 30,
              "bitrate": 0
              "advancedOptions": {
                 "superResolution": {
                    "enabled": true,
                    "alphaBlending": 256
                 },
                 "pvc": {
                    "enabled": true,
                    "saveBitrateRatio": 20
                 }
              }
           },
           "audio": {
              "enabled": true,
              "profile": 3
           }
        }
     }
  }
  ```

Among them,
  1. Set "settings.transcoding.video.enabled" to "true" to enable video transcoding, and set appropriate resolution, frame rate, and bitrate information according to customer scenarios. 
  1. Use "settings.transcoding.video.advancedOptions" to start advanced configuration of video transcoding, including:
     1. "pvc": Enable and configure the PVC function:
        1. "enabled": Indicates whether PVC is enabled with a value of true or false(default).
        1. "saveBitrateRatio": The bitrate ratio saved by PVC, for example, 20 means save 20% bitrate. Note that this parameter only works when "video.bitrate" value is missing or 0.
     1. "superResolution": Enable and configure super quality:
        1. "enabled": Indicates whether Super Quality is enabled, with a value of true or false(default).
        1. "alphaBlending": Indicates the strength of Super Quality with a value of 1 ~ 256. The larger the value, the higher the strength, and the default is 128.

After configuring the flow configuration template, you can apply the template.

## Precautions

### Relationship between PVC and bitrate

It is important to note the relationship between the PVC function and the bitrate setting:
1. When `video.bitrate` is missing, the output bitrate will follow the source stream bitrate. If PVC is enabled and `saveBitrateRatio` is specified, the output bitrate will be reduced by a ratio based on the bitrate of the source stream.
1. When `video.bitrate` is 0, it means the bitrate of the transcoded output will be automatically calculated according to the resolution and frame rate, which is the recommended bitrate of sound network. If PVC is enabled and `saveBitrateRatio` is specified, the output bitrate will be reduced by a ratio based on the recommended bitrate of the network. 
1. When `video.bitrate` is explicitly set, the bitrate of the transcoded output is the set bitrate. If PVC is enabled, the pvc module will not adjust the output bitrate, but will process the picture before encoding. At this time, there is no need to set the `saveBitrateRatio` value (it will not work even if you set it).
1. The PVC function will save bitrate strictly according to the specified ratio, but whether the actual picture quality can achieve the effect of "low code and high definition" depends on the picture complexity of the source stream itself. When the source stream quality is simple, the HD effect can still be maintained under a higher saving ratio. When the source stream quality is complex, if the saving ratio is high, the quality may also deteriorate.

To summarize the above points, customers need to compare the output image quality through dynamic adjustment before going online according to their actual scenarios, so as to determine the saving ratio that suits them.

### Scope of application of PVC

The technical principle of PVC is to pre-process the YUV image before encoding to erase the details of the picture in the area that is not sensitive to the human eye. This allows the encoder to use the limited bitrate more in the areas that are sensitive to the human eye.

So, purely from the perspective of PVC itself, it is detrimental to the image quality.

So when is it suitable to turn on PVC? That is, in scenarios that require a fixed encoding output bitrate, and the bitrate is set so low that the encoder cannot guarantee the output image quality without turning on PVC. In short, PVC is only suitable when the bitrate is not enough.


As for what kind of bitrate is "not enough" in actual scenarios, this is not only related to the bitrate value, but also to the image complexity of the source stream itself. If the picture complexity is high and the bitrate is low, you can try to enable PVC. The specific needs have to be tested and verified according to the actual customer scenario.
