<PlatformWrapper platform="flutter">
        
### Implement the user interface

In a real-word application, you provide several buttons to enable a user to open, play, pause and stop playing files in the media player. In this simple example, you use a single `Button` to demonstrate the basic media player functions. You also add a `ProgressBar` to display the play progress to the user.

To add the UI elements, in `/app/res/layout/activity_main.xml`, add the following code before `</RelativeLayout>`:

``` dart
_mediaPLayerButton(),
Slider(
    value: _seekPos.toDouble(),
    min: 0,
    max: _duration.toDouble(),
    divisions: 100,
    label: '${(_seekPos / 1000.round())} s',
    onChanged: (double value) {
    _seekPos = value.toInt();
    _mediaPlayerController.seek(_seekPos);
    setState(() {});
    }),
```


``` dart
Widget _mediaPLayerButton() {
    String caption = "";

    if (!_isUrlOpened) {
        caption = "Load media file";
    } else if (_isPaused) {
        caption = "Resume playing";
    } else if (_isPlaying) {
        caption = "Pause playing media";
    } else {
        caption = "Play media file";
}
```

### Handle the system logic

To setup your project to use the media player APIs and access the UI elements, take the following steps:

**Declare the variables you need**

    To create and manage an instance of the media player and access the UI elements, in `/app/java/com.example.<projectname>/MainActivity`, add the following declarations to the `MainActivity` class:

    ``` java
    late final MediaPlayerController _mediaPlayerController;
    String mediaLocation =
    "https://webdemo.agora.io/agora-web-showcase/examples/Agora-Custom-VideoSource-Web/assets/sample.mp4";

    bool _isUrlOpened = false;
    bool _isPlaying = false;
    bool _isPaused = false;

    int _seekPos = 0;
    int _duration = 0;
    ```

### Implement media player functions

To implement playing and publishing media files in your <Vpl k="CLIENT" />, take the following steps:

1.  **Open, play and pause media files**

    When a user presses the button for the first time, you create an instance of the media player, set its `mediaPlayerObserver` to receive the callbacks, and open the media file. When the user presses the button again, you play the media file. On subsequent button presses, you pause or resume playing the media file alternately. To do this, add the following method to the `MainActivity` class:

    ``` dart
    void playMedia() async {
        if (!_isUrlOpened) {
            await initializeMediaPlayer();
            // Open the media file
            _mediaPlayerController.open(url:mediaLocation, startPos:0);
        } else if (_isPaused) {
            _mediaPlayerController.resume();
            setState(() {
                _isPaused = false;
            });
        } else if (_isPlaying) {
            _mediaPlayerController.pause();
            setState(() {
                _isPaused = true;
            });
        } else {
            _mediaPlayerController.play();
            setState(() {
                _isPlaying = true;
                updateChannelPublishOptions(_isPlaying);
            });
        }
    }
    ```

2.  **Manage media player callbacks**

    The `IMediaPlayerObserver` implements media player callbacks. You create an instance of `IMediaPlayerObserver` and register it with the media player instance. When the player state changes, you take appropriate actions to update the UI in `onPlayerStateChanged`. You use the `onPositionChanged` callback to update the progress bar. To create an instance named `mediaPlayerObserver`, add the following code to the `MainActivity` class:

    ``` dart
    Future<void> initializeMediaPlayer() async {
        _mediaPlayerController = await MediaPlayerController.create(
        rtcEngine: agoraEngine,
        useAndroidSurfaceView: true,
        useFlutterTexture: false,
        canvas: VideoCanvas(uid: uid,
            sourceType: VideoSourceType.videoSourceMediaPlayer
        )
        );

        _mediaPlayerController.registerPlayerSourceObserver(
        MediaPlayerSourceObserver(
            onCompleted: () {

            },
            onPlayerSourceStateChanged:
                (MediaPlayerState state, MediaPlayerError ec) async {
            showMessage(state.name);

            if (state == MediaPlayerState.playerStateOpenCompleted) {
                // Media file opened successfully
                _duration = await _mediaPlayerController.getDuration();
                setState(() {
                _isUrlOpened = true;
                });
            } else if (state == MediaPlayerState.playerStatePlaybackAllLoopsCompleted) {
                // Media file finished playing
                setState(() {
                _isPlaying = false;
                _seekPos = 0;
                // Restore camera and microphone streams
                updateChannelPublishOptions(_isPlaying);
                });
            }
            },
            onPositionChanged: (int position) {
            setState(() {
                _seekPos = position;
            });
            },
            onPlayerEvent:
                (MediaPlayerEvent eventCode, int elapsedTime, String message) {
            // Other events
            },
        ),
        );
    }
    ```

3.  **Configure <Vg k="ENGINE" /> to publish the media player stream**

    You use `ChannelMediaOptions` and the `updateChannelMediaOptions` method to specify the type of stream to publish. To switch between publishing media player and camera and microphone streams, add the following method to the `MainActivity` class:

    ``` dart
    void updateChannelPublishOptions(bool publishMediaPlayer) {
        ChannelMediaOptions channelOptions = ChannelMediaOptions(
            publishMediaPlayerAudioTrack: publishMediaPlayer,
            publishMediaPlayerVideoTrack: publishMediaPlayer,
            publishAudioTrack: !publishMediaPlayer,
            publishCameraTrack: !publishMediaPlayer,
            publishMediaPlayerId: _mediaPlayerController.getMediaPlayerId());

        agoraEngine.updateChannelMediaOptions(channelOptions);
    }
    ```

4.  **Display media player output locally**

    Create a `VideoCanvas` and use it in the `setupLocalVideo` method of the <Vg k="ENGINE" /> to show the media player output locally. To switch between displaying media player output and the camera stream, replace the `setupLocalVideo()` method in the `MainActivity` class with the following:

    ``` dart
    Widget _localPreview() {
        if (_isJoined) {
        if (_isPlaying) {
            return AgoraVideoView(
            controller: _mediaPlayerController,
            );
        } else {
            return AgoraVideoView(
            controller: VideoViewController(
                rtcEngine: agoraEngine,
                canvas: VideoCanvas(uid: uid),
            ),
            );
        }
        } else {
        return const Text(
            'Join a channel',
            textAlign: TextAlign.center,
        );
        }
    }
    ```

6.  **Clean up when you close the <Vpl k="CLIENT" />**

    To free up resources when you exit the <Vpl k="CLIENT" />, add the following lines to the `onDestroy` method after `super.onDestroy();`:

    ``` java
    // Destroy the media player
    mediaPlayer.stop();
    mediaPlayer.unRegisterPlayerObserver(mediaPlayerObserver);
    mediaPlayer.destroy();
    ```
</PlatformWrapper>
