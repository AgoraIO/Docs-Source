<PlatformWrapper platform="flutter">

<ProductWrapper product="{['interactive-live-streaming', 'broadcast-streaming']}">
![image](/images/video-sdk/ils-call-logic-flutter.svg)
</ProductWrapper>

<ProductWrapper product="video-calling">
![image](/images/video-sdk/video-call-logic-flutter.svg)
</ProductWrapper>

Best practice is to separate the <Vpd k="NAME" /> workflows from your UI implementation. The <Vpd  k="SDK" /> sample project implements <Vpd k="PRODUCT" /> logic in the
  [`AgoraManager`](https://github.com/AgoraIO/video-sdk-samples-flutter/blob/main/flutter-reference-app/lib/agora-manager/agora_manager.dart) class.
  This class encapsulates the `RTCEngine` instance and core functionality as illustrated by the excerpts below:

1. **Import the <Vpd k="SDK" /> classes and interfaces**

    ``` dart
    import 'dart:convert';
    import 'package:flutter/services.dart';
    import 'package:agora_rtc_engine/agora_rtc_engine.dart';
    import 'package:permission_handler/permission_handler.dart';
    ```

2.  **Declare variables to create an <Vg k="ENGINE" /> instance and join a channel**

    <ProductWrapper product="video-calling">
    ``` dart
    ProductName currentProduct = ProductName.videoCalling;
    late Map<String, dynamic> config; // Configuration parameters
    int localUid = -1;
    String appId = "", channelName = "";
    List<int> remoteUids = []; // Uids of remote users in the channel
    bool isJoined = false; // Indicates if the local user has joined the channel
    bool isBroadcaster = true; // Client role
    RtcEngine? agoraEngine; // Agora engine instance
    ```
    </ProductWrapper>

    <ProductWrapper product="interactive-live-streaming">
    ``` dart
    ProductName currentProduct = ProductName.interactiveLiveStreaming;
    late Map<String, dynamic> config; // Configuration parameters
    int localUid = -1;
    String appId = "", channelName = "";
    List<int> remoteUids = []; // Uids of remote users in the channel
    bool isJoined = false; // Indicates if the local user has joined the channel
    bool isBroadcaster = true; // Client role
    RtcEngine? agoraEngine; // Agora engine instance
    ```
    </ProductWrapper>

    <ProductWrapper product="broadcast-streaming">
    ``` dart
    ProductName currentProduct = ProductName.broadcastStreaming;
    late Map<String, dynamic> config; // Configuration parameters
    int localUid = -1;
    String appId = "", channelName = "";
    List<int> remoteUids = []; // Uids of remote users in the channel
    bool isJoined = false; // Indicates if the local user has joined the channel
    bool isBroadcaster = true; // Client role
    RtcEngine? agoraEngine; // Agora engine instance
    ```
    </ProductWrapper>    

3.  **Configure an <Vg k="ENGINE" /> instance and set up an event handler**

    ``` dart
    Future<void> setupAgoraEngine() async {
        // Retrieve or request camera and microphone permissions
        await [Permission.microphone, Permission.camera].request();

        // Create an instance of the Agora engine
        agoraEngine = createAgoraRtcEngine();
        await agoraEngine!.initialize(RtcEngineContext(appId: appId));

        if (currentProduct != ProductName.voiceCalling) {
            await agoraEngine!.enableVideo();
        }

        // Register the event handler
        agoraEngine!.registerEventHandler(getEventHandler());
    }
    ```

4.  **Handle and respond to <Vg k="ENGINE" /> events**

    ``` dart
    RtcEngineEventHandler getEventHandler() {
        return RtcEngineEventHandler(
            // Occurs when the network connection state changes
            onConnectionStateChanged: (RtcConnection connection,
                ConnectionStateType state, ConnectionChangedReasonType reason) {
                if (reason ==
                    ConnectionChangedReasonType.connectionChangedLeaveChannel) {
                    remoteUids.clear();
                    isJoined = false;
                }
                // Notify the UI
                Map<String, dynamic> eventArgs = {};
                eventArgs["connection"] = connection;
                eventArgs["state"] = state;
                eventArgs["reason"] = reason;
                eventCallback("onConnectionStateChanged", eventArgs);
            },
            // Occurs when a local user joins a channel
            onJoinChannelSuccess: (RtcConnection connection, int elapsed) {
                isJoined = true;
                messageCallback(
                    "Local user uid:${connection.localUid} joined the channel");
                // Notify the UI
                Map<String, dynamic> eventArgs = {};
                eventArgs["connection"] = connection;
                eventArgs["elapsed"] = elapsed;
                eventCallback("onJoinChannelSuccess", eventArgs);
            },
            // Occurs when a remote user joins the channel
            onUserJoined: (RtcConnection connection, int remoteUid, int elapsed) {
                remoteUids.add(remoteUid);
                messageCallback("Remote user uid:$remoteUid joined the channel");
                // Notify the UI
                Map<String, dynamic> eventArgs = {};
                eventArgs["connection"] = connection;
                eventArgs["remoteUid"] = remoteUid;
                eventArgs["elapsed"] = elapsed;
                eventCallback("onUserJoined", eventArgs);
            },
            // Occurs when a remote user leaves the channel
            onUserOffline: (RtcConnection connection, int remoteUid,
                UserOfflineReasonType reason) {
                remoteUids.remove(remoteUid);
                messageCallback("Remote user uid:$remoteUid left the channel");
                // Notify the UI
                Map<String, dynamic> eventArgs = {};
                eventArgs["connection"] = connection;
                eventArgs["remoteUid"] = remoteUid;
                eventArgs["reason"] = reason;
                eventCallback("onUserOffline", eventArgs);
            },
        );
    }
    ```

5.  **Render video from a remote user in the channel**

    ``` dart
    AgoraVideoView remoteVideoView(int remoteUid) {
        return AgoraVideoView(
            controller: VideoViewController.remote(
                rtcEngine: agoraEngine!,
                canvas: VideoCanvas(uid: remoteUid),
                connection: RtcConnection(channelId: channelName),
            ),
        );
    }
    ```

6.  **Render video from the local user in the channel**

    ``` dart
    AgoraVideoView localVideoView() {
        return AgoraVideoView(
            controller: VideoViewController(
                rtcEngine: agoraEngine!,
                canvas: const VideoCanvas(uid: 0), // Use uid = 0 for local view
            ),
        );
    }
    ```

7.  **Join a channel to start <Vpd k="PRODUCT" />**

    ``` dart
    Future<void> join({
        String channelName = '',
        String token = '',
        int uid = -1,
        ClientRoleType clientRole = ClientRoleType.clientRoleBroadcaster,
    }) async {
        channelName = (channelName.isEmpty) ? this.channelName : channelName;
        token = (token.isEmpty) ? config['rtcToken'] : token;
        uid = (uid == -1) ? localUid : uid;

        // Set up Agora engine
        if (agoraEngine == null) await setupAgoraEngine();

        // Enable the local video preview 
        await agoraEngine!.startPreview();
        
        // Set channel options including the client role and channel profile
        ChannelMediaOptions options = ChannelMediaOptions(
            clientRoleType: clientRole,
            channelProfile: ChannelProfileType.channelProfileCommunication,
        );

        // Join a channel
        await agoraEngine!.joinChannel(
            token: token,
            channelId: channelName,
            options: options,
            uid: uid,
        );
    }
    ```

8.  **Leave the channel when the local user ends the call**

    ``` dart
    Future<void> leave() async {
        // Clear saved remote Uids
        remoteUids.clear();

        // Leave the channel
        if (agoraEngine != null) {
            await agoraEngine!.leaveChannel();
        }
        isJoined = false;

        // Destroy the Agora engine instance
        destroyAgoraEngine();
    }
    ```

1.  **Clean up the resources used by the app**

    ``` dart
    void destroyAgoraEngine() {
        // Release the RtcEngine instance to free up resources
        if (agoraEngine != null) {
            agoraEngine!.release();
            agoraEngine = null;
        }
    }
    ```
</PlatformWrapper>
