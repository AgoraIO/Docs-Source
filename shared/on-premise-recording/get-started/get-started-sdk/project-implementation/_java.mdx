<PlatformWrapper platform="linux-java">
<details>
<summary>Complete sample code for On-Premise Recording</summary>

```java
// Create and configure the AgoraService instance
AgoraService agoraService = new AgoraService();
AgoraServiceConfiguration config = new AgoraServiceConfiguration();
config.setEnableAudioDevice(false);       // Disable audio device
config.setEnableAudioProcessor(true);     // Enable audio processing
config.setEnableVideo(true);              // Enable video
config.setAppId(recorderConfig.getAppId());             // Set your App ID
config.setUseStringUid(recorderConfig.isUseStringUid()); // Use string user ID

// Configure log settings
LogConfig logConfig = new LogConfig();
logConfig.setFileSizeInKB(1024 * 20);                       // Set max log size to 20 MB
logConfig.setFilePath("logs/agora_logs/agorasdk.log");     // Set log file path
config.setLogConfig(logConfig);

// Initialize the Agora service
int ret = agoraService.initialize(config);

// Create a recorder instance from the media component factory
AgoraMediaComponentFactory factory = agoraService.createAgoraMediaComponentFactory();
AgoraMediaRtcRecorder agoraMediaRtcRecorder = factory.createMediaRtcRecorder();

// Initialize the recorder
boolean enableMix = false; // false = individual streams; true = mixed stream
agoraMediaRtcRecorder.initialize(agoraService, enableMix);

// Register a callback handler to listen for recording events
IAgoraMediaRtcRecorderEventHandler eventHandler = new IAgoraMediaRtcRecorderEventHandler() {
    @Override
    public void onConnected(String channelId, String userId) {
        // Called when the recorder connects to the channel
    }

    @Override
    public void onDisconnected(String channelId, String userId, Constants.ConnectionChangedReasonType reason) {
        // Called when the recorder disconnects from the channel
    }

    // Implement other event callbacks if needed
};
agoraMediaRtcRecorder.registerRecorderEventHandler(eventHandler);

// Subscribe to all audio and high-quality video streams
agoraMediaRtcRecorder.subscribeAllAudio();
VideoSubscriptionOptions options = new VideoSubscriptionOptions();
options.setEncodedFrameOnly(false);
options.setType(Constants.VideoStreamType.VIDEO_STREAM_HIGH);
agoraMediaRtcRecorder.subscribeAllVideo(options);

// Set the recording configuration
MediaRecorderConfiguration mediaRecorderConfiguration = new MediaRecorderConfiguration();
mediaRecorderConfiguration.setWidth(width != 0 ? width : recorderConfig.getVideo().getWidth());
mediaRecorderConfiguration.setHeight(height != 0 ? height : recorderConfig.getVideo().getHeight());
mediaRecorderConfiguration.setFps(recorderConfig.getVideo().getFps());
mediaRecorderConfiguration.setStoragePath(recorderConfig.getRecorderPath());           // Path must exist
mediaRecorderConfiguration.setSampleRate(recorderConfig.getAudio().getSampleRate());
mediaRecorderConfiguration.setChannelNum(recorderConfig.getAudio().getNumOfChannels());
mediaRecorderConfiguration.setStreamType(Constants.MediaRecorderStreamType.STREAM_TYPE_BOTH);
mediaRecorderConfiguration.setMaxDurationMs(recorderConfig.getMaxDuration() * 1000);    // Convert seconds to milliseconds
agoraMediaRtcRecorder.setRecorderConfig(mediaRecorderConfiguration);

// Join the channel and start recording
agoraMediaRtcRecorder.joinChannel(
    recorderConfig.getToken(),
    recorderConfig.getChannelName(),
    recorderConfig.getUserId()
);
agoraMediaRtcRecorder.startRecording();

// Stop recording, clean up resources, and leave the channel
agoraMediaRtcRecorder.unsubscribeAllAudio();
agoraMediaRtcRecorder.unsubscribeAllVideo();
agoraMediaRtcRecorder.stopRecording();
agoraMediaRtcRecorder.unregisterRecorderEventHandler(eventHandler);
agoraMediaRtcRecorder.leaveChannel();
agoraMediaRtcRecorder.release();
factory.release();
agoraService.release();
```
</details>

### Initialize the service

Create an `AgoraService` instance and initialize it with your App ID and feature settings.

```java
// Create and configure the service
AgoraService agoraService = new AgoraService();
AgoraServiceConfiguration config = new AgoraServiceConfiguration();
config.setEnableAudioDevice(false);
config.setEnableAudioProcessor(true);
config.setEnableVideo(true);
config.setAppId(recorderConfig.getAppId());
config.setUseStringUid(recorderConfig.isUseStringUid());

// Set up log configuration
LogConfig logConfig = new LogConfig();
logConfig.setFileSizeInKB(1024 * 20);
logConfig.setFilePath("logs/agora_logs/agorasdk.log");
config.setLogConfig(logConfig);

// Initialize the Agora service
int ret = agoraService.initialize(config);
```

### Create a recorder instance

Use the `AgoraMediaComponentFactory` to create and initialize a recording instance.

```java
// Create the recorder
AgoraMediaComponentFactory factory = agoraService.createAgoraMediaComponentFactory();
AgoraMediaRtcRecorder agoraMediaRtcRecorder = factory.createMediaRtcRecorder();

// Initialize the recorder
boolean enableMix = false; // false = Individual stream; true = mixed stream
agoraMediaRtcRecorder.initialize(agoraService, enableMix);
```

### Register event handlers

Register an event handler to receive callbacks for recording events.

```java
// Define the event handler
private IAgoraMediaRtcRecorderEventHandler eventHandler = new IAgoraMediaRtcRecorderEventHandler() {
    @Override
    public void onConnected(String channelId, String userId) {
        // Handle connection event
    }

    @Override
    public void onDisconnected(String channelId, String userId, Constants.ConnectionChangedReasonType reason) {
        // Handle disconnection event
    }

    // Add more overrides as needed
};

// Register the event handler
agoraMediaRtcRecorder.registerRecorderEventHandler(eventHandler);
```

### Subscribe to audio and video streams

Subscribe to all audio and high-quality video streams in the channel.

```java
// Subscribe to audio
agoraMediaRtcRecorder.subscribeAllAudio();

// Subscribe to video
VideoSubscriptionOptions options = new VideoSubscriptionOptions();
options.setEncodedFrameOnly(false);
options.setType(Constants.VideoStreamType.VIDEO_STREAM_HIGH);
agoraMediaRtcRecorder.subscribeAllVideo(options);
```

### Configure the recorder

Set up the recording configuration, such as resolution, frame rate, and file path.

<Admonition type="info" info="info">
 The `storagePath` must exist before recording. If the directory does not exist, the recording will fail.
</Admonition>

```java
// Configure the recorder
MediaRecorderConfiguration recorderConfig = new MediaRecorderConfiguration();
recorderConfig.setWidth(width != 0 ? width : recorderConfig.getVideo().getWidth());
recorderConfig.setHeight(height != 0 ? height : recorderConfig.getVideo().getHeight());
recorderConfig.setFps(recorderConfig.getVideo().getFps());
recorderConfig.setMaxDurationMs(recorderConfig.getMaxDuration() * 1000);
recorderConfig.setStoragePath(recorderConfig.getRecorderPath());
recorderConfig.setSampleRate(recorderConfig.getAudio().getSampleRate());
recorderConfig.setChannelNum(recorderConfig.getAudio().getNumOfChannels());
recorderConfig.setStreamType(Constants.MediaRecorderStreamType.STREAM_TYPE_BOTH);
recorderConfig.setVideoSourceType(Constants.VideoSourceType.VIDEO_SOURCE_CAMERA_SECONDARY);

agoraMediaRtcRecorder.setRecorderConfig(recorderConfig);
```

### Join the channel and start recording

Join the channel and begin recording.

```java
agoraMediaRtcRecorder.joinChannel(
    recorderConfig.getToken(),
    recorderConfig.getChannelName(),
    recorderConfig.getUserId()
);
agoraMediaRtcRecorder.startRecording();
```

### Stop and release resources

Unsubscribe from streams, stop recording, and release all associated resources.

```java
agoraMediaRtcRecorder.unsubscribeAllAudio();
agoraMediaRtcRecorder.unsubscribeAllVideo();
agoraMediaRtcRecorder.stopRecording();
agoraMediaRtcRecorder.unregisterRecorderEventHandler(eventHandler);
agoraMediaRtcRecorder.leaveChannel();
agoraMediaRtcRecorder.release();
factory.release();
agoraService.release();
```
</PlatformWrapper>
