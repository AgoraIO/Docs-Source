<PlatformWrapper platform="android">

### Implement the user interface

To create a simple interface for testing speech to text functionality you add two buttons to the UI. Open `/app/res/layout/activity_main.xml` and add the following lines before `</RelativeLayout>`:

```xml
<Button
    android:id="@+id/SpeechToTextButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_below="@id/LeaveButton"
    android:layout_alignStart="@id/remote_video_view_container"
    android:layout_alignEnd="@id/remote_video_view_container"
    android:onClick="SpeechToText"
    android:text="Start speech to text" />


<Button
    android:id="@+id/QuerySpeechToTextButton"
    android:layout_width="wrap_content"
    android:layout_height="wrap_content"
    android:layout_below="@id/SpeechToTextButton"
    android:layout_alignStart="@id/remote_video_view_container"
    android:layout_alignEnd="@id/remote_video_view_container"
    android:onClick="query"
    android:text="Query speech to text" />
```

### Handle the system logic

1. **Integrate the `okhttp` library into your project**

    To do this, open `/Gradle Scripts/build.gradle (Module: <project name>.app)` and add the following line under `dependencies {`:

    ```groovy
    implementation 'com.squareup.okhttp3:okhttp:4.10.0'
    ```

1. **Import the required libraries**

    To call `HTTP` methods that start, stop, and query a speech to text task, add the following statements after the last `import` statement in `/app/java/com.example.<projectname>/MainActivity`.

    ```java
    import okhttp3.Call;
    import okhttp3.Callback;
    import okhttp3.MediaType;
    import okhttp3.OkHttpClient;
    import okhttp3.Request;
    import okhttp3.RequestBody;
    import okhttp3.Response;

    import java.io.IOException;
    import java.util.Base64;

    import org.json.JSONArray;
    import org.json.JSONException;
    import org.json.JSONObject;
    ```

1. **Define variables to manage a text to speech task**

    In `/app/java/com.example.<projectname>/MainActivity`, add the following declarations to the `MainActivity` class:

    ```java
    private String baseUrl = "https://api.agora.io";
    private String apiKey = "<your API key from Agora console>";
    private String apiSecret = "<your API secret from Agora console>";
    private String builderToken, Authorization;
    private boolean isSpeechToTextRunning = false;
    private OkHttpClient httpClient;
    private Button btnSpeechToText;
    private String speechToTextTaskId = "";
    ```

### Start, stop and manage a text-to-speech task

1. **Get authorization**

    Before using an Agora RESTful API, you need to setup REST authentication. You generate a Base64-encoded credential with the API key and API Secret provided by Agora and pass the credential to the `Authorization` parameter in the request header. To get the authorization key, add the following method to the `MainActivity` class:

    ```java
    public void getAuthorization() {
        // Concatenate the key and secret and use base64 encoding
        String plainCredentials = apiKey + ":" + apiSecret;
        String base64Credentials = new String(Base64.getEncoder().encode(plainCredentials.getBytes()));

        // Create authorization header
        String authorizationHeader = "Basic " + base64Credentials;

        OkHttpClient client = new OkHttpClient().newBuilder().build();
        // Create HTTP request object
        Request request = new Request.Builder()
                .url(baseUrl + "/dev/v1/projects")
                .get()
                .header("Authorization", authorizationHeader)
                .header("Content-Type", "application/json")
                .build();

        // Send HTTP request
        client.newCall(request)
            .enqueue(new Callback() {
                @Override
                public void onFailure(final Call call, IOException e) {
                    // Error
                    showMessage(e.toString());
                }

                @Override
                public void onResponse(Call call, final Response response) throws IOException {
                    String result = response.body().string();
                    Log.i("response:", result.toString());
                    try {
                        JSONObject jsonObject = new JSONObject(result);
                        jsonObject = (JSONObject) jsonObject.getJSONArray("projects").get(0);
                        Authorization = jsonObject.getString("sign_key");
                        showMessage("Authorization received: " + Authorization);
                        getBuildToken();
                    } catch (Exception e) {
                        showMessage("Error fetching authorization: " + e.toString());
                    }
                }
            });
    }
    ```

1. **Obtain the buildToken**

    ```java
    public void getBuildToken() throws IOException {
        httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        RequestBody body = RequestBody.create("{\n \"instanceId\" : \"SpeechtoText\" \n}", mediaType);
        Request request = new Request.Builder()
                .addHeader("Authorization", Authorization)
                .url(baseUrl + "/v1/projects/" + appId + "/rtsc/speech-to-text/builderTokens")
                .method("POST", body)
                .build();

        httpClient.newCall(request)
            .enqueue(new Callback() {
                @Override
                public void onFailure(final Call call, IOException e) {
                    // Error
                    showMessage(e.toString());
                }

                @Override
                public void onResponse(Call call, final Response response) throws IOException {
                    String result = response.body().string();
                    String message = "";
                    try {
                        JSONObject jsonObject = new JSONObject(result);
                        if (response.isSuccessful()) {
                            builderToken = jsonObject.getString("tokenName");
                            showMessage("BuildToken received: " + builderToken);
                            startSpeechToText();
                        } else {
                            message = jsonObject.getString("message");
                            showMessage("BuildToken not received: " + message);
                        }
                    } catch (Exception e) {
                        showMessage("Exception fetching buildToken: " + e.toString());
                    }
                }
            });
    }
    ```

1. **Start**

    ```java
    public void startSpeechToText() throws JSONException {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks?" + "builderToken=" + builderToken;
        // Build Request body JSON
        JSONObject startConfig = new JSONObject()
            .put("audio", new JSONObject()
                .put("subscribeSource", "AGORARTC")
                .put("agoraRtcConfig", new JSONObject()
                    .put("channelName", channelName)
                    .put("uid", uid)
                    .put("token", token)
                    .put("channelType", "LIVE_TYPE")
                    .put("subscribeConfig", new JSONObject()
                            .put("subscribeMode", "CHANNEL_MODE"))
                    .put("maxIdleTime", 60)))
        .put("config", new JSONObject()
            .put("features", new JSONArray()
                    .put("RECOGNIZE"))
            .put("recognizeConfig", new JSONObject()
                .put("language", "ENG")
                .put("model", "Model")
                .put("output", new JSONObject()
                    .put("destinations", new JSONArray()
                            .put("AgoraRTCDataStream")
                            .put("Storage"))
                    .put("agoraRTCDataStream", new JSONObject()
                            .put("channelName", channelName)
                            .put("uid", uid)
                            .put("token", token)
                    ).put("cloudStorage", new JSONArray()
                        .put(new JSONObject()
                            .put("format", "HLS")
                            .put("storageConfig", new JSONObject()
                                .put("accessKey", "<YourOssAccessKey>")
                                .put("secretKey", "<YourOssSecretKey>")
                                .put("bucket", "<YourOssBucketName>")
                                .put("vendor", "<YourOssVendor>")
                                .put("region", "<YourOssRegion>")
                                .put("fileNamePrefix", "<YourOssPrefix>")
                            )
                        )
                    )
                )
            )
            );

        httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        RequestBody body = RequestBody.create(startConfig.toString(), mediaType);
        Request request = new Request.Builder()
            .addHeader("Authorization", Authorization)
            .url(url)
            .method("POST", body)
            .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                if (response.isSuccessful()) {
                    try {
                        JSONObject jsonObject = new JSONObject(result);
                        String status = jsonObject.getString("status");
                        speechToTextTaskId = jsonObject.getString("taskId");
                        if (status.equals("IN_PROGRESS") || status.equals("PREPARING")) {
                            isSpeechToTextRunning = true;
                            runOnUiThread(() -> btnSpeechToText.setText("Stop speech to text"));
                            showMessage("Speech to text started");
                        } else {
                            isSpeechToTextRunning = false;
                            showMessage("Speech to text status: " + status);
                        }
                    } catch (Exception e) {
                        Log.i("Error parsing start call response", result);
                    }
                } else {
                    showMessage("Exception starting speech-to-text task: " + result);
                }
            }
        }
        );
    }
    ```

1. **Query**

    ```java
    public void querySpeechToText() {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks?" + "builderToken=" + builderToken;
        httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        //RequestBody body = RequestBody.create(startConfig.toString(), mediaType);
        Request request = new Request.Builder()
                .addHeader("Authorization", Authorization)
                .url(url)
                .get()
                .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                // Error
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                try {
                    JSONObject jsonObject = new JSONObject(result);
                    if (response.isSuccessful()) {
                        String status = jsonObject.getString("status");
                        speechToTextTaskId = jsonObject.getString("taskId");
                        if (status.equals("IN_PROGRESS") || status.equals("PREPARING")) {
                            isSpeechToTextRunning = true;
                            runOnUiThread(() -> btnSpeechToText.setText("Stop speech to text"));
                            showMessage("Speech to text started");
                        } else {
                            isSpeechToTextRunning = false;
                            speechToTextTaskId = "";
                            showMessage("Speech to text status: " + status + "");
                        }
                    } else {
                        String message = jsonObject.getString("message");
                        showMessage("Exception querying speech-to-text task: " + message);
                    }

                } catch (Exception e) {
                    Log.i("Error parsing query call response", result);
                }
            }
        }
        );
    }
    ```

1. **Stop**

    ```java
    public void stopSpeechToText() {
        String url = baseUrl + "/v1/projects/" + appId
                + "/rtsc/speech-to-text/tasks/" + speechToTextTaskId
                + "?builderToken=" + builderToken;

        httpClient = new OkHttpClient().newBuilder().build();
        MediaType mediaType = MediaType.parse("application/json");
        Request request = new Request.Builder()
                .url(url)
                .delete()
                .build();

        httpClient.newCall(request).enqueue(new Callback() {
            @Override
            public void onFailure(final Call call, IOException e) {
                // Error
                showMessage(e.toString());
            }

            @Override
            public void onResponse(Call call, final Response response) throws IOException {
                String result = response.body().string();
                if (response.isSuccessful()) {
                    showMessage("Speect to text task stopped");
                    speechToTextTaskId = "";
                    isSpeechToTextRunning = false;
                } else {
                    showMessage("Exception stopping speech-to-text task: " + result);
                }
            }
        }
        );
    }
    ```


1. **Run**

    ```java
    public void query(View view) {
        querySpeechToText();
    }

    public void SpeechToText(View view) {
        if (!isSpeechToTextRunning) {
            try {
                getAuthorization();
            } catch (Exception e) {
                showMessage(e.toString());
            }
        } else {
            stopSpeechToText();
        }
    }
    ```

</PlatformWrapper>
