<PlatformWrapper platform="react-native">

1. **Import the required Agora modules**

    ``` typescript
    import AgoraManager from "../agora-manager/agoraManager";
    import AgoraUI from "../agora-manager/agoraUI";
    import {
        AudioProfileType,
        AudioScenarioType,
        FrameRate,
        VideoDimensions,
        OrientationMode,
        DegradationPreference,
        VideoMirrorModeType,
        LastmileProbeConfig,
        VideoEncoderConfiguration,
        VideoStreamType,
        CompressionPreference,
        QualityType,
        LogLevel,
        EchoTestConfiguration
    } from 'react-native-agora';
    ```

1. **Declare the require state variables**

    ``` typescript
    // State variables
    const [quality, setQuality] = useState(''); // Indicates network quality
    const [isHighQuality, setVideoQuality] = useState(false); // Quality of the remote video stream being played.
    const [isEchoTestRunning, SetEchoTest] = useState(false); // A variable to track the echo test state.
    const [channelName, setChannelName] = useState("");
    ```

1. **Use a probe test to check network health**

    ``` typescript
    // Function to start a network probe test
    const startProbeTest = () => {
        // Configure a LastmileProbeConfig instance.
        var probeConfig = new LastmileProbeConfig();
        probeConfig.probeUplink = true; // Probe the uplink network quality.
        probeConfig.probeDownlink = true; // Probe the downlink network quality.
        probeConfig.expectedUplinkBitrate = 100000; // Expected uplink bitrate (bps).
        probeConfig.expectedDownlinkBitrate = 100000; // Expected downlink bitrate (bps).
        agoraManager.agoraEngineRef.current?.startLastmileProbeTest(probeConfig);
    };
    ```

1. **Implement best practice for app initiation**

    Use the following <Vg k="VSDK" /> features when you set up an instance of the <Vg k="ENGINE" />:

    * _Enable and configure logging_: For optimization and debugging.
    * _Enable dual stream mode_: Required for multi-user scenarios.
    * _Set an audio profile and audio scenario_: Setting an audio profile is optional and only required if you have special requirements such as streaming  music.
    * _Set the video profile_: Setting a video profile is also optional. It is useful when you want to change one or more of `mirrorMode`, `frameRate`, `bitrate`, `dimensions`, `orientationMode`, `degradationPrefer` or `compressionPrefer` from the default setting to custom values.
      For more information, see  [video profile table](#video-profile-table).
    * _Start a network probe test_: A quick test at startup to gauge network quality.

    ``` typescript
    // Function to set up the video SDK engine
    const setupVideoSDKEngine = async () => {
        await agoraManager.setupAgoraEngine();
        if (agoraManager.agoraEngineRef.current !== null) {
            // Enable the dual stream mode
            agoraManager.agoraEngineRef.current.enableDualStreamMode(true);
            // Specify the audio scenario and audio profile.
            agoraManager.agoraEngineRef.current.setAudioProfile(
                AudioProfileType.AudioProfileMusicHighQualityStereo,
                AudioScenarioType.AudioScenarioGameStreaming,
            );
            // Set the video profile
            var videoConfig = new VideoEncoderConfiguration();
            // Set mirror mode
            videoConfig.mirrorMode = VideoMirrorModeType.VideoMirrorModeAuto;
            // Set framerate
            videoConfig.frameRate = FrameRate.FrameRateFps10;
            // Set bitrate
            videoConfig.bitrate = 100000;
            // Set dimensions
            videoConfig.dimensions = new VideoDimensions();
            // Set orientation mode
            videoConfig.orientationMode = OrientationMode.OrientationModeAdaptive;
            // Set degradation preference
            videoConfig.degradationPreference = DegradationPreference.MaintainBalanced;
            // Set compression preference
            if (videoConfig.advanceOptions !== undefined) {
                videoConfig.advanceOptions.compressionPreference = CompressionPreference.PreferLowLatency;
                }
            // Apply the configuration
            agoraManager.agoraEngineRef.current.setVideoEncoderConfiguration(videoConfig);
            // Start the probe test
            startProbeTest();
            
            // Configure the log file.
            agoraManager.agoraEngineRef.current?.setLogFile(
                '<Specify the log directory path>\\agorasdk.log'
                );
            agoraManager.agoraEngineRef.current.setLogFileSize(256); // Ranges from 128 - 20480kb.
            agoraManager.agoraEngineRef.current.setLogLevel(LogLevel.LogLevelWarn);
            agoraManager.agoraEngineRef.current.registerEventHandler(
                {
                    onConnectionStateChanged: (connection, state, reason) => {
                        console.log(
                            'Connection state changed' +
                            '\n New state: ' +
                            state +
                            '\n Reason: ' +
                            reason);
                    },
                    onLastmileQuality: Quality => {
                        updateNetworkStatus(Quality);
                    },
                    onLastmileProbeResult: result => {
                        agoraManager.agoraEngineRef.current?.stopLastmileProbeTest();
                        // The result object contains the detailed test results that help you
                        // manage call quality, for example, the downlink jitter.
                        console.log('Downlink jitter: ' + result.downlinkReport?.jitter);
                        agoraManager.agoraEngineRef.current?.release();
                        agoraManager.agoraEngineRef.current = null;
                    },
                    onNetworkQuality(_connection, _Uid, _txQuality, rxQuality) {
                        // Use downlink network quality to update the network status
                        updateNetworkStatus(rxQuality);
                    },
                    onRtcStats: (_connection, rtcStats) => {
                        console.log(rtcStats.userCount + ' user(s)');
                        console.log('Packet loss rate: ' + rtcStats.rxPacketLossRate);
                    },
                    onRemoteVideoStateChanged: (
                        _connection,
                        Uid,
                        state,
                        reason,
                        elapsed,
                        ) => {
                            console.log(
                                'Remote video state changed: \n Uid =' +
                                Uid +
                                ' \n NewState =' +
                                state +
                                ' \n reason =' +
                                reason +
                                ' \n elapsed =' +
                                elapsed,
                            );
                    },
                    onRemoteVideoStats: (_connection, stats) => {
                        console.log(
                            'Remote Video Stats: ' +
                            '\n User id =' +
                            stats.uid +
                            '\n Received bitrate =' +
                            stats.receivedBitrate +
                            '\n Total frozen time =' +
                            stats.totalFrozenTime,
                        );
                    },
                });
        }
    };
    ```

1. **Test the user's hardware**

    The echo test checks that the user's hardware is working properly.

    ``` typescript
    fun startEchoTest(): SurfaceView {
        if (agoraEngine == null) setupAgoraEngine()
        // Set test configuration parameters
        val echoConfig = EchoTestConfiguration()
        echoConfig.enableAudio = true
        echoConfig.enableVideo = true
        echoConfig.channelId = channelName
        echoConfig.intervalInSeconds = 2 // Interval  between recording and playback
        // Set up a SurfaceView
        val localSurfaceView = SurfaceView(mContext)
        localSurfaceView.visibility = View.VISIBLE
        // Call setupLocalVideo with a VideoCanvas having uid set to 0.
        agoraEngine!!.setupLocalVideo(
            VideoCanvas(
                localSurfaceView,
                VideoCanvas.RENDER_MODE_HIDDEN,
                0
            )
        )
        echoConfig.view = localSurfaceView

        // Get a token from the server or from the config file
        if (serverUrl.contains("http")) { // A valid server url is available
            // Fetch a token from the server for channelName
            fetchToken(channelName, 0, object : TokenCallback {
                override fun onTokenReceived(rtcToken: String?) {
                    // Set the token in the config
                    echoConfig.token = rtcToken
                    // Start the echo test
                    agoraEngine!!.startEchoTest(echoConfig)
                }

                override fun onError(errorMessage: String) {
                    // Handle the error
                    sendMessage("Error: $errorMessage")
                }
            })
        } else { // use the token from the config.json file
            echoConfig.token = config!!.optString("rtcToken")
            // Start the echo test
            agoraEngine!!.startEchoTest(echoConfig)
        }
        return localSurfaceView
    }

    fun stopEchoTest() {
        agoraEngine!!.stopEchoTest()
        destroyAgoraEngine()
    }
    ```

1. **Listen to <Vg k="ENGINE" /> events to receive state change notifications and quality statistics**

    Use the following `IRtcEngineEventHandler` callbacks to monitor and ensure channel quality:

    ``` typescript
    override fun onLastmileQuality(quality: Int) {
        // Reports the last-mile network quality of the local user
        (mListener as CallQualityManagerListener).onLastMileQuality(quality)
    }

    override fun onLastmileProbeResult(result: LastmileProbeResult) {
        // Reports the last mile network probe result
        agoraEngine!!.stopLastmileProbeTest()
        // The result object contains the detailed test results that help you
        // manage call quality, for example, the down link bandwidth.
        sendMessage("Available down link bandwidth: " + result.downlinkReport.availableBandwidth)
    }

    override fun onNetworkQuality(uid: Int, txQuality: Int, rxQuality: Int) {
        // Reports the last mile network quality of each user in the channel
        (mListener as CallQualityManagerListener).onNetworkQuality(
            uid, txQuality, rxQuality
        )
    }

    override fun onRtcStats(rtcStats: RtcStats) {
        // Reports the statistics of the current session
        counter += 1
        var msg = ""
        if (counter == 5) msg =
            rtcStats.users.toString() + " user(s)" else if (counter == 10) {
            msg = "Packet loss rate: " + rtcStats.rxPacketLossRate
            counter = 0
        }
        if (msg.isNotEmpty()) sendMessage(msg)
    }

    override fun onConnectionStateChanged(state: Int, reason: Int) {
        // Occurs when the network connection state changes
        sendMessage(
            "Connection state changed\n" +
                    "New state: $state\n" +
                    "Reason: $reason"
        )
    }

    override fun onRemoteVideoStateChanged(uid: Int, state: Int, reason: Int, elapsed: Int) {
        // Occurs when the remote video stream state changes
        val msg = "Remote video state changed:\n" +
                "Uid = $uid\n" +
                "NewState = $state\n" +
                "Reason = $reason\n" +
                "Elapsed = $elapsed"
        sendMessage(msg)
    }

    override fun onRemoteVideoStats(stats: RemoteVideoStats) {
        // Reports the statistics of the video stream sent by each remote user
        (mListener as CallQualityManagerListener).onRemoteVideoStats(
            stats
        )
    }
    ```

1. **Switch stream quality**

    Take advantage of dual-stream mode and switch remote video quality to high or low.

    <ProductWrapper product="interactive-live-streaming">
    3. Add the `OnClientRoleChanged` call back to get recieve state change notification on role change by the client. To specify the audience latency level, call the `updateChannelMediaOptions()` method with the specified latency. For <Vg k="ILS" /> choose `AudienceLatencyLevelUltraLowLatency`. Ultra-low latency is a feature of <Vg k="ILS" /> and its use is subject to special [pricing](../overview/pricing#unit-pricing).

        ```ts
        // Listen to the onClientRoleChanged when the local user changes the user role.
        onClientRoleChanged: (_connection, _oldRole, newRole) => {
          if (remoteUid == null) {
            return;
          }
          // Check if the selected role is Host.
          if (newRole === ClientRoleType.ClientRoleBroadcaster) {
            // Start the local preview.
            agoraEngine.startPreview();
            // Unsubscribe to the remote video stream
            agoraEngine.muteRemoteVideoStream(remoteUid, true);
          } else {
            // Stop the local preview.
            agoraEngine.stopPreview();
            // Subscribe to the remote user live streaming.
            agoraEngine.muteRemoteVideoStream(remoteUid, false);

            // Use ultra low level latency
            var channeloptions = new ChannelMediaOptions();
            channeloptions.audienceLatencyLevel =
              AudienceLatencyLevelType.AudienceLatencyLevelUltraLowLatency;
            agoraEngine.updateChannelMediaOptions(channeloptions);
          }
        },
        ```
    </ProductWrapper>
    <ProductWrapper product="broadcast-streaming">
    3. Add the `OnClientRoleChanged` call back to get recieve state change notification on role change by the client. To specify the audience latency level, call the `updateChannelMediaOptions()` method with the specified latency. For <Vg k="BS" /> choose `AudienceLatencyLevelLowLatency`. Low latency is a feature of <Vg k="BS" /> and its use is subject to special [pricing](../overview/pricing#unit-pricing).

        ```ts
        // Listen to the onClientRoleChanged when the local user changes the user role.
        onClientRoleChanged: (_connection, _oldRole, newRole) => {
          if (remoteUid == null) {
            return;
          }
          // Check if the selected role is Host.
          if (newRole === ClientRoleType.ClientRoleBroadcaster) {
            // Start the local preview.
            agoraEngine.startPreview();
            // Unsubscribe to the remote video stream
            agoraEngine.muteRemoteVideoStream(remoteUid, true);
          } else {
            // Stop the local preview.
            agoraEngine.stopPreview();
            // Subscribe to the remote user live streaming.
            agoraEngine.muteRemoteVideoStream(remoteUid, false);

            // Use ultra low level latency
            var channeloptions = new ChannelMediaOptions();
            channeloptions.audienceLatencyLevel =
              AudienceLatencyLevelType.AudienceLatencyLevelLowLatency;
            agoraEngine.updateChannelMediaOptions(channeloptions);
          }
        },
        ```
    </ProductWrapper>

    Each event reports the statistics of the audio video streams from each remote user and host. 

1. **Switch stream quality when the user taps the switch button**

    To take advantage of dual-stream mode and switch remote video quality to high or low, in `App.tsx`, add the following code after the `leave` function:

    ```ts
    const setRemoteStreamQuality = () => {
        if (agoraManager.remoteUids[0] === null) {
            console.log("No remote user in the channel");
            return;
        }
        setVideoQuality(!isHighQuality);
        const streamType = isHighQuality
        ? VideoStreamType.VideoStreamHigh
        : VideoStreamType.VideoStreamLow;
        
        agoraManager.agoraEngineRef.current?.setRemoteVideoStreamType(
            agoraManager.remoteUids[0],streamType);
    console.log(
      `Switching to ${isHighQuality ? 'high-quality' : 'low-quality'} video`);
    };
    ```

<ProductWrapper product="interactive-live-streaming">
7. **Set the latency level**

    For ultra low-latency applications, set the appropriate `audienceLatencyLevel` when joining a channel. Ultra-low latency is a feature of <Vg k="ILS" /> and its use is subject to special [pricing](../reference/pricing#unit-pricing).

    ``` typescript
    // Set the latency level
    audienceLatencyLevel: AudienceLatencyLevelType.AudienceLatencyLevelUltraLowLatency
    ```
</ProductWrapper>

<ProductWrapper product="broadcast-streaming">
7. **Set the latency level**

    For low-latency applications, set the appropriate `audienceLatencyLevel` when joining a channel. Low latency is a feature of <Vg k="BS" /> and its use is subject to special [pricing](../reference/pricing#unit-pricing).

    ``` typescript
    // Set the latency level
    audienceLatencyLevel: AudienceLatencyLevelType.AudienceLatencyLevelLowLatency
    ```
</ProductWrapper>

</PlatformWrapper>
