<PlatformWrapper platform="windows">


1. **Use a probe test to check network health**

    ```cpp
    void CallQuality::startProbeTest()
    {
        // Configure a LastmileProbeConfig instance.
        LastmileProbeConfig config;
        // Probe the uplink network quality.
        config.probeUplink = true;
        // Probe the downlink network quality.
        config.probeDownlink = true;
        // The expected uplink bitrate (bps). The value range is [100000,5000000].
        config.expectedUplinkBitrate = 100000;
        // The expected downlink bitrate (bps). The value range is [100000,5000000].
        config.expectedDownlinkBitrate = 100000;
        int res = agoraEngine->startLastmileProbeTest(config);
    }
    ```

1. **Implement best practice for app initiation**

    Use the following <Vg k="VSDK" /> features when you set up an instance of the <Vg k="ENGINE" />:

    * _Enable and configure logging_: For optimization and debugging.
    * _Enable dual stream mode_: Required for multi-user scenarios.
    * _Set an audio profile and audio scenario_: Setting an audio profile is optional and only required if you have special requirements such as streaming  music.
    * _Set the video profile_: Setting a video profile is also optional. It is useful when you want to change one or more of `mirrorMode`, `frameRate`, `bitrate`, `dimensions`, `orientationMode`, `degradationPrefer` or `compressionPrefer` from the default setting to custom values.
      For more information, see  [video profile table](#video-profile-table).
    * _Start a network probe test_: A quick test at startup to gauge network quality.

    ```cpp
    void CallQuality::setupVideoSDKEngine()
    {
        // Check if the engine initialized successfully.
        agoraEngine = createAgoraRtcEngine();
        if (!agoraEngine)
        {
            return;
        }
        AgoraEventStrategy->SetMsgReceiver(gui->getGuiWindowReference());
        // Create an instance of RtcEngineContext to initialize the engine.
        RtcEngineContext context;
        // Pass your app ID to the context.
        context.appId = appId.c_str();
        // Pass an object of agoraEventHandler class to receive callbacks.
        //HWND agoraEventHandler = AgoraEventStrategy->getMsgEventHandler();
        context.eventHandler = AgoraEventStrategy.get();
        // Set channel profile in the engine to the CHANNEL_PROFILE_LIVE_BROADCASTING.
        context.channelProfile = CHANNEL_PROFILE_LIVE_BROADCASTING;
        // Create log file to check the status
        std::string user_name = AgoraManager::config["user_name"].asString();
        std::string file_path = "C:\\Users\\"+ user_name + "\\AppData\\Local\\Agora\\AgoraImplementation\\agorasdk.log";
        context.logConfig.filePath = file_path.c_str();
        context.logConfig.fileSizeInKB = 256;
        context.logConfig.level = agora::commons::LOG_LEVEL::LOG_LEVEL_WARN;
        // Initialize the engine using the context variable.
        agoraEngine->initialize(context);
        // Set the user role to Host.
        agoraEngine->setClientRole(CLIENT_ROLE_TYPE::CLIENT_ROLE_BROADCASTER);
        // Enable the dual stream mode
        agoraEngine->enableDualStreamMode(true);
        // Set audio profile and audio scenario.
        agoraEngine->setAudioProfile(AUDIO_PROFILE_DEFAULT, AUDIO_SCENARIO_GAME_STREAMING);
        // Set the video profile
        VideoEncoderConfiguration videoConfig;
        // Set mirror mode
        videoConfig.mirrorMode = VIDEO_MIRROR_MODE_AUTO;
        // Set framerate
        videoConfig.frameRate = FRAME_RATE_FPS_10;
        // Set bitrate
        videoConfig.bitrate = STANDARD_BITRATE;
        // Set dimensions
        videoConfig.dimensions = VideoDimensions(360, 360);
        // Set orientation mode
        videoConfig.orientationMode = ORIENTATION_MODE_ADAPTIVE;
        // Set degradation preference
        videoConfig.degradationPreference = MAINTAIN_BALANCED;
        // Set compression preference: low latency or quality.
        //videoConfig.compressionPreference = PREFER_LOW_LATENCY;    // Apply the configuration
        agoraEngine->setVideoEncoderConfiguration(videoConfig);
        // Start the probe test
        startProbeTest();
    }
    ```


1. **Test the user's hardware**

    The echo test checks that the user's hardware is working properly.

    ```cpp
    void CallQuality::EchoTest()
    {
        if (!isEchoTestRunning)
        {
            // Setup a config for the echo test.
            EchoTestConfiguration echoConfig;
            // To test your microphone, set it to true.
            echoConfig.enableAudio = true;
            // To test your video device, set it to true..
            echoConfig.enableVideo = true;
            // Pass your token.
            echoConfig.token = token.c_str();
            // Pass the channel name.
            echoConfig.channelId = channelName.c_str();
            // Pass the window handle to test the local video device.
            echoConfig.view = gui->localView;
            // Start the echo test.
            agoraEngine->startEchoTest(echoConfig);
            // Setup a canvas to render video from your video device.
            VideoCanvas canvas;
            canvas.uid = 0;
            canvas.sourceType = VIDEO_SOURCE_CAMERA;
            canvas.view = gui->localView;
            agoraEngine->setupLocalVideo(canvas);
            // Update the test state.
            isEchoTestRunning = true;
            // Update the button text.
            SetWindowTextW(echoTestButton, L"Stop test");
        }
        else
        {
            // Stop the test.
            agoraEngine->stopEchoTest();
            // Update the test state.
            isEchoTestRunning = false;
            // Update the button text.
            SetWindowTextW(echoTestButton,L"Echo test");
        }
    }
    ```


1. **Listen to <Vg k="ENGINE" /> events to receive state change notifications and quality statistics**

    Use the following `IRtcEngineEventHandler` callbacks to monitor and ensure channel quality:

      ```cpp
      void CallQualityEventHandler::onLastmileQuality(int quality)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_LAST_MILE_QUALITY), (WPARAM)quality, (LPARAM)NULL);
          }
      }
      void CallQualityEventHandler::onRtcStats(const RtcStats& stats)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_RTC_STATS), (WPARAM)stats.userCount, (LPARAM)stats.rxPacketLossRate);
          }
      }
      void CallQualityEventHandler::onRemoteVideoStateChanged(uid_t uid, REMOTE_VIDEO_STATE state, REMOTE_VIDEO_STATE_REASON reason, int elapsed)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_REMOTE_VIDEO_STATE_CHANGED), (WPARAM)state, (LPARAM)reason);
          }
      }
      void CallQualityEventHandler::onRemoteVideoStats(const RemoteVideoStats& stats)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_REMOTE_VIDEO_STATE_CHANGED), (WPARAM)stats.uid, (LPARAM)stats.receivedBitrate);
          }
      }
      void CallQualityEventHandler::onLastmileProbeResult(const LastmileProbeResult& result)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          // The result object contains the detailed test results that help you manage call quality, for example, the downlink jitter.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_LAST_MILE_RESULT), (WPARAM)result.downlinkReport.jitter, (LPARAM)NULL);
          }
      }
      void CallQualityEventHandler::onNetworkQuality(uid_t uid, int txQuality, int rxQuality)
      {
          // Send the call results to the corresponding function in the CAgoraImplementationDlg class.
          HWND m_hMsgHandler = getMsgEventHandler();
          if (m_hMsgHandler)
          {
              ::PostMessage(m_hMsgHandler, WM_MSGID(EID_NETWORK_QUALITY), (WPARAM)txQuality, (LPARAM)rxQuality);
          }
      }
      ```

    Each event reports the statistics of the audio and video streams from each remote user and host.



1. **Switch stream quality**

    Take advantage of dual-stream mode and switch remote video quality to high or low.

    ```cpp
    void CallQuality::VideoQuality()
    {
        highQuality = !highQuality;
        if (highQuality)
        {
            // Switch the remote user video quality to high video quality.
            agoraEngine->setRemoteVideoStreamType(remoteUId, VIDEO_STREAM_HIGH);
            MessageBox(NULL, L"Switching to high-quality video", L"Notification", NULL);
        }
        else
        {
            // Switch the remote user video quality to low video quality.
            agoraEngine->setRemoteVideoStreamType(remoteUId, VIDEO_STREAM_LOW);
            MessageBox(NULL, L"Switching to low-quality video", L"Notification", NULL);
        }
    }
    ```

<ProductWrapper product="interactive-live-streaming">
7. **Set the latency level**

    For ultra low-latency applications, set the appropriate `audienceLatencyLevel` when joining a channel. Ultra-low latency is a feature of <Vg k="ILS" /> and its use is subject to special [pricing](../reference/pricing#unit-pricing).

    ``` cpp
    // Set the latency level
  : audienceLatencyLevel(AUDIENCE_LATENCY_LEVEL_ULTRA_LOW_LATENCY) {}
    ```
</ProductWrapper>

<ProductWrapper product="broadcast-streaming">
7. **Set the latency level**

    For low-latency applications, set the appropriate `audienceLatencyLevel` when joining a channel. Low latency is a feature of <Vg k="BS" /> and its use is subject to special [pricing](../reference/pricing#unit-pricing).
    ``` cpp
    // Set the latency level
    : audienceLatencyLevel(AUDIENCE_LATENCY_LEVEL_LOW_LATENCY) {}
    ```

</ProductWrapper>

    
</PlatformWrapper>
