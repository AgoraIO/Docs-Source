<PlatformWrapper platform="windows">

### Create the UI

In the quickstart <Vpl k="CLIENT"/>, you create a simple UI that consists of the following elements:

* A `Button` to `Join` or `Leave` the Agora <Vg k="CHAT" />.
* An `TextBox` box to specify the recipient user ID.
* An `TextBox` box to enter a text message.
* A `Button` to send the text message.
* A scrollable layout to display sent and received messages.

To add the UI framework to your <Vpl k="NAME"/> project, select and open `<project-name>` > `MainWindow.xaml` from **Solution Explorer** of **Visual Studio** and replace the content with the following:

```xaml
<Window
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AgoraWindowsChat"
        xmlns:ComponentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase" x:Class="AgoraWindowsChat.MainWindow"
        mc:Ignorable="d"
        Title="MainWindow" Height="457" Width="804">
    <Grid x:Name="mainGrid">
        <Button x:Name="btnJoinLeave" Content="Join" HorizontalAlignment="Left" Margin="662,53,0,0" VerticalAlignment="Top" Height="36" Width="107" Click="JoinLeave_Click" Background="#FF4B5ADE" FontSize="18">
            <Button.Foreground>
                <SolidColorBrush Color="{DynamicResource {x:Static SystemColors.GradientInactiveCaptionColorKey}}"/>
            </Button.Foreground>
        </Button>
        <TextBox x:Name="eReciepientUserId" HorizontalAlignment="Left" Height="39" Margin="10,50,0,0" TextWrapping="Wrap" VerticalAlignment="Top" FontSize="20" Width="642" Foreground="Gray" Opacity="1.0" Text="">
            <TextBox.Resources>
                <VisualBrush x:Key="HelpBrush" TileMode="None" Opacity="0.3" Stretch="None" AlignmentX="Left">
                    <VisualBrush.Visual>
                        <TextBlock FontStyle="Normal" Text="Recipient User Id"/>
                    </VisualBrush.Visual>
                </VisualBrush>
            </TextBox.Resources>
            <TextBox.Style>
                <Style TargetType="TextBox">
                    <Style.Triggers>
                        <Trigger Property="Text" Value="{x:Null}">
                            <Setter Property="Background" Value="{StaticResource HelpBrush}"/>
                        </Trigger>
                        <Trigger Property="Text" Value="">
                            <Setter Property="Background" Value="{StaticResource HelpBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </TextBox.Style>
        </TextBox>

        <Button x:Name="btnMessageSend" Content="&gt;&gt;" HorizontalAlignment="Left" Margin="662,334,0,0" VerticalAlignment="Top" Height="36" Width="107" Click="MessageSend_Click" Background="#FF4B5ADE" FontSize="18">
            <Button.Foreground>
                <SolidColorBrush Color="{DynamicResource {x:Static SystemColors.GradientInactiveCaptionColorKey}}"/>
            </Button.Foreground>
        </Button>
        <TextBox x:Name="eMessage" HorizontalAlignment="Left" Height="39" Margin="5,331,0,0" TextWrapping="Wrap" VerticalAlignment="Top" Width="652" FontSize="20" Foreground="Gray" Opacity="1.0" Text="" >
            <TextBox.Resources>
                <VisualBrush x:Key="HelpBrush" TileMode="None" Opacity="0.3" Stretch="None" AlignmentX="Left">
                    <VisualBrush.Visual>
                        <TextBlock FontStyle="Normal" Text="Message"/>
                    </VisualBrush.Visual>
                </VisualBrush>
            </TextBox.Resources>
            <TextBox.Style>
                <Style TargetType="TextBox">
                    <Style.Triggers>
                        <Trigger Property="Text" Value="{x:Null}">
                            <Setter Property="Background" Value="{StaticResource HelpBrush}"/>
                        </Trigger>
                        <Trigger Property="Text" Value="">
                            <Setter Property="Background" Value="{StaticResource HelpBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </TextBox.Style>
        </TextBox>
        <Label x:Name="appNameLabel" Content="   agoraChatQuickStart" HorizontalAlignment="Left" Height="45" Margin="10,0,0,0" VerticalAlignment="Top" Width="759" Background="#FF4655D6" FontSize="22" FontWeight="Bold" Foreground="White"/>
        <ScrollViewer x:Name="scrollMessagesView" HorizontalAlignment="Left" Height="198" Margin="10,94,0,0" VerticalAlignment="Top" Width="763" Foreground="#FF000000"  Background="Linen" RenderTransformOrigin="0.5,0.5" VerticalScrollBarVisibility="Auto">
            <StackPanel></StackPanel>
        </ScrollViewer>
    </Grid>
</Window>
```

### Handle the system logic

1. **Add namespaces:**

    In **Solution Explorer** of **Visual Studio**, select `<project-name>` > `MainWindow.xaml`, and double-click to open the `MainWindow.xaml.cs` file. At the top lines of the `MainWindow.xaml.cs` file, add the following into the namespaces list:

    ```c#
    using AgoraChat;
    using AgoraChat.MessageBody;
    ```
1. **Inherit AgoraChat Chat Manager Interface**

    To add the logic for messages comunication, declare and inherit the `IChatManagerDelegate` class to the `MainWindow`interface.

    ```c#
    public partial class MainWindow : Window, IChatManagerDelegate
    ```

1. **Declare variables**

    In the `MainWindow` class, add the following declarations:

    ```c#
    private readonly string userId = "<User ID of the local user>"
    private string token = "<Your authentication token>"
    private readonly string app_key = "<App key from Agora console>"
    private bool isJoined = false;

    private readonly System.Windows.Threading.Dispatcher? Dip = null; 
    ```

1. **Set up <Vpd k="NAME" /> when the <Vpl k="CLIENT"/> starts**

    When the <Vpl k="CLIENT"/> starts, you create an instance of the AgoraChat `ChatClient` and set up callbacks to handle <Vpd k="NAME" /> events.
    To do this, replace the `MainWindow()` contructor in the `MainWindow` class with the following:

    ```c#
    public MainWindow()
    {
        InitializeComponent(); // initialize window component
            
        Dip = System.Windows.Threading.Dispatcher.CurrentDispatcher; // initialize thread dispatcher
        
        setupChatClient();  // setup Agora chat sdk client.
        AddChatDelegate(); // add chat delegate to listen the `MainWindow` object.

        Closed += CloseWindow; // close the app and remove chat delegate
    }
    ```
1. **Instantiate the `ChatClient`**   

    To implement peer-to-peer messaging, you use <Vpd k="SDK" /> to initialize a `ChatClient` instance. In the `MainActivity` class, add the following method:

    ```c#
    // Initialize agra chat SDKClient.
    private void setupChatClient()
    {
        var options = new Options(appKey: app_key);
        options.UsingHttpsOnly = true;
        SDKClient.Instance.InitWithOptions(options);
    }
    ```

1. **Add & remove chat manager listener and closig window functionality**

    Add below code snippet for adding & removing the chat manager listener after `setupChatClient()`:
    
    ```c#
    private void AddChatDelegate()
    {
        // Add the listener for the `MainWindow` object.
        SDKClient.Instance.ChatManager.AddChatManagerDelegate(this);

    }

    private void RemoveChatDelegate()
    {
        // Remove the listener when the object is released.
        SDKClient.Instance.ChatManager.RemoveChatManagerDelegate(this);

    }
    ```
1.  **Close window event**

    Closing the window actually remove the listener for the `MainWindow` object:

    ```c#
    private void CloseWindow(object sender, EventArgs e)
    {
        RemoveChatDelegate();
    }
    ```

1.  **Log events and show status updates to your users**

    In the `MainWindow` class, add the following method after `CloseWindow`.

    ```c#
    private void showLog(string log)
    {
        // Show a message box with log
        Dip?.Invoke(() =>
        {
            MessageBox.Show(log);
        });

        // Write log
        Console.WriteLine(log);
    }
    ```
### Send and receive messages

When a user opens the <Vpl k="CLIENT"/>, you instantiate and initialize a `ChatClient`. When the user taps the **Join** button, the <Vpl k="CLIENT"/> logs in to the <Vg k="COMPANY" /> <Vg k="CHAT" />. When a user types a message in the text box and then presses **Send**, the typed message is sent to the another registered user. When the <Vpl k="CLIENT"/> receives a message from the server, the message is displayed in the message list. This simple workflow enables you to rapidly build a <Vpd k="NAME" /> client with basic functionality. 

The following figure shows the API call sequence for implementing this workflow.

![image](/images/chat/chat-call-logic-windows.svg)

To implement this workflow in your <Vpl k="CLIENT" />, take the following steps:

1. **Log in to the <Vg k="COMPANY" /> <Vg k="CHAT" />**  

    When a user clicks **Join**, your <Vpl k="CLIENT"/> logs in to the <Vg k="COMPANY" /> <Vg k="CHAT" />. When a user clicks **Leave**, the <Vpl k="CLIENT"/> logs out from the <Vg k="COMPANY" /> <Vg k="CHAT" />. To implement this logic, you add the following method after `showLog()` in the `MainWindow` class:

    ```c#
    private void JoinLeave_Click(object sender, RoutedEventArgs e)
    {
        Button button = (Button)this.FindName("btnJoinLeave");
        
        if (isJoined) 
        {
            SDKClient.Instance.Logout(true, callback: new CallBack(
                onSuccess: () =>
                {
                    showLog("sign out from agoa chat sdk succeed");
                    Dip?.Invoke(() =>
                    {
                        button.Content = "Join";
                    });
                    isJoined = false;
                
                },
                onError: (code, desc) =>
                {
                    showLog(desc);
                }
            ));
        } 
        else 
        {
            // Calls `LoginWithAgoraToken` to log in to the Chat service with username and Agora token.
            SDKClient.Instance.LoginWithAgoraToken(userId, token, callback: new CallBack(
            onSuccess: () =>
            {
                showLog("sign in to agora chat sdk succeed");
                isJoined = false;
                Dip?.Invoke(() =>
                {
                    button.Content = "Leave";
                });
            },
            onError: (code, desc) =>
            {
                if (code == 200)
                { // Already joined
                    isJoined = true;
                    Dip?.Invoke(() =>
                    {
                        button.Content = "Leave";
                    });
                }
                else
                {
                    showLog(desc);
                }
            }
        ));
        }
    }
    ```
1. **Send a message**
    
    When a user draft the message and presses the **Send** button to send it to the recipient. To implement the logic you add the following method to the `MainWindow` class, after `JoinLeave_Click()`:

    ```c#
    private void MessageSend_Click(object sender, RoutedEventArgs e)
        {
            if (eReciepientUserId.Text.Equals("")|| eMessage.Text.Equals(""))
            {
                showLog("Enter a recipient name and a message");
                return;
            }
            //Send Message
            Message msg = Message.CreateTextSendMessage(eReciepientUserId.Text, eMessage.Text);
            SDKClient.Instance.ChatManager.SendMessage(ref msg, new CallBack(
                onSuccess: () =>
                {
                // The success callback uses the System.Windows.Threading.Dispatcher to invoke UI elements `eReciepientUserId.Text` and `eReciepientUserId.Text`.

                Dip?.Invoke(() =>
                {
                    TextBody? txtBody = msg.Body as TextBody;
                    if (txtBody != null)
                    {
                        displayMessage(txtBody.Text, true);
                    }
                    eMessage.Text = "";
                });

                },
                onError: (code, desc) =>
                {
                   showLog(desc);
                }
            ));
        }
    ```
1. **Recieve messages**

    To add the receiving logic for messages, add the following callbacks to handle `IChatManagerDelegate` implementation to  the `MainWindow` class: 

    ```c#
    public void OnMessagesReceived(List<Message> messages)
    {
        foreach (Message msg in messages)
        {
            Dip?.Invoke(() =>
            {
                TextBody? txtBody = msg.Body as TextBody;
                if (txtBody != null)
                {
                    displayMessage(txtBody.Text, false);
                }
            });
                                
        }
    }

    public void OnCmdMessagesReceived(List<Message> messages)
    {
        
    }

    public void OnMessagesRead(List<Message> messages)
    {
        
    }

    public void OnMessagesDelivered(List<Message> messages)
    {
        
    }

    public void OnMessagesRecalled(List<Message> messages)
    {
        
    }

    public void OnReadAckForGroupMessageUpdated()
    {
        
    }

    public void OnGroupMessageRead(List<GroupReadAck> list)
    {
        
    }

    public void OnConversationsUpdate()
    {
        
    }

    public void OnConversationRead(string from, string to)
    {
        
    }

    public void MessageReactionDidChange(List<MessageReactionChange> list)
    {

    }
    ```

1. **Display chat messages**
    
    To display the messages, the current user sends and receives, add the following method to the `MainWindow` class:

    ```c#
    private void displayMessage(string messageText, bool isSentMessage)
    {
        // Create a new TextBlock
        TextBlock messageTextBlock = new TextBlock();
        messageTextBlock.Text = messageText;
        messageTextBlock.Padding = new Thickness(10);

        // Set formatting
        ScrollViewer? messageList = FindName("scrollMessagesView") as ScrollViewer;
        if (messageList != null)
        {
            if (isSentMessage)
            {
                messageTextBlock.Background = new SolidColorBrush(Color.FromRgb(220, 248, 198));
                messageTextBlock.HorizontalAlignment = HorizontalAlignment.Right;
                messageTextBlock.Margin = new Thickness(100, 25, 15, 5);
            }
            else
            {
                messageTextBlock.Background = Brushes.White;
                messageTextBlock.HorizontalAlignment = HorizontalAlignment.Left;
                messageTextBlock.Margin = new Thickness(15, 25, 100, 5);
            }

            // Add the message TextBlock to the StackPanel inside the ScrollViewer
            StackPanel? messageStackPanel = messageList.Content as StackPanel;
            if (messageStackPanel != null)
            {
                messageStackPanel.Children.Add(messageTextBlock);
                messageList.ScrollToEnd(); // Scroll to the bottom of the messages
            }
        }
    }
    ```
</PlatformWrapper>