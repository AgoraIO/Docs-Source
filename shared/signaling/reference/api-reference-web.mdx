import Status from '@docs/shared/signaling/reference/rtm-status.mdx';

The Signaling SDK API Reference lists the description, methods, basic usage, sample codes, and return values. It is divided in the following sections:

* [Setup](#setup)
* [Channels](#channels)
* [Topics](#topics)
* [Messages](#messages)
* [Presence](#presence)
* [Storage](#storage)
* [Lock](#lock)
* [Properties](#properties)

## Setup   

Before initializing a Signaling client instance, you need to import the Signaling Javascript SDK into your project:

// TODO need updates
```javascript 
<script src="https://cdn.agora.com/sdk/javascript/agora-rtm.2.1.1.js"></script>
```

### Initialization
#### Description

Initialization in Signaling refers to creating and initializing a Signaling client instance. When initializing the instance, you need to pass in parameters including `appId` and `userId`. You can create a project and get the App ID on the Agora console.

<Admonition type="info" title="Information"><ul><li>The initialization step needs to be completed before calling the other Signaling APIs. </li> <li>In order to identifying users and devices, you need to ensure that `userId` is globally unique and remains constant throughout the lifecycle of the user or device. </li></ul></Admonition>

#### Method

You can create and initialize an instance in the following way:

```javascript 
class RTM(
    constructor(
        appId: string,
        userId: string,
        rtmConfig?: RTMConfig
    );
)
```

|    Parameter     |                        Type                        | Required | Default | Description                                                                           |
| :---------: | :------------------------------------------------: | :------: | :----: | ------------------------------------------------------------------------------- |
|   `appId`   |                       string                       |   Required   |   -    |  The App ID of your Agora project on the Agora console.                                        |
|  `userId`   |                       string                       |   Required   |   -    |  The unique ID to identify a user or device.                                                  |
| `rtmConfig` | `rtm` |   Optional   |   -    | The configuration parameters for initialization, see `rtm`. |

#### Basic Usage

```javascript 
const { RTM } = AgoraRTM;
const rtm = new RTM(
    appId : "myAppId",
    userId : "Tony"
);
```

#### Return Value

A Signaling client instance. Now you can call other Signaling APIs.

### `RTMConfig`

#### Description

`RTMConfig` is used to configure additional properties when you initializing a Signaling client instance. These configuration properties take effect throughout the lifecycle of the Signaling client and affect the behaviors of the Signaling client.

#### Method

You can create a `RTMConfig` instance in the following way:

```javascript 
const { RTMConfig } = AgoraRTM;
```

|       Property       |    Type    | Required | Default  | 描述       |
| :---------------: | :--------: | :------: | :-----: | ---------------------------------------- |
| `token` | string | Optional | - | A dynamic key, usually generated by a token server. |
| `encryptionMode` | string | Optional | - | Encryption mode for end-to-end messages. If you do not set this property or set it as `encryptionmodenone`,  end-to-end encryption is disabled. For details, see <a href="../enumv#encryptionmode">Encryption Mode</a>. |
| `cipherKey` | string | Optional | - | The key used for encryption and decryption. You must set this property if you want to enable message encryption. |
| `salt` | Uint8Array | Optional | - | The salt required for encryption. The value must be a 32-byte binary array. You must set this property if you want to enable message encryption.|
| `useStringUserId` | boolean | Optional | `true` | Whether to use string-type user IDs: <ul><li>`true`: Use string-type user IDs. </li><li>`false`: Use number-type user IDs. If you set the property as `false`, SDK automatically converts string-type user IDs to number-type ones. In this case, the `userId` parameter must be a numeric string (for example, "123456"), otherwise initialization fails. </li></ul> |
| `presenceTimeout` | number | optional | `300` | Presence timeout in seconds, and the value range is [10,300]. |
| `logUpload` | boolean | Optional | `false` | Whether to upload logs to the server: <ul><li>`true`: Enable log upload</li><li><code>false</code >: Disable log upload. </li></ul> |
| `logLevel` | string | Optional | - | Set the output level of SDK log. For details, see <a href="../enumv#loglevel">log output level</a>. |
| `cloudProxy` | boolean | Optional | `false` | Whether to enable the cloud proxy: <ul><li>`true`: Enable. </li><li>`false`: Disable. </li></ul> |

#### Basic Usage

```javascript 
const { RTM, EncryptionMode } = AgoraRTM;
const rtmConfig = {
        token : "yourToken",
        encryptionMode : EncryptionMode.AES_256_GCM,
        slat : yourSalt,
        cipherKey : "yourCipherKey",
        presenceTimeout : 300,
        logUpload : true,
        logFilter : 'debug',
        cloudProxy : false,
        useStringUserId : false
};
const rtm = new RTM( "myAppId", "Tony", rtmConfig);
```

### Event Listeners

#### Description

In Signaling there are seven types of event as follows:

| Event Type | Description |
|:----------------------------:| ------------------------- |
| `onmessageevent` | Receive message event notifications in subscribed message channels and subscribed topics. |
| `onpresenceevent` | Receive presence event notifications in subscribed message channels and joined stream channels. |
| `ontopicevent` | Receive all topic event notifications in joined stream channels. |
| `onstorageevent` | Receive channel metadata event notifications in subscribed message channels and joined stream channels, and the user metadata event notification of the subscribed users. |
| `onlockevent` | Receive lock event notifications in subscribed message channels and joined stream channels. |
| `onconnection` | Receive event notifications when client connection status changes. For details, see <a href="../enumv#connectionstate">SDK connection state</a> and <a href="../enumv#connectionreason">SDK connection state change reason</a>. |
| `ontokenwillexpire` | Receive event notifications when the client tokens are about to expire. |

#### Add event listeners

You can add event listeners in the following way:

```javascript 
// add message event listeners
rtm.addEventListener({
    // Message
    message : event => {
        const channelType = event.channelType;      // Channel type, 'STREAM' or 'MESSAGE'.
        const channelName = event.channelName;      // Channel name
        const topic = event.topicName;              // Topic name, available only when channelType is 'STREAM'.
        const messageType = event.messageType;      // Message type, "string" or "binary" .
        const customType = event.customType;        // User-defined type
        const publisher = event.publisher;          // Message publisher
        const message = event.message;              // Message payload
        const pubTime = event.publishTime;          // Message timestamp
    },
    // Presence
    presence : event => {
        const action = event.eventType;             // Action type, 'SNAPSHOT','INTERVAL','JOIN','LEAVE','TIMEOUT,'STATE_CHANGED','OUT_OF_SERVICE'.
        const channelType = event.channelType;      // Channel type, 'STREAM' or 'MESSAGE'.
        const channelName = event.channelName;      // Channel name
        const publisher = event.publisher;          // User triggers this event
        const states = event.stateChanged;          // User state payload
        const interval = event.interval;            // Interval payload
        const snapshot = event.snapshot;            // Snapshot payload
    },
    // Topic
    topic : event => {
        const action = event.evenType;              // Action type, 'SNAPSHOT','JOIN',or 'LEAVE'.
        const channelName = event.channelName;      // Channel name
        const publisher = event.userId;             // User triggers this event
        const topicInfos = event.topicInfos;        // Topic information payload
        const totalTopics = event.totalTopics;      // Topic number
    },
    // Storage
    storage : event => {
        const channelType = event.channelType;      // Channel type, 'STREAM' or 'MESSAGE'.
        const channelName = event.channelName;      // Channel name
        const publisher = event.publisher;          // User triggers this event
        const storageType = event.storageType;      // Category of the metadata, 'USER or 'CHANNEL'
        const action = event.eventType;             // Action type, 'SNAPSHOT', 'SET', 'REMOVE', 'UPDATE' or 'NONE'
        const data = event.data;                    // User metadata or channel metadata payload
    },
    // Lock
    lock : event => {
        const channelType = event.channelType;      // Channel type, 'STREAM' or 'MESSAGE'.
        const channelName = event.channelName;      // Channel name
        const publisher = event.publisher;          // User triggers this event
        const action = event.evenType;              // Action type, 'SET','REMOVED','ACQUIRED','RELEASED','EXPIRED', or 'SNAPSHOT'
        const lockName = event.lockName;            // Lock name
        const ttl = event.ttl;                      // The ttl of this lock
        const snapshot = event.snapshot;            // Snapshot payload
    },
    // Connection State Change
    status : (states, reason) => {
        const currentState = states;                // Connection state
        const changeReason = reason;                // Reason Why the user triggers this event
    },
    // Token Privilege Will Expire
    TokenPrivilegeWillExpire : (channelName) => {
        const channelName = channelName;            // Name of the channel in which the token is to expire
    },
});
```

### `login`

#### Description

After creating and initializing a Signaling client instance, you need to perform the `login` operation to login to the Signaling service. With successful login, the client establishes a long link to the Signaling server and allow the client to access Signaling resources.

#### Method

You can call the `login` method in the following way:

```javascript 
rtm.login(): Promise<LoginResponse>;
```

#### Basic Usage

```javascript 
try{
    const result = await rtm.login();
    console.log(result);
} catch (status){
    console.log(status);
}
```

#### Return Value

If the method call succeeds, the `LoginResponse` is returned as follows:

```javascript 
type LoginResponse = {
    timeToken: number  // Reserved property, indicating the timestamp of the successful operation
}
```

If the method call fails, the `ErrorInfo` response is returned as follows:

<Status />

### logout

#### Description

You can log out of the Signaling system if you don't need to perform any operation.

#### Method

You can call the `logout` method in the following way:

```javascript 
rtm.logout(): Promise<LogoutResponse>;
```

#### Basic Usage

```javascript 
try{
    const result = await rtm.logout();
    console.log(result);
} catch (status){
    console.log(status);
}
```

#### Return Value

If the method call succeeds, the `LogoutResponse` is returned as follows:

```javascript 
type LoginResponse = {
    timeToken: number               // Reserved property, indicating the timestamp of the successful operation
}
```

If the method call fails, the `ErrorInfo` response as follows is returned:

<Status/>

## Channels

Agora Signaling provides a highly efficient channel management mechanism for data transmission. Any user who subscribes or joins a channel can receive messages and events transmitted within 100 milliseconds. Signaling allows clients to subscribe to hundreds or even thousands of channels. Most Signaling APIs perform actions such as sending, receiving, and encrypting based on channels.

Based on capabilities of Agora, Signaling channels are divided into two types to match different application scenarios:

- Message Channel: Follows the industry-standard Pub/Sub (publish/subscribe) mode. You can send and receive messages within the channel by subscribing to a channel, and do not need to create the channel in advance. There is no limit to the number of publishers and subscribers in a channel.

- Stream Channel: Follows a concept similar to the observer pattern in the industry, where users need to create and join a channel before sending and receiving messages. You can create different topics in a channel. Each channel can contain up to 1,000 users.

To learn more about the usage and applicable scenarios of Message Channel and Stream Channel, click the following card:

// TODO DocLinkCard `/doc/rtm2/${frontMatter.ag_platform}/user-guide/channel/channel-basic` Channels

### subscribe

#### Description

Signaling provides event notification capabilities for messages, states, and events. By setting up event listeners, you can receive messages and events within subscribed channels. For information on how to add and set up event listeners, see <a href="../toc-configuration/configuration#Event-Listener">Event Listener</a>.



By calling the `subscribe` method, the client can subscribe to a message channel and start receiving messages and event notifications within the channel. After successfully calling this method, users who subscribe to the channel and enable the presence event listener can receive a `onpresenceevent` event with the `remotejoinchannel` type.

<Admonition type="info" title="Information">This method only applies to the message channel.</Admonition>

#### Method

You can call the `subscribe` method in the following way:

```javascript 
rtm.subscribe(
    channelName: string,
    options?: object
): Promise<SubscribeResponse>;
```

|   Parameter   |  Type  | Required | Default |       Description        |
| :-----------: | :----: | :------: | :-----: | :----------------------: |
| `channelName` | string |   Yes    |    -    |   The channel name.   |
|   `options`   | object | Optional |    -    | Options for subscribing a channel. |

The `options` object includes the following properties:

|    Property    |  Type   | Required | Default |                         Description                          |
| :------------: | :-----: | :------: | :-----: | :----------------------------------------------------------: |
| `withMessage`  | boolean | Optional | `true`  | Whether to subscribe to message event notifications in the channel. |
| `withPresence` | boolean | Optional | `true`  | Whether to subscribe to presence event notifications in the channel. |
| `withMetadata` | boolean | Optional | `false` | Whether to subscribe to storage event notifications in the channel. |
| `withLock`     | boolean | Optional | `false` | Whether to subscribe to lock event notifications in the channel. |

#### Basic usage

```javascript 
const options ={
    withMessage : true,
    withPresence : true,
    withMetadata : false,
    withLock : false
};
try {
    const result = await rtm.subscribe("chat_room", options);
    console.log(result);
} catch (status) {
    console.log(status);
}
```

#### Return value

If the method call succeeds, the `subscriberesulttype` response as follows is returned:

```javascript 
type SubscribeResponse = {
    timeToken : number               // Reserved property, indicating the timestamp of the successful operation.
    channelName : string             // Channel name.
}
```

If the method call fails, the `errorinfo` response as follows is returned:


### `unsubscribe`

#### Description

If you no longer need to subscribe to a channel, you can call the `unsubscribe` method to cancel your subscription. After successfully unsubscribing from the channel, other users who subscribe to the channel and enable event listeners can receive a `presence` event notification with the `REMOTE_LEAVE` type. For details, see Event Listeners(#event-listeners).

<Admonition type="info" title="Information">This method only applies to the message channel.</Admonition>

#### Method

You can call the `unsubscribe` method in the following way:

```javascript 
rtm.unsubscribe(
    channelName: string
): Promise<UnsubscribeResponse>;
```

|   Parameter   |  Type  | Required | Default |       Description        |
| :-----------: | :----: | :------: | :-----: | :----------------------: |
| `channelName` | string |   Yes    |    -    |   The channel name.   |

#### Basic usage

```javascript 
try {
    const result = await rtm.unsubscribe("chat_room");
    console.log(result);
} catch (status) {
    console.log(status);
}
```

#### Return value

If the method call succeeds, the `UnsubscribeResponse` is returned:

```javascript 
type UnsubscribeResponse = {
    timeToken : number       // Reserved property, indicating the timestamp of the successful operation.
    channelName : string     // Channel name.
}
```

If the method call fails, the `errorinfo` response as follows is returned:


### `createStreamChannel`

#### Description

Before using a stream channel, you need to call the `createStreamChannel` method to create an `RTMStreamChannel` instance. After successfully creating the instance, you can call its relevant methods to implement functions, such as joining the channel, leaving the channel, sending messages in a topic, and subscribing to messages in a topic.

<Admonition type="info" title="Information">This method only applies to the stream channel.</Admonition>

#### Method

You can call the `create` method in the following way:

```javascript 
rtm.createStreamChannel(chanelName: string): RTMStreamChannel;
```

|   Parameter   |  Type  | Required | Default |       Description        |
| :-----------: | :----: | :------: | :-----: | :----------------------: |
| `channelName` | string |   Yes    |    -    |   The channel name.   |


#### Basic usage

```javascript 
try{
    const Loc_stChannel = await rtm.createStreamChannel( "Location");
    console.log("Create Stream Channel success!: ");
} catch (status){
    console.log(status);
}
```

#### Return value

An `RTMStreamChannel` instance.


### `join`

#### Description

After successfully creating a stream channel, you can call the `join` method to join the stream channel. Once you join the channel, you can implement channel-related functions. At this point, users who subscribe to the channel and add event listeners can receive the following event notifications:

- Local users:
  - `presence` event notification with the `SNAPSHOT` type.
  - `topic` event notification with the `SNAPSHOT` type.
- Remote users: `presence` event notification with the `REMOTE_JOIN` type.

<Admonition type="info" title="Information">This method only applies to the stream channel.</Admonition>

#### Method

You can call the `join` method in the following way:

```javascript 
join(options?: {
    token?: string;
    withPresence?: boolean;
    withMetadata?: boolean;
    withLock?: boolean;
}): Promise<JoinChannelResponse>;
```

|   Parameter   |  Type  | Required | Default |       Description        |
| :-----------: | :----: | :------: | :-----: | :----------------------: |
|   `options`   | object | Optional |    -    | Options for joining a channel. |

The `options` object includes the following properties:

|    Property    |  Type   | Required | Default |                         Description                          |
| :------------: | :-----: | :------: | :-----: | :----------------------------------------------------------: |
|    `token`     | string  |   Optional   |   -    | The token used for joining a stream channel, which is currently the same as the RTC token. |
| `withMetadata` | boolean | Optional | `false` | Whether to subscribe to storage event notifications in the channel. |
| `withPresence` | boolean | Optional | `true`  | Whether to subscribe to presence event notifications in the channel. |
| `withLock`     | boolean | Optional | `false` | Whether to subscribe to lock event notifications in the channel. |

#### Basic usage

```javascript 
const options ={
    token : "yourToken",
    withPresence : true,
    withMetadata : false,
    withLock : false
};
try {
    const result = await stChannel.join(options);
    console.log(result);
} catch (status) {
    console.log(status);
}
```

#### Return value

If the method call succeeds, the `JoinChannelResponse` response as follows is returned:

```javascript 
type JoinChannelResponse = {
    timeToken : number ,              // Reserved property, indicating the timestamp of the successful operation.
    channelName : string             // Channel name.
}
```

If the method call fails, the `errorinfo` response as follows is returned:


### `leave`

#### Description

If you no longer need to stay in a channel, you can call the `leave` method to leave the channel. After leaving the channel, you can no longer receive any messages, states, or event notifications from this channel. At the same time, you can no longer be the topic publisher or subscriber of all topics. If you want to restore your previous publisher role and subscribing relationship, you need to call `join`, `joinTopic` and `subscribeTopic` methods in this order.

After successfully leaving the channel, remote users in the channel can receive a `presence` event notification with the `REMOTE_LEAVE` type. For details, see [Event Listener](#event-listeners).

<Admonition type="info" title="Information">This method only applies to the stream channel.</Admonition>

#### Method

You can call the `leave` method in the following way:

```javascript 
leave(): Promise<LeaveChannelResponse>;
```

#### Basic usage

```javascript 
try{
    const result = await rtm.leave();
    console.log(result);
} catch (status){
    console.log(status);
}
```

#### Return value

If the method call succeeds, the `LeaveChannelResponse` is returned:

```javascript 
type LeaveChannelResponse = {
    timeToken : number       // Reserved property, indicating the timestamp of the successful operation.
    channelName : string     // Channel name.
}
```
If the method call fails, the `errorinfo` response as follows is returned:

