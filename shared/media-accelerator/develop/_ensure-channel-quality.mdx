import * as data from '@site/data/variables';
import Introduction from '@docs/shared/video-sdk/common/channel_quality_intro.mdx';
import Prerequisites from '@docs/shared/common/prerequities.mdx';
import ProjectSetup from '@docs/shared/media-accelerator/develop/ensure-channel-quality/project-setup/index.mdx';
import ProjectImplement from '@docs/shared/media-accelerator/develop/ensure-channel-quality/project-implementation/index.mdx';
import ProjectTest from '@docs/shared/media-accelerator/develop/ensure-channel-quality/project-test/index.mdx';
import Reference from '@docs/shared/media-accelerator/develop/ensure-channel-quality/reference/index.mdx';

<Introduction />

This page shows you how to use <Vpd k="SDK"/> features to account for these factors and ensure optimal audio and video quality in your {props.PRODUCT} <Vpl k="CLIENT" />.

## Understand the tech

<Vpd k="SDK"/> provides the following features to deal with channel quality issues:

- **Choose from built-in audio codec or implement your own**

  Choose from:

  * **Built-in audio codec**
  
    Since version 1.4.1, you can use the internal audio codec provided by the Media Streaming SDK to encode audio. This article takes the use of C API to encode PCM data into Opus format as an example to introduce how to use the SDK internal audio encoder to send and receive data.

    When calling the `agora_rtc_join_channel` method to join the RTC channel, set `rtc_channel_options_t.audio_codec_opt.audio_codec_type` to `Opus`, `G722`, `G711A` or `G711U` audio codec. Set different sampling rates and channel numbers according to different codecs. 

    When calling the `agora_rtc_send_audio_data` method to send audio data, set the `*info_ptr.data_type` parameter to `AUDIO_DATA_TYPE_PCM` the PCM type. The SDK will automatically encode the PCM data into Opus format and transmit it.

  * **Use own codec**

    If you use your own codec, you need to call the agora_rtc_join_channel method to join the RTC channel, set rtc_channel_options_t.audio_codec_opt.audio_codec_type to AUDIO_CODEC_DISABLED. When calling the agora_rtc_send_audio_data method to send audio data, set the *info_ptr.data_type parameter to your encoding format. This setting is mainly for information synchronization, that is, the receiving end can know the audio encoding format you send through this setting. The SDK does not process audio.

    The receiving end obtains the encoded audio data and encoding format transmitted by the sending end through the on_audio_data callback , and decodes it through your own decoder.

- **Adjust target bit rate in real time**

  In order to increase data transmission and avoid network congestion, <Vpd k="SDK"/> will suggest developers to adjust the sending bit rate in real time according to changes in network bandwidth conditions.

  Developers can call the agora_rtc_set_bwe_param (C API) method or setBweParam (Java API) method to configure BWE (BandWidth Estimation) before joining the RTC channel according to their actual bandwidth and bit rate needs, and set the minimum, maximum, and starting value.

  You must call (C API) method or (Java API) method to configure BWE (BandWidth Estimation) before calling (C agora_rtc_join_channelAPI) or joinChannel(Java API) to join the channel , otherwise the call is invalid.agora_rtc_set_bwe_paramsetBweParam

  During bit stream transmission, when the network bandwidth changes, the SDK will trigger a on_target_bitrate_changed(C API) callback or onTargetBitrateChanged(Java API) callback to prompt the application to adjust the sending bit rate in real time. The bit rate returned by the callback is the maximum recommended encoding bit rate of the video encoder.

  Take the different definition levels of the webcam as an example:

  
  | gear	| resolution	| frame rate	| Bit rate range (kbps) | 
  |---|---|---|---| 
  | SD	| L1: 640*360	| 15 | 400 ~ 800 |
  | hd	| L2: 1280*720	| 15	| 1130 ~ 2260 | 
  | ultra hd	| L3: 1920*1080	| 15	| 1130 ~ 4160 | 

  According to the configuration in the above table, the minimum value can be set to 400 kbps, and the maximum value can be set to 4200 kbps. The initial value is the initial callback value of bandwidth detection, the actual setting is between the minimum value and the maximum value, generally set to the code rate of normal encoding. If the initial encoding file is the SD file in the above table, the initial value can be set to 500 kbps.

  The sender will continue to detect the available bandwidth, and notify the application of the current available bandwidth through a on_target_bitrate_changed callback . The application code needs to follow the code rate to avoid sending at an excessive code rate, causing problems such as freezes.

  The sample code is as follows:

  ```java
  // Add Code here
  ```

  - **onTargetBitrateChanged**

    Encoder code rate update notification callback. You can use this callback to remind the app to update the encoder bit rate.

- **Change audio and video streaming status**

  After the user successfully connects to the Connection and starts audio and video streaming, he can suspend sending streams to the specified Connection or all Connections, or suspend receiving streams from the specified Connection or all Connections, so as to flexibly adjust the transmission status of audio and video streams.

- **Log files** 

  <Vpd k="SDK"/> provides configuration options that you use to customize the location, content and size of log files containing key data of <Vpd k="SDK"/> operation. When you set up logging, <Vpd k="SDK"/> writes information messages, warnings, and errors regarding activities such as initialization, configuration, connection and disconnection to log files. Log files are useful in detecting and resolving channel quality issues.

The following figure shows the workflow you need to implement to ensure channel quality in your <Vpl k="CLIENT"/>:

![Ensure Channel Quality](/images/common/ensure-channel-quality.png)

## Prerequisites

In order to follow this procedure you must have:

* Implemented the [<Vg k="GET_STARTED"/>](../get-started/get-started-sdk) project for <Vpd k="NAME"/>.

<Prerequisites/>

## Project setup

To create the environment necessary to implement call quality best practices into your <Vpl k="CLIENT" />, open the [<Vg k="GET_STARTED"/>](../get-started/get-started-sdk) for <Vpd k="NAME"/> project you created previously.

<ProjectSetup />

## Implement best practice to optimize call quality

This section shows you how to integrate call quality optimization features of <Vg k="VSDK" /> into your <Vpl k="CLIENT" />, step by step.

<ProjectImplement />

## Test your implementation

To ensure that you have implemented call quality features into your <Vpl k="CLIENT" />:

1. [Generate a temporary token](../reference/manage-agora-account#generate-a-temporary-token) in <Vg k="CONSOLE" /> .

2. In your browser, navigate to the <Link target="_blank" to="https://webdemo.agora.io/dualStream/index.html"><Vg k="COMPANY" /> dual stream web demo</Link> and update _App ID_, _Channel_, and _Token_ with the values for your temporary token, then click **Join**.

<ProjectTest />

## Reference

This section contains information that completes the information in this page, or points you to documentation that explains other aspects to this product.

### Recommended Video Settings

The recommended video settings vary by scenario. For example, in a one-to-one online class, the video windows of the teacher and student are both large, which calls for higher resolutions, frame rate, and bitrate. However, in a one-to-many online class, the video windows are smaller. You can set lower resolution, frame rate, and bitrate to accommodate bandwidth limitations.
The recommended settings for these different scenarios are:

- One-to-one video call:

    - Resolution: 320 x 240; Frame rate: 15 fps; Bitrate: 200 Kbps.
    - Resolution: 640 x 360; Frame rate: 15 fps; Bitrate: 400 Kbps.

- One-to-many video call:

    - Resolution: 160 x 120; Frame rate: 15 fps; Bitrate: 65 Kbps.
    - Resolution: 320 x 180; Frame rate: 15 fps; Bitrate: 140 Kbps.
    - Resolution: 320 x 240; Frame rate: 15 fps; Bitrate: 200 Kbps.

### Video profile table

<Vg k="VSDK" /> provides a selection of video dimensions, framerate, and bitrate to choose from. You can also customize the values according to the table below.

| Video Profile | Resolution (Width×Height) | Frame rate (fps） | Bitrate（Kbps） |
| -------- | --------------- | ----------- | ------------ |
| 120p | 160 × 120 | 15 | 65 |
| 120p_1 | 160 × 120 | 15 | 65 |
| 120p_3 | 120 × 120 | 15 | 50 |
| 180p | 320 × 180 | 15 | 140 |
| 180p_1 | 320 × 180 | 15 | 140 |
| 180p_3 | 180 × 180 | 15 | 100 |
| 180p_4 | 240 × 180 | 15 | 120 |
| 240p | 320 × 240 | 15 | 200 |
| 240p_1 | 320 × 240 | 15 | 200 |
| 240p_3 | 240 × 240 | 15 | 140 |
| 240p_4 | 424 × 240 | 15 | 220 |
| 360p | 640 × 360 | 15 | 400 |
| 360p_1 | 640 × 360 | 15 | 400 |
| 360p_3 | 360 × 360 | 15 | 260 |
| 360p_4 | 640 × 360 | 30 | 600 |
| 360p_6 | 360 × 360 | 30 | 400 |
| 360p_7 | 480 × 360 | 15 | 320 |
| 360p_8 | 480 × 360 | 30 | 490 |
| 360p_9 | 640 × 360 | 15 | 800 |
| 360p_10 | 640 × 360 | 24 | 800 |
| 360p_11 | 640 × 360 | 24 | 1000 |
| 480p | 640 × 480 | 15 | 500 |
| 480p_1 | 640 × 480 | 15 | 500 |
| 480p_2 | 640 × 480 | 30 | 1000 |
| 480p_3 | 480 × 480 | 15 | 400 |
| 480p_4 | 640 × 480 | 30 | 750 |
| 480p_6 | 480 × 480 | 30 | 600 |
| 480p_8 | 848 × 480 | 15 | 610 |
| 480p_9 | 848 × 480 | 30 | 930 |
| 480p_10 | 640 × 480 | 10 | 400 |
| 720p | 1280 × 720 | 15 | 1130 |
| 720p_1 | 1280 × 720 | 15 | 1130 |
| 720p_2 | 1280 × 720 | 30 | 2000 |
| 720p_3 | 1280 × 720 | 30 | 1710 |
| 720p_5 | 960 × 720 | 15 | 910 |
| 720p_6 | 960 × 720 | 30 | 1380 |
| 1080p | 1920 × 1080 | 15 | 2080 |
| 1080p_1 | 1920 × 1080 | 15 | 2080 |
| 1080p_2 | 1920 × 1080 | 30 | 3000 |
| 1080p_3 | 1920 × 1080 | 30 | 3150 |
| 1080p_5 | 1920 × 1080 | 60 | 4780 |

For more details, see <Link to="{{Global.API_REF_WEB_ROOT}}/globals.html#videoencoderconfigurationpreset">VideoEncoderConfigurationPreset</Link>.

### Mainstream video profiles

You can also refer to the following tables to learn the default resolution, frame rate, and bitrate of the low-quality video stream for different mainstream video profiles of the high-quality video stream.


| High-quality stream video profile: Communication      | Default low-quality stream video profile: Communication |
| :------------------- | :---------------- |
| 320 × 240, 15, 200   | 144 × 108, 5, 20  |
| 640 × 360, 15, 400   | 288 × 162, 5, 40  |
| 640 × 480, 15, 500   | 288 × 216, 5, 50  |
| 1280 × 720, 15, 1130 | 288 × 162, 5, 113 |
| 240 × 320, 15, 200   | 108 × 144, 5, 20  |
| 240 × 320, 15, 200   | 108 × 144, 5, 20  |
| 360 × 640, 15, 400   | 164 × 288, 5, 40  |
| 480 × 640, 15, 500   | 216 × 288, 5, 50  |
| 720 × 1280, 15, 1130  | 164 × 288, 5, 113 |


| High-quality stream video profile: Live-broadcast  | Default low-quality stream video profile: Live-broadcast|
| :------------------- | :----------------------- |
| 320 × 240, 15, 350   | 160 × 120, 5, 45         |
| 640 × 360, 15, 650   | 192 × 108, 5, 50         |
| 640 × 480, 15, 800   | 160 × 120, 5, 45         |
| 1280 × 720, 15, 1600 | 192 × 108, 5, 50         |
| 240 × 320, 15, 350   | 120 × 160, 5, 45         |
| 360 × 640, 15, 650   | 108 × 192, 5, 50         |
| 480 × 640, 15, 800   | 120 × 160, 5, 45         |
| 720 × 1280, 15, 1600 | 108 × 192, 5, 50         |


### Recommended video profiles

This section provides the recommended video resolution, frame rate, and bitrate for high-quality and low-quality streams.

<table>
<thead>
  <tr>
    <th>Channel profile</th>
    <th>Video stream type</th>
    <th>Device system</th>
    <th>Recommended video profile</th>
  </tr>
</thead>
<tbody>
  <tr>
    <td rowspan="4">Communication</td>
    <td rowspan="2">high-quality stream</td>
    <td>macOS, Windows</td>
    <td>640 × 480, 15, 500</td>
  </tr>
  <tr>
    <td>Android, iOS</td>
    <td>640 × 360, 15, 400</td>
  </tr>
  <tr>
    <td rowspan="2">low-quality stream</td>
    <td>macOS, Windows</td>
    <td>320 × 180, 7, 75</td>
  </tr>
  <tr>
    <td>Android, iOS</td>
    <td>160 × 90, 7, 45</td>
  </tr>
  <tr>
    <td rowspan="4">Live-broadcast</td>
    <td rowspan="2">high-quality stream</td>
    <td>macOS, Windows</td>
    <td>640 × 480, 15, 800</td>
  </tr>
  <tr>
    <td>Android, iOS</td>
    <td>640 × 360, 15, 650</td>
  </tr>
  <tr>
    <td rowspan="2">low-quality stream</td>
    <td>macOS, Windows</td>
    <td>320 × 180, 7, 126</td>
  </tr>
  <tr>
    <td>Android, iOS</td>
    <td>160 × 90, 7, 64</td>
  </tr>
</tbody>
</table>

In practice, different user devices, user network conditions, application service locations, and user requirements affect which kinds of video profiles you use. Therefore, if the recommended video profiles are not suitable for you, contact technical support for assistance.

### Mirror mode

By default, Video SDK does not mirror the video during encoding. You can use the `mirrorMode` parameter to decide whether to mirror the video that remote users see.

### Connection states

When the connection state changes, Agora sends the `onConnectionStateChanged` callback. The following diagram illustrates the various states and how the states change as a client app joins and leaves a channel:

![](https://web-cdn.agora.io/docs-files/1630290002743)

When the network connection is interrupted, the SDK automatically tries to reconnect to the server. The following diagram shows the callbacks received by the local user (UID1) and the remote user (UID2) when the local user joins the channel, gets a network exception, lises connection, and rejoins the channal.

![](https://web-cdn.agora.io/docs-files/1630290020302)

As shown in the above diagram:

- T0: The SDK receives the `joinChannel` request from UID1.
- T1: 200 ms after calling `joinChannel`, UID1 joins the channel. In the process, UID1 also receives the `onConnectionStateChanged(CONNECTING, CONNECTING)` callback. When successfully joining the channel, UID 1 receives the `onConnectionStateChanged(CONNECTED, JOIN_SUCCESS)` and `onJoinChannelSuccess` callbacks.
- T2: 100 ms after UID1 joins the channel, UID2 receives the `onUserJoined` callback.
- T3: The uplink network condition of UID1 deteriorates. The SDK automatically tries rejoining the channel.
- T4: If UID1 fails to receive any data from the server in four seconds, UID1 receives `onConnectionStateChanged(RECONNCTING, INTERRUPTED)`; meanwhile the SDK continues to try rejoining the channel.
- T5: If UID1 fails to receive any data from the server in ten seconds, UID1 receives `onConnectionLost`; meanwhile the SDK continues to try rejoining the channel.
- T6: If UID2 fails to receive any data from UID1 in 20 seconds, the SDK decides that UID1 is offline. UID2 receives `onUserOffline`.
- T7: If UID1 fails to rejoin the channel in 20 minutes, the SDK stops trying to rejoin the channel. UID1 receives `onConnectionStateChanged(FAILED, JOIN_FAILED)`.


<Reference />