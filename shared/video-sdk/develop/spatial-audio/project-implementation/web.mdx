<PlatformWrapper platform="web">

### Spatial audio for remote users

When you subscribe to a channel, create the remote user's spatial sound effect as follows:

1. Call [`createProcessor`](#createprocessor) and create a `SpatialAudioProcessor` instance.

1. Update the local user's spatial location by calling `updateSelfPosition` method of the extension. 

    ```javascript
    const mockLocalUserNewPosition = {
        // For example, mockLocalUserNewPosition can be produced by dragging the local user's avatar to walk in a 3D scene
        position: [1, 1, 1], // The coordinates in the world coordinate system
        forward: [1, 0, 0], // The unit vector of the front axis 
        right: [0, 1, 0], // The unit vector of the right axis 
        up: [0, 0, 1], // The unit vector of the vertical axis 
    };

    extension.updateSelfPosition(
        mockLocalUserNewPosition.position,
        mockLocalUserNewPosition.forward,
        mockLocalUserNewPosition.right,
        mockLocalUserNewPosition.up,
    );
    ```

1. Spatial sound effect parameters are calculated on the basis of the relative positions of local and remote users. To update the spatial location information of remote users, call `updateRemotePosition`:

    ```javascript
    const processors = new Map();
    client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);
        console.log("subscribe success");
        if (mediaType === "audio") {
            const processor = extension.createProcessor();
            processors.set(user.uid, processor);
            const track = user.audioTrack;
            track.pipe(processor).pipe(track.processorDestination);
            track.play();
        }
    });

    // The following code mocks the case of receiving the remote user's position change message from your server
    yourOwnEventHandler.on("updatePosition", (uid, data) => {
        const processor = processors.get(uid);
        processor.updateRemotePosition({
            position: data.position,
            forward: data.forward,
        });
    });
    ```

1. To inject a plug-in into the remote user's audio track, call the `pipe` method and specify the `processorDestination` property.

    ```javascript
    async function subscribe(user, mediaType) {
        await client.subscribe(user, mediaType);
        console.log("subscribe success");
        if (mediaType === "audio") {
            const processor = extension.createProcessor();
            const track = user.audioTrack;
            track.pipe(processor).pipe(track.processorDestination);
            track.play();
        }
    }
    ```

### Spatial audio effect for media player

To implement spatial audio for background sound, accompaniment, and NPC voice locally using audio files, take the following steps:

1. Call the `createProcessor` method to create a `SpatialAudioProcessor` instance.

1. Inject a plugin into the audio track of a local audio file. Call the `pipe` method and specify the `processorDestination` properties.

    ```javascript
    var localPlayerSound = [
        // './resources/1.mp3',
        "./resources/2.mp3",
        // './resources/3.mp3',
        // './resources/4.mp3',
    ];

    async function localPlayerStart() {
        for (let i = 0; i < localPlayerSound.length; i++) {
            const processor = extension.createProcessor();
            const track = await AgoraRTC.createBufferSourceAudioTrack({source: localPlayerSound[i]});
            track.startProcessAudioBuffer({loop: true});
            track.pipe(processor).pipe(track.processorDestination);
            track.play();
        }
    }
    ```

1. Update the spatial position for the local audio player.

    ```javascript
    const mockLocalPlayerNewPosition = {
        position: [1, 1, 1],
        forward: [1, 0, 0],
    };
    processor.updatePlayerPositionInfo(mockLocalPlayerNewPosition);
    ```

</PlatformWrapper>