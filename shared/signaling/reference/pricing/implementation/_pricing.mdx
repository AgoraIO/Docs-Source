import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import * as presence from '@docs/shared/signaling/reference/api-ref/shared/_presence.mdx'
import * as storage from '@docs/shared/signaling/reference/api-ref/shared/_storage.mdx'
import * as lock from '@docs/shared/signaling/reference/api-ref/shared/_lock.mdx'

### Number of messages

In <Vg k="SIG" />, message count is the total number of instructions and data interactions between users and <Vg k="SIG" /> servers through the SDKs, RESTful APIs, webhooks, or serverless services. It is important to note that one message in <Vg k="SIG" /> is measured in units of 1 KB. This means that if you send a 2.5 KB message or instruction, it counts as three messages. Use of <Vg k="SIG" /> features contributes to the message count as follows:

<Tabs>
  <TabItem value="tab1" label="General" default>
  Each of the following constitutes one message:
    - A login request
    - A logout request
    - Updating an expiring token
    - Receiving a connection status change notification
    - Receiving a token expiry notification
  </TabItem>
  <TabItem value="tab2" label="Channels" default>
  Each of the following constitutes one message:
    - Subscribing to a message channel
    - Unsubscribing from a message channel
    - Creating a stream channel instance 
    - Joining a stream channel
    - Leaving a stream channel
  </TabItem>
  <TabItem value="tab3" label="Topics" default>
  Each of the following constitutes one message:
    - Joining a topic
    - Leaving a topic
    - Subscribing to a topic
    - Unsubscribing from a topic
    - Receiving a topic change notification
  </TabItem>
  <TabItem value="tab4" label="Messaging" default>
  Each of the following constitutes one message:
    - Publishing a message to a message channel
    - Receiving a message in a message channel
        For example, if a client sends a message to a message channel, and 10 people are subscribed to this channel, this counts as 1 sent message and 10 received messages, for a total of 11 messages.
    - Publishing to a topic in a stream channel
    - Receiving a message in a stream channel topic
        For example, if a client sends a message to a topic in a stream channel, and 10 people are subscribed to this topic, this counts as 1 sent message and 10 received messages, for a total of 11 messages.

    <Admonition type="info" title="Note"> Even if message filtering is enabled on the client, it does not have any impact on message metering. The client-side message filtering function is only for the convenience of developers, and the messages are actually delivered to the client.<ul><li>The asynchronous callback generated by publishing a message in the message channel or stream channel is not counted in the number of messages.</li> <li>Messages sent using the RESTful API are also counted as messages.</li><li>If a client is not subscribed to a channel or topic, it does not receive any messages.</li></ul></Admonition>
  </TabItem>

<TabItem value="tab5" label="Presence" default>
Each of the following constitutes one message:
- A <code>{presence.whonow[props.ag_platform]}</code> query 
- A <code>{presence.wherenow[props.ag_platform]}</code> query 
- Each <code>{presence.setstate[props.ag_platform]}</code>, <code>{presence.getstate[props.ag_platform]}</code>, or <code>{presence.removestate[props.ag_platform]}</code> call to manage temporary user state 
- Each triggered presence event notification, such as a client entering a channel, leaving a channel, timing out, or changing status.
- Each received presence event notification. For example, if a client enters a channel and 10 other clients are subscribed to the channel, it sends 1 presence event notification, and the other 10 clients each receive 1 presence event notification, totaling in 11 messages.

<Admonition type="info" title="Note">
- If a client joins or subscribes to a channel and disables presence event notifications, it does not receive any such notifications. However, since <Vg k="SIG" /> still sends these notifications to the client, the notifications still count as messages.
- If a client does not join or subscribe to a channel, it does not receive presence event notifications from that channel. Therefore, no messages are added to the count.
</Admonition>
</TabItem>

<TabItem value="tab6" label="Storage" default>
If you turn off the storage module in <Vg k="CONSOLE" />, no storage message count is generated. If storage is enabled, each of the following counts as one message:

##### Channel metadata
- Setting channel metadata using <code>{storage.setchannel[props.ag_platform]}</code> 
- Querying channel metadata using <code>{storage.getchannel[props.ag_platform]}</code> 
- Updating channel metadata using <code>{storage.updatechannel[props.ag_platform]}</code> 
- Deleting channel metadata using <code>{storage.removechannel[props.ag_platform]}</code> 
- Receiving a channel metadata change event notification. For example, if a client sets metadata in a channel, and the channel is subscribed to by 10 users, it sends 1 storage event notification, and the other 10 clients each receive 1 storage event notification, for a total of 11 messages.

<Admonition type="info">
- If a client joins or subscribes to a channel and disables storage event notifications, it does not receive any such notifications. However, since <Vg k="SIG" /> still sends these notifications to the client, the notifications still count as messages.
- If a client does not join or subscribe to a channel, it does not receive storage event notifications from that channel. Therefore, no messages are added to the count.
</Admonition>

##### User metadata
- Setting user metadata using <code>{storage.setuser[props.ag_platform]}</code>
- Querying user metadata using <code>{storage.getuser[props.ag_platform]}</code>
- Updating user metadata using <code>{storage.updateuser[props.ag_platform]}</code> 
- Deleting user metadata using <code>{storage.removeuser[props.ag_platform]}</code>
- Receiving a user metadata change event notification. For example, if a client sets user metadata, and 10 other users are subscribed to this user's metadata, it sends 1 storage event notification, and the other 10 users each receive 1 storage event notification, for a total of 11 messages.

<Admonition type="info">
If a client does not subscribe to user metadata, it does not receive user metadata change notifications. Therefore, no messages are added to the count.
</Admonition>
</TabItem>

<TabItem value="tab7" label="Locks" default>
Each of the following constitutes one message:
- <code>{lock.set[props.ag_platform]}</code>
- <code>{lock.acquire[props.ag_platform]}</code>
- <code>{lock.get[props.ag_platform]}</code>
- <code>{lock.release[props.ag_platform]}</code>
- <code>{lock.revoke[props.ag_platform]}</code>
- <code>{lock.remove[props.ag_platform]}</code>

- Receiving a lock change event notification. For example, if a client sets a lock on a channel, and 10 other users subscribe to this channel, it sends 1 lock event notification, and 10 users each receive 1 lock event notification, for a total of 11 messages.

<Admonition type="info" title="Note">In <Vg k="SIG" />, a message is calculated in 1 KB. Therefore, if you send a message package with a size of 10 KB to a channel or topic subscribed by 100 people, it will be counted as 10 inbound messages and 1,000 outbound messages to give a total of 1,010 messages.</Admonition>

</TabItem>
</Tabs>

### Storage occupancy

Storage in Signaling generates cloud storage occupancy. <Vg k="COMPANY" /> measures the total storage occupancy and bills the amount for the month by sampling the customer's actual storage use at 1-hour intervals during a calendar month. At the end of the month, the average storage occupancy is calculated by dividing the sum of all sample values by the number of samples. The average occupancy is then multiplied by the monthly unit price to calculate the monthly charge. The following formula mathematically represents this calculation process:

![Signaling storage calculation formula](/images/signaling/signaling-storage-calculation-formula.png)

### Peak connections

Peak connection usage (PCU) is the maximum number of clients simultaneously connected to <Vg k="SIG" /> at any point during a calendar month. For example, if you have 10,000 customers, and a maximum of 500 clients connected to <Vg k="SIG" /> simultaneously during the month, the PCU value is 500. This means you only pay for 500 peak connections. The total number of clients or devices that connect to <Vg k="SIG" /> during a month does not affect billing.
